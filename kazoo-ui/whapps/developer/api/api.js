winkstart.module("developer","api",{subscribe:{"api.activate":"activate","api.render":"render_api","api.request":"send_request","api.schema_to_template":"schema_to_template"},templates:{api:"tmpl/api.html",form:"tmpl/form.html",schema:"tmpl/schema.html",input_id:"tmpl/input_id.html",info:"tmpl/info_popup.html"},css:["css/api.css"],resources:{"api.list":{url:"{api_url}/schemas",contentType:"application/json",verb:"GET"},"api.show":{url:"{api_url}/schemas/{id}",contentType:"application/json",verb:"GET"}}},function(e){var t=this;t.module="api",winkstart.registerResources(t.__whapp,t.config.resources),t.ressources()},{clean_form:function(e){var t=this,n=function(e){for(var t in e)return!1;return!0};return $.each(e,function(r,i){typeof i=="object"?n(i)?delete e[r]:(e[r]=t.clean_form(i),n(e[r])&&delete e[r]):i==""&&delete e[r]}),e},send_request:function(e,t,n,r,i){var s=this,o={account_id:winkstart.apps.developer.account_id,api_url:winkstart.apps.developer.api_url},u={};$.extend(!0,u,n),u.id&&(o.id=u.id,delete u.id),o.data=u,typeof r=="function"&&typeof i=="function"&&winkstart.request("developer."+e+"."+t,o,r,i)},build_url:function(e,t,n,r){var i=this,s="";return s+=winkstart.config.fake_api_url||winkstart.apps.developer.api_url,s+=i.apis[e].ressources["developer."+t+"."+n].url.substr(9).replace("{account_id}",winkstart.apps.developer.account_id).replace("{id}",r.id),s},build_curl:function(e,t,n){var r=this,i="",s={get_all:"GET",get:"GET",put:"PUT",post:"POST","delete":"DELETE"},o={};i+='curl -i -H "Accept: application/json" -H "Content-Type: application/json"',i+=' -H "X-Auth-Token: '+winkstart.apps.developer.auth_token+'"',i+=" -X "+s[e],$.extend(!0,o,n),delete o.id;if(Object.getOwnPropertyNames(o).length!=0){var u={data:n,verb:s[e]};i+=" -d '"+winkstart.jsonToString(u)+"'"}return i+=" "+t,i},render_api:function(e){var t=this,n=null,r=null,i=null,s=t.templates.info.tmpl({developer:{api_url:winkstart.config.fake_api_url||winkstart.apps.developer.api_url,auth_token:winkstart.apps.developer.auth_token,account_id:winkstart.apps.developer.account_id},_t:function(e){return window.translate.api[e]}}),o=t.templates.input_id.tmpl();winkstart.request("api.show",{api_url:winkstart.apps.developer.api_url,id:e.id},function(e,u){if(!t.apis[e.data.id])return winkstart.alert("Api "+e.data.id+" not available"),!1;winkstart.registerResources(t.__whapp,t.apis[e.data.id].ressources),winkstart.publish("api.schema_to_template",e.data.properties,function(o,u,a){n=t.templates.form.tmpl({title:t.apis[e.data.id].title,apis:t.apis[e.data.id].api,ressources:t.apis[e.data.id].ressources,rests:t.rest,_t:function(e){return window.translate.api[e]}}),r=t.templates.schema.tmpl({schema:u,hide:!0}),i=t.templates.schema.tmpl({schema:o}),$(".toggle",n).click(function(){var e=$(this).parent(".whapp-header");e.hasClass("active")?e.removeClass("active"):e.addClass("active")}),$(".try",n).click(function(r){r.preventDefault();var i=$(this).data("id"),s=$(this).data("verb"),o=i+"_"+s,u=t.clean_form(form2object(o+"_form")),a=t.build_url(e.data.id,i,s,u),f=t.build_curl(s,a,u),l=function(e){var t=$("<pre>").append(f).css({cursor:"pointer"}).click(function(){prompt(_t("api","copy_paste_curl_command"),f)});$("#"+o+" .result_content",n).empty().append("<pre>URL: "+a+"</pre>").append(winkstart.print_r(e)).append(t),$("#"+o+" .result",n).show("fade")};winkstart.publish("api.request",i,s,u,function(e,t){l(e)},function(e,t){l(e)})}),$(".details",n).click(function(e){e.preventDefault();var t=$(this).data("id"),r=$(this).data("state"),i=$("#"+t+" .hide",n);r?($(this).data("state",!1).text(_t("api","show_advanced")),i.slideUp()):($(this).data("state",!0).text(_t("api","hide_advanced")),i.slideDown())}),$(".clean",n).click(function(e){e.preventDefault(),$("#"+$(this).data("id")+" .result",n).hide().find(".result_content").empty()}),$(".api-urls",n).click(function(){info_popup=winkstart.dialog(s,{height:"auto",width:400,modal:!0,title:_t("api","api_information")})}),winkstart.accordion(n,!1)}),$("#accounts_get .id",n).remove(),$("#api-view").empty().append(n),$(".schema",n).empty().append(i).append(r),$(".id",n).empty().append(o),$('*[rel=popover]:not([type="text"])',n).popover({trigger:"hover"}),$('*[rel=popover][type="text"]',n).popover({trigger:"focus"})})},schema_to_template:function(e,t){var n={},r={},i={},s={},o=function(e,t){var n={};typeof e=="object"&&$.each(e,function(e,r){switch(r.type){case"object":r.properties?(t[e]={},o(r.properties,t[e])):n[e]=r;break;case"array":r["enum"]||!r.items||!r.items.properties?n[e]=r:(t[e]={},t[e].type="array",o(r.items.properties,t[e]));break;default:n[e]=r}}),$.extend(!0,t,n)},u=function(e,t,n){var r={};$.each(e,function(e,t){if(t.type){var i="";n?i=n+"."+e:i=e,t.input_name=i,t.id=e,r[i]=t}}),$.extend(!0,t,r)};try{o(e,n),u(n,r),$.each(r,function(e,t){t.required?i[e]=t:s[e]=t}),typeof t=="function"&&t(i,s,r,e)}catch(a){winkstart.alert("error",_t("api","something_went_wrong"))}},render_list:function(e){var t=this;winkstart.request(!0,"api.list",{api_url:winkstart.apps.developer.api_url},function(n,r){var i=function(e){var n=[];return e.length>0&&$.each(e,function(e,r){t.apis[r]&&n.push({id:r,title:t.apis[r].title||"(name)"})}),n.sort(function(e,t){return e.title.toLowerCase()<t.title.toLowerCase()?-1:1}),n};$("#api-listpanel",e).empty().listpanel({label:_t("api","apis_developer_label"),identifier:"api-listview",new_entity_label:_t("api","apis_developer"),data:i(n.data),publisher:winkstart.publish,notifyMethod:"api.render",notifyCreateMethod:"",notifyParent:e})})},activate:function(e){var t=this,n=t.templates.api.tmpl();(e||$("#ws-content")).empty().append(n),t.render_list(n)},ressources:function(){var e=this,t=function(t,n,r){var i={get_all:"GET",get:"GET",put:"PUT",post:"POST","delete":"DELETE"};e.apis[t]={title:n,api:{},ressources:{}},e.apis[t].api[t]={verbs:r,title:n,url:"/"+t},$.each(r,function(n,r){var s="";if(r=="get"||r=="post"||r=="delete")s="/{id}";e.apis[t].ressources["developer."+t+"."+r]={url:"{api_url}/accounts/{account_id}/"+t+s,contentType:"application/json",verb:i[r]}})},n={menus:{title:_t("api","menus"),verbs:["get_all","get","put","post","delete"]},vmboxes:{title:_t("api","vmboxes"),verbs:["get_all","get","put","post","delete"]},callflows:{title:_t("api","callflows"),verbs:["get_all","get","put","post","delete"]},conferences:{title:_t("api","conferences"),verbs:["get_all","get","put","post","delete"]},directories:{title:_t("api","directories"),verbs:["get_all","get","put","post","delete"]},queues:{title:_t("api","queues"),verbs:["get_all","get","put","post","delete"]},resources:{title:_t("api","resources"),verbs:["get_all","get","put","post","delete"]},temporal_rules:{title:_t("api","temporal_rules"),verbs:["get_all","get","put","post","delete"]},phone_numbers:{title:_t("api","phone_numbers"),verbs:["get_all","post","delete"]},limits:{title:_t("api","limits"),verbs:["get_all"]},user_auth:{title:_t("api","user_auth"),verbs:["put"]}};e.rest={get_all:{btn:"primary"},get:{btn:"info","class":["id"]},put:{btn:"success","class":["schema"]},post:{btn:"","class":["id","schema"]},"delete":{btn:"danger","class":["id"]}},e.apis={devices:{title:_t(e.module,"devices"),api:{devices:{verbs:["get_all","get","put","post","delete"],title:_t("api","devices"),url:"/devices"},devices_status:{verbs:["get_all"],title:_t("api","devices_status"),url:"/devices/status"}},ressources:{"developer.devices.get_all":{url:"{api_url}/accounts/{account_id}/devices",contentType:"application/json",verb:"GET"},"developer.devices.get":{url:"{api_url}/accounts/{account_id}/devices/{id}",contentType:"application/json",verb:"GET"},"developer.devices.put":{url:"{api_url}/accounts/{account_id}/devices",contentType:"application/json",verb:"PUT"},"developer.devices.post":{url:"{api_url}/accounts/{account_id}/devices/{id}",contentType:"application/json",verb:"POST"},"developer.devices.delete":{url:"{api_url}/accounts/{account_id}/devices/{id}",contentType:"application/json",verb:"DELETE"},"developer.devices_status.get_all":{url:"{api_url}/accounts/{account_id}/devices/status",contentType:"application/json",verb:"GET"}}},accounts:{title:_t("api","accounts"),api:{accounts:{verbs:["get","post"],title:_t("api","accounts"),url:"/accounts"},accounts_children:{verbs:["get_all"],title:_t("api","accounts_children"),url:"/accounts/{account_id}/children"},accounts_descendants:{verbs:["get_all"],title:_t("api","accounts_descendants"),url:"/accounts/{account_id}/descendants"},accounts_siblings:{verbs:["get_all"],title:_t("api","accounts_siblings"),url:"/accounts/{account_id}/siblings"}},ressources:{"developer.accounts.get":{url:"{api_url}/accounts/{account_id}",contentType:"application/json",verb:"GET"},"developer.accounts.post":{url:"{api_url}/accounts/{account_id}",contentType:"application/json",verb:"POST"},"developer.accounts_children.get_all":{url:"{api_url}/accounts/{account_id}/children",contentType:"application/json",verb:"GET"},"developer.accounts_descendants.get_all":{url:"{api_url}/accounts/{account_id}/descendants",contentType:"application/json",verb:"GET"},"developer.accounts_siblings.get_all":{url:"{api_url}/accounts/{account_id}/siblings",contentType:"application/json",verb:"GET"}}},users:{title:_t(e.module,"users"),api:{users:{verbs:["get_all","get","put","post","delete"],title:_t("api","users"),url:"/users"},hotdesk:{verbs:["get_all"],title:_t("api","hotdesk"),url:"/users/hotdesk"}},ressources:{"developer.users.get_all":{url:"{api_url}/accounts/{account_id}/users",contentType:"application/json",verb:"GET"},"developer.users.get":{url:"{api_url}/accounts/{account_id}/users/{id}",contentType:"application/json",verb:"GET"},"developer.users.put":{url:"{api_url}/accounts/{account_id}/users",contentType:"application/json",verb:"PUT"},"developer.users.post":{url:"{api_url}/accounts/{account_id}/users/{id}",contentType:"application/json",verb:"POST"},"developer.users.delete":{url:"{api_url}/accounts/{account_id}/users/{id}",contentType:"application/json",verb:"DELETE"},"developer.hotdesk.get_all":{url:"{api_url}/accounts/{account_id}/users/hotdesk",contentType:"application/json",verb:"GET"}}},servers:{title:_t("api","servers"),api:{servers:{verbs:["get_all"],title:_t("api","servers"),url:"/servers"},servers_deployment:{verbs:["get","put"],title:_t("api","servers_deployment"),url:"/servers/{id}/deployment",rest:{put:["id"]}},servers_log:{verbs:["get"],title:_t("api","servers_log"),url:"/servers/{id}/log"}},ressources:{"developer.servers.get_all":{url:"{api_url}/accounts/{account_id}/servers",contentType:"application/json",verb:"GET"},"developer.servers_deployment.get":{url:"{api_url}/accounts/{account_id}/servers/{id}/deployment",contentType:"application/json",verb:"GET"},"developer.servers_deployment.put":{url:"{api_url}/accounts/{account_id}/servers/{id}/deployment",contentType:"application/json",verb:"PUT"},"developer.servers_log.get":{url:"{api_url}/accounts/{account_id}/servers/{id}/log",contentType:"application/json",verb:"GET"}}},media:{title:_t(e.module,"media"),api:{media:{verbs:["get_all","get","put","post","delete"],title:_t("api","media"),url:"/media"},languages:{verbs:["get_all"],title:_t("api","languages"),url:"/media/languages"},languages_missing:{verbs:["get_all"],title:_t("api","languages_missing"),url:"/media/languages/missing"}},ressources:{"developer.media.get_all":{url:"{api_url}/accounts/{account_id}/media",contentType:"application/json",verb:"GET"},"developer.media.get":{url:"{api_url}/accounts/{account_id}/media/{id}",contentType:"application/json",verb:"GET"},"developer.media.put":{url:"{api_url}/accounts/{account_id}/media",contentType:"application/json",verb:"PUT"},"developer.media.post":{url:"{api_url}/accounts/{account_id}/media/{id}",contentType:"application/json",verb:"POST"},"developer.media.delete":{url:"{api_url}/accounts/{account_id}/media/{id}",contentType:"application/json",verb:"DELETE"},"developer.languages.get_all":{url:"{api_url}/accounts/{account_id}/media/languages",contentType:"application/json",verb:"GET"},"developer.languages_missing.get_all":{url:"{api_url}/accounts/{account_id}/media/languages/missing",contentType:"application/json",verb:"GET"}}}},$.each(n,function(e,n){t(e,n.title,n.verbs)})}});