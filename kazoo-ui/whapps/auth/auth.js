winkstart.module("auth","auth",{css:[_t("auth","css_auth")],templates:{recover_password:"tmpl/recover_password.html",login:"tmpl/login.html",new_login:"tmpl/new_login.html",register:"tmpl/register.html",new_password:"tmpl/new_password.html",code:"tmpl/code.html",landing:"tmpl/landing.html"},subscribe:{"auth.activate":"activate","auth.login":"login_popup","auth.welcome":"login","auth.load_account":"load_account","auth.recover_password":"recover_password","auth.new_password":"new_password","auth.authenticate":"authenticate","auth.shared_auth":"shared_auth","auth.register":"register","auth.save_registration":"save_registration","auth.landing":"landing","core.loaded":"core_loaded","auth.logout":"_logout"},validation:[{name:"#username",regex:_t("auth","username_regex")},{name:"#email",regex:_t("auth","email_regex")}],validation_recover:[{name:"#username",regex:/^.+$/},{name:"#account_name",regex:/^.*$/},{name:"#account_realm",regex:/^.*$/},{name:"#phone_number",regex:/^.*$/}],validation_new_password:[{name:"#old_password",regex:".+"},{name:"#new_password1",regex:".+"},{name:"#new_password2",regex:".+"}],resources:{"auth.user_auth":{url:"{api_url}/user_auth",contentType:"application/json",verb:"PUT"},"auth.shared_auth":{url:"{api_url}/shared_auth",contentType:"application/json",verb:"PUT"},"auth.register":{url:"{api_url}/signup",contentType:"application/json",verb:"PUT"},"auth.activate":{url:"{api_url}/signup/{activation_key}",contentType:"application/json",verb:"POST"},"auth.get_user":{url:"{api_url}/accounts/{account_id}/users/{user_id}",contentType:"application/json",verb:"GET"},"auth.user.update":{url:"{api_url}/accounts/{account_id}/users/{user_id}",contentType:"application/json",verb:"POST"},"auth.recover_password":{url:"{api_url}/user_auth/recovery",contentType:"application/json",verb:"PUT"},"auth.invite_code":{url:"{api_url}/onboard/invite/{invite_code}",contentType:"application/json",verb:"GET"},"auth.get_account":{url:"{api_url}/accounts/{account_id}",contentType:"application/json",verb:"GET"}}},function(){var e,t=this;t.module="auth",winkstart.registerResources(this.__whapp,this.config.resources);var n=$.parseJSON($.cookie("c_winkstart_auth"));$.cookie("c_winkstart_auth")?n&&winkstart.apps.auth.api_url!==n.api_url&&($.cookie("c_winkstart_auth",null),winkstart.publish("layout.render_welcome",{callback:function(){winkstart.publish("auth.welcome")}})):winkstart.publish("auth.welcome"),"account_name"in URL_DATA&&(account_name=URL_DATA.account_name);if("auth_url"in URL_DATA)winkstart.apps.auth.api_url=URL_DATA.auth_url;else{var r=URL.match(/^(?:https?:\/\/)*([^\/?#]+).*$/)[1];typeof winkstart.config.base_urls=="object"&&r in winkstart.config.base_urls&&"auth_url"in winkstart.config.base_urls[r]&&(winkstart.apps.auth.api_url=winkstart.config.base_urls[r].auth_url)}winkstart.module(t.__module,"onboarding").init(function(){winkstart.log("Core: Loaded Onboarding")})},{request_realm:!1,get_account:function(e,t){winkstart.request("auth.get_account",{api_url:winkstart.apps.auth.api_url,account_id:winkstart.apps.auth.account_id},function(t,n){typeof e=="function"&&e(t)},function(e,n){typeof t=="function"&&t(e)})},core_loaded:function(){var THIS=this;"c"in URL_DATA&&"a"in URL_DATA&&"f"in URL_DATA&&($.cookie("c_winkstart_auth")||THIS.external_login(URL_DATA.c,URL_DATA.a,URL_DATA.f)),URL_DATA.activation_key?winkstart.postJSON("auth.activate",{crossbar:!0,api_url:winkstart.apps.auth.api_url,activation_key:URL_DATA.activation_key,data:{}},function(e){winkstart.alert("info",_t("auth","you_are_now_registered"),function(){winkstart.publish("auth.welcome",{username:e.data.user.username})}),e.auth_token!=""&&e.auth_token!="null"&&e.auth_token!="undefined"&&(winkstart.apps.auth.account_id=e.data.account.id,winkstart.apps.auth.auth_token=e.auth_token,winkstart.apps.auth.user_id=e.data.user.id,winkstart.apps.auth.realm=e.data.account.realm,winkstart.publish("auth.load_account"))}):URL_DATA.recover_password&&winkstart.alert("info",_t("auth","you_are_in_the_recover_password"));if(cookie_data=$.cookie("c_winkstart_auth"))$("#ws-content").empty(),eval('winkstart.apps["auth"] = '+cookie_data),winkstart.publish("auth.load_account")},register:function(){var e=this,t={_t:function(e){return window.translate.auth[e]}},n=winkstart.dialog(e.templates.register.tmpl(t),{title:_t("auth","register_new_account_title"),resizable:!1,modal:!0});$("#username",n).focus(),winkstart.validate.set(e.config.validation,n),$("button.register",n).click(function(t){t.preventDefault(),winkstart.validate.is_valid(e.config.validation,n,function(){if($("#password",n).val()==$("#password2",n).val()){if(winkstart.is_password_valid($("#password",n).val())){var t;e.request_realm?t=$("#realm",n).val():t=$("#username",n).val()+(typeof winkstart.config.realm_suffix=="object"?winkstart.config.realm_suffix.register:winkstart.config.realm_suffix),"realm"in URL_DATA&&(t=URL_DATA.realm);var r={crossbar:!0,api_url:winkstart.apps.auth.api_url,data:{account:{realm:t,name:$("#name",n).val(),app_url:URL},user:{username:$("#username",n).val(),password:$("#password",n).val(),first_name:$("#first_name",n).val(),last_name:$("#last_name",n).val(),email:$("#email",n).val(),apps:winkstart.config.register_apps}}};winkstart.putJSON("auth.register",r,function(e,t){$.cookie("c_winkstart.login",null),winkstart.alert("info",_t("auth","registered_successfully")),n.dialog("close")})}}else winkstart.alert(_t("auth","please_confirm_your_password"))},function(){winkstart.alert(_t("auth","there_were_errors_on_the_form"))})})},get_realm_from_url:function(){var e="";return"realm"in URL_DATA&&(e=URL_DATA.realm),e},get_account_name_from_url:function(){var e="",t,n;return"account_name"in URL_DATA?e=URL_DATA.account_name:(t=URL.match(/^(?:https?:\/\/)*([^\/?#]+).*$/)[1],n=t.split("."),typeof winkstart.config.base_urls=="object"&&n.slice(1).join(".")in winkstart.config.base_urls&&(e=n[0])),e},external_login:function(e,t,n){winkstart.putJSON("auth.user_auth",{api_url:winkstart.apps.auth.api_url,data:{credentials:e,account_name:t}},function(e,t){winkstart.apps.auth.account_id=e.data.account_id,winkstart.apps.auth.auth_token=e.auth_token,winkstart.apps.auth.user_id=e.data.owner_id,winkstart.apps.auth.reseller_id=e.data.reseller_id,winkstart.apps.auth.is_reseller=e.data.is_reseller,$("#ws-content").empty(),$.cookie("c_winkstart_auth",JSON.stringify(winkstart.apps.auth)),winkstart.publish("auth.load_account")},function(e,t){window.location.replace(n+"?error="+t)})},login:function(e){var t=this,n=typeof e=="object"&&"username"in e?e.username:"",r=t.get_account_name_from_url(),i=t.get_realm_from_url(),s=$.parseJSON($.cookie("c_winkstart.login"))||{},o={_t:function(e){return window.translate.auth[e]},username:n||s.login||"",request_account_name:i||r?!1:!0,account_name:r||s.account_name||"",remember_me:s.login||s.account_name?!0:!1,register_btn:winkstart.config.hide_registration||!1},u=t.templates.new_login.tmpl(o),a=t.templates.code.tmpl({_t:function(e){return window.translate.auth[e]}}),f=$(".welcome-page-top .right_div","#content_welcome_page").empty().append(u);o.username!=""?$("#password",f).focus():$("#login",f).focus(),$(".login",f).click(function(e){e.preventDefault();var t=$("#login",f).val(),n=$("#password",f).val(),s=$("#account_name",f).val(),o=$.md5(t+":"+n),u={};i?u.realm=i:r?u.account_name=r:s?u.account_name=s:u.realm=t+(typeof winkstart.config.realm_suffix=="object"?winkstart.config.realm_suffix.login:winkstart.config.realm_suffix),winkstart.putJSON("auth.user_auth",{api_url:winkstart.apps.auth.api_url,data:$.extend(!0,{credentials:o},u)},function(e,n){winkstart.apps.auth.account_id=e.data.account_id,winkstart.apps.auth.auth_token=e.auth_token,winkstart.apps.auth.user_id=e.data.owner_id,winkstart.apps.auth.realm=i,winkstart.apps.auth.reseller_id=e.data.reseller_id,winkstart.apps.auth.is_reseller=e.data.is_reseller,$("#ws-content").empty();if($("#remember_me",f).is(":checked")){var r={};t?r.login=t:!0,u.account_name?r.account_name=u.account_name:!0,$.cookie("c_winkstart_login",JSON.stringify(r))}else $.cookie("c_winkstart_login",null);$.cookie("c_winkstart_auth",JSON.stringify(winkstart.apps.auth)),winkstart.publish("auth.load_account")},function(e,t){t===400?winkstart.alert(_t("auth","invalid_check_username_and_account")):$.inArray(t,[401,403])>-1?winkstart.alert(_t("auth","invalid_check_password_and_account")):t==="error"?winkstart.alert(_t("auth","we_are_having_trouble_contacting")):winkstart.alert(_t("auth","an_error_was_encountered")+t+")")})}),$("button.register",f).click(function(e){e.preventDefault(),winkstart.config.nav.register?window.location.href=winkstart.config.nav.register:winkstart.config.register_type=="ask_code"?$("#ws-content").empty().append(a):winkstart.config.register_type==="onboard"?winkstart.publish("onboard.register"):winkstart.publish("auth.register")}),$("button.register",a).click(function(e){e.preventDefault();var t=$("input#code",a).val();t!=""&&t!=null&&winkstart.request("auth.invite_code",{api_url:winkstart.apps.auth.api_url,invite_code:t},function(e,n){winkstart.publish("onboard.register",{invite_code:t})},function(e,t){switch(e.error){case"404":winkstart.alert("error",_t("auth","invalid_invite_code"));break;case"410":winkstart.alert("error",_t("auth","invite_code_already_used"));break;default:winkstart.alert("error",_t("auth","an_error_occurred")+winkstart.print_r(e))}})}),$("a.recover_password",f).click(function(e){e.preventDefault(),winkstart.publish("auth.recover_password",{data:window.translate})})},login_popup:function(e){var t=this,n=typeof e=="object"&&"username"in e?e.username:"",r=t.get_account_name_from_url(),i=t.get_realm_from_url(),s=t.templates.login.tmpl({username:n,request_account_name:i||r?!1:!0,account_name:r,_t:function(e){return window.translate.auth[e]}}),o=winkstart.dialog(s,{title:_t("auth","login_title"),resizable:!1,width:"340",modal:!0});n!=""&&$("#password",o).focus(),$(".login",o).click(function(e){e.preventDefault();var t=$("#login",o).val(),n=$("#password",o).val(),s=$("#account_name",o).val(),u=$.md5(t+":"+n),a={};i?a.realm=i:r?a.account_name=r:s?a.account_name=s:a.realm=t+(typeof winkstart.config.realm_suffix=="object"?winkstart.config.realm_suffix.login:winkstart.config.realm_suffix),winkstart.putJSON("auth.user_auth",{api_url:winkstart.apps.auth.api_url,data:$.extend(!0,{credentials:u},a)},function(e,t){winkstart.apps.auth.account_id=e.data.account_id,winkstart.apps.auth.auth_token=e.auth_token,winkstart.apps.auth.user_id=e.data.owner_id,winkstart.apps.auth.realm=i,$(o).dialog("close"),$("#ws-content").empty(),$.cookie("c_winkstart_auth",JSON.stringify(winkstart.apps.auth)),winkstart.publish("auth.load_account")},function(e,t){t===400?winkstart.alert(_t("auth","invalid_check_username_and_account")):$.inArray(t,[401,403])>-1?winkstart.alert(_t("auth","invalid_check_password_and_account")):t==="error"?winkstart.alert(_t("auth","we_are_having_trouble_contacting")):winkstart.alert(_t("auth","an_error_was_encountered")+t+")")})}),$("a.register",o).click(function(e){e.preventDefault(),winkstart.publish("auth.register"),$(o).dialog("close")}),$("a.recover_password",o).click(function(e){e.preventDefault(),winkstart.publish("auth.recover_password"),$(o).dialog("close")})},landing:function(e){var t=this,e=e||$(".ws-content"),n=t.templates.landing.tmpl();e.empty().append(n)},load_account:function(e){winkstart.log("Loading your apps!");var t=this,n={crossbar:!0,account_id:winkstart.apps.auth.account_id,api_url:winkstart.apps.auth.api_url,user_id:winkstart.apps.auth.user_id};t.get_account(function(e){winkstart.apps.auth.superduper_admin=e.data.superduper_admin||!1,winkstart.getJSON("auth.get_user",n,function(t,n){t.data.account_name=(e.data||{}).name||winkstart.config.company_name,t.data.apps=t.data.apps||{},winkstart.apps.auth.role=t.data.priv_level,winkstart.publish("auth.account.loaded",t.data),$.each(t.data.apps,function(e,t){winkstart.log("WhApps: Loading "+e+" from URL "+t.api_url),winkstart.apps[e]=t,"account_id"in t||(winkstart.apps[e].account_id=winkstart.apps.auth.account_id),"user_id"in t||(winkstart.apps[e].user_id=winkstart.apps.auth.user_id),winkstart.module.loadApp(e,function(){this.init(),winkstart.log("WhApps: Initializing "+e)})}),t.data.require_password_update&&winkstart.publish("auth.new_password",t.data),winkstart.autoLogout()},function(e,n){winkstart.alert("error",_t("auth","an_error_occurred_while_loading"),function(){t._logout()})})},function(e){winkstart.alert("error",_t("auth","an_error_occurred_while_loading"),function(){t._logout()})})},_logout:function(){var e=this;$.cookie("c_winkstart_auth",null),window.location.reload()},shared_auth:function(e){var t=this,n={api_url:winkstart.apps[e.app_name].api_url,data:{realm:winkstart.apps.auth.realm,account_id:winkstart.apps.auth.account_id,shared_token:winkstart.apps.auth.auth_token}},r=function(e,t,n){var r={account_id:winkstart.apps.auth.account_id,api_url:winkstart.apps.auth.api_url,user_id:winkstart.apps.auth.user_id};winkstart.apps[t]=$.extend(!0,{},r,winkstart.apps[t]),winkstart.apps[t].auth_token=e,typeof n=="function"&&n()};winkstart.apps["auth"].api_url!=winkstart.apps[e.app_name].api_url?winkstart.putJSON("auth.shared_auth",n,function(t,n){r(t.auth_token,e.app_name,e.callback)}):r(winkstart.apps.auth.auth_token,e.app_name,e.callback)},new_password:function(e){var t=this,n={_t:function(e){return window.translate.auth[e]}},r=winkstart.dialog(t.templates.new_password.tmpl(n),{title:_t("auth","please_set_a_new_password"),width:"500px"});winkstart.validate.set(t.config.validation_new_password,r),$(".btn_new_password",r).click(function(n){n.preventDefault();var i=form2object("new_password_form");winkstart.validate.is_valid(t.config.validation_new_password,r,function(){i.new_password1===i.new_password2?(e.password=i.new_password1,e.require_password_update=!1,winkstart.request(!0,"auth.user.update",{api_url:winkstart.apps.auth.api_url,account_id:winkstart.apps.auth.account_id,user_id:e.id,data:e},function(e,t){winkstart.alert("info",_t("auth","password_updated")),r.dialog("close")},function(e,t){winkstart.alert("error","Error :"+t)})):($("#new_password1",r).val(""),$("#new_password2",r).val(""),winkstart.alert(_t("auth","password_typed_dont_match")))})})},recover_password:function(e){var t=this,n=winkstart.dialog(t.templates.recover_password.tmpl({_t:function(e){return window.translate.auth[e]}}),{title:window.translate.auth.title_recover});winkstart.validate.set(t.config.validation_recover,n),$(".btn_recover_password",n).click(function(e){e.preventDefault();var r=form2object("recover_password_form");r.account_realm==""?delete r.account_realm:!0,r.account_name==""?delete r.account_name:!0,r.phone_number==""?delete r.phone_number:!0,winkstart.validate.is_valid(t.config.validation_recover,n,function(){winkstart.request(!0,"auth.recover_password",{api_url:winkstart.apps.auth.api_url,data:r},function(e,t){winkstart.alert("info",e.data),n.dialog("close")},function(e,t){var n="Error "+t+"<br/>";e.data&&$.each(e.data,function(t,r){$.each(e.data[t],function(e,t){n+="<br/>"+t})}),winkstart.alert("error",n)})})})},authenticate:function(){var e=this;amplify.request("auth.establish",{username:"",passwordhash:""},function(t){e.session.authenticated=!0,e.session.token=t.auth_token,e.session.expires=t.expires,winkstart.alert("User authenticated")})},init:function(){var e=$.cookie("winkstart");e&&(this.session=e)},activate:function(){winkstart.apps["auth"].auth_token==null?winkstart.publish("auth.login"):winkstart.confirm(_t("auth","are_you_sure_that_you_want_to_log_out"),function(){$.each(winkstart.apps,function(e,t){winkstart.apps[e].realm=null,winkstart.apps[e].auth_token=null,winkstart.apps[e].user_id=null,winkstart.apps[e].account_id=null}),$.cookie("c_winkstart_auth",null),$("#ws-content").empty(),URL_DATA.f?window.location.replace(URL_DATA.f):window.location.reload()})}});