winkstart.module("myaccount","billing",{css:["css/billing.css"],templates:{billing:"tmpl/billing.html"},subscribe:{"myaccount.nav.post_loaded":"myaccount_loaded","billing.popup":"popup","billing.ext_link":"ext_link"},resources:{"past_purchases.get":{url:"{api_url}/accounts/{account_id}/braintree/transactions",contentType:"application/json",verb:"GET"},"past_purchases.list_accounts":{url:"{api_url}/accounts/{account_id}/descendants",contentType:"application/json",verb:"GET"},"billing.user_get":{url:"{api_url}/accounts/{account_id}/users/{user_id}",contentType:"application/json",verb:"GET"},"billing.user_update":{url:"{api_url}/accounts/{account_id}/users/{user_id}",contentType:"application/json",verb:"POST"},"billing.update":{url:"{api_url}/accounts/{account_id}/braintree/customer",contentType:"application/json",verb:"POST"},"billing.get":{url:"{api_url}/accounts/{account_id}/braintree/customer",contentType:"application/json",verb:"GET"}}},function(e){var t=this;winkstart.registerResources(t.__whapp,t.config.resources)},{addons:{},update_acct:function(e,t,n,r){winkstart.request("billing.user_update",{account_id:winkstart.apps.myaccount.account_id,api_url:winkstart.apps.myaccount.api_url,user_id:winkstart.apps.myaccount.user_id,data:$.extend(!0,{},e,t)},function(e,t){typeof n=="function"&&n(e,t)},function(e,t){typeof r=="function"&&r(e,t)})},update_billing:function(e,t,n,r){winkstart.request("billing.update",{account_id:winkstart.apps.myaccount.account_id,api_url:winkstart.apps.myaccount.api_url,data:$.extend(!0,{},e,t)},function(e,t){typeof n=="function"&&n(e,t)},function(e,t){typeof r=="function"&&r(e,t)})},list_accounts:function(e,t){winkstart.request("past_purchases.list_accounts",{api_url:winkstart.apps.myaccount.api_url,account_id:winkstart.apps.myaccount.account_id},function(t,n){typeof e=="function"&&e(t,n)},function(e,n){typeof t=="function"&&t(e,n)})},myaccount_loaded:function(e){(winkstart.config.display_billing||!e.priv_level||e.priv_level==="admin")&&winkstart.publish("nav.add_sublink",{link:"nav",sublink:"billing",label:_t("billing","billing_label"),weight:"15",publish:winkstart.config.nav.billing?"billing.ext_link":"billing.popup"})},ext_link:function(){window.open(winkstart.config.nav.billing)},render_billing:function(e,t){e._t=function(e){return window.translate.billing[e]};var n=this,r=n.templates.billing.tmpl(e);$("#save-billing",r).click(function(e){e.preventDefault();var r=form2object("billing-form");n.clean_billing_form_data(r),n.update_billing({},r,function(e){n.render_billing(e,t),winkstart.alert("info",_t("billing","credit_card_updated"))},function(e,t){t==400&&e.message?winkstart.alert("error",_t("billing","the_following_errors_occurred")+"<br/><br/>"+e.message.replace(/\./g,"<br/>")):winkstart.alert("error",_t("billing","there_was_an_unspecified_server_error"))})}),$("#edit-billing",r).click(function(e){e.preventDefault();var t=["company","phone","postal_code","firstname","lastname"];billing_form_html=$("#billing-form"),billing_form_html.find("input").each(function(){var e=$(this);$.inArray(this.id,t)==-1&&e.val("").empty(),e.removeClass("hide")}),billing_form_html.find(".uneditable-input").each(function(){$(this).remove()}),$("#save-billing",r).removeClass("disabled").removeAttr("disabled")}),$("#cardnbr",r).change(function(){var e=new RegExp("^4"),t=$(this).val();$(".card").css("opacity",.2),t.match(e)!=null&&$("#visa",r).css("opacity",1),e=new RegExp("^(34|37)"),t.match(e)!=null&&$("#amex",r).css("opacity",1),e=new RegExp("^5[1-5]"),t.match(e)!=null&&$("#mastercard",r).css("opacity",1)}),n.setup_transactions(r),n.setup_subscriptions(e.past_purchases,r),n.list_payments(e.past_purchases,r),t.empty().append(r)},popup:function(){var e=this,t=$('<div class="inline_popup billing"><div class="inline_content main_content"/></div>');winkstart.request("billing.get",{account_id:winkstart.apps.myaccount.account_id,api_url:winkstart.apps.myaccount.api_url},function(n,r){var i={data:{credit_cards:[{billing_address:{}}]}};winkstart.request("past_purchases.get",{account_id:winkstart.apps.myaccount.account_id,api_url:winkstart.apps.myaccount.api_url},function(r,i){n.past_purchases=r,e.render_billing(n,$(".inline_content",t)),winkstart.dialog(t,{modal:!0,title:_t("billing","billing_title"),position:"top",width:"1000px"})})})},setup_transactions:function(e){var t=this,n=[{sTitle:_t("billing","date_stitle")},{sTitle:_t("billing","status_stitle")},{sTitle:_t("billing","amount_stitle")}];winkstart.table.create("transactions",$("#transactions-grid",e),n,{},{sDom:"frtlip",aaSorting:[[0,"desc"]]}),$("#transactions-grid_filter input[type=text]",e).first().focus(),$(".cancel-search",e).click(function(){$("#transactions-grid_filter input[type=text]",e).val(""),winkstart.table.transactions.fnFilter("")})},setup_subscriptions:function(e,t){var n=this,r=[{sTitle:_t("billing","date_stitle"),sWidth:"10%"},{sTitle:_t("billing","subscription_stitle"),sWidth:"20%"},{sTitle:_t("billing","status_stitle"),sWidth:"10%"}],i=[];e&&e.data&&$.each(e.data,function(){$.each(this.add_ons,function(e,t){i.indexOf(t.id)<0&&i.push(t.id)})}),n.addons=i;var s=40/i.length+"%";$.each(i,function(e,t){r.push({sTitle:t,sWidth:s})}),r.push({sTitle:_t("billing","discount_stitle"),sWidth:"10%"},{sTitle:_t("billing","amount_stitle"),sWidth:"10%"}),winkstart.table.create("subscriptions",$("#subscriptions-grid",t),r,{},{sDom:"frtlip",aaSorting:[[0,"desc"]],bAutoWidth:!1}),$("#subscriptions-grid_filter input[type=text]",t).first().focus(),$(".cancel-search",t).click(function(){$("#subscriptions-grid_filter input[type=text]",t).val(""),winkstart.table.subscriptions.fnFilter("")})},list_payments:function(e,t){var n=this,r=[],i=[],s,o;n.list_accounts(function(t){var u={};$.each(t.data,function(e,t){u[t.id]=t}),e&&e.data&&$.each(e.data,function(e,t){t.created_at=t.created_at.replace(/-/g,"/").replace("T"," - ").replace("Z",""),t.created_at=t.created_at.substring(0,t.created_at.length-11);if(t.subscription_id){var a=t.subscription_id.split("_")[0];o=a.length===32&&a in u?u[a].name:"-",s=[t.created_at,o,t.status],$.each(n.addons,function(){s.push("0")}),t.add_ons&&$.each(t.add_ons,function(e,t){var r=n.addons.indexOf(t.id);r>=0&&(r+=3,s[r]=t.quantity)});var f=0;t.discounts&&$.each(t.discounts,function(e,t){f+=t.quantity*t.amount}),s.push(f.toFixed(2),t.amount),i.push(s)}else s=[t.created_at,t.status,t.amount],r.push(s)}),winkstart.table.transactions.fnClearTable(),winkstart.table.subscriptions.fnClearTable(),winkstart.table.transactions.fnAddData(r),winkstart.table.subscriptions.fnAddData(i)})},clean_billing_form_data:function(e){return e.credit_card.number.indexOf("*")!=-1&&delete e.credit_card.number,e.credit_card.cvv==""&&delete e.credit_card.cvv,e.credit_card.expiration_date=e.credit_card.expiration_date.month+"/"+e.credit_card.expiration_date.year,e}});