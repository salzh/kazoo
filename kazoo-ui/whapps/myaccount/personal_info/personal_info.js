winkstart.module("myaccount","personal_info",{css:["css/personal_info.css"],templates:{info:"tmpl/personal_info.html"},subscribe:{"myaccount.nav.post_loaded":"myaccount_loaded","personal_info.popup":"popup","personal_info.advanced_view":"advanced_view","personal_info.primary_set":"primary_set"},resources:{"personal_info.user_get":{url:"{api_url}/accounts/{account_id}/users/{user_id}",contentType:"application/json",verb:"GET"},"personal_info.user_update":{url:"{api_url}/accounts/{account_id}/users/{user_id}",contentType:"application/json",verb:"POST"}}},function(e){var t=this;winkstart.registerResources(t.__whapp,t.config.resources)},{update_acct:function(e,t,n,r){winkstart.request("personal_info.user_update",{account_id:winkstart.apps.myaccount.account_id,api_url:winkstart.apps.myaccount.api_url,user_id:winkstart.apps.myaccount.user_id,data:$.extend(!0,{},e,t)},function(e,t){typeof n=="function"&&n(e,t)},function(e,t){typeof r=="function"&&r(e,t)})},myaccount_loaded:function(e){winkstart.publish("nav.add_sublink",{link:"nav",sublink:"perso",label:_t("personal-info","my_account_label"),weight:"10",publish:"personal_info.popup"})},render_info:function(e,t){e._t=function(e){return window.translate["personal-info"][e]};var n=this,r=n.templates.info.tmpl(e);$('*[rel=popover]:not([type="text"])',r).popover({trigger:"hover"}),$('*[rel=popover][type="text"]',r).popover({trigger:"focus"}),$("#btnEmail",r).click(function(t){t.preventDefault(),n.update_acct(e.data,{email:$("#infos_email",r).val()},function(){winkstart.alert("info",_t("personal-info","email_address_updated"))})}),$("#btnPwd",r).click(function(t){var i=$("#infos_pwd1",r).val();t.preventDefault(),i==$("#infos_pwd2",r).val()?winkstart.is_password_valid(i)&&n.update_acct(e.data,{password:i},function(){winkstart.alert("info",_t("personal-info","password_updated"))}):winkstart.alert(_t("personal-info","passwords_do_not_match"))}),$("#advanced",r).click(function(){var t=$(this);winkstart.config.advancedView=t.is(":checked"),n.update_acct(e.data,{advanced:t.is(":checked")})}),$("#primary_app",r).change(function(){winkstart.publish("personal_info.primary_set",$("option:selected",this).val())});var i=!0;$.each(e.data.apps,function(e,t){t["default"]&&(i=!1)}),i&&$('#primary_app option[value="false"]',r).attr("checked","checked"),t.empty().append(r)},popup:function(){var e=this,t=$('<div class="inline_popup"><div class="inline_content main_content"/></div>');winkstart.request("personal_info.user_get",{account_id:winkstart.apps.myaccount.account_id,api_url:winkstart.apps.myaccount.api_url,user_id:winkstart.apps.myaccount.user_id},function(n,r){e.render_info(n,$(".inline_content",t));var i=winkstart.dialog(t,{modal:!0,title:_t("personal-info","my_account_title"),autoOpen:!0});$(".personal_info-close",t).click(function(e){e.preventDefault(),i.dialog("close")})})},advanced_view:function(e){winkstart.request("personal_info.user_get",{account_id:winkstart.apps.myaccount.account_id,api_url:winkstart.apps.myaccount.api_url,user_id:winkstart.apps.myaccount.user_id},function(t,n){typeof e=="function"&&e(t.data.advanced)})},primary_set:function(e,t){var n=this;winkstart.request("personal_info.user_get",{account_id:winkstart.apps.myaccount.account_id,api_url:winkstart.apps.myaccount.api_url,user_id:winkstart.apps.myaccount.user_id},function(r,i){var s=r.data;$.each(s.apps,function(t,n){t==e?s.apps[t]["default"]=!0:s.apps[t]["default"]=!1}),n.update_acct(r.data,s,function(n,r){e&&e!="false"?winkstart.alert("info",e+_t("personal-info","is_now_your_primary_app")):winkstart.alert("info",_t("personal-info","you_dont_have_a_primary_app")),typeof t=="function"&&t(n)})})}});