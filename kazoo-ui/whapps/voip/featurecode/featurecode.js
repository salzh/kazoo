winkstart.module("voip","featurecode",{css:["css/featurecode.css"],templates:{featurecode:"tmpl/featurecode.html"},subscribe:{"featurecode.activate":"activate","featurecode.define_featurecodes":"define_featurecodes"},resources:{"featurecode.list":{url:"{api_url}/accounts/{account_id}/callflows",contentType:"application/json",verb:"GET"},"featurecode.get":{url:"{api_url}/accounts/{account_id}/callflows/{featurecode_id}",contentType:"application/json",verb:"GET"},"featurecode.create":{url:"{api_url}/accounts/{account_id}/callflows",contentType:"application/json",verb:"PUT"},"featurecode.update":{url:"{api_url}/accounts/{account_id}/callflows/{featurecode_id}",contentType:"application/json",verb:"POST"},"featurecode.delete":{url:"{api_url}/accounts/{account_id}/callflows/{featurecode_id}",contentType:"application/json",verb:"DELETE"}}},function(e){winkstart.registerResources(this.__whapp,this.config.resources),winkstart.publish("whappnav.subnav.add",{whapp:"voip",module:this.__module,label:_t("featurecode","feature_codes_label"),icon:"sip",weight:"95"})},{actions:{},categories:{},activate:function(){var e=this,t;$("#ws-content").empty(),e.categories={},e.actions={},winkstart.publish("featurecode.define_featurecodes",e.actions),$.each(e.actions,function(t,n){this.tag=t,this.number=n.number==undefined?n.default_number:n.number,"category"in n&&(n.category in e.categories?!0:e.categories[n.category]=[],e.categories[n.category].push(n))}),winkstart.getJSON("featurecode.list",{crossbar:!0,account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){$.each(t.data,function(){"featurecode"in this&&this.featurecode!=0&&this.featurecode.name in e.actions&&(e.actions[this.featurecode.name].id=this.id,e.actions[this.featurecode.name].enabled=!0,e.actions[this.featurecode.name].number=this.featurecode.number.replace("\\",""))});var t={categories:e.categories,label:"data",_t:function(e){return window.translate.featurecode[e]}},r=e.templates.featurecode.tmpl(t);winkstart.accordion(r),$('*[rel=popover]:not([type="text"])',r).popover({trigger:"hover"}),$('*[rel=popover][type="text"]',r).popover({trigger:"focus"}),$(".featurecode_number",r).bind("blur keyup focus",function(){var t=$(this).parents(".action_wrapper");t.dataset("number",$(this).val()),$(this).val()!=e.actions[t.dataset("action")].number?t.addClass("changed"):t.removeClass("changed")}),$(".featurecode_enabled",r).each(function(){var e=$(this).parents(".action_wrapper"),t=e.find(".featurecode_number");$(this).is(":checked")?$(t).removeAttr("disabled"):$(t).attr("disabled","")}),$(".featurecode_enabled",r).change(function(){var e=$(this).parents(".action_wrapper");!$(this).is(":checked")&&e.dataset("enabled")=="true"?e.addClass("disabled"):$(this).is(":checked")&&e.dataset("enabled")=="false"?e.addClass("enabled"):(e.removeClass("enabled"),e.removeClass("disabled"));var t=e.find(".featurecode_number");$(this).is(":checked")?$(t).removeAttr("disabled"):$(t).attr("disabled","")}),$(".featurecode-save",r).click(function(){var t=e.clean_form_data();return e.update_list_featurecodes(t),!1}),$("#ws-content").empty().append(r)})},update_list_featurecodes:function(e){var t=this,n=e.created_callflows.length+e.deleted_callflows.length+e.updated_callflows.length;if(n==0){winkstart.alert("info",_t("featurecode","nothing_to_save"));return}$.each(e.created_callflows,function(){winkstart.putJSON("featurecode.create",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,featurecode_id:this.id,data:{flow:this.flow,patterns:this.patterns,numbers:this.numbers,featurecode:{name:this.action,number:this.number}}},function(e,t){--n||winkstart.publish("featurecode.activate")})}),$.each(e.updated_callflows,function(){winkstart.postJSON("featurecode.update",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,featurecode_id:this.id,data:{flow:this.flow,patterns:this.patterns,numbers:this.numbers,featurecode:{name:this.action,number:this.number}}},function(e,t){--n||winkstart.publish("featurecode.activate")})}),$.each(e.deleted_callflows,function(){winkstart.deleteJSON("featurecode.delete",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,featurecode_id:this.id},function(){--n||winkstart.publish("featurecode.activate")})})},render_featurecodes:function(){var e=this;winkstart.getJSON("featurecode.list",{crossbar:!0,account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){$.each(t.data,function(){"featurecode"in this&&this.featurecode!=0&&this.featurecode.name in e.actions&&(e.actions[this.featurecode.name].id=this.id,e.actions[this.featurecode.name].enabled=!0,e.actions[this.featurecode.name].number=this.featurecode.number.replace("\\",""))});var t={categories:e.categories,label:"data",_t:function(e){return window.translate.featurecode[e]}},r=e.templates.featurecode.tmpl(t);$("#ws-content").empty().append(r)})},clean_form_data:function(){var e=this,t={created_callflows:[],deleted_callflows:[],updated_callflows:[]};return $(".enabled","#featurecode-view").each(function(){var n=$(this).dataset();n.flow={data:e.actions[n.action].data,module:e.actions[n.action].module,children:{}},n.type+="s",n.type==="patterns"&&(n.number=n.number.replace(/([*])/g,"\\$1")),n[n.type]=[e.actions[n.action].build_regex(n.number)],t.created_callflows.push(n)}),$(".disabled","#featurecode-view").each(function(){var e=$(this).dataset();t.deleted_callflows.push(e)}),$(".changed:not(.enabled, .disabled)","#featurecode-view").each(function(){if($(this).dataset("enabled")=="true"){var n=$(this).dataset();n.flow={data:e.actions[n.action].data,module:e.actions[n.action].module,children:{}},n.type+="s",n.type==="patterns"&&(n.number=n.number.replace(/([*])/g,"\\$1")),n[n.type]=[e.actions[n.action].build_regex(n.number)],t.updated_callflows.push(n)}}),t},construct_action:function(e){var t=[];return"data"in e&&"action"in e.data&&(t+="{action="+e.data.action+"}"),e.module+t},define_featurecodes:function(e){var t=this;$.extend(e,{"call_forward[action=activate]":{name:_t("featurecode","enable_call_forward"),icon:"phone",category:_t("featurecode","call_forward_cat"),module:"call_forward",number_type:"number",data:{action:"activate"},enabled:!1,default_number:"72",number:this.default_number,build_regex:function(e){return"*"+e}},"call_forward[action=deactivate]":{name:_t("featurecode","disable_call_forward"),icon:"phone",category:_t("featurecode","call_forward_cat"),module:"call_forward",number_type:"number",data:{action:"deactivate"},enabled:!1,default_number:"73",number:this.default_number,build_regex:function(e){return"*"+e}},"call_forward[action=toggle]":{name:_t("featurecode","toggle_call_forward"),icon:"phone",category:_t("featurecode","call_forward_cat"),module:"call_forward",number_type:"pattern",data:{action:"toggle"},enabled:!1,default_number:"74",number:this.default_number,build_regex:function(e){return"^\\*"+e+"([0-9]*)$"}},"call_forward[action=update]":{name:_t("featurecode","update_call_forward"),icon:"phone",category:_t("featurecode","call_forward_cat"),module:"call_forward",number_type:"number",data:{action:"update"},enabled:!1,default_number:"56",number:this.default_number,build_regex:function(e){return"*"+e}},"hotdesk[action=login]":{name:_t("featurecode","enable_hot_desking"),icon:"phone",category:_t("featurecode","hot_desking_cat"),module:"hotdesk",number_type:"number",data:{action:"login"},enabled:!1,default_number:"11",number:this.default_number,build_regex:function(e){return"*"+e}},"hotdesk[action=logout]":{name:_t("featurecode","disable_hot_desking"),icon:"phone",category:_t("featurecode","hot_desking_cat"),module:"hotdesk",number_type:"number",data:{action:"logout"},enabled:!1,default_number:"12",number:this.default_number,build_regex:function(e){return"*"+e}},"hotdesk[action=toggle]":{name:_t("featurecode","toggle_hot_desking"),icon:"phone",category:_t("featurecode","hot_desking_cat"),module:"hotdesk",number_type:"number",data:{action:"toggle"},enabled:!1,default_number:"13",number:this.default_number,build_regex:function(e){return"*"+e}},"voicemail[action=check]":{name:_t("featurecode","check_voicemail"),icon:"phone",category:_t("featurecode","miscellaneous_cat"),module:"voicemail",number_type:"number",data:{action:"check"},enabled:!1,default_number:"97",number:this.default_number,build_regex:function(e){return"*"+e}},'voicemail[action="direct"]':{name:_t("featurecode","direct_to_voicemail"),category:_t("featurecode","miscellaneous_cat"),module:"voicemail",number_type:"pattern",data:{action:"compose"},enabled:!1,default_number:"*",number:this.default_number,build_regex:function(e){return"^\\*"+e+"([0-9]*)$"}},intercom:{name:_t("featurecode","intercom"),icon:"phone",category:_t("featurecode","miscellaneous_cat"),module:"intercom",number_type:"pattern",data:{},enabled:!1,default_number:"0",number:this.default_number,build_regex:function(e){return"^\\*"+e+"([0-9]*)$"}},"privacy[mode=full]":{name:_t("featurecode","privacy"),icon:"phone",category:_t("featurecode","miscellaneous_cat"),module:"privacy",number_type:"pattern",data:{mode:"full"},enabled:!1,default_number:"67",number:this.default_number,build_regex:function(e){return"^\\*"+e+"([0-9]*)$"}},park_and_retrieve:{name:_t("featurecode","park_and_retrieve"),icon:"phone",category:_t("featurecode","parking_cat"),module:"park",number_type:"pattern",data:{action:"auto"},enabled:!1,default_number:"3",number:this.default_number,build_regex:function(e){return"^\\*"+e+"([0-9]*)$"}},valet:{name:_t("featurecode","valet"),icon:"phone",category:_t("featurecode","parking_cat"),module:"park",number_type:"number",data:{action:"park"},enabled:!1,default_number:"4",number:this.default_number,build_regex:function(e){return"*"+e}},retrieve:{name:_t("featurecode","retrieve"),icon:"phone",category:_t("featurecode","parking_cat"),module:"park",number_type:"pattern",data:{action:"retrieve"},enabled:!1,default_number:"5",number:this.default_number,build_regex:function(e){return"^\\*"+e+"([0-9]*)$"}}})}});