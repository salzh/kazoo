winkstart.module("voip","groups",{css:["css/groups.css"],templates:{groups:"tmpl/groups.html",edit:"tmpl/edit.html",groups_callflow:"tmpl/groups_callflow.html",endpoint_row:"tmpl/endpoint_row.html"},subscribe:{"groups.activate":"activate","groups.edit":"edit_groups","callflow.define_callflow_nodes":"define_callflow_nodes","groups.popup_edit":"popup_edit_groups"},validation:[{name:"#name",regex:/^.*/}],resources:{"groups.list":{url:"{api_url}/accounts/{account_id}/groups",contentType:"application/json",verb:"GET"},"groups.get":{url:"{api_url}/accounts/{account_id}/groups/{groups_id}",contentType:"application/json",verb:"GET"},"groups.create":{url:"{api_url}/accounts/{account_id}/groups",contentType:"application/json",verb:"PUT"},"groups.update":{url:"{api_url}/accounts/{account_id}/groups/{groups_id}",contentType:"application/json",verb:"POST"},"groups.delete":{url:"{api_url}/accounts/{account_id}/groups/{groups_id}",contentType:"application/json",verb:"DELETE"},"groups.user_list":{url:"{api_url}/accounts/{account_id}/users",contentType:"application/json",verb:"GET"}}},function(e){var t=this;winkstart.registerResources(t.__whapp,t.config.resources),winkstart.publish("whappnav.subnav.add",{whapp:"voip",module:t.__module,label:_t("groups","groups_label"),icon:"user",weight:"60",category:_t("config","advanced_menu_cat")})},{save_groups:function(e,t,n,r){var i=this,s=i.normalize_data($.extend(!0,{},t.data,e));typeof t.data=="object"&&t.data.id?winkstart.request(!0,"groups.update",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,groups_id:t.data.id,data:s},function(e,t){typeof n=="function"&&n(e,t,"update")},function(e,t){typeof r=="function"&&r(e,t,"update")}):winkstart.request(!0,"groups.create",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,data:s},function(e,t){typeof n=="function"&&n(e,t,"create")},function(e,t){typeof r=="function"&&r(e,t,"update")})},edit_groups:function(e,t,n,r,i){var s=this,o=t||$("#groups-content"),u=n||$("#groups-view",o),r=r||{},a={save_success:r.save_success||function(e){s.render_list(o),s.edit_groups({id:e.data.id},o,u,a)},save_error:r.save_error,delete_success:r.delete_success||function(){u.empty(),s.render_list(o)},delete_error:r.delete_error,after_render:r.after_render},f={data:$.extend(!0,{endpoints:{},music_on_hold:{}},i||{}),field_data:{}};winkstart.parallel({device_list:function(e){winkstart.request(!0,"device.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){f.field_data.devices=t.data,e(null,t)})},user_list:function(e){winkstart.request(!0,"user.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){f.field_data.users=t.data,e(null,t)})},groups_get:function(t){typeof e=="object"&&e.id?winkstart.request(!0,"groups.get",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,groups_id:e.id},function(e,n){t(null,e)}):t(null,{})}},function(t,n){var r=f;typeof e=="object"&&e.id&&(r=$.extend(!0,f,n.groups_get)),r=s.format_data(r),s.render_groups(r,u,a),typeof a.after_render=="function"&&a.after_render()})},delete_groups:function(e,t,n){var r=this;typeof e.data=="object"&&e.data.id&&winkstart.request(!0,"groups.delete",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,groups_id:e.data.id},function(e,n){typeof t=="function"&&t(e,n)},function(e,t){typeof n=="function"&&n(e,t)})},render_groups:function(e,t,n){e._t=function(e){return window.translate.groups[e]};var r=this,i=r.templates.edit.tmpl(e);r.render_endpoint_list(e,i),winkstart.validate.set(r.config.validation,i),winkstart.timezone.populate_dropdown($("#timezone",i),e.data.timezone),$("#tab_users > .rows",i).sortable({handle:".column.first"}),$('*[rel=popover]:not([type="text"])',i).popover({trigger:"hover"}),$('*[rel=popover][type="text"]',i).popover({trigger:"focus"}),winkstart.tabs($(".view-buttons",i),$(".tabs",i)),$(".group-save",i).click(function(t){t.preventDefault(),winkstart.validate.is_valid(r.config.validation,i,function(){var t=form2object("group-form");r.clean_form_data(t,e.field_data),t.endpoints={},$(".rows .row:not(#row_no_data)",i).each(function(e,n){t.endpoints[$(n).dataset("id")]={type:$(n).dataset("type"),weight:e+1}}),delete e.data.resources,delete e.data.endpoints,r.save_groups(t,e,n.save_success,winkstart.error_message.process_error(n.save_error))},function(){winkstart.alert(_t("groups","there_were_errors_on_the_form"))})}),$(".group-delete",i).click(function(t){t.preventDefault(),winkstart.confirm(_t("groups","are_you_sure_you_want_to_delete"),function(){r.delete_groups(e,n.delete_success,n.delete_error)})}),add_user=function(){var t=$("#select_user_id",i);if(t.val()!="empty_option_user"){var n=t.val();$.each(e.field_data.users,function(s,o){if(n===o.id){var u={endpoint_id:n,endpoint_type:"user",endpoint_name:o.first_name+" "+o.last_name};e.data.endpoints.push(u),e.data.endpoints.sort(function(e,t){return e.endpoint_name.toLowerCase()>t.endpoint_name.toLowerCase()}),r.render_endpoint_list(e,i),t.val("empty_option_user")}})}},add_device=function(){var t=$("#select_device_id",i);if(t.val()!="empty_option_device"){var n=t.val();$.each(e.field_data.devices,function(s,o){if(n===o.id){var u={endpoint_id:n,endpoint_type:"device",endpoint_name:o.name};e.data.endpoints.push(u),e.data.endpoints.sort(function(e,t){return e.endpoint_name.toLowerCase()>t.endpoint_name.toLowerCase()}),r.render_endpoint_list(e,i),t.val("empty_option_device")}})}},$("#select_user_id",i).change(function(){add_user()}),$("#select_device_id",i).change(function(){add_device()}),$("#music_on_hold_media_id",i).val()||$("#edit_link_media",i).hide(),$("#music_on_hold_media_id",i).change(function(){$("#music_on_hold_media_id option:selected",i).val()?$("#edit_link_media",i).show():$("#edit_link_media",i).hide()}),$(".inline_action_media",i).click(function(e){var t=$(this).dataset("action")=="edit"?{id:$("#music_on_hold_media_id",i).val()}:{},n=t.id;e.preventDefault(),winkstart.publish("media.popup_edit",t,function(e){n?"id"in e.data?$("#music_on_hold_media_id #"+e.data.id,i).text(e.data.name):($("#music_on_hold_media_id #"+n,i).remove(),$("#edit_link_media",i).hide()):($("#music_on_hold_media_id",i).append('<option id="'+e.data.id+'" value="'+e.data.id+'">'+e.data.name+"</option>"),$("#music_on_hold_media_id",i).val(e.data.id),$("#edit_link_media",i).show())})}),$(i).delegate(".action_endpoint.delete","click",function(){var t=$(this).dataset("id");$("#row_endpoint_"+t,i).remove(),$("#option_endpoint_"+t,i).show(),$(".rows .row",i).size()===0&&$(".rows",i).append(r.templates.endpoint_row.tmpl({_t:function(e){return window.translate.groups[e]}}));var n=[];$.each(e.data.endpoints,function(e,r){r.endpoint_id!==t&&n.push(r)}),e.data.endpoints=n}),t.empty().append(i)},format_data:function(e){var t,n=[];return $.each(e.field_data.users,function(t,r){r.id in e.data.endpoints&&(endpoint_item={endpoint_type:"user",endpoint_id:r.id,endpoint_name:r.first_name+" "+r.last_name,endpoint_weight:e.data.endpoints[r.id].weight||0},n.push(endpoint_item))}),$.each(e.field_data.devices,function(t,r){r.id in e.data.endpoints&&(endpoint_item={endpoint_type:"device",endpoint_id:r.id,endpoint_name:r.name,endpoint_weight:e.data.endpoints[r.id].weight||0},n.push(endpoint_item))}),n.sort(function(e,t){return e.endpoint_weight-t.endpoint_weight}),e.data.endpoints=n,e},normalize_data:function(e){return delete e.users,e},clean_form_data:function(e,t){var n={};"resources"in e&&$.each(e.resources,function(e,r){r!==!1&&(r in t.resources.local?n[r]={type:"local"}:n[r]={type:"global"})}),e.resources=n,delete e.extra},render_list:function(e){var t=this,n=e||$("#groups-content");winkstart.request(!0,"groups.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(e,t){var r=function(e){var t=[];return e.length>0&&$.each(e,function(e,n){t.push({id:n.id,title:n.name||_t("groups","no_name")})}),t.sort(function(e,t){return e.title.toLowerCase()<t.title.toLowerCase()?-1:1}),t};$("#groups-listpanel",n).empty().listpanel({label:_t("groups","groups_label"),identifier:"groups-listview",new_entity_label:_t("groups","add_group_label"),data:r(e.data),publisher:winkstart.publish,notifyMethod:"groups.edit",notifyCreateMethod:"groups.edit",notifyParent:n})})},activate:function(e){var t=this,n=t.templates.groups.tmpl();(e||$("#ws-content")).empty().append(n),t.render_list(n)},render_endpoint_list:function(e,t){var n=this;$(".rows",t).empty(),"endpoints"in e.data&&e.data.endpoints.length>0?(console.log(e.data.endpoints),$.each(e.data.endpoints,function(e,r){$(".rows",t).append(n.templates.endpoint_row.tmpl(r)),$("#option_endpoint_"+r.endpoint_id,t).hide()})):$(".rows",t).empty().append(n.templates.endpoint_row.tmpl({_t:function(e){return window.translate.groups[e]}}))},popup_edit_groups:function(e,t,n){var r,i;i=$('<div class="inline_popup"><div class="inline_content main_content"/></div>'),winkstart.publish("groups.edit",e,i,$(".inline_content",i),{save_success:function(e){r.dialog("close"),typeof t=="function"&&t(e)},delete_success:function(){r.dialog("close"),typeof t=="function"&&t({data:{}})},after_render:function(){r=winkstart.dialog(i,{title:e.id?_t("groups","edit_groups"):_t("groups","create_groups")})}},n)}});