winkstart.module("voip","timeofday",{css:["css/timeofday.css"],templates:{timeofday:"tmpl/timeofday.html",edit:"tmpl/edit.html",timeofday_callflow:"tmpl/timeofday_callflow.html",timeofday_key_dialog:"tmpl/timeofday_key_dialog.html",two_column:"tmpl/two_column.html"},subscribe:{"timeofday.activate":"activate","timeofday.edit":"edit_timeofday","callflow.define_callflow_nodes":"define_callflow_nodes","timeofday.popup_edit":"popup_edit_timeofday"},validation:[{name:"#name",regex:_t("timeofday","name_regex")}],resources:{"timeofday.list":{url:"{api_url}/accounts/{account_id}/temporal_rules",contentType:"application/json",verb:"GET"},"timeofday.get":{url:"{api_url}/accounts/{account_id}/temporal_rules/{timeofday_id}",contentType:"application/json",verb:"GET"},"timeofday.create":{url:"{api_url}/accounts/{account_id}/temporal_rules",contentType:"application/json",verb:"PUT"},"timeofday.update":{url:"{api_url}/accounts/{account_id}/temporal_rules/{timeofday_id}",contentType:"application/json",verb:"POST"},"timeofday.delete":{url:"{api_url}/accounts/{account_id}/temporal_rules/{timeofday_id}",contentType:"application/json",verb:"DELETE"}}},function(e){var t=this;winkstart.registerResources(t.__whapp,t.config.resources),winkstart.publish("whappnav.subnav.add",{whapp:"voip",module:t.__module,label:_t("timeofday","time_of_day_label"),icon:"timeofday",weight:"25",category:_t("config","advanced_menu_cat")})},{save_timeofday:function(e,t,n,r){var i=this,s=i.normalize_data($.extend(!0,{},t.data,e));typeof t.data=="object"&&t.data.id?winkstart.request(!0,"timeofday.update",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,timeofday_id:t.data.id,data:s},function(e,t){typeof n=="function"&&n(e,t,"update")},function(e,t){typeof r=="function"&&r(e,t,"update")}):winkstart.request(!0,"timeofday.create",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,data:s},function(e,t){typeof n=="function"&&n(e,t,"create")},function(e,t){typeof r=="function"&&r(e,t,"create")})},edit_timeofday:function(e,t,n,r,i){var s=this,o=t||$("#timeofday-content"),u=n||$("#timeofday-view",o);r=r||{},callbacks={save_success:r.save_success||function(e){s.render_list(o),s.edit_timeofday({id:e.data.id},o,u,callbacks)},save_error:r.save_error,delete_success:r.delete_success||function(){u.empty(),s.render_list(o)},delete_error:r.delete_error,after_render:r.after_render},defaults={data:$.extend(!0,{time_window_start:32400,time_window_stop:61200,wdays:[],days:[],interval:1},i||{}),field_data:{wdays:[_t("timeofday","sunday"),_t("timeofday","monday"),_t("timeofday","tuesday"),_t("timeofday","wednesday"),_t("timeofday","thursday"),_t("timeofday","friday"),_t("timeofday","saturday")],day:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"],cycle:[{id:"weekly",value:"Weekly"},{id:"monthly",value:"Monthly"},{id:"yearly",value:"Yearly"}],ordinals:[{id:"first",value:"First"},{id:"second",value:"Second"},{id:"third",value:"Third"},{id:"fourth",value:"Fourth"},{id:"fifth",value:"Fifth"},{id:"last",value:"Last"},{id:"every",value:"Day"}],months:[{id:1,value:"January"},{id:2,value:"February"},{id:3,value:"March"},{id:4,value:"April"},{id:5,value:"May"},{id:6,value:"June"},{id:7,value:"July"},{id:8,value:"August"},{id:9,value:"September"},{id:10,value:"October"},{id:11,value:"November"},{id:12,value:"December"}]}},typeof e=="object"&&e.id?winkstart.request(!0,"timeofday.get",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,timeofday_id:e.id},function(e,t){s.migrate_data(e),s.format_data(e),s.render_timeofday($.extend(!0,defaults,e),u,callbacks),typeof callbacks.after_render=="function"&&callbacks.after_render()}):(s.render_timeofday(defaults,u,callbacks),typeof callbacks.after_render=="function"&&callbacks.after_render())},delete_timeofday:function(e,t,n){var r=this;e.data.id&&winkstart.request(!0,"timeofday.delete",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,timeofday_id:e.data.id},function(e,n){typeof t=="function"&&t(e,n)},function(e,t){typeof n=="function"&&n(e,t)})},render_timeofday:function(e,t,n){e._t=function(e){return window.translate.timeofday[e]};var r=this,i,s=r.templates.edit.tmpl(e),o;winkstart.validate.set(r.config.validation,s),$("*[rel=popover]",s).popover({trigger:"focus"}),winkstart.tabs($(".view-buttons",s),$(".tabs",s)),$("#start_date",s).datepicker(),$("#yearly_every",s).hide(),$("#monthly_every",s).hide(),$("#weekly_every",s).hide(),$("#ordinal",s).hide(),$("#days_checkboxes",s).hide(),$("#weekdays",s).hide(),$("#specific_day",s).hide();if(e.data.id==undefined)$("#weekly_every",s).show(),$("#days_checkboxes",s).show();else if(e.data.cycle=="monthly")$("#monthly_every",s).show(),$("#ordinal",s).show(),e.data.days!=undefined&&e.data.days[0]!=undefined?$("#specific_day",s).show():$("#weekdays",s).show();else if(e.data.cycle=="yearly")$("#yearly_every",s).show(),$("#ordinal",s).show(),e.data.days!=undefined&&e.data.days[0]!=undefined?$("#specific_day",s).show():$("#weekdays",s).show();else if(e.data.cycle="weekly")$("#weekly_every",s).show(),$("#days_checkboxes",s).show();$(".fake_checkbox",s).click(function(){$(this).toggleClass("checked")}),$("#ordinal",s).change(function(){$(this).val()=="every"?($("#weekdays",s).hide(),$("#specific_day",s).show()):($("#weekdays",s).show(),$("#specific_day",s).hide())}),$("#cycle",s).change(function(){$("#yearly_every",s).hide(),$("#monthly_every",s).hide(),$("#weekly_every",s).hide(),$("#ordinal",s).hide(),$("#days_checkboxes",s).hide(),$("#weekdays",s).hide(),$("#specific_day",s).hide();switch($(this).val()){case"yearly":$("#yearly_every",s).show(),$("#ordinal",s).show(),$("#ordinal",s).val()=="every"?$("#specific_day",s).show():$("#weekdays",s).show();break;case"monthly":$("#monthly_every",s).show(),$("#ordinal",s).show(),$("#ordinal",s).val()=="every"?$("#specific_day",s).show():$("#weekdays",s).show();break;case"weekly":$("#weekly_every",s).show(),$("#days_checkboxes",s).show()}}),$(".timeofday-save",s).click(function(t){t.preventDefault(),winkstart.validate.is_valid(r.config.validation,s,function(){var t=form2object("timeofday-form");t.wdays=[],e.data.wdays=[],$(".fake_checkbox.checked",s).each(function(){t.wdays.push($(this).dataset("value"))}),t.interval=$("#cycle",s).val()=="monthly"?$("#interval_month",s).val():$("#interval_week",s).val(),t=r.clean_form_data(t),r.save_timeofday(t,e,n.save_success,winkstart.error_message.process_error(n.save_error))},function(){winkstart.alert(_t("timeofday","there_were_errors_on_the_form"))})}),$(".timeofday-delete",s).click(function(t){t.preventDefault(),winkstart.confirm(_t("timeofday","are_you_sure_you_want_to_delete"),function(){r.delete_timeofday(e,n.delete_success,n.delete_error)})}),o=n.after_render,n.after_render=function(){typeof o=="function"&&o(),$("#time",s).slider({from:0,to:86400,step:900,dimension:"",scale:["12:00am","1:00am","2:00am","3:00am","4:00am","5:00am","6:00am","7:00am","8:00am","9:00am","10:00am","11:00am","12:00pm","1:00pm","2:00pm","3:00pm","4:00pm","5:00pm","6:00pm","7:00pm","8:00pm","9:00pm","10:00pm","11:00pm","12:00am"],limits:!1,calculate:function(e){var t=Math.floor(e/3600),n=(e-t*3600)/60,r=t<12?"am":"pm";return t%=12,t==0&&(t=12),t+":"+(n?n:"0"+n)+r},onstatechange:function(){}})},t.empty().append(s)},clean_form_data:function(e){var t=[],n=e.time.split(";");e.cycle!="weekly"&&e.weekday!=undefined&&(e.wdays=[],e.wdays.push(e.weekday)),$.each(e.wdays,function(e,n){n&&(n=="wednesday"&&(n="wensday"),t.push(n))}),t.length>0&&t[0]=="sunday"&&t.push(t.shift()),e.wdays=t;if(e.start_date==="")delete e.start_date;else{var r=new Date(e.start_date),i=r.getFullYear(),s=r.getMonth(),o=r.getDate(),u=new Date(Date.UTC(i,s,o)),a=u.getTime()/1e3+62167219200;e.start_date=a}return e.time_window_start=n[0],e.time_window_stop=n[1],e.month&&(e.month=parseInt(e.month)),e},normalize_data:function(e){return e.cycle=="weekly"?(delete e.ordinal,delete e.days,delete e.month):(e.cycle=="yearly"?delete e.interval:delete e.month,e.ordinal!="every"?delete e.days:delete e.wdays),delete e.time,delete e.weekday,e.enabled==="true"?e.enabled=!0:e.enabled==="false"?e.enabled=!1:delete e.enabled,e},format_data:function(e){var t=new Date;e.data.start_date&&(t=new Date((e.data.start_date-62167219200)*1e3));var n=t.getUTCMonth()+1<10?"0"+(t.getUTCMonth()+1):t.getUTCMonth()+1,r=t.getUTCDate()<10?"0"+t.getUTCDate():t.getUTCDate();return t=n+"/"+r+"/"+t.getUTCFullYear(),e.data.start_date=t,e.data.wdays!=undefined&&e.data.cycle!="weekly"&&(e.data.weekday=e.data.wdays[0]),e},migrate_data:function(e){return"wdays"in e.data&&(wday=$.inArray("wensday",e.data.wdays))>-1&&(e.data.wdays[wday]="wednesday"),e},render_list:function(e){var t=this;winkstart.request(!0,"timeofday.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){var r=function(e){var t=[];return e.length>0&&$.each(e,function(e,n){t.push({id:n.id,title:n.name||_t("timeofday","no_name")})}),t.sort(function(e,t){return e.title.toLowerCase()<t.title.toLowerCase()?-1:1}),t};$("#timeofday-listpanel",e).empty().listpanel({label:_t("timeofday","time_of_day_label"),identifier:"timeofday-listview",new_entity_label:_t("timeofday","add_time_of_day_label"),data:r(t.data),publisher:winkstart.publish,notifyMethod:"timeofday.edit",notifyCreateMethod:"timeofday.edit",notifyParent:e})})},activate:function(e){var t=this,n=t.templates.timeofday.tmpl();(e||$("#ws-content")).empty().append(n),t.render_list(n)},popup_edit_timeofday:function(e,t,n){var r,i;i=$('<div class="inline_popup"><div class="main_content inline_content"/></div>'),winkstart.publish("timeofday.edit",e,i,$(".inline_content",i),{save_success:function(e){r.dialog("close"),typeof t=="function"&&t(e)},delete_success:function(){r.dialog("close"),typeof t=="function"&&t({data:{}})},after_render:function(){r=winkstart.dialog(i,{title:e.id?_t("timeofday","edit_time_of_day"):_t("timeofday","create_time_of_day")})}},n)},define_callflow_nodes:function(e){var t=this;$.extend(e,{"temporal_route[]":{name:_t("timeofday","time_of_day"),icon:"temporal_route",category:_t("config","time_of_day_cat"),module:"temporal_route",data:{},rules:[{type:"quantity",maxSize:"12"}],isUsable:"true",key_caption:function(e,t){var n=e.key;return n==="_"?caption=_t("timeofday","all_other_times"):t.hasOwnProperty(n)?caption=t[n].name:caption="",caption},key_edit:function(e,n){var r=this;winkstart.request(!0,"timeofday.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(r,i){var s,o;r.data.push({id:"_",name:_t("timeofday","all_other_times")}),o=t.templates.timeofday_key_dialog.tmpl({items:winkstart.sort(r.data),selected:e.key,_t:function(e){return window.translate.timeofday[e]}}),$(".inline_action",o).click(function(t){var n=$(this).dataset("action")=="edit"?{id:$("#timeofday_selector",o).val()}:{};t.preventDefault(),winkstart.publish("timeofday.popup_edit",n,function(t){e.key=t.data.id||"null",e.key_caption=t.data.name||"",s.dialog("close")})}),$("#timeofday_selector option:selected",o).val()=="_"&&$("#edit_link",o).hide(),$("#timeofday_selector",o).change(function(){$("#timeofday_selector option:selected",o).val()=="_"?$("#edit_link",o).hide():$("#edit_link",o).show()}),$("#add",o).click(function(){e.key=$("#timeofday_selector",o).val(),e.key_caption=$("#timeofday_selector option:selected",o).text(),s.dialog("close")}),s=winkstart.dialog(o,{title:"Time of Day",minHeight:"0",beforeClose:function(){typeof n=="function"&&n()}})})},caption:function(e,t){return e.getMetadata("timezone")||""},edit:function(e,n){var r,i;i=t.templates.timeofday_callflow.tmpl({_t:function(e){return window.translate.timeofday[e]},items:{},selected:{}}),winkstart.timezone.populate_dropdown($("#timezone_selector",i),e.getMetadata("timezone")),$("#add",i).click(function(){e.setMetadata("timezone",$("#timezone_selector",i).val()),e.caption=$("#timezone_selector option:selected",i).text(),r.dialog("close")}),r=winkstart.dialog(i,{title:_t("timeofday","select_a_timezone_title"),minHeight:"0",beforeClose:function(){typeof n=="function"&&n()}})}},"temporal_route[action=disable]":{name:_t("timeofday","disable_time_of_day"),icon:"temporal_route",category:_t("config","time_of_day_cat"),module:"temporal_route",data:{action:"disable",rules:[]},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",caption:function(e,t){return""},edit:function(e,n){winkstart.request(!0,"timeofday.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(r,i){var s,o,u,a=[],f=[];(u=e.getMetadata("rules"))?$.each(r.data,function(e,t){$.inArray(t.id,u)!=-1?f.push(t):a.push(t)}):a=r.data,o=t.templates.two_column.tmpl({_t:function(e){return window.translate.timeofday[e]},left:{title:_t("timeofday","unselected_time_of_day_rules"),items:a},right:{title:_t("timeofday","selected_time_of_day_rules"),items:f}}),$("#add",o).click(function(){var t=[];$(".right .connect li",o).each(function(){t.push($(this).dataset("id"))}),e.setMetadata("rules",t),s.dialog("close")}),s=winkstart.dialog(o,{title:_t("timeofday","disable_time_of_day_rules_title"),minHeight:"0",beforeClose:function(){typeof n=="function"&&n()}}),$(".scrollable",s).jScrollPane(),$(".connect",s).sortable({connectWith:$(".connect",s),zIndex:2e3,helper:"clone",appendTo:$(".wrapper",s),scroll:!1,receive:function(){$(".scrollable",s).data("jsp").reinitialise()},remove:function(){$(".scrollable",s).data("jsp").reinitialise()}})})}},"temporal_route[action=enable]":{name:_t("timeofday","enable_time_of_day"),icon:"temporal_route",category:_t("config","time_of_day_cat"),module:"temporal_route",data:{action:"enable",rules:[]},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",caption:function(e,t){return""},edit:function(e,n){winkstart.request(!0,"timeofday.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(r,i){var s,o,u,a=[],f=[];(u=e.getMetadata("rules"))?$.each(r.data,function(e,t){$.inArray(t.id,u)!=-1?f.push(t):a.push(t)}):a=r.data,o=t.templates.two_column.tmpl({_t:function(e){return window.translate.timeofday[e]},left:{title:_t("timeofday","unselected_time_of_day_rules"),items:a},right:{title:_t("timeofday","selected_time_of_day_rules"),items:f}}),$("#add",o).click(function(){var t=[];$(".right .connect li",o).each(function(){t.push($(this).dataset("id"))}),e.setMetadata("rules",t),s.dialog("close")}),s=winkstart.dialog(o,{title:_t("timeofday","enable_time_of_day_rules"),minHeight:"0",beforeClose:function(){typeof n=="function"&&n()}}),$(".scrollable",s).jScrollPane(),$(".connect",s).sortable({connectWith:$(".connect",s),zIndex:2e3,helper:"clone",appendTo:$(".wrapper",s),scroll:!1,receive:function(){$(".scrollable",s).data("jsp").reinitialise()},remove:function(){$(".scrollable",s).data("jsp").reinitialise()}})})}},"temporal_route[action=reset]":{name:_t("timeofday","reset_time_of_day"),icon:"temporal_route",category:_t("config","time_of_day_cat"),module:"temporal_route",data:{action:"reset",rules:[]},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",caption:function(e,t){return""},edit:function(e,n){winkstart.request(!0,"timeofday.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(r,i){var s,o,u,a=[],f=[];(u=e.getMetadata("rules"))?$.each(r.data,function(e,t){$.inArray(t.id,u)!=-1?f.push(t):a.push(t)}):a=r.data,o=t.templates.two_column.tmpl({_t:function(e){return window.translate.timeofday[e]},left:{title:_t("timeofday","unselected_time_of_day_rules"),items:a},right:{title:_t("timeofday","selected_time_of_day_rules"),items:f}}),$("#add",o).click(function(){var t=[];$(".right .connect li",o).each(function(){t.push($(this).dataset("id"))}),e.setMetadata("rules",t),s.dialog("close")}),s=winkstart.dialog(o,{title:_t("timeofday","reset_time_of_day_rules"),minHeight:"0",beforeClose:function(){typeof n=="function"&&n()}}),$(".scrollable",s).jScrollPane(),$(".connect",s).sortable({connectWith:$(".connect",s),zIndex:2e3,helper:"clone",appendTo:$(".wrapper",s),scroll:!1,receive:function(){$(".scrollable",s).data("jsp").reinitialise()},remove:function(){$(".scrollable",s).data("jsp").reinitialise()}})})}}})}});