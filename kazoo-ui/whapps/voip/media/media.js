winkstart.module("voip","media",{css:["css/media.css"],templates:{media:"tmpl/media.html",edit:"tmpl/edit.html",media_callflow:"tmpl/media_callflow.html"},subscribe:{"media.activate":"activate","media.edit":"edit_media","callflow.define_callflow_nodes":"define_callflow_nodes","media.popup_edit":"popup_edit_media"},validation:[{name:"#name",regex:/^.+$/}],resources:{"media.list":{url:"{api_url}/accounts/{account_id}/media",contentType:"application/json",verb:"GET"},"media.get":{url:"{api_url}/accounts/{account_id}/media/{media_id}",contentType:"application/json",verb:"GET"},"media.create":{url:"{api_url}/accounts/{account_id}/media",contentType:"application/json",verb:"PUT"},"media.update":{url:"{api_url}/accounts/{account_id}/media/{media_id}",contentType:"application/json",verb:"POST"},"media.delete":{url:"{api_url}/accounts/{account_id}/media/{media_id}",contentType:"application/json",verb:"DELETE"},"media.upload":{url:"{api_url}/accounts/{account_id}/media/{media_id}/raw",contentType:"application/x-base64",verb:"POST"}}},function(e){var t=this;winkstart.registerResources(t.__whapp,t.config.resources),winkstart.publish("whappnav.subnav.add",{whapp:"voip",module:t.__module,label:_t("media","media_label"),icon:"media",weight:"45",category:_t("config","advanced_menu_cat")})},{save_media:function(e,t,n,r){var i=this,s=i.normalize_data($.extend(!0,{},t.data,e));typeof t.data=="object"&&t.data.id?winkstart.request(!0,"media.update",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,media_id:t.data.id,data:s},function(e,t){typeof n=="function"&&n(e,t,"update")},function(e,t){typeof r=="function"&&r(e,t,"update")}):winkstart.request(!0,"media.create",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,data:s},function(e,t){typeof n=="function"&&n(e,t,"create")},function(e,t){typeof r=="function"&&r(e,t,"create")})},edit_media:function(e,t,n,r,i){var s=this,o=t||$("#media-content"),u=n||$("#media-view",o),r=r||{},a={save_success:r.save_success||function(e){s.render_list(o),s.edit_media({id:e.data.id},o,u,a)},save_error:r.save_error,delete_success:r.delete_success||function(){u.empty(),s.render_list(o)},delete_error:r.delete_error,after_render:r.after_render},f={data:$.extend(!0,{streamable:!0},i||{}),auth_token:winkstart.apps.voip.auth_token};typeof e=="object"&&e.id?winkstart.request(!0,"media.get",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,media_id:e.id},function(e,t){s.format_data(e),s.render_media($.extend(!0,f,e),u,a),typeof a.after_render=="function"&&a.after_render()}):(s.render_media(f,u,a),typeof a.after_render=="function"&&a.after_render())},delete_media:function(e,t,n){var r=this;e.data.id&&winkstart.request(!0,"media.delete",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,media_id:e.data.id},function(e,n){typeof t=="function"&&t(e,n)},function(e,t){typeof n=="function"&&n(e,t)})},upload_file:function(e,t,n,r){winkstart.request("media.upload",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,media_id:t,data:e},function(e,t){typeof n=="function"&&n()},winkstart.error_message.process_error(function(e,t){typeof r=="function"&&r()}))},render_media:function(e,t,n){function o(e){var t=e.val();switch(t){case"tts":$(".tts",i).show(),$(".file",i).hide();break;case"upload":$(".tts",i).hide(),$(".file",i).show()}}e._t=function(e){return window.translate.media[e]};var r=this,i=r.templates.edit.tmpl(e),s;winkstart.validate.set(r.config.validation,i),$('*[rel=popover]:not([type="text"])',i).popover({trigger:"hover"}),$('*[rel=popover][type="text"]',i).popover({trigger:"focus"}),winkstart.tabs($(".view-buttons",i),$(".tabs",i)),e.data.id&&$("#upload_div",i).hide(),$("#change_link",i).click(function(e){e.preventDefault(),$("#upload_div",i).show(),$(".player_file",i).hide()}),$("#download_link",i).click(function(t){t.preventDefault(),window.location.href=winkstart.apps.voip.api_url+"/accounts/"+winkstart.apps.voip.account_id+"/media/"+e.data.id+"/raw?auth_token="+winkstart.apps.voip.auth_token}),$("#file",i).bind("change",function(e){var t=e.target.files;if(t.length>0){var n=new FileReader;s="updating",n.onloadend=function(e){var t=e.target.result;s=t},n.readAsDataURL(t[0])}}),o($("#media_type",i)),$("#media_type",i).change(function(){o($(this))}),$(".media-save",i).click(function(t){t.preventDefault(),winkstart.validate.is_valid(r.config.validation,i,function(){var t=form2object("media-form");t=r.clean_form_data(t),r.save_media(t,e,function(o,u){t.tts?typeof n.save_success=="function"&&n.save_success(o,u):$("#upload_div",i).is(":visible")&&$("#file").val()!=""?s==="updating"?winkstart.alert(_t("media","the_file_you_want_to_apply")):r.upload_file(s,o.data.id,function(){typeof n.save_success=="function"&&n.save_success(o,u)},function(){e&&e.data&&e.data.id?r.save_media({},e,function(){typeof n.save_success=="function"&&n.save_success(o,u)},winkstart.error_message.process_error(n.save_error)):r.delete_media(o,n.delete_success,n.delete_error),typeof n.save_error=="function"&&n.save_error(o,u)}):typeof n.save_success=="function"&&n.save_success(o,u)},winkstart.error_message.process_error(n.save_error))},function(){winkstart.alert(_t("media","there_were_errors_on_the_form"))})}),$(".media-delete",i).click(function(t){t.preventDefault(),winkstart.confirm(_t("media","are_you_sure_you_want_to_delete"),function(){r.delete_media(e,n.delete_success,n.delete_error)})}),t.empty().append(i)},clean_form_data:function(e){return e.description=e.upload_media,e.description==""&&delete e.description,e.media_source=="tts"?e.description="tts file":delete e.tts,delete e.media_type,e},format_data:function(e){return e.data.streamable=="false"?e.data.streamable=!1:e.data.streamable=="true"&&(e.data.streamable=!0),e.data.description!=undefined&&e.data.description.substr(0,12)=="C:\\fakepath\\"&&(e.data.description=e.data.description.substr(12)),e},normalize_data:function(e){return delete e.upload_media,"field_data"in e&&delete e.field_data,e.media_source=="upload"&&delete e.tts,e},render_list:function(e){var t=this;winkstart.request(!0,"media.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){var r=function(e){var t=[];return e.length>0&&$.each(e,function(e,n){t.push({id:n.id,title:n.name||_t("media","no_name")})}),t.sort(function(e,t){return e.title.toLowerCase()<t.title.toLowerCase()?-1:1}),t};$("#media-listpanel",e).empty().listpanel({label:_t("media","media_label"),identifier:"media-listview",new_entity_label:_t("media","add_media_label"),data:r(t.data),publisher:winkstart.publish,notifyMethod:"media.edit",notifyCreateMethod:"media.edit",notifyParent:e})})},activate:function(e){var t=this,n=t.templates.media.tmpl();(e||$("#ws-content")).empty().append(n),t.render_list(n)},popup_edit_media:function(e,t,n){var r,i;i=$('<div class="inline_popup"><div class="inline_content main_content"/></div>'),winkstart.publish("media.edit",e,i,$(".inline_content",i),{save_success:function(e){r.dialog("close"),typeof t=="function"&&t(e)},delete_success:function(){r.dialog("close"),typeof t=="function"&&t({data:{}})},after_render:function(){r=winkstart.dialog(i,{title:e.id?_t("media","edit_media"):_t("media","create_media")})}},n)},define_callflow_nodes:function(e){var t=this;$.extend(e,{"play[id=*]":{name:_t("media","play_media"),icon:"play",category:_t("config","basic_cat"),module:"play",tip:_t("media","play_media_tip"),data:{id:"null"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",caption:function(e,t){var n=e.getMetadata("id"),r="";return n in t&&(r=t[n].name),r},edit:function(e,n){var r=this;winkstart.request(!0,"media.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(r,i){var s,o;o=t.templates.media_callflow.tmpl({items:winkstart.sort(r.data),selected:e.getMetadata("id")||"",_t:function(e){return window.translate.media[e]},route_var:e.getMetadata("var")||""}),$("#media_selector option:selected",o).val()==undefined&&$("#edit_link",o).hide(),$(".inline_action",o).click(function(t){var n=$(this).dataset("action")=="edit"?{id:$("#media_selector",o).val()}:{};t.preventDefault(),winkstart.publish("media.popup_edit",n,function(t){e.setMetadata("id",t.data.id||"null"),$("#route_var",o).val().length>0?e.setMetadata("var",$("#route_var",o).val()):e.deleteMetadata("var"),e.caption=t.data.name||"",s.dialog("close")})}),$("#toggle_advanced",o).click(function(){$("#route_var_div",o).toggle()}),$("#add",o).click(function(){e.setMetadata("id",$("#media_selector",o).val()),$("#route_var",o).val().length>0?e.setMetadata("var",$("#route_var",o).val()):e.deleteMetadata("var"),e.caption=$("#media_selector option:selected",o).text(),s.dialog("close")}),s=winkstart.dialog(o,{title:_t("media","media"),minHeight:"0",beforeClose:function(){typeof n=="function"&&n()}})})}}})}});