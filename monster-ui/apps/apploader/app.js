define(["require","jquery","underscore","monster","toastr"],function(e){var a=e("jquery"),i=e("underscore"),n=e("monster"),t=e("toastr"),r={name:"apploader",isMasqueradable:!1,css:["app"],i18n:{"en-US":{customCss:!1},"fr-FR":{customCss:!1},"ru-RU":{customCss:!1}},requests:{},subscribe:{"apploader.show":"render","apploader.hide":"_hide","apploader.toggle":"_toggle","apploader.current":"_currentApp"},load:function(e){var a=this;a.initApp(function(){e&&e(a)})},initApp:function(e){var a=this;a.isMasqueradable=!1,n.pub("auth.initApp",{app:a,callback:e})},_render:function(){},isRendered:function(){return 0!==a("#apploader").length},render:function(){var e=this;e.isRendered()?e.show():e.getUserApps(function(i){var t=a(n.template(e,"app",{allowAppstore:"admin"===n.apps.auth.currentUser.priv_level,defaultApp:i[0],apps:i}));a(".core-absolute").append(t),e.bindEvents(t,i),e.show()})},bindEvents:function(e,r){var s=this,d=(e.find(".app-default"),function(a){var i=r.filter(function(e,i){return a===e.id})[0];e.find(".app-description").find("h4").text(i.label).addBack().find("p").text(i.description)});setTimeout(function(){e.find(".search-query").focus()}),e.find(".app-container").sortable({cancel:".ui-sortable-disabled",receive:function(i,n){var t=a(n.item),r=t.data("id");t.addClass("ui-sortable-disabled"),a.each(e.find(".left-div .app-element"),function(e,i){a(i).data("id")!==r&&a(i).remove()}),d(r),a(n.sender).data("copied",!0)},over:function(){e.find(".left-div .app-element.ui-sortable-disabled").hide()},out:function(){e.find(".left-div .app-element.ui-sortable-disabled").show()}}),e.find(".app-list").sortable({delay:100,appendTo:e.find(".app-container"),connectWith:".app-container",sort:function(){e.find(".app-container").addClass("dragging")},helper:function(e,i){return this.copyHelper=i.clone().css("opacity","0.2").insertAfter(i),a(this).data("copied",!1),i.clone()},stop:function(){var i=a(this).data("copied");a(this.copyHelper).css("opacity","1"),i||this.copyHelper.remove(),this.copyHelper=null,e.find(".app-container").removeClass("dragging")},over:function(a,i){e.find(".right-div .ui-sortable-placeholder").hide()}}),e.find(".search-query").on("keyup",function(){var n=a(this).val().toLowerCase(),t=e.find(".right-div .app-element");i.each(t,function(e){var i=a(e);i.data("search").toLowerCase().indexOf(n)<0?i.hide():i.show()})}),e.find(".search-query").on("blur",function(){a(this).val(""),e.find(".right-div .app-element").show()}),e.find(".right-div").on("mouseenter",".app-element",function(){d(a(this).data("id"))}),e.find(".right-div").on("mouseleave",".app-element",function(){d(e.find(".left-div .app-element").data("id"))}),e.on("click",".right-div .app-element, #launch_appstore, .default-app .app-element",function(){var i=a(this),d=i.data("name");d&&("appstore"!==d&&n.util.isMasquerading()&&n.appsStore[d].masqueradable===!1?t.error(s.i18n.active().noMasqueradingError):(n.routing.goTo("apps/"+d),e.find(".right-div .app-element.active").removeClass("active"),"appstore"!==d&&i.addClass("active"),s.appListUpdate(e,r,function(e){r=e})))}),e.find("#close_app").on("click",function(){s.appListUpdate(e,r,function(a){r=a,s._hide(e)})}),a(document).on("keydown",function(i){if(e.is(":visible")&&27===i.keyCode){var n=a(i.target);n.hasClass("search-query")?n.val(""):s.appListUpdate(e,r,function(a){r=a,s._hide(e)})}})},show:function(){var e=a("#apploader");e.hasClass("active")||(n.pub("myaccount.hide"),e.addClass("active").fadeIn(250,function(){a("#monster-content").hide()}))},_hide:function(){var e=a("#apploader");e.hasClass("active")&&(a("#monster-content").show(),e.removeClass("active").fadeOut(250,function(){if(a!==e.find(".right-div .app-element").first().data("id")){var a=e.find(".left-div .app-element").data("id");e.find(".right-div .app-list").prepend(e.find('.right-div .app-element[data-id="'+a+'"]'))}}))},_toggle:function(){var e=this;if(e.isRendered()){var i=a("#apploader");i.hasClass("active")?e._hide(i):(e.show(i),i.find(".search-query").focus())}else e.render()},_currentApp:function(e){var i=this,n=a("#apploader"),t=n.find(".right-div .app-element.active"),r={};t.length?(r={id:t.data("id"),name:t.data("name")},e&&e(r)):i.getUserApps(function(a){r={id:a[0].id,name:a[0].name},e&&e(r)})},getFullAppList:function(e){var a=this,t={};i.each(n.apps.auth.installedApps,function(e){t[e.id]=function(i){e.icon=a.apiUrl+"accounts/"+a.accountId+"/apps_store/"+e.id+"/icon?auth_token="+a.authToken,i&&i(null,e)}}),n.parallel(t,function(a,i){e&&e(i)})},getUserApps:function(e){var a=this;a.callApi({resource:"appsStore.list",data:{accountId:a.accountId},success:function(t,r){var s={},d=n.config.whitelabel.language,p=d.substr(0,3).concat(d.substr(d.length-2,2).toUpperCase());i.each(t.data,function(e){var i=e.i18n.hasOwnProperty(p)?p:"en-US";e.description=e.i18n[i].description,e.label=e.i18n[i].label,s[e.id]=function(i){e.icon=a.apiUrl+"accounts/"+a.accountId+"/apps_store/"+e.id+"/icon?auth_token="+a.authToken,i&&i(null,e)}}),n.parallel(s,function(t,r){var s=r,d=n.apps.auth.currentUser,p=d.appList||[],o=!1,c=[],u=function(e){if(e){var a=i.map(e.users||[],function(e){return e.id});if(e&&e.allowed_users&&("all"===e.allowed_users||"admins"===e.allowed_users&&"admin"===d.priv_level||"specific"===e.allowed_users&&a.indexOf(d.id)>=0))return!0}return!1};p=i.filter(p,function(e){var a=s[e];return u(a)?(c.push({id:a.id,name:a.name,icon:a.icon,label:a.label,description:a.description}),!0):(o=!0,!1)}),i.each(s,function(e){-1===p.indexOf(e.id)&&u(e)&&(c.push({id:e.id,name:e.name,icon:e.icon,label:e.label,description:e.description}),p.push(e.id),o=!0)}),o&&(n.apps.auth.currentUser.appList=p,a.userUpdate()),e&&e(c)})}})},appListUpdate:function(e,i,t){var r=this,s=a.map(e.find(".right-div .app-element"),function(e){return a(e).data("id")}),d=i.every(function(e,a){return e.id===s[a]}),p=e.find(".left-div .app-element").data("id"),o=i.length?i[0].id===p:void 0===p;if(o&&d)t(i);else{var c=[];s.unshift(s.splice(s.indexOf(p),1)[0]),i.forEach(function(e,a){c[s.indexOf(e.id)]=e}),n.apps.auth.currentUser.appList=s,n.apps.auth.defaultApp=c[0].name,r.userUpdate(t(c))}},userUpdate:function(e){var a=this;a.callApi({resource:"user.update",data:{accountId:a.accountId,userId:a.userId,data:n.apps.auth.currentUser},success:function(a,i){e&&e()}})}};return r});