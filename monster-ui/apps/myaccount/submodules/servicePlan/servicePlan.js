define(["require","jquery","underscore","monster"],function(e){var n=e("jquery"),t=(e("underscore"),e("monster")),a={requests:{},subscribe:{"myaccount.servicePlan.renderContent":"_servicePlanRenderContent"},_servicePlanRenderContent:function(e){var a=this,r={hasServicePlan:!1,hasSubscriptions:!1,totalAmount:0,servicePlanArray:[]},c=r;t.parallel({servicePlan:function(e){a.servicePlanGet(function(r){var i,o=[],u=0;c.hasServicePlan=!0,"items"in r.data&&n.each(r.data.items,function(e,r){n.each(r,function(e,n){var r=n.single_discount_rate+n.cumulative_discount_rate*n.cumulative_discount,c=parseFloat(n.rate*n.quantity-r||0);c>0&&(i=a.i18n.active().servicePlan.titles.hasOwnProperty(e)?a.i18n.active().servicePlan.titles[e]:t.util.formatVariableToDisplay(e),o.push({service:i,rate:n.rate||0,quantity:n.quantity||0,discount:r>0?"-"+a.i18n.active().currencyUsed+t.util.formatPrice(r,2):"",monthlyCharges:c}),u+=c)})});var s=function(e,n){return parseFloat(e.monthlyCharges)>=parseFloat(n.monthlyCharges)?-1:1};o.sort(s),c.servicePlanArray=o,c.totalAmount=u,e(null,r)},function(n){e(null,{})})},subscription:function(e){a.servicePlanGetSubscription(function(n){c.hasSubscriptions=!0,c.dueDate="?",n.data.length>0&&n.data.forEach(function(e){return"Active"===e.status?(c.dueDate=t.util.toFriendlyDate(e.next_bill_date,"short"),!1):void 0}),e(null,n)},function(n){e(null,{})})}},function(r,i){var o=n(t.template(a,"servicePlan-layout",c));a.servicePlanBindEvents(o),t.pub("myaccount.renderSubmodule",o),"function"==typeof e.callback&&e.callback(o)})},servicePlanCleanFormData:function(e,n){return delete n.extra,n},servicePlanBindEvents:function(e){var n=this;t.ui.tooltips(e),e.find(".action-number#download").on("click",function(){window.location.href=n.apiUrl+"accounts/"+n.accountId+"/service_plans/current?depth=4&identifier=items&accept=csv&auth_token="+n.authToken})},servicePlanDownloadCsv:function(e,n){var t=this;t.callApi({resource:"servicePlan.getCsv",data:{accountId:t.accountId},success:function(n,t){e&&e(n,t)},error:function(e,t){n&&n(e,t)}})},servicePlanGet:function(e,n){var t=this;t.callApi({resource:"servicePlan.listCurrent",data:{accountId:t.accountId,generateError:!1},success:function(n,t){e&&e(n,t)},error:function(e,t){n&&n(e,t)}})},servicePlanGetSubscription:function(e,n){var t=this;t.callApi({resource:"balance.getSubscriptions",data:{accountId:t.accountId,generateError:!1},success:function(n,t){e&&e(n,t)},error:function(e,t){n&&n(e,t)}})}};return a});