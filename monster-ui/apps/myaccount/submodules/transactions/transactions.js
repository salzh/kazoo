define(["require","jquery","underscore","toastr","monster"],function(t){var n=t("jquery"),a=(t("underscore"),t("toastr"),t("monster")),e={requests:{},subscribe:{"myaccount.transactions.renderContent":"_transactionsRenderContent"},transactionsRange:"monthly",_transactionsRenderContent:function(t){var e=this;e.listTransactions(function(i){var r=n(a.template(e,"transactions-layout",i)),o=a.template(e,"transactions-list",i),s={container:r,range:e.transactionsRange};r.find(".list-transactions").append(o),a.ui.initRangeDatepicker(s),e.transactionsBindEvents(r),a.pub("myaccount.renderSubmodule",r),"function"==typeof t.callback&&t.callback(r)})},transactionsFormatData:function(t){return t.amount=parseFloat(t.amount).toFixed(2),t.listTransactions.sort(function(t,n){return t.created<n.created?1:-1}),t},transactionsBindEvents:function(t,e){var i=this;t.find(".expandable").hide(),t.on("click",".expand-box:not(.disabled)",function(){var t=n(this),a=t.parents(".transaction-box"),e=a.first().find(".expandable");t.find(".fa-stack-content").toggleClass("fa-plus fa-minus"),a.toggleClass("open"),e.slideToggle("fast")}),t.find("#filter_transactions").on("click",function(){var n=a.util.parseDateString(t.find("#startDate").val()),e=a.util.parseDateString(t.find("#endDate").val());i.listTransactions(n,e,function(n){var e=t.find(".list-transactions").empty();e.append(a.template(i,"transactions-list",n)),t.find(".expandable").hide(),t.find(".start-date .value").html(n.billingStartDate),t.find(".end-date .value").html(n.billingEndDate),t.find(".total-amount .value").html(i.i18n.active().currencyUsed+n.amount)})})},listTransactions:function(t,e,i){var r=this;if("function"==typeof t){i=t;var o=a.util.getDefaultRangeDates(r.balanceRange);t=o.from,e=o.to}t=a.util.dateToBeginningOfGregorianDay(t),e=a.util.dateToEndOfGregorianDay(e);var s={amount:0,billingStartDate:a.util.toFriendlyDate(t,"short"),billingEndDate:a.util.toFriendlyDate(e,"short")};a.parallel({charges:function(i){r.transactionsGetCharges(t,e,function(t){var e=[];n.each(t.data,function(t,n){4e3!==n.code&&(n=a.util.formatTransaction(n,r),e.push(n),n.approved&&("credit"===n.type?s.amount-=parseFloat(n.amount):s.amount+=parseFloat(n.amount)))}),i(null,e)})}},function(t,n){var a=s;a.listTransactions=n.charges,a=r.transactionsFormatData(a),i(a)})},transactionsGetCharges:function(t,n,a,e){var i=this;i.callApi({resource:"balance.getCharges",data:{accountId:i.accountId,from:t,to:n,reason:"no_calls"},success:function(t,n){a&&a(t,n)},error:function(t,n){e&&e(t,n)}})}};return e});