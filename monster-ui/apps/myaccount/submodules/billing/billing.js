define(["require","jquery","underscore","monster","card"],function(n){var i=n("jquery"),e=n("underscore"),t=n("monster"),c=(n("card"),{subscribe:{"myaccount.billing.renderContent":"_billingRenderContent"},_billingRenderContent:function(n){var e=this;t.parallel({account:function(n){e.callApi({resource:"account.get",data:{accountId:e.accountId},success:function(i,e){n(null,i.data)}})},billing:function(n){e.callApi({resource:"billing.get",data:{accountId:e.accountId,generateError:!1},success:function(i,e){n(null,i.data)},error:function(i,e){n(null,{})}})}},function(c,r){e.billingFormatData(r,function(c){var r=i(t.template(e,"billing-layout",c));e.billingBindEvents(r,c),t.pub("myaccount.renderSubmodule",r),r.find("#form_credit_card").card({container:".credit-card-container",nameInput:"#first_name, #last_name",numberInput:"#credit_card_number",expiryInput:"#expiration_date_month, #expiration_date_year",cvcInput:"#security_code",values:{number:"•••• •••• •••• "+(c.billing.credit_card.last_four||"••••")}}),"function"==typeof n.callback&&n.callback(r)})})},billingFormatData:function(n,i){e.isEmpty(n.billing)||(n.billing.credit_card=n.billing.credit_cards[0]||{},n.billing.credit_card.last_four&&(n.billing.credit_card.fake_number="************"+n.billing.credit_card.last_four,n.billing.credit_card.fake_cvv="***",n.billing.credit_card.type=n.billing.credit_card.card_type.toLowerCase())),i(n)},billingBindEvents:function(n,e){var c=function(n){var i=new RegExp("^4[0-9]{12}(?:[0-9]{3})?$"),e=new RegExp("^5[1-5][0-9]{14}$"),t=new RegExp("^3[47][0-9]{13}$"),c=new RegExp("^6(?:011|5[0-9]{2})[0-9]{12}$");return i.test(n)?"visa":e.test(n)?"mastercard":t.test(n)?"amex":c.test(n)?"discover":!1},r=function(i){var e=c(i);e===!1?(n.find(".edition .card-type").hide(),n.find(".add-on i").show()):n.find(".card-type."+e).is(":visible")||(n.find(".edition .card-type").hide(),n.find(".add-on i").hide(),n.find(".edition .card-type."+e).css("display","inline-block"))};n.find(".edit-credit-card").on("click",function(i){i.preventDefault(),n.find(".edition").show(),n.find(".uneditable").hide(),r("")}),n.find("#credit_card_number").on("keyup",function(n){r(i(this).val())}),n.find("#credit_card_number").on("paste",function(n){var e=i(this);setTimeout(function(){r(e.val())},0)}),n.find('.settings-item[data-name="credit_card"] .settings-link').on("click",function(){var n=i(this).parents(".settings-item");n.hasClass("open")||n.find("input").keyup()}),t.pub("myaccount.events",{template:n,data:e})}});return c});