define(["require","jquery","underscore","monster","toastr","mousetrap"],function(t){var e=t("jquery"),n=t("underscore"),a=t("monster"),o=t("toastr"),i=(t("mousetrap"),{name:"core",css:["app"],i18n:{"en-US":{customCss:!1},"fr-FR":{customCss:!1},"ru-RU":{customCss:!1}},requests:{},subscribe:{"core.loadApps":"_loadApps","core.showAppName":"showAppName","core.triggerMasquerading":"triggerMasquerading","core.restoreMasquerading":"restoreMasquerading","core.initializeShortcuts":"initializeShortcuts"},_baseApps:["apploader","appstore","myaccount","common"],_defaultApp:"appstore",spinner:{requestAmount:0,active:!1},load:function(t){var e=this;e.callApi({resource:"whitelabel.getByDomain",data:{domain:window.location.hostname,generateError:!1},success:function(n){t(e)},error:function(n){t(e)}})},render:function(t){var n=this,o=e(a.template(n,"app",{hidePowered:a.config.whitelabel.hide_powered}));document.title=a.config.whitelabel.applicationTitle,n.bindEvents(o),n.displayVersion(o),n.displayLogo(o),n.displayFavicon(),t.append(o),n.loadAuth()},loadAuth:function(){a.apps.load("auth",function(t){t.render(e("#monster-content"))})},showAppName:function(t){var o,i=this,c=e(".core-topbar"),r=c.find("#main_topbar_current_app");if("myaccount"===t){var u={name:t,label:i.i18n.active().controlCenter};if(r.is(":empty"))r.append(a.template(i,"current-app",u)),c.find("#main_topbar_current_app_name").data("originalName","appstore"),c.find("#main_topbar_current_app_name").fadeIn(100);else{var p=c.find("#main_topbar_current_app_name").data("name");c.find("#main_topbar_current_app_name").fadeOut(100,function(){r.empty().append(a.template(i,"current-app",u)),c.find("#main_topbar_current_app_name").data("originalName",p),c.find("#main_topbar_current_app_name").fadeIn(100)})}}else n.each(a.apps.auth.installedApps,function(e){e.name===t&&(o=e,o.icon=i.apiUrl+"accounts/"+a.apps.auth.currentAccount.id+"/apps_store/"+e.id+"/icon?auth_token="+i.authToken)}),"appstore"===t?r.empty():r.is(":empty")?(r.append(a.template(i,"current-app",o)),c.find("#main_topbar_current_app_name").fadeIn(100)):c.find("#main_topbar_current_app_name").fadeOut(100,function(){r.empty().append(a.template(i,"current-app",o)),c.find("#main_topbar_current_app_name").fadeIn(100)})},_loadApps:function(t){var n=this;if(n._baseApps.length){var o=n._baseApps.pop();a.apps.load(o,function(e){n._loadApps(t)})}else{var i="admin"===a.apps.auth.currentUser.priv_level?t.defaultApp||n._defaultApp:t.defaultApp;a.routing.parseHash(),a.routing.hasMatch()||("undefined"!=typeof i?a.apps.load(i,function(t){n.showAppName(i),t.render(e("#monster-content"))},{},!0):console.warn("Current user doesn't have a default app"))}},bindEvents:function(t){var n=this,o=t.find(".loading-wrapper");window.onerror=function(t,e,n,o,i){a.error("js",{message:t,fileName:e,lineNumber:n,columnNumber:o||"",error:i||{}})},a.sub("monster.requestStart",function(){n.onRequestStart(o)}),a.sub("monster.requestEnd",function(){n.onRequestEnd(o)}),t.find("#main_topbar_apploader_link").on("click",function(t){t.preventDefault(),a.pub("apploader.toggle")}),t.find("#main_topbar_account_toggle_link").on("click",function(t){t.preventDefault(),n.toggleAccountToggle()}),t.find("#main_topbar_account_toggle").on("click",".home-account-link",function(){n.restoreMasquerading({callback:function(){var t=a.apps.getActiveApp();t in a.apps&&a.apps[t].render(),n.hideAccountToggle()}})}),t.find("#main_topbar_signout_link").on("click",function(){a.pub("auth.clickLogout")}),t.find("#main_topbar_current_app").on("click",function(){var t=e(this).find("#main_topbar_current_app_name").data("name");"myaccount"===t?a.apps.load(t,function(t){t.renderDropdown(!1)}):a.apps.load(t,function(t){t.render()})}),t.find("#main_topbar_brand").on("click",function(){var t=a.apps.auth.defaultApp;t&&(a.pub("myaccount.hide"),a.apps.load(t,function(e){n.showAppName(t),e.render()}))}),e("body").on("click",'*[class*="monster-button"]:not(.disabled)',function(t){var n=e(this),a=e('<div class="monster-splash-effect"/>'),o=n.offset(),i=t.pageX-o.left,c=t.pageY-o.top;a.css({height:n.height(),width:n.height(),top:c-a.height()/2,left:i-a.width()/2}).appendTo(n),window.setTimeout(function(){a.remove()},1500)}),a.config.whitelabel.hasOwnProperty("nav")&&a.config.whitelabel.nav.hasOwnProperty("logout")&&a.config.whitelabel.nav.logout.length>0&&t.find("#main_topbar_signout_link").unbind("click").attr("href",a.config.whitelabel.nav.logout),t.find('[data-toggle="tooltip"]').tooltip()},hideAccountToggle:function(){e("#main_topbar_account_toggle_container .account-toggle-content").empty(),e("#main_topbar_account_toggle_container .current-account-container").empty(),e("#main_topbar_account_toggle").removeClass("open")},showAccountToggle:function(){var t=this,n=e("#main_topbar_account_toggle_container");a.pub("common.accountBrowser.render",{container:n.find(".account-toggle-content"),customClass:"ab-dropdown",addBackButton:!0,allowBackOnMasquerading:!0,onSearch:function(e){if(e){var o=a.template(t,"accountToggle-search",{searchValue:e});n.find(".current-account-container").html(o)}else n.find(".current-account-container").html(a.apps.auth.currentAccount.name)},onAccountClick:function(e,n){t.callApi({resource:"account.get",data:{accountId:e},success:function(e,n){t.triggerMasquerading({account:e.data,callback:function(){var e=a.apps.getActiveApp();e in a.apps&&(a.apps[e].isMasqueradable?a.apps[e].render():(o.warning(t.i18n.active().noMasqueradingAllowed),a.apps.apploader.render())),t.hideAccountToggle()}})}})},onChildrenClick:function(t){n.find(".current-account-container").html(t.parentName)},onBackToParentClick:function(t){n.find(".current-account-container").html(t.parentName)},callback:function(t){n.find(".current-account-container").html(a.apps.auth.currentAccount.name)}}),e("#main_topbar_account_toggle").addClass("open")},toggleAccountToggle:function(){var t=this;e("#main_topbar_account_toggle").hasClass("open")?t.hideAccountToggle():t.showAccountToggle()},triggerMasquerading:function(t){var n=this,i=t.account,c=t.callback,r=function(t){a.apps.auth.currentAccount=e.extend(!0,{},t),n.updateApps(t.id),a.pub("myaccount.renderNavLinks",{name:t.name,isMasquerading:!0}),e("#main_topbar_account_toggle").addClass("masquerading"),o.info(a.template(n,"!"+n.i18n.active().triggerMasquerading,{accountName:t.name})),a.pub("core.changedAccount"),c&&c()};t.account.id===a.apps.auth.originalAccount.id?n.restoreMasquerading({callback:c}):t.account.hasOwnProperty("name")?r(t.account):n.callApi({resource:"account.get",data:{accountId:i.id,generateError:!1},success:function(t,e){i=t.data,r(i)},error:function(){c&&c()}})},updateApps:function(t){e.each(a.apps,function(e,n){(n.hasOwnProperty("isMasqueradable")?n.isMasqueradable:!0)&&(n.accountId=t)})},restoreMasquerading:function(t){var n=this,i=t.callback;a.apps.auth.currentAccount=e.extend(!0,{},a.apps.auth.originalAccount),n.updateApps(a.apps.auth.originalAccount.id),a.pub("myaccount.renderNavLinks"),e("#main_topbar_account_toggle").removeClass("masquerading"),o.info(n.i18n.active().restoreMasquerading),a.pub("core.changedAccount"),i&&i()},displayVersion:function(t){a.getVersion(function(e){t.find(".core-footer .tag-version").html("("+e+")"),a.config.version=e})},displayLogo:function(t){var e=this,n=window.location.hostname,o=a.config.api["default"];e.callApi({resource:"whitelabel.getLogoByDomain",data:{domain:n,generateError:!1,dataType:"*"},success:function(e){t.find("#main_topbar_brand").css("background-image","url("+o+"whitelabel/"+n+"/logo?_="+(new Date).getTime()+")")},error:function(e){t.find("#main_topbar_brand").css("background-image",'url("apps/core/style/static/images/logo.png")')}})},displayFavicon:function(){var t=this,e=window.location.hostname,n=a.config.api["default"],o=function(t){var e=document.createElement("link"),n=document.getElementById("dynamicFavicon");e.id="dynamicFavicon",e.rel="shortcut icon",e.href=t,n&&document.head.removeChild(n),document.head.appendChild(e)};t.callApi({resource:"whitelabel.getIconByDomain",data:{domain:e,generateError:!1,dataType:"*"},success:function(t){var a=n+"whitelabel/"+e+"/icon?_="+(new Date).getTime();o(a)},error:function(t){var e="apps/core/style/static/images/favicon.png";o(e)}})},onRequestStart:function(t){var e=this,n=250;e.spinner.requestAmount++,clearTimeout(e.spinner.endTimeout),e.spinner.startTimeout=setTimeout(function(){0!==e.spinner.requestAmount&&e.spinner.active===!1&&(e.spinner.active=!0,t.addClass("active"),clearTimeout(e.spinner.startTimeout))},n)},onRequestEnd:function(t){var e=this,n=50;e.spinner.requestAmount--,0===e.spinner.requestAmount&&(e.spinner.endTimeout=setTimeout(function(){0===e.spinner.requestAmount&&e.spinner.active===!0&&(t.removeClass("active"),e.spinner.active=!1,clearTimeout(e.spinner.startTimeout),clearTimeout(e.spinner.endTimeout))},n))},initializeShortcuts:function(t){var e=this,o=[{category:"general",key:"?",title:e.i18n.active().globalShortcuts.keys["?"].title,callback:function(){e.showShortcutsPopup()}},{category:"general",key:"@",title:e.i18n.active().globalShortcuts.keys["@"].title,callback:function(){a.pub("myaccount.renderDropdown")}},{category:"general",key:"#",title:e.i18n.active().globalShortcuts.keys["#"].title,callback:function(){a.pub("apploader.toggle")}},{category:"general",key:"a",title:e.i18n.active().globalShortcuts.keys.a.title,callback:function(){e.toggleAccountToggle()}},{category:"general",key:"shift+m",title:e.i18n.active().globalShortcuts.keys["shift+m"].title,callback:function(){e.restoreMasquerading({callback:function(){var t=a.apps.getActiveApp();t in a.apps&&a.apps[t].render(),e.hideAccountToggle()}})}},{category:"general",key:"d",title:e.i18n.active().globalShortcuts.keys.d.title,callback:function(){e.showDebugPopup()}},{category:"general",key:"r",title:e.i18n.active().globalShortcuts.keys.r.title,callback:function(){a.routing.goTo("apps/"+a.apps.getActiveApp())}},{category:"general",key:"shift+l",title:e.i18n.active().globalShortcuts.keys["shift+l"].title,callback:function(){a.pub("auth.logout")}}];n.each(o,function(t){a.ui.addShortcut(t)}),e.addShortcutsGoToApps(t)},showDebugPopup:function(){var t=this,e=a.apps.auth.currentAccount,n={account:e,authToken:t.authToken,apiUrl:t.apiUrl};template=a.template(t,"dialog-accountInfo",n),a.ui.dialog(template,{title:t.i18n.active().debugAccountDialog.title})},showShortcutsPopup:function(){if(!e(".shortcuts-dialog").length){var t=this,n=a.ui.getShortcuts(),o=a.template(t,"shortcuts",{categories:n});a.ui.dialog(o,{title:t.i18n.active().globalShortcuts.popupTitle,width:700})}},addShortcutsGoToApps:function(t){var e,o={voip:"shift+v",accounts:"shift+a",callflows:"shift+c",branding:"shift+b",provisioner:"shift+p"};n.each(t,function(t){e={},o.hasOwnProperty(t.name)&&(e={key:o[t.name],callback:function(){a.routing.goTo("apps/"+t.name)},category:"apps",title:t.label},a.ui.addShortcut(e))})}});return i});
