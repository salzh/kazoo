define(["require","jquery","underscore","monster","toastr"],function(e){var o=e("jquery"),t=e("underscore"),n=e("monster"),a=e("toastr"),i={name:"webhooks",css:["app"],i18n:{"en-US":{customCss:!1},"ru-RU":{customCss:!1},"es-ES":{customCss:!1}},requests:{},subscribe:{},load:function(e){var o=this;o.initApp(function(){e&&e(o)})},initApp:function(e){var o=this;n.pub("auth.initApp",{app:o,callback:e})},render:function(e){var a=this,e=e||{},i=e.container,r=e.webhookId||"";a.getWebhooks(function(e){var s=a.formatWebhooksData(e),c=o(n.template(a,"webhooks-layout",s)),u=t.isEmpty(i)?o("#monster-content"):i;if(a.bindEvents(c),u.empty().append(c),r){var d=u.find(".grid-row[data-id="+r+"]");n.ui.highlight(d)}})},formatWebhooksData:function(e){var o={isEmpty:0===e.length,groupedWebhooks:[],ungroupedWebhooks:[],counters:t.countBy(e,function(e){return e.enabled?"active":e.disable_reason?"error":"disabled"})},a={};return t.each(e,function(e){e.group?(a.hasOwnProperty(e.group)||(a[e.group]={groupName:e.group,webhooks:[]}),a[e.group].webhooks.push(e)):o.ungroupedWebhooks.push(e)}),o.groupedWebhooks=t.map(a,function(e,o){return n.util.sort(e.webhooks,"name"),e}),n.util.sort(o.ungroupedWebhooks,"name"),n.util.sort(o.groupedWebhooks,"groupName"),o},bindEvents:function(e){var i=this;setTimeout(function(){e.find(".search-query").focus()}),n.ui.tooltips(e),e.find(".new-webhook").on("click",function(o){i.renderWebhookEdit(e)}),e.find(".reenable-button").on("click",function(){i.enableAllWebhooks(function(){i.render()})}),e.find(".edit").on("click",function(t){var n=o(this).data("id");i.renderWebhookEdit(e,n)}),e.find(".history").on("click",function(t){var n=o(this).parents(".grid-row");i.renderAttemptsHistory(e,n.data("id"),n.hasClass("error"))}),e.find(".delete").on("click",function(e){o(this).parents(".grid-row").find(".grid-row-delete").fadeIn()}),e.find(".confirm-delete").on("click",function(e){var t=o(this).parents(".grid-row").data("id");i.deleteWebhook(t,function(e){i.render(),a.success(n.template(i,"!"+i.i18n.active().webhooks.toastr.deleteSuccess+e.name))})}),e.find(".cancel-delete").on("click",function(e){o(this).parents(".grid-row-delete").fadeOut()}),e.find(".search-query").on("keyup",function(){var n=o(this).val().toLowerCase(),a=e.find(".webhooks-grid .grid-row:not(.title)"),i=e.find(".webhooks-grid .empty-search-row").toggleClass(".show");t.each(a,function(e){var t=o(e),a=t.parents(".grid-row-group");t.data("search").toLowerCase().indexOf(n)<0?(t.hide(),a.length>0&&0===a.find(".grid-row:not(.title):visible").length&&a.hide()):(t.show(),a.length>0&&a.show())}),a.size()>0&&(a.is(":visible")?i.hide():i.show())}),e.find(".webhook-toggle").on("change",function(){var t=o(this),n=t.data("id"),a=t.is(":checked");i.getWebhookDetails(n,function(o){o.enabled=a,i.updateWebhook(n,o,function(){var o=e.find(".counter-active .count"),n=e.find(".counter-disabled .count");e.find(".counter-errors .count");a?(o.html(parseInt(o.html())+1),n.html(parseInt(n.html())-1)):(n.html(parseInt(n.html())+1),o.html(parseInt(o.html())-1)),t.parents(".grid-row").toggleClass("disabled")})})})},renderWebhookEdit:function(e,a){var i=this,r=function(e,o){n.parallel({webhookList:function(e){i.getAvailableWebhooks(function(o){e&&e(null,o)})},webhookDetails:function(o){e?i.getWebhookDetails(e,function(e){o&&o(null,e)}):o&&o(null,{})}},function(e,t){o&&o(t)})};r(a,function(a){var r=i.i18n.active().webhooks.webhookList,s=n.util.sort(t.map(a.webhookList,function(e){return{id:e.id,name:e.id in r?r[e.id].name:e.name,description:e.id in r?r[e.id].description:e.description}})).concat({id:"all",name:r.all.name,description:r.all.description}),c=o(n.template(i,"webhooks-edit",{webhookList:s,webhook:a.webhookDetails,groups:Object.keys(i.uiFlags.account.get("groups")||{}).sort()}));a.webhookDetails.custom_data&&t.each(a.webhookDetails.custom_data,function(e,o){var t=n.template(i,"webhooks-customDataRow",{key:o,value:e});c.find(".custom-data-container").append(t)}),n.ui.validate(c.find("#webhook_edition_form"),{rules:{uri:{url:!0}}}),i.bindWebhookEditEvents(c,a.webhookDetails),e.find(".webhooks-container").empty().append(c)})},bindWebhookEditEvents:function(e,i){var r=this,s=r.uiFlags.account.get("groups")||{};e.find(".select-group").on("change",function(){"new"===o(this).val()?e.find(".new-group-container").show():e.find(".new-group-container").hide()}),e.find(".custom-data-link").on("click",function(){e.find(".custom-data-container").append(n.template(r,"webhooks-customDataRow"))}),e.find(".custom-data-container").on("click",".delete-custom-data",function(){o(this).parent().remove()}),e.find(".action-bar .cancel").on("click",function(){r.render()}),e.find(".action-bar .save").on("click",function(){n.ui.valid(e.find("#webhook_edition_form"))&&r.getFormData(e,function(e){t.isEmpty(i)?r.addWebhook(e,function(o){e.group?(s[e.group]=(s[e.group]||0)+1,r.updateWebhookGroups(s,function(){r.render({webhookId:o.id})})):r.render({webhookId:o.id}),a.success(n.template(r,"!"+r.i18n.active().webhooks.toastr.addSuccess+o.name))}):r.updateWebhook(i.id,e,function(o){e.group&&(e.group!==i.group?(s[e.group]=(s[e.group]||0)+1,s[i.group]=(s[i.group]||0)-1,s[i.group]<=0&&delete s[i.group],r.updateWebhookGroups(s,function(){r.render({webhookId:o.id})})):r.render({webhookId:o.id})),i.group?(s[i.group]=(s[i.group]||0)-1,s[i.group]<=0&&delete s[i.group],r.updateWebhookGroups(s,function(){r.render({webhookId:o.id})})):r.render({webhookId:o.id}),a.success(n.template(r,"!"+r.i18n.active().webhooks.toastr.editSuccess+o.name))})})})},renderAttemptsHistory:function(e,t,a){var i=this;n.parallel({webhook:function(e){i.getWebhookDetails(t,function(o){e&&e(null,o)})},attempts:function(e){i.getWebhookHistory(t,function(o){e&&e(null,o)})}},function(t,r){var s=i.formatAttemptsHistoryData(r,a),c=o(n.template(i,"webhooks-attempts",s));i.bindAttemptsHistoryEvents(c,r.webhook),e.find(".webhooks-container").empty().append(c)})},formatAttemptsHistoryData:function(e,o){var a=this,i={name:e.webhook.name?n.template(a,"!"+a.i18n.active().webhooks.webhookAttempts.header,{webhookName:e.webhook.name}):"",url:e.webhook.uri,isError:o};return i.attempts=t.map(e.attempts,function(o){var t=n.util.toFriendlyDate(o.timestamp).split(" - ");return{date:t[0],time:t[1],sent:e.webhook.http_verb.toUpperCase(),received:o.reason,attempts:parseInt(e.webhook.retries)-o.retries_left,error:"failure"===o.result}}),i},bindAttemptsHistoryEvents:function(e,o){var t=this;e.find(".top-action-bar .back-button").on("click",function(){t.render()}),e.find(".top-action-bar .enable-button").on("click",function(){t.enableWebhook(o.id,function(){t.render()})})},getFormData:function(e,t){var a=this,i={},r=!0,s=e.find(".select-group").val(),c=e.find(".new-group").val();if(e.find(".custom-data-row").each(function(e){var t=o(this).find(".custom-data-key").val(),n=o(this).find(".custom-data-value").val();return i.hasOwnProperty(t)?(r=!1,!1):void(i[t]=n)}),r){var u=n.ui.getFormData("webhook_edition_form");u.custom_data=i,delete u.extra,"new"===s?u.group=c:"none"!==s&&(u.group=s.replace("group_","")),t&&t(u)}else n.ui.alert("warning",a.i18n.active().webhooks.warning)},getWebhooks:function(e){var o=this;o.callApi({resource:"webhooks.list",data:{accountId:o.accountId},success:function(o){e(o.data)}})},getAvailableWebhooks:function(e){var o=this;o.callApi({resource:"webhooks.listAvailable",data:{},success:function(o){e(o.data)}})},getWebhookDetails:function(e,o){var t=this;t.callApi({resource:"webhooks.get",data:{accountId:t.accountId,webhookId:e},success:function(e){o&&o(e.data)}})},getWebhookHistory:function(e,o){var t=this;t.callApi({resource:"webhooks.listAttempts",data:{accountId:t.accountId,webhookId:e},success:function(e){o&&o(e.data)}})},addWebhook:function(e,o){var t=this;t.callApi({resource:"webhooks.create",data:{accountId:t.accountId,data:e},success:function(e){o(e.data)}})},updateWebhook:function(e,o,t){var n=this;n.callApi({resource:"webhooks.update",data:{accountId:n.accountId,webhookId:e,data:o},success:function(e){t&&t(e.data)}})},deleteWebhook:function(e,o){var t=this;t.callApi({resource:"webhooks.delete",data:{accountId:t.accountId,webhookId:e,data:{}},success:function(e){o&&o(e.data)}})},enableWebhook:function(e,o){var t=this;t.callApi({resource:"webhooks.patch",data:{accountId:t.accountId,webhookId:e,data:{enabled:!0}},success:function(e){o&&o(e.data)}})},enableAllWebhooks:function(e){var o=this;o.callApi({resource:"webhooks.patchAll",data:{accountId:o.accountId,data:{"re-enable":!0}},success:function(o){e&&e(o.data)}})},updateWebhookGroups:function(e,o){var t=this,n=t.uiFlags.account.set("groups",e);t.callApi({resource:"account.update",data:{accountId:n.id,data:n},success:function(e,t){o(e.data)}})}};return i});