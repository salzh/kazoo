define(["require","jquery","underscore","monster","toastr"],function(e){var a=e("jquery"),t=e("underscore"),n=e("monster"),o=e("toastr"),r={name:"auth",css:["app"],i18n:{"en-US":{customCss:!1},"fr-FR":{customCss:!1},"ru-RU":{customCss:!1}},appFlags:{mainContainer:void 0,isAuthentified:!1},requests:{"auth.upgradeTrial":{apiRoot:n.config.api.screwdriver,url:"upgrade",verb:"POST"}},subscribe:{"auth.logout":"_logout","auth.clickLogout":"_clickLogout","auth.initApp":"_initApp","auth.afterAuthenticate":"_afterSuccessfulAuth","auth.showTrialInfo":"showTrialInfo"},load:function(e){var a=this;e&&e(a)},render:function(e){var a=this;a.appFlags.mainContainer=e,a.triggerLoginMechanism()},triggerLoginMechanism:function(){var e=this,t=n.util.getUrlVars(),o=function(a){e._afterSuccessfulAuth(a)};if("authentication"in n.config.whitelabel){e.customAuth=n.config.whitelabel.authentication;var r={sourceUrl:e.customAuth.source_url,apiUrl:e.customAuth.api_url};n.apps.load(e.customAuth.name,function(a){a.render(e.appFlags.mainContainer)},r)}else if(a.cookie("monster-auth")){var i=a.parseJSON(a.cookie("monster-auth"));e.authenticateAuthToken(i.accountId,i.authToken,o)}else t.hasOwnProperty("t")&&t.hasOwnProperty("a")&&32===t.t.length&&32===t.a.length?e.authenticateAuthToken(t.a,t.t,o):e.renderLoginPage(e.appFlags.mainContainer)},authenticateAuthToken:function(e,a,t){var n=this;n.authToken=a,n.getAuth(e,a,function(e){t&&t(e)},function(){delete n.authToken,n.renderLoginPage(n.appFlags.mainContainer)})},_afterSuccessfulAuth:function(e){var t=this;t.accountId=e.data.account_id,t.authToken=e.auth_token,t.userId=e.data.owner_id,t.isReseller=e.data.is_reseller,t.resellerId=e.data.reseller_id,t.appFlags.isAuthentified=!0,"apps"in e.data?t.installedApps=e.data.apps:(t.installedApps=[],o.error(t.i18n.active().toastrMessages.appListError));var r={language:e.data.language,authToken:t.authToken,accountId:t.accountId};a.cookie("monster-auth",JSON.stringify(r)),a(".core-footer").append(t.appFlags.mainContainer.find(".powered-by-block .powered-by")),t.appFlags.mainContainer.empty(),n.apps.core.authToken=e.auth_token,n.pub("core.initializeShortcuts",e.data.apps),t.afterLoggedIn()},_clickLogout:function(){var e=this;n.ui.confirm(e.i18n.active().confirmLogout,function(){e._logout()})},afterLoggedIn:function(){var e=this;a("#main_topbar_apploader").show(),e.loadAccount()},loadAccount:function(){var e=this;n.parallel({appsStore:function(a){e.getAppsStore(function(e){a(null,e)})},account:function(a){e.getAccount(e.accountId,function(e){a(null,e.data)},function(e){a("error account",e)})},user:function(a){e.getUser(function(e){a(null,e.data)},function(e){a("error user",e)})}},function(o,r){var i;if(o)n.util.logoutAndReload();else{r.user.hasOwnProperty("require_password_update")&&r.user.require_password_update&&e.newPassword(r.user),n.util.autoLogout(),a("#main_topbar_signout").show(),r.user.account_name=r.account.name,r.user.apps=r.user.apps||{},r.account.apps=r.account.apps||{};var s=function(){var o=t.indexBy(e.installedApps,"id"),s=t.find(r.user.appList||[],function(e){return o.hasOwnProperty(e)});s?i=o[s].name:e.installedApps.length>0&&(i=e.installedApps[0].name),n.appsStore=t.indexBy(r.appsStore,"name"),e.currentUser=r.user,e.originalAccount=r.account,e.currentAccount=a.extend(!0,{},e.originalAccount),e.defaultApp=i,e.showAnnouncement(e.originalAccount.announcement),"ui_flags"in r.user&&r.user.ui_flags.colorblind&&a("body").addClass("colorblind"),n.util.isAdmin()&&a("#main_topbar_account_toggle_link").addClass("visible"),n.pub("core.loadApps",{defaultApp:i})},c=function(a,t){a!==n.config.whitelabel.language&&a!==n.apps.defaultLanguage?n.apps.loadLocale(n.apps.core,a,function(){n.apps.loadLocale(e,a,function(){n.config.whitelabel.language=a,t&&t()})}):(n.config.whitelabel.language=a,t&&t())};"language"in r.user?c(r.user.language,s):"language"in r.account?c(r.account.language,s):s&&s()}})},showAnnouncement:function(){var e=this,a=e.originalAccount.announcement||n.config.whitelabel.announcement;a&&n.ui.alert("info",a,null,{title:e.i18n.active().announcementTitle})},showTrialInfo:function(e){var t=this,o=e>0?Math.ceil(e/86400):-1,r=t.uiFlags.user.get("hasLoggedIn")?!0:!1,i=a(n.template(t,"trial-message",{daysLeft:o}));i.find(".links").on("click",function(){t.showTrialPopup(o)}),a("#main_topbar_nav").prepend(i),r?t.showTrialPopup(o):t.showFirstTrialGreetings()},showFirstTrialGreetings:function(){var e=this,t=function(a){var t=e.uiFlags.user.set("hasLoggedIn",!0);e.updateUser(t,function(e){a&&a(e)}),n.pub("auth.continueTrial")},o=a(n.template(e,"trial-greetingsDialog"));o.find("#acknowledge").on("click",function(){r.dialog("close").remove(),t&&t()});var r=n.ui.dialog(o,{title:e.i18n.active().trialGreetingsDialog.title});r.siblings().find(".ui-dialog-titlebar-close").on("click",function(){t&&t()})},updateUser:function(e,a){var t=this;t.callApi({resource:"user.update",data:{accountId:t.accountId,data:e},success:function(e){a&&a(e.data)}})},showTrialPopup:function(e){var a=this,t=a.uiFlags.account.get("trial_upgraded");t?n.ui.alert("info",a.i18n.active().trialPopup.alreadyUpgraded):e>=0?n.ui.confirm("",function(){a.handleUpgradeClick()},function(){n.pub("auth.continueTrial")},{title:n.template(a,"!"+a.i18n.active().trialPopup.mainMessage,{variable:e}),cancelButtonText:a.i18n.active().trialPopup.closeButton,confirmButtonText:a.i18n.active().trialPopup.upgradeButton,confirmButtonClass:"monster-button-primary",type:"warning"}):n.ui.alert("error","",function(){a.handleUpgradeClick()},{closeOnEscape:!1,title:a.i18n.active().trialPopup.trialExpired,closeButtonText:a.i18n.active().trialPopup.upgradeButton,closeButtonClass:"monster-button-primary"})},handleUpgradeClick:function(){var e=this;n.pub("myaccount.hasCreditCards",function(a){a?e.upgradeAccount(e.accountId,function(){n.ui.alert("info",e.i18n.active().trial.successUpgrade.content,null,{title:e.i18n.active().trial.successUpgrade.title})}):(n.pub("myaccount.showCreditCardTab"),o.error(e.i18n.active().trial.noCreditCard))})},upgradeAccount:function(e,a){var t=this;t.sendUpgradeTrialRequest(e,function(){t.setUpgradeFlagAccount(e,function(e){a&&a(e)})})},sendUpgradeTrialRequest:function(e,a){n.request({resource:"auth.upgradeTrial",data:{envelopeKeys:{id:e}},success:function(e,t){a&&a(e)}})},setUpgradeFlagAccount:function(e,a){var t=this;t.getAccount(e,function(e){var n=t.uiFlags.account.set("trial_upgraded",!0,e.data);t.callApi({resource:"account.update",data:{accountId:t.accountId,data:n},success:function(e){a&&a(e.data)}})})},renderLoginPage:function(e){var t=this,o="",r="",i=a.parseJSON(a.cookie("monster-login"))||{},s={username:i.login||"",requestAccountName:r||o?!1:!0,accountName:i.accountName||"",rememberMe:i.login||i.accountName?!0:!1,showRegister:n.config.hide_registration||!1,hidePasswordRecovery:n.config.whitelabel.hidePasswordRecovery||!1},c=a(n.template(t,"app",s)),u=function(){n.config.whitelabel.custom_welcome&&c.find(".welcome-message").empty().html((n.config.whitelabel.custom_welcome_message||"").replace(/\r?\n/g,"<br />")),e.append(c),t.bindLoginBlock(s),c.find(".powered-by-block").append(a(".core-footer .powered-by"))},l=window.location.hostname;t.callApi({resource:"whitelabel.getLogoByDomain",data:{domain:l,generateError:!1,dataType:"*"},success:function(e){c.find(".logo-block").css("background-image","url("+n.config.api["default"]+"whitelabel/"+l+"/logo?_="+(new Date).getTime()+")"),u()},error:function(e){c.find(".logo-block").css("background-image",'url("apps/auth/style/static/images/logo.png")'),u()}})},bindLoginBlock:function(e){var r=this,i=a("#auth_container");i.find(""!==e.username?"#password":"#login").focus(),i.find(".btn-submit.login").on("click",function(e){e.preventDefault(),r.loginClick()}),""!==i.find('.input-wrap input[type="text"], input[type="password"], input[type="email"]').val()&&i.find(".placeholder-shift").addClass("fixed"),i.find(".input-wrap input").on("focus",function(){a(this).parents(".input-wrap").removeClass("error")}),i.find('.input-wrap input[type="text"], input[type="password"], input[type="email"]').on("change",function(){""!==this.value?a(this).next(".placeholder-shift").addClass("fixed"):a(this).next(".placeholder-shift").removeClass("fixed")}),i.find(".form-toggle").on("click",function(){var e=a(this).data("form");i.find(".form-container").toggleClass("hidden"),i.find('.form-container[data-form="'+e+'"]').addClass("fadeInDown"),i.find(".form-content").removeClass("hidden"),i.find(".reset-notification").addClass("hidden")});var s=i.find("#form_password_recovery");n.ui.validate(s),i.find(".recover-password").on("click",function(){if(n.ui.valid(s)){var e=n.ui.getFormData("form_password_recovery",".",!0);e.ui_url=window.location.href,e.hasOwnProperty("account_name")||e.hasOwnProperty("phone_number")?r.callApi({resource:"auth.recovery",data:{data:e,generateError:!1},success:function(e,a){i.find(".form-content").addClass("hidden"),i.find(".reset-notification").addClass("animated fadeIn").removeClass("hidden")},error:function(e,a,n){400===a.status?t.keys(e.data).forEach(function(a){r.i18n.active().recoverPassword.toastr.error.reset.hasOwnProperty(a)?o.error(r.i18n.active().recoverPassword.toastr.error.reset[a]):e.data[a].hasOwnProperty("not_found")&&o.error(e.data[a].not_found)}):n(e)}}):o.error(r.i18n.active().recoverPassword.toastr.error.missing)}})},loginClick:function(e){var t=this,n=a("#login").val(),o=a("#password").val(),r=a("#account_name").val(),i=a.md5(n+":"+o),s={credentials:i,account_name:r};n&&o?t.putAuth(s,function(e){if(a("#remember_me").is(":checked")){var o={login:n,accountName:r};a.cookie("monster-login",JSON.stringify(o),{expires:30})}else a.cookie("monster-login",null);t._afterSuccessfulAuth(e)}):(n||a("#login").parents(".input-wrap").addClass("error"),o||a("#password").parents(".input-wrap").addClass("error"))},_logout:function(){n.util.logoutAndReload()},newPassword:function(e){var t=this,r=a(n.template(t,"dialogPasswordUpdate")),i=r.find("#form_password_update"),s=n.ui.dialog(r,{title:t.i18n.active().passwordUpdate.title});n.ui.validate(i),r.find(".update-password").on("click",function(){if(n.ui.valid(i)){var r=n.ui.getFormData("form_password_update");if(r.new_password===r.new_password_confirmation){var c={password:r.new_password,require_password_update:!1},u=a.extend(!0,{},e,c);t.callApi({resource:"user.update",data:{accountId:t.accountId,userId:t.userId,data:u},success:function(e,a){s.dialog("close").remove(),o.success(t.i18n.active().passwordUpdate.toastr.success.update)}})}else o.error(t.i18n.active().passwordUpdate.toastr.error.password)}}),r.find(".cancel-link").on("click",function(){s.dialog("close").remove()})},conferenceLogin:function(){var e=this,a=n.ui.getFormData("user_login_form");t.each(a.update,function(e,t){e||delete a.update[t]}),e.callApi({resource:"auth.pinAuth",data:{data:a},success:function(t,o){e.accountId=t.data.account_id,e.authToken=t.auth_token,e.userId=null,e.isReseller=t.data.is_reseller,e.resellerId=t.data.reseller_id,e.appFlags.mainContainer.empty(),n.apps.load("conferences",function(n){n.userType="unregistered",n.user=a,n.isModerator=t.data.is_moderator,n.conferenceId=t.data.conference_id,n.render(e.appFlags.mainContainer)})},error:function(a,t){var o=e.i18n.active().errors.generic;t.status in e.i18n.active().errors?o=e.i18n.active().errors[t.status]:a.message&&(o+="<br/><br/>"+e.i18n.active().errors.genericLabel+": "+a.message),n.ui.alert("error",o)}})},putAuth:function(e,a){var t=this;t.callApi({resource:"auth.userAuth",data:{data:e,generateError:!1},success:function(e,t){a&&a(e)},error:function(e,a,o){if(423===a.status&&e.data.hasOwnProperty("account")&&e.data.account.hasOwnProperty("expired")){var r=n.util.toFriendlyDate(n.util.gregorianToDate(e.data.account.expired.cause),"short"),i=n.template(t,"!"+t.i18n.active().expiredTrial,{date:r});n.ui.alert("warning",i)}else 423===a.status?n.ui.alert("error",t.i18n.active().disabledAccount):o(e,{generateError:!0})}})},getAuth:function(e,a,t,n){var o=this;o.callApi({resource:"auth.get",data:{accountId:e,token:a,generateError:!1},success:function(e){t&&t(e)},error:function(e){n&&n()}})},getAccount:function(e,a,t){var n=this;n.callApi({resource:"account.get",data:{accountId:e},success:function(e){"function"==typeof a&&a(e)},error:function(e){"function"==typeof t&&t(e)}})},getAppsStore:function(e){var a=this;a.callApi({resource:"appsStore.list",data:{accountId:a.accountId},success:function(a){e&&e(a.data)}})},getUser:function(e,a){var t=this;t.callApi({resource:"user.get",data:{accountId:t.accountId,userId:t.userId},success:function(a){"function"==typeof e&&e(a)},error:function(e){"function"==typeof a&&a(e)}})},_initApp:function(e){var a=this,o=({data:{realm:a.realm,accountId:a.accountId,shared_token:a.authToken}},function(t){t.isMasqueradable=t.hasOwnProperty("isMasqueradable")?t.isMasqueradable:n.appsStore.hasOwnProperty(t.name)?n.appsStore[t.name].masqueradable:!0,t.accountId=t.isMasqueradable&&a.currentAccount?a.currentAccount.id:a.accountId,t.userId=a.userId,e.callback&&e.callback()}),r=t.find(a.installedApps,function(a){return a.name===e.app.name});r&&r.api_url&&(e.app.apiUrl=r.api_url,"/"!==e.app.apiUrl.substr(e.app.apiUrl.length-1)&&(e.app.apiUrl+="/")),e.app.authToken=this.authToken,o(e.app)}};return r});
