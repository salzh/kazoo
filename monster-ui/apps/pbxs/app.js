define(["require","jquery","underscore","monster","toastr","nicescroll"],function(e){var t=e("jquery"),n=e("underscore"),a=e("monster"),i=e("toastr"),s=(e("nicescroll"),{name:"pbxs",css:["app"],i18n:{"en-US":{customCss:!1},"fr-FR":{customCss:!1},"ru-RU":{customCss:!1},"es-ES":{customCss:!1}},requests:{},subscribe:{"pbxsManager.activate":"_render","pbxsManager.edit":"editServer"},load:function(e){var t=this;t.initApp(function(){e&&e(t)})},initApp:function(e){var t=this;a.pub("auth.initApp",{app:t,callback:e})},render:function(e){var t=this;t._render(e)},_render:function(e){var i=this,s=t(a.template(i,"pbxsManager")),r=n.isEmpty(e)?t("#monster-content"):e;r.empty().append(s),i.renderList(-1,r,function(e){i.refreshUnassignedList(function(){i.bindEvents(s),0===e.length?a.pub("pbxsManager.edit",{}):e.length>=1&&(a.pub("pbxsManager.edit",{id:0}),s.find('.pbx-wrapper[data-id="0"]').addClass("selected"))})}),s.find("#pbxs_manager_listpanel").niceScroll({cursorcolor:"#333",autohidemode:!1,cursorborder:"1px solid #666"}).railh.addClass("pbx-fixed-hscroll"),s.find("#unassigned_numbers_wrapper").niceScroll({cursorcolor:"#333",cursoropacitymin:.5,hidecursordelay:1e3}).rail.addClass("unassigned-number-fixed-vscroll")},editServer:function(e){var n=this;a.parallel({realm:function(e){n.callApi({resource:"account.get",data:{accountId:n.accountId},success:function(t,n){e(null,t.data.realm)}})},account:function(e){n.getAccount(function(t){e(null,t)})},numbers:function(e){n.listAllNumbers(function(t){e(null,t)})}},function(i,s){var r=e.parent||t("#monster-content"),c=e.target||r.find("#pbxs_manager_view"),o=e.callbacks||{},u={saveSuccess:o.saveSuccess||function(a){var i=0===e.id||e.id?e.id:a.data.servers.length-1;n.renderList(i,r,function(){var e=t.extend(!0,{},d),s=t.extend(!0,e,a.data.servers[i]);n.renderPbxsManager(a,s,c,u)},a.data.servers)},saveError:o.saveError,deleteSuccess:o.deleteSuccess||function(){c.empty(),n.renderList()},cancelSuccess:o.cancelSuccess||function(){a.pub("pbxsManager.edit",{id:e.id,parent:r,target:c,callbacks:u})},deleteError:o.deleteError,afterRender:o.afterRender},d={auth:{auth_user:"user_"+a.util.randomString(8),auth_password:a.util.randomString(12),auth_method:"IP"},options:{e911_info:{}},cfg:{register_time:"360",opening_pings:!0,caller_id_header:"p-asserted",supported_codecs:"g722",signaling_type:"rfc_2833",allow_refer:!0,use_t38:!0},extra:{support_email:a.config.support_email||"support@2600hz.com",pbx_help_link:a.config.pbx_help_link||"https://2600hz.atlassian.net/wiki/display/docs/Trunking.io",pbx_help_configuration_link:a.config.pbx_help_configuration_link||"https://2600hz.atlassian.net/wiki/display/docs/Trunking_config.io",configure:"manually",realm:s.realm,id:e.id||(0===e.id?0:"new")}};s.account.data.servers&&t.each(s.account.data.servers,function(e,n){t.each(n.DIDs,function(t,n){if(t in s.numbers.data.numbers){var a=s.numbers.data.numbers[t];s.account.data.servers[e].DIDs[t].features=a.features,"locality"in a&&(s.account.data.servers[e].DIDs[t].isoCountry=a.locality.country||"")}})}),"object"!=typeof e||!e.id&&0!==e.id?n.renderEndpoint(s.accounts,d,c,u,r):n.renderPbxsManager(s.account,t.extend(!0,d,s.account.data.servers[e.id]),c,u)})},listAvailablePbxs:function(){return["allworks","altigen","asterisk","avaya","bluebox","cisco","digium","epygi","freepbx","freeswitch","mitel","objectworld","other","pingtel","responsepoint","samsung","shoretel","sutus","talkswitch","threecom","taridium"]},listAllNumbers:function(e,t){var n=this;n.callApi({resource:"numbers.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(t,n){"function"==typeof e&&e(t,n)},error:function(e,n){"function"==typeof t&&t(e,n)}})},listCallflows:function(e,t){var n=this;n.callApi({resource:"callflow.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(t,n){"function"==typeof e&&e(t,n)},error:function(e,n){"function"==typeof t&&t(e,n)}})},createAccount:function(e,t){var n=this;n.callApi({resource:"account.get",data:{accountId:n.accountId},success:function(a,i){var s={account:{credits:{prepay:"0.00"},trunks:0,inbound_trunks:0,auth_realm:a.data.realm},billing_account_id:n.accountId,DIDs_Unassigned:{},servers:[]};n.callApi({resource:"connectivity.create",data:{accountId:n.accountId,data:s},success:function(t,n){"function"==typeof e&&e(t,n)},error:function(e,n){"function"==typeof t&&t(e,n)}})}})},listAccounts:function(e,t){var n=this;n.callApi({resource:"connectivity.list",data:{accountId:n.accountId},success:function(t,n){"function"==typeof e&&e(t,n)},error:function(e,n){"function"==typeof t&&t(e,n)}})},getAccount:function(e,t){var n=this;n.callApi({resource:"connectivity.get",data:{accountId:n.accountId,connectivityId:n.connectivityId},success:function(t,n){"function"==typeof e&&e(t,n)},error:function(e,n){"function"==typeof t&&t(e,n)}})},listServers:function(e,t){var n=this,i=function(){n.getAccount(function(t,n){e(t.data.servers,n)})};n.listAccounts(function(e,t){e.data.length?(n.connectivityId=e.data[0],i()):n.createAccount(function(e){n.listAccounts(function(e,t){n.connectivityId=e.data[0],i()})},function(e,t){var i=a.template(n,"!"+n.i18n.active().error_signup,{status:t});a.ui.alert(i)})})},getNumber:function(e,t,n){var a=this;a.callApi({resource:"numbers.get",data:{accountId:a.accountId,phoneNumber:encodeURIComponent(e)},success:function(e,n){"function"==typeof t&&t(e)},error:function(e,t){"function"==typeof n&&n(e)}})},updateNumber:function(e,t,n,a){var i=this;i.callApi({resource:"numbers.update",data:{accountId:i.accountId,phoneNumber:encodeURIComponent(e),data:t},success:function(e,t){"function"==typeof n&&n(e)},error:function(e,t){"function"==typeof a&&a(e)}})},createNumber:function(e,t,n){var a=this;a.callApi({resource:"numbers.create",data:{accountId:a.accountId,phoneNumber:encodeURIComponent(e),data:{}},success:function(e,n){"function"==typeof t&&t(e,n)},error:function(e,t){"function"==typeof n&&n(e,t)}})},activateNumber:function(e,t,n){var a=this;a.callApi({resource:"numbers.activate",data:{accountId:a.accountId,phoneNumber:encodeURIComponent(e),data:{}},success:function(e,n){"function"==typeof t&&t(e,n)},error:function(e,t){"function"==typeof n&&n(e,t)}})},deleteNumber:function(e,t,n){var a=this;a.callApi({resource:"numbers.delete",data:{accountId:a.accountId,phoneNumber:encodeURIComponent(e)},success:function(e,n){"function"==typeof t&&t(e,n)},error:function(e,t){"function"==typeof n&&n(e,t)}})},cleanPhoneNumberData:function(e){return e},cleanFormData:function(e){return""!==e.server_name&&"server_name"in e||(e.server_name="PBX "+e.extra.serverid),e.hasOwnProperty("extra")&&e.extra.hasOwnProperty("compatibilityMode")&&(e.options.media_handling=e.extra.compatibilityMode===!0?"process":"bypass"),delete e.extra,e},saveEndpoint:function(e,n,i,s){var r=this,c=e.extra.serverid,o=t.extend(!0,{},n.data);r.cleanFormData(e),e.server_name?(!c&&0!==c||"new"===c?o.servers.push(t.extend(!0,{DIDs:{},options:{enabled:!0,inbound_format:"e.164",international:!1,caller_id:{},e911_info:{},failover:{}},permissions:{users:[]},monitor:{monitor_enabled:!1}},e)):(t.extend(!0,o.servers[c],e),"bypass"!==e.options.media_handling&&e.options.hasOwnProperty("codecs")&&0!==e.options.codecs.length||delete o.servers[c].options.codecs),r.updateOldTrunkstore(o,i,s)):a.ui.alert("formatting_error")},normalizeData:function(e){return t.each(e.servers,function(n,a){delete e.servers[n][""],t.each(a.DIDs,function(a,i){t.each(i,function(t,i){i===!1&&delete e.servers[n].DIDs[a][t]})})}),e},updateOldTrunkstore:function(e,t,n){var a=this;a.normalizeData(e),a.callApi({resource:"connectivity.update",data:{accountId:a.accountId,connectivityId:a.connectivityId,data:e},success:function(e,n){i.success(a.i18n.active().changesSaved),"function"==typeof t&&t(e,n)},error:function(e,t){"function"==typeof n&&n(e,t)}})},loadSpecificStep:function(e,n,a){t(".wizard-top-bar",a).hide(),t(".wizard-content-step",a).hide(),t('.wizard-content-step[data-step="'+e+'"]',a).show(),t(".wizard-buttons button",a).hide(),t(".cancel",a).show(),t(".submit-btn",a).show(),t("#list_pbxs_navbar").hide(),t(".cancel",a).off().on("click",function(e){e.preventDefault(),"function"==typeof n.cancelSuccess&&n.cancelSuccess()})},initializeWizard:function(e,n){var i=this,s=parseInt(t(".wizard-top-bar",e).attr("data-max_step"));t(".wizard-top-bar",e).attr("data-active_step","1"),t(".wizard-content-step",e).hide(),t('.wizard-content-step[data-step="1"]',e).show(),t(".wizard-top-bar",e).attr("data-active_step","1"),1!==s?t(".submit-btn",e).hide():t(".next-step",e).hide(),t(".prev-step",e).hide(),t(".step",e).on("click",function(){var n=t(this).data("step");t(this).hasClass("completed")&&i.validate_step(t(".wizard-top-bar",e).attr("data-active_step"),e,function(){i.change_step(n,s,e)})}),t(".next-step",e).on("click",function(n){n.preventDefault(),current_step=parseInt(t(".wizard-top-bar",e).attr("data-active_step")),i.validate_step(current_step,e,function(){i.change_step(++current_step,s,e)})}),t(".prev-step",e).on("click",function(n){n.preventDefault(),current_step=parseInt(t(".wizard-top-bar",e).attr("data-active_step")),i.change_step(--current_step,s,e)}),t(".cancel",e).on("click",function(e){e.preventDefault(),a.pub("pbxsManager.activate")}),t(".submit-btn",e).on("click",function(a){a.preventDefault(),current_step=parseInt(t(".wizard-top-bar",e).attr("data-active_step")),i.validate_step(current_step,e,function(){"function"==typeof n&&n()})})},change_step:function(e,n,a){t(".step",a).removeClass("active"),t('.step[data-step="'+e+'"]',a).addClass("active");for(var i=e;i>=1;--i)t('.step[data-step="'+i+'"]',a).addClass("completed");t(".wizard-content-step",a).hide(),t('.wizard-content-step[data-step="'+e+'"]',a).show(),t(".cancel",a).hide(),t(".prev-step",a).show(),t(".next-step",a).show(),t(".submit-btn",a).hide(),e===n&&(t(".next-step",a).hide(),t(".submit-btn",a).show()),1===e&&(t(".prev-step",a).hide(),t(".cancel",a).show()),t(".wizard-top-bar",a).attr("data-active_step",e)},validate_step:function(e,n,i){var s=this,r=a.ui.valid(t("#endpoint")),e=parseInt(e),c=s.i18n.active().please_correct;a.ui.getFormData("endpoint");r&&(1===e?0===t(".pbx-brand-list .pbx.selected",n).size()&&(c+="<br/>- "+s.i18n.active().no_pbx_selected,r=!1):2===e&&"IP"===t('input[type="radio"][name="auth.auth_method"]:checked',n).val()&&null===t("#auth_ip",n).val().match(/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/)&&(r=!1,c+="<br/>- "+s.i18n.active().not_valid_ip),r===!0?"function"==typeof i&&i():a.ui.alert(c))},renderEndpoint:function(e,n,i,s,r){n.server_name||(n.server_name=null);var c=this,o=function(){var e=a.ui.getFormData("endpoint");if(e.auth.auth_method=t('input[type="radio"][name="auth.auth_method"]:checked',p).val(),e.server_type=t(".pbx-brand-list .pbx.selected",p).data("pbx_name"),e.cfg=t.extend(!0,u,e.cfg),e.extra.compatibilityMode){var n=l.getSelectedItems();n.length&&(e.options.codecs=n)}c.getAccount(function(t){c.saveEndpoint(e,t,function(e){"function"==typeof s.saveSuccess&&s.saveSuccess(e)})})},u={},d=n,p=t(a.template(c,"endpoint",d));a.ui.tooltips(p);var l=a.ui.codecSelector("audio",p.find("#compatibility_codec_selector"),n.options.codecs||[]);t.each(n.cfg,function(e,n){"object"==typeof n?t.each(n,function(n,a){t('button[data-value="'+a+'"]',t('.btn-group[data-type="'+e+'"]',p)).addClass("btn-primary")}):t('button[data-value="'+n+'"]',t('.btn-group[data-type="'+e+'"]',p)).addClass("btn-primary")}),c.initializeWizard(p,o),t(".static-ip-block",p).hide(),t('.static-ip-block[data-value="'+n.auth.auth_method+'"]',p).show(),p.find('[name="extra.compatibilityMode"]').on("change",function(e){var n=p.find("#compatibility_codec_selector");t(this).is(":checked")?n.addClass("active"):n.removeClass("active")}),t(".btn-group .btn",p).on("click",function(e){e.preventDefault();var n=t(this).parent(".btn-group");"multi"===n.data("select")?(t(this).toggleClass("btn-primary"),u[n.data("type")]=[],t(".btn",n).each(function(e,a){t(a).hasClass("btn-primary")&&u[n.data("type")].push(t(a).data("value"))})):(t(this).hasClass("btn-primary")||(t(".btn",t(this).parent()).removeClass("btn-primary"),t(this).addClass("btn-primary")),u[n.data("type")]=t(this).data("value"))}),t("#submit_settings",p).on("click",function(e){e.preventDefault(),o()}),t('input[type="radio"][name="auth.auth_method"]',p).on("click",function(){t(".static-ip-block",p).hide(),t('.static-ip-block[data-value="'+t(this).val()+'"]',p).slideDown()}),t(".pbx-brand-list .pbx",p).each(function(){return t(this).data("pbx_name")===n.server_type?(t(this).addClass("selected"),t(".pbx-brand-list .pbx:not(.selected)",p).css("opacity","0.2"),!1):void 0}),n.server_type&&0===t(".pbx-brand-list .pbx.selected",p).size()&&(t(".pbx-brand-list .pbx.other",p).addClass("selected"),t(".pbx-brand-list .pbx:not(.selected)",p).css("opacity","0.2")),n.server_type||t(".info_pbx",p).hide(),t(".pbx-brand-list .pbx",p).click(function(){t(".pbx-brand-list .pbx",p).removeClass("selected").css("opacity","0.2"),t(this).addClass("selected"),t(".selected-pbx",p).html(t(".pbx-brand-list .selected",p).data("pbx_name")),t(".info_pbx",p).slideDown()}),n.load_step&&n.load_step>0?c.loadSpecificStep(n.load_step,s,p):t("#list_pbxs_navbar",r).hide(),a.ui.protectField(p.find("#auth_password"),p),a.ui.validate(p.find("#endpoint"),{rules:{"auth.ip":{ipv4:!0}}}),i.empty().append(p)},refreshListNumbers:function(e,i){var s=i||t("#pbx_connector_container"),r=this,c=s.find("#numbers_wrapper");c.empty();var o=[];n.each(e,function(e,t){e.phoneNumber=t,o.push(e)}),o=a.util.sort(o,"phoneNumber"),t.isEmptyObject(e)?c.append(a.template(r,"noNumbers")):c.append(a.template(r,"listNumbers",{isCnamEnabled:a.util.isNumberFeatureEnabled("cnam"),isE911Enabled:a.util.isNumberFeatureEnabled("e911"),DIDs:o})),t("#count_phones",s).html(o.length),t("#trigger_links",s).hide()},renderPbxsManager:function(e,i,s,r){var c=this,o=i.extra.id,u=i.server_type?i.server_type.replace(".","").toLowerCase():"other";t.inArray(u,c.listAvailablePbxs())<0?u="other":!0,i.img_link=u,i.servers_list=[],i.hidePort=a.config.whitelabel.hasOwnProperty("hide_port")?a.config.whitelabel.hide_port:!1,t.each(e.data.servers,function(e,n){if(e!==o){var a=n.server_type?n.server_type.replace(".","").toLowerCase():"other";t.inArray(a,c.listAvailablePbxs())<0?a="other":!0,i.servers_list.push({index:e,server_name:n.server_name,img_link:a})}});var d=t(a.template(c,"endpointNumbers",i)),p=function(e){c.refreshListNumbers(e,d)};c.refreshListNumbers(i.DIDs,d),t("#list_pbxs_navbar").show();var l=d.find("#search_results"),f=d.find("#numbers_wrapper");l.hide(),setTimeout(function(){d.find(".search-query").focus()}),d.find(".search-query").on("keyup",function(){var e=t(this),n=f.find(".number-wrapper"),i=t.trim(e.val().toLowerCase().replace(/[^0-9]/g,"")),s=[],r={};t.each(n,function(e,n){var a=t(this).data(),i=a.phone_number;r[i]=t(this)}),i?(l.show().empty(),t.each(r,function(e,n){e.indexOf(i)>-1&&s.push({phone_number:e,selected:t(n).hasClass("selected")})}),s.length>0?l.append(a.template(c,"searchResults",{isCnamEnabled:a.util.isNumberFeatureEnabled("cnam"),isE911Enabled:a.util.isNumberFeatureEnabled("e911"),matches:s,i18n:{amountNumbers:s.length}})):l.append(a.template(c,"noResults")),f.hide()):(f.show(),l.empty().hide())}),d.on("click",".number-wrapper",function(e){if(t(e.target).closest(".number-options").size()<1){var n=function(e,t){var n=e.find('input[type="checkbox"]'),a=n.prop("checked");t&&n.prop("checked",!a),e.toggleClass("selected")},a=t(this);if(n(a,!t(e.target).is("input:checkbox")),a.parents("#search_results").size()>0){var i=d.find('#numbers_wrapper .number-wrapper[data-phone_number="'+a.data("phone_number")+'"]');n(i,!0)}var s=d.find("#trigger_links");d.find(".number-wrapper.selected").size()>0?s.show("fast"):s.hide()}}),d.find("#delete_pbx").on("click",function(){a.ui.confirm(c.i18n.active().delete_pbx_confirmation,function(){c.getAccount(function(e){e.data.servers.splice(i.extra.id,1),c.updateOldTrunkstore(e.data,r.deleteSuccess)})})}),d.find(".settings-pbx-link").on("click",function(){i.load_step=parseInt(t(this).data("step")),c.renderEndpoint(e,i,s,r,d)}),d.find(".buy-numbers-link").on("click",function(e){e.preventDefault(),a.pub("common.buyNumbers",{searchType:t(this).data("type"),callbacks:{success:function(e){c.getAccount(function(t){n.each(e,function(e,n){t.data.servers[o].DIDs[n]={failover:!1,cnam:!1,dash_e911:!1}}),c.updateOldTrunkstore(t.data,function(e){c.renderList(o,void 0,void 0,e.data.servers),c.listNumbersByPbx(o,p)})})}}})}),d.find(".pbx-dropdown:not(.empty)").on("click",function(e){e.preventDefault();var n=[];if(d.find(".number-wrapper.selected").each(function(){n.push(t(this).data("phone_number"))}),n.length>0){var i=t(this).data("index");c.getAccount(function(e){var s=e.data.servers[i].server_name,r=a.template(c,"!"+c.i18n.active().confirm_move,{serverName:s});a.ui.confirm(r,function(){t.each(n,function(t,n){e.data.servers[i].DIDs[n]=e.data.servers[o].DIDs[n],delete e.data.servers[o].DIDs[n]}),c.updateOldTrunkstore(e.data,function(e){c.listNumbersByPbx(o,p,e.data),c.renderList(o)})})})}else a.ui.alert(c.i18n.active().no_number_selected)}),d.find("#port_numbers").on("click",function(e){e.preventDefault(),a.pub("common.port.render",{accountId:c.accountId,callbacks:{}})}),d.on("click",".failover-number",function(){var e=t(this).parents(".number-wrapper").first(),n=e.data("phone_number");if(n){var i={phoneNumber:n,callbacks:{success:function(t){"failover"in t.data?0===e.find(".features i.fa-thumbs-down").size()&&e.find(".features").append('<i class="fa fa-thumbs-down monster-green"></i>'):e.find(".features i.fa-thumbs-down").remove()}}};a.pub("common.failover.renderPopup",i)}}),a.util.isNumberFeatureEnabled("cnam")&&d.on("click",".cnam-number",function(){var e=t(this).parents(".number-wrapper").first(),n=e.data("phone_number");if(n){var i={phoneNumber:n,callbacks:{success:function(n){t.isEmptyObject(n.data.cnam)?e.find(".features i.fa-user").remove():0===e.find(".features i.fa-user").size()&&e.find(".features").append('<i class=fa fa-user "monster-green"></i>')}}};a.pub("common.callerId.renderPopup",i)}}),a.util.isNumberFeatureEnabled("e911")&&d.on("click",".e911-number",function(){var e=t(this).parents(".number-wrapper").first(),n=e.data("phone_number");if(n){var i={phoneNumber:n,callbacks:{success:function(n){t.isEmptyObject(n.data.dash_e911)?e.find(".features i.fa-ambulance").remove():0===e.find(".features i.fa-ambulance").size()&&e.find(".features").append('<i class="fa fa-ambulance monster-green"></i>')}}};a.pub("common.e911.renderPopup",i)}}),d.find("#remove_numbers").on("click",function(){var e=d.find(".number-wrapper.selected"),n=e.size();n>0?a.ui.confirm(c.i18n.active().remove_number_confirmation,function(){var n=[];e.each(function(){n.push(t(this).data("phone_number"))}),c.getAccount(function(e){t.each(n,function(t,n){n in e.data.servers[o].DIDs&&delete e.data.servers[o].DIDs[n]}),c.updateOldTrunkstore(e.data,function(e){c.refreshUnassignedList(function(){c.listNumbersByPbx(o,p,e.data),c.renderList(o,void 0,void 0,e.data.servers)})},function(){c.listNumbersByPbx(o,p)})})},function(){}):a.ui.alert(c.i18n.active().no_number_selected)}),(s||t("#monster-content")).empty().append(d)},refreshUnassignedList:function(e){var n=this;n.listAvailableNumbers(function(i){i=a.util.sort(i,"phoneNumber");var s={unassignedNumbers:i};t("#unassigned_numbers_wrapper").empty().append(a.template(n,"pbxsUnassignedNumbers",s)),t("#unassigned_numbers_count").empty().html(i.length),"function"==typeof e&&e()})},bindEvents:function(e){var n,i=this;a.ui.tooltips(e),e.find(".link-box.assign").on("click",function(){var s=[];e.find("#unassigned_numbers .unassigned-number.selected").each(function(e,n){t(n).data("phone_number")&&s.push(t(this).data("phone_number"))}),n=parseInt(e.find("#pbx_connector_container").data("id")),n>=0?i.getAccount(function(a){t.each(s,function(e,t){a.data.servers[n].DIDs[t]={}}),i.updateOldTrunkstore(a.data,function(t){i.refreshUnassignedList(function(){i.listNumbersByPbx(n,function(a){i.refreshListNumbers(a,e),i.renderList(n,void 0,void 0,t.data.servers)},t.data)})})}):a.ui.alert(i.i18n.active().no_pbx_selected)}),e.find("#unassigned_numbers_header").on("click",function(){var n=t(this),a=e.find("#unassigned_numbers .content"),i=t("#unassigned_numbers_wrapper",e).getNiceScroll()[0];n.hasClass("open")?(n.removeClass("open"),a.hide(),i.resize()):(n.addClass("open"),a.slideDown(i.resize))}),e.on("click",".unassigned-number",function(e){var n=t(this);if(n.toggleClass("selected"),!t(e.target).is("input:checkbox")){var a=n.find('input[type="checkbox"]'),i=a.prop("checked");a.prop("checked",!i)}}),e.on("click","#pbxs_manager_listpanel .pbx-wrapper",function(){t("#pbxs_manager_listpanel .pbx-wrapper",e).removeClass("selected"),n=t(this).data("id"),a.pub("pbxsManager.edit",{id:n}),t(this).addClass("selected")}),e.find("#add_pbx").on("click",function(){a.pub("pbxsManager.edit",{})}),e.find(".link-box.delete").on("click",function(){var n,s=t(".unassigned-number.selected",e),r=s.size(),c=function(){r--,0===r&&i.refreshUnassignedList()};r>0?a.ui.confirm(i.i18n.active().delete_numbers_confirmation,function(){s.each(function(){n=t(this).data("phone_number"),n&&i.deleteNumber(n,function(){c()},function(){c()})})},function(){}):a.ui.alert(i.i18n.active().no_number_selected)}),e.find("#unassigned_numbers .search-query").on("keyup",function(){var n=t(this),a=t("#unassigned_numbers .content .unassigned-number",e),i=t.trim(n.val().toLowerCase().replace(/[^0-9]/g,"")),s=[],r={};t.each(a,function(e,n){var a=t(this).data(),i=a.phone_number;r[i]=t(this)}),t("#empty_search",e).hide(),i?(a.hide(),t.each(r,function(e,t){e.indexOf(i)>-1&&s.push(t)}),s.length>0?t.each(s,function(e,n){t(n).show()}):t("#empty_search",e).show()):a.show()})},renderList:function(e,n,i,s){var r=this,c=i,o=n||t("#monster-content"),u=e||0,d=function(e){t("#list_pbxs_navbar",o).show(),t("#unassigned_numbers",o).show();var n=function(e){var n=[];if(e.length>0){var a=0;t.each(e,function(e,i){var s=0;t.each(i.DIDs,function(e,t){s++}),n.push({id:a,name:i.server_name||"(no name)",count:s}),a++})}return n},i={numbers:n(e)};t("#list_pbxs_navbar #pbxs_manager_listpanel",o).empty().append(a.template(r,"pbxsListElement",i)).show(),t("#list_pbxs_navbar #pbxs_manager_listpanel .pbx-wrapper[data-id="+u+"]",o).addClass("selected"),t.each(e,function(e,n){var a=n.server_type?n.server_type.replace(".","").toLowerCase():"other";t.inArray(a,r.listAvailablePbxs())<0?a="other":!0,t('#pbxs_manager_listpanel .pbx-wrapper[data-id="'+e+'"] .img-wrapper',o).append('<img class="img_style" src="'+r.appPath+"/style/static/images/endpoints/"+a+'.png" height="49" width=72"/>')}),c&&c(e)};s?d(s):r.listServers(function(e,t){d(e)})},listNumbersByPbx:function(e,n,i){var s=this;(e||e>-1)&&a.parallel({list_numbers:function(e){s.listAllNumbers(function(t){e(null,t.data.numbers)})},account:function(e){i?e(null,i):s.getAccount(function(t){e(null,t.data)})}},function(a,i){var s={};t.each(i.account.servers[e].DIDs,function(e,t){e in i.list_numbers&&(s[e]=i.list_numbers[e])}),n&&n(s)})},listAvailableNumbers:function(e){var n=this;a.parallel({listNumbers:function(e){n.listAllNumbers(function(t){e(null,t.data)})}},function(n,a){var i=[];"numbers"in a.listNumbers&&t.each(a.listNumbers.numbers,function(e,t){t.used_by&&""!==t.used_by||i.push({phoneNumber:e,isoCountry:"locality"in t?t.locality.country||"":""})}),e&&e(i)})}});return s});