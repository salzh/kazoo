define(["require","jquery","underscore","monster","toastr"],function(e){var t=e("jquery"),s=e("underscore"),i=e("monster"),a=e("toastr"),n={requests:{},subscribe:{"common.e911.renderPopup":"e911Edit"},e911Edit:function(e){var t=this,s={success:function(s){t.e911Render(s,e.callbacks)},number:e.phoneNumber};i.pub("common.numbers.editFeatures",s)},e911Render:function(e,n){var o,d=this,c=t(i.template(d,"e911-dialog",e.dash_e911||{}));c.find("#postal_code").blur(function(){t.getJSON("http://www.geonames.org/postalCodeLookupJSON?&country=US&callback=?",{postalcode:t(this).val()},function(e){e&&e.postalcodes.length&&e.postalcodes[0].placeName&&(c.find("#locality").val(e.postalcodes[0].placeName),c.find("#region").val(e.postalcodes[0].adminName1))})}),c.find(".inline_field > input").keydown(function(){o.find(".gmap_link_div").hide()}),c.find("#submit_btn").on("click",function(c){c.preventDefault();var r=i.ui.getFormData("e911");s.extend(e,{dash_e911:r});var u=function(e){var t=i.util.formatPhoneNumber(e.data.id),s=i.template(d,"!"+d.i18n.active().e911.successE911,{phoneNumber:t});a.success(s),o.dialog("destroy").remove(),n.success&&n.success(e)};d.e911UpdateNumber(e.id,e,{success:function(e){u(e)},multipleChoices:function(a){var n,o=t(i.template(d,"e911-addressesDialog",a));o.find(".address-option").on("click",function(){o.find(".address-option.active").removeClass("active"),t(this).addClass("active"),o.find(".save-address").removeClass("disabled")}),o.find(".cancel-link").on("click",function(){n.dialog("destroy").remove()}),o.find(".save-address").on("click",function(){if(o.find(".address-option").hasClass("active")){var t=o.find(".address-option.active").data("id"),i=a.details[t];s.extend(e,{dash_e911:i}),d.e911UpdateNumber(e.id,e,{success:function(e){n.dialog("destroy").remove(),u(e)}})}}),n=i.ui.dialog(o,{title:d.i18n.active().e911.chooseAddressPopup.title})},invalidAddress:function(e){i.ui.alert("error",d.i18n.active().e911.invalidAddress)}})}),c.find("#remove_e911_btn").on("click",function(t){t.preventDefault(),d.callApi({resource:"numbers.list",data:{accountId:d.accountId},success:function(t,c){var r=s.countBy(t.data.numbers,function(e){return"features"in e&&e.features.indexOf("dash_e911")>=0})["true"];r>1?(delete e.dash_e911,d.e911UpdateNumber(e.id,e,{success:function(e){var t=i.util.formatPhoneNumber(e.data.id),s=i.template(d,"!"+d.i18n.active().e911.successE911,{phoneNumber:t});a.success(s),o.dialog("destroy").remove(),n.success&&n.success(e)}})):i.ui.alert(d.i18n.active().e911.lastE911Error)}})}),o=i.ui.dialog(c,{title:d.i18n.active().e911.dialogTitle});var r=o.find("#e911_rotated_text"),u=r.width()/2;r.css({top:40+u+"px",left:25-u+"px"})},e911UpdateNumber:function(e,t,s){var i=this;i.callApi({resource:"numbers.update",data:{accountId:i.accountId,phoneNumber:encodeURIComponent(e),data:t,generateError:!1},success:function(e,t){s.success&&s.success(e)},error:function(e,i,a){"400"===e.error?"multiple_choice"===t.message?s.multipleChoices&&s.multipleChoices(e.data.multiple_choice.dash_e911):s.invalidAddress&&s.invalidAddress(e.data.address.invalid):a(e,{generateError:!0})}})}};return n});