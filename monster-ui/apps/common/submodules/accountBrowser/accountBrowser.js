define(["require","jquery","underscore","monster"],function(a){var n=a("jquery"),t=a("underscore"),c=a("monster"),e={requests:{},subscribe:{"common.accountBrowser.render":"accountBrowserRender"},accountBrowserRender:function(a){var t=this,e=a.container,o=a.parentId,r=a.selectedId,i=a.onAccountClick,s=a.onChildrenClick,d=a.onBackToParentClick,u=a.onNewAccountClick,l=a.onSearch,f=a.addCurrentAccount||!1,h=a.addBackButton||!1,p=a.allowBackOnMasquerading||!1,k=a.callback,B=n(c.template(t,"accountBrowser-layout",{customClass:a.customClass||"ab-sidebar",addAccountEnabled:"function"==typeof u})),v=B.find(".account-search-link").remove();if(!e)throw new ReferenceError('The "container" arg is required to load the account browser.');e.empty().append(B),t.accountBrowserRenderList({container:B.find(".account-list-container"),parentId:o,selectedId:r,addCurrentAccount:f,addBackButton:h,allowBackOnMasquerading:p,callback:k}),t.accountBrowserBindEvents({template:B,onAccountClick:i,onChildrenClick:s,onBackToParentClick:d,onNewAccountClick:u,addCurrentAccount:f,addBackButton:h,allowBackOnMasquerading:p,searchLink:v,onSearch:l})},accountBrowserBindEvents:function(a){var e=this,o=a.template,r=a.onAccountClick,i=a.onChildrenClick,s=a.onBackToParentClick,d=a.onNewAccountClick,u=a.searchLink,l=a.addCurrentAccount,f=a.addBackButton,h=a.allowBackOnMasquerading,p=a.onSearch,k=o.find(".account-list"),B=!1,v=n('<li class="content-centered account-list-loader"> <i class="fa fa-spinner fa-spin"></i></li>');setTimeout(function(){o.find(".search-query").focus()}),o.on("click",function(a){a.stopPropagation()}),o.find(".account-list-add").on("click",function(){d&&d()});var m=function(a,n){var c=!1;return t.each(n,function(n){n.toString().toLowerCase().indexOf(a.toLowerCase())>=0&&(c=!0)}),c};o.find(".account-browser-search").on("keyup",function(a){var t=n(this),c=t.val();u.find(".account-search-value").text(c),13==a.which?o.find(".account-search-link").click():c?(n.each(o.find(".account-list-element"),function(){var a=n(this),t=a.data();m(c,t)?a.show():a.hide()}),k.prepend(u)):(o.find(".account-list-element").show(),u.remove())}),k.on("click",".account-link",function(){var a=n(this).parents(".account-list-element");o.find(".account-list-element").removeClass("active"),a.addClass("active"),r&&r(a.data("id"),a.data("name"))}),k.on("click",".account-children-link:not(.disabled)",function(){var a=n(this),c=a.parents(".account-list-element"),r=c.data("id"),s=c.data("name"),d=(k.data("current"),k.data("search-value"),a.hasClass("local-back"));a.addClass("disabled"),o.find(".account-browser-search").prop("disabled",!1).val("");var u=function(a,n,c){e.accountBrowserRenderList({container:o.find(".account-list-container"),parentId:a,selectedId:n,slide:c?!1:!0,addCurrentAccount:l,addBackButton:f,allowBackOnMasquerading:h,callback:function(e){var r={parentName:s,children:e.accounts};if(c){if(n){o.find(".account-list").scrollTop(0);var d=o.find(".account-list li.active").position().top-o.find(".account-list li:first-child").position().top;o.find(".account-list").scrollTop(d)}t.each(c,function(n){n.id===a&&(r.parentName=n.name)})}i&&i(r)}})};o.find(".account-search-link").removeClass("active").remove(),d?e.callApi({resource:"account.listParents",data:{accountId:r},success:function(a,n){a.data.length>1?u(a.data[a.data.length-2].id,a.data[a.data.length-1].id,a.data):u(a.data[a.data.length-1].id,null,a.data)}}):u(r)}),k.on("click",".account-search-link",function(){if(u.hasClass("active"))k.data("search-value",null),u.removeClass("active").remove(),o.find(".account-browser-search").prop("disabled",!1).val(""),p&&p(),e.accountBrowserRenderList({container:o.find(".account-list-container"),addBackButton:f,allowBackOnMasquerading:h,addCurrentAccount:l});else{var a=u.find(".account-search-value").text();u.addClass("active").remove(),p&&p(a),e.accountBrowserRenderList({container:o.find(".account-list-container"),searchValue:a,slide:!1,addCurrentAccount:l,addBackButton:f,allowBackOnMasquerading:h,showLocalBackButton:!0,callback:function(){o.find(".account-browser-search").prop("disabled",!0),k.prepend(u)}})}}),k.on("scroll",function(){if(!B&&k.data("next-key")&&k.scrollTop()>=k[0].scrollHeight-k.innerHeight()-100){B=!0,k.append(v);var a=k.data("search-value"),t=a?"account.searchByName":"account.listChildren",o=a?{accountName:a}:{accountId:k.data("current")},r=k.data("next-key");e.callApi({resource:t,data:n.extend(!0,o,{filters:{start_key:encodeURIComponent(r)}}),success:function(a,t){var o=a.next_start_key,r=n(c.template(e,"accountBrowser-list",{accounts:c.util.sort(a.data)}));v.remove(),k.append(r),k.data("next-key",o||null),B=!1}})}}),f&&k.on("click",".account-previous-link",function(){var a=k.data("current")||e.accountId,n=h?c.apps.auth.originalAccount.id:e.accountId;a!==n&&e.callApi({resource:"account.listParents",data:{accountId:a},success:function(a,n){if(a.data&&a.data.length>0){var t=a.data[a.data.length-1].id,c=a.data[a.data.length-1].name;o.find(".account-browser-search").prop("disabled",!1).val(""),e.accountBrowserRenderList({container:o.find(".account-list-container"),parentId:t,addCurrentAccount:l,addBackButton:f,allowBackOnMasquerading:h,callback:function(a){var n={parentName:c,children:a.accounts};s&&s(n)}})}}})})},accountBrowserRenderList:function(a){var t=this,e=a.container,o=a.parentId||t.accountId,r=a.selectedId,i=a.slide,s=a.searchValue,d=a.addCurrentAccount,u=a.addBackButton,l=a.showLocalBackButton,f=a.allowBackOnMasquerading,h=a.callback,p=f?c.apps.auth.originalAccount.id:t.accountId;o===p&&(u=!1),t.accountBrowserGetData(s,o,function(a){var f=a.next_start_key,p=e.find(".account-list-slider"),k=e.find(".account-list"),B={accounts:c.util.sort(a.data),selectedId:r,addBackButton:u,showLocalBackButton:l};d&&(B.currentAccount=c.apps.auth.currentAccount);var v=n(c.template(t,"accountBrowser-list",B)),m=function(){w(),k.data("next-key",f||null),k.data("current",o),k.data("search-value",s||null),h&&h(B)},w=function(){if(-1!=navigator.userAgent.indexOf("Mac OS X")&&-1!=navigator.userAgent.toLowerCase().indexOf("chrome")){var a=k.css("margin-left");k.css("margin-left","1px"),setTimeout(function(){k.css("margin-left",a)},1)}};i?(p.empty().append(v),k.animate({marginLeft:-k.outerWidth()},400,"swing",function(){k.empty().append(p.html()).css("marginLeft","0px"),p.empty(),m()})):(k.empty().append(v),m())})},accountBrowserGetData:function(a,n,t){var c=this,e=a?"account.searchAll":"account.listChildren",o=a?{searchValue:a}:{accountId:n};c.callApi({resource:e,data:o,success:function(a){var n=c.accountBrowserFormatGetData(a);t&&t(n)}})},accountBrowserFormatGetData:function(a){var n={data:[]};if(t.isArray(a.data))n=a;else{var c={},e=function(a){t.each(a,function(a){c.hasOwnProperty(a.id)||(n.data.push(a),c[a.id]=!0)})};t.each(a.data,function(a){e(a)})}return n}};return e});