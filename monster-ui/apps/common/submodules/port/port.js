define(["require","jquery","underscore","fileupload","monster","toastr"],function(e){var t=e("jquery"),n=e("underscore"),r=(e("fileupload"),e("monster")),a=e("toastr"),o={requests:{"common.numbers.metadata":{apiRoot:r.config.api.phonebook,url:"locality/metadata?lerg_lookup=true",verb:"POST"}},subscribe:{"common.port.render":"portRender"},isLaunchedInAppMode:!0,defaultStateToDisplay:"allOpenState",states:[{value:"unconfirmed",next:[1,6]},{value:"submitted",next:[2,4,6]},{value:"pending",next:[3,4,5,6]},{value:"scheduled",next:[4,5,6]},{value:"rejected",next:[1,5,6]},{value:"completed",next:[]},{value:"canceled",next:[]}],portRender:function(e){var t=this,e=e||{},a=e.accountId||t.accountId,o={width:"940px",position:["center",20],title:t.i18n.active().port.dialogTitle,autoOpen:!1,dialogClass:"port-container-dialog"},i=e.hasOwnProperty("parent")?e.parent:r.ui.dialog("",o);n.each(t.states,function(e,n){e.text=t.i18n.active().port.state[e.value]}),e.hasOwnProperty("accountId")?t.isLaunchedInAppMode=!1:t.isLaunchedInAppMode=!0,t.portRenderPendingOrder(i,a)},portFormatPendingOrderData:function(e){return e=e.filter(function(e){return e.port_requests.length>0}),e.forEach(function(e,t){e.port_requests.sort(function(e,t){return e.updated<t.updated?1:-1})}),e},portRenderPendingOrder:function(e,n){var a=this,o=[{value:"allOpenState",text:a.i18n.active().port.extraStatuses.allOpen},{value:"allState",text:a.i18n.active().port.extraStatuses.all}].concat(a.states),i=t(r.template(a,"port-pendingOrders",{states:o,defaultStateToDisplay:a.defaultStateToDisplay,isLaunchedInAppMode:a.isLaunchedInAppMode}));e.empty().append(i),a.portBindPendingOrderEvents(e,n),a.portRenderPendingOrderListing(e,n,a.defaultStateToDisplay),e.hasClass("ui-dialog-content")&&e.dialog("open")},portToggleRequestsDisplay:function(e,n,r,a){var o=e.find(".accounts-list > .requests-wrapper"),i=o.hasClass("empty"),s=e.find(".account-section");if("accounts"===r){if(!i){var d={};o.addClass("empty"),o.find(".request-box").each(function(n,r){var a=t(r),o=a.data("account_id");d.hasOwnProperty(o)?d[o].push(a):d[o]=[a],e.find('.account-section[data-id="'+o+'"] .requests-wrapper').append(a)});for(var n in d)e.find('.account-section[data-id="'+n+'"] .requests-wrapper').append(d[n].sort(function(e,n){return t(e).data("updated_date")<n.data("updated_date")?1:-1}))}a?s.show():s.fadeIn(400)}else if("requests"===r&&i){var c=function(){o.append(e.find(".request-box").sort(function(e,n){return t(e).data("updated_date")<t(n).data("updated_date")?1:-1})),o.removeClass("empty")};a?(s.hide(),c()):s.fadeOut(400,c)}},portBindPendingOrderEvents:function(e,n,o){var i=this,s=e.find("#orders_list");i.portPositionDialogBox(),s.find("span.pull-right a").on("click",function(){i.portRenderAddNumber(e,n)}),s.find(".search-numbers").on("click",function(){var t=s.find("#search_input").val();/(\+1|1)?([0-9]{10})/.test(t)?i.portSearchNumber({data:{accountId:n,number:t},success:function(a){s.find(".filter-options").hide(),s.find("#number_searched").text(r.util.formatPhoneNumber(t)),s.find("#search_indicator").removeClass("hidden"),i.portRenderPendingOrderListing(e,n,void 0,a)}}):a.error(i.i18n.active().port.toastr.error.number)}),s.find("#search_indicator").on("click",function(){t(this).addClass("hidden"),s.find("#search_input").val(""),s.find(".filter-options").show(),s.find(".filter-select").val(i.defaultStateToDisplay),i.portRenderPendingOrderListing(e,n,i.defaultStateToDisplay)}),s.find(".filter-options .btn-group:first-child .btn").on("click",function(){var e=t(this);e.hasClass("active")||(e.siblings().removeClass("active"),e.addClass("active"),i.portToggleRequestsDisplay(s,n,e.data("value")))}),s.find(".filter-options .btn-group:last-child .filter-select").on("change",function(){i.portRenderPendingOrderListing(e,n,t(this).val())})},portRenderPendingOrderListing:function(e,n,a,o){var i=this,s=e.find(".accounts-list"),d=function(a){var d={data:i.portFormatPendingOrderData(a),isAdmin:r.util.isSuperDuper()},c=t(r.template(i,"port-pendingOrdersList",d));s.empty().append(c),(!i.isLaunchedInAppMode||o)&&i.portToggleRequestsDisplay(s,n,"requests",!0),i.portRenderDynamicCells(e,a),i.portBindPendingOrderListingEvents(e,n,a)};o?d(o):i.portListRequests(n,a,function(e){d(e)})},portBindPendingOrderListingEvents:function(e,o,i){var s=this,d=e.find(".accounts-list");d.find(".account-header").on("click",function(){var e=t(this).parents(".account-section");e.hasClass("active")?e.find(".requests-wrapper").slideUp(function(){e.find(".left-part i").removeClass("fa-chevron-down monster-white").addClass("fa-chevron-right"),e.removeClass("active")}):(e.addClass("animate"),e.find(".requests-wrapper").slideDown(function(){e.find(".left-part i").removeClass("fa-chevron-right").addClass("fa-chevron-down monster-white"),e.removeClass("animate"),e.addClass("active")}))}),d.find(".account-ancestors").on("click",function(e){e.stopPropagation();var n=t(this).parents(".account-section").data("id");r.pub("common.accountAncestors.render",{accountId:n})}),d.find(".request-box .request-state").on("change",".switch-state",function(n){var o=t(this),c=o.parents(".request-box"),u=c.data("account_id"),p=c.data("id"),l=s.portGetRequest(u,p,i),f=o.val();"rejected"===f?s.portRequestChangeState(u,p,f,function(e){delete e.scheduled_date,s.portRequestUpdate(u,p,e,function(e){s.portUpdateData(u,e,i),s.portRenderDynamicCells(d,e),c.find(".actions .dropdown-menu").prepend(r.template(s,"port-orderActions")),a.success(s.i18n.active().port.toastr.success.request.update)})}):"scheduled"===f?s.portRenderScheduledDatePopup(e,{callbackSave:function(e){s.portRequestChangeState(u,p,f,function(t){t.scheduled_date=e,s.portRequestUpdate(u,p,t,function(e){s.portUpdateData(u,e,i),s.portRenderDynamicCells(d,e),a.success(s.i18n.active().port.toastr.success.request.update)})},function(){a.error(s.i18n.active().port.toastr.error.request.update)})},callbackCancel:function(){s.portRenderDynamicCells(d,l)}}):s.portRequestChangeState(u,p,f,function(e){s.portUpdateData(u,e,i),s.portRenderDynamicCells(d,e),c.find(".continue-request, .delete-request").remove(),a.success(s.i18n.active().port.toastr.success.request.update)},function(){a.error(s.i18n.active().port.toastr.error.request.update)},function(){s.portRenderDynamicCells(d,l)})}),d.find(".request-box .scheduled-date .edit").on("click",function(){var n=t(this),a=n.parents(".request-box").data("account_id"),o=n.parents(".request-box").data("id"),d=s.portGetRequest(a,o,i),c=d.scheduled_date;s.portRenderScheduledDatePopup(e,{scheduledDate:c,callbackSave:function(e){t.extend(!0,d,{scheduled_date:e}),s.portRequestUpdate(a,o,d,function(e){s.portUpdateData(a,e,i),n.text(r.util.toFriendlyDate(r.util.gregorianToDate(e.scheduled_date),"shortdatetime"))})}})}),d.find(".request-box .actions").on("click","li",function(){var o,d=t(this),c=d.parents(".request-box").data("account_id"),u=d.parents(".request-box").data("id"),p=s.portGetRequest(c,u,i);if(d.hasClass("continue-request")){var l={orders:[p]};o=r.template(s,"port-submitDocuments",{whitelabelPort:r.config.whitelabel.port,port:p}),e.empty().append(o),s.portRenderSubmitDocuments(e,c,l)}else if(d.hasClass("info-request")){var f={};p.hasOwnProperty("uploads")&&n.each(p.uploads,function(e,t){var r=t.slice(0,-4);f[r]=n.extend(e,{name:t})});var m,h={position:["center",20],title:s.i18n.active().port.infoPopup.title};o=r.template(s,"port-requestInfo",{request:p,uploads:f}),m=t(r.ui.dialog(o,h)),m.find(".download").on("click",function(e){e.preventDefault();var n=t(this).data("type");s.portRequestGetAttachment(c,p.id,f[n].name,function(e){s.portGhettoAttachmentDownload(f[n].name,e)})})}else d.hasClass("delete-request")?s.portRequestDelete(c,u,function(){d.parents(".request-box").remove(),a.success(s.i18n.active().port.toastr.success.request["delete"])}):d.hasClass("comments-request")&&s.portRenderComments(e,c,u)})},portRenderScheduledDatePopup:function(e,n){var a=this,o=n.hasOwnProperty("scheduledDate")?{scheduledDate:n.scheduledDate}:{},i=t(r.template(a,"port-editScheduledDate",o)),s=r.ui.dialog(i,{title:a.i18n.active().port.pendingOrders.scheduledDatePopup.title,beforeClose:function(e,t){n.hasOwnProperty("callbackCancel")&&n.callbackCancel()}});a.portBindScheduledDatePopupEvents(e,s,n)},portBindScheduledDatePopupEvents:function(e,n,a){var o=n.find("#scheduled_time"),i=n.find("#scheduled_date"),s={minDate:new Date,beforeShowDay:t.datepicker.noWeekends};r.ui.timepicker(o),r.ui.datepicker(i,s),n.find(".save-link").on("click",function(){var e=1e3*o.timepicker("getSecondsFromMidnight"),t=i.datepicker("getDate").getTime(),s=r.util.dateToGregorian(new Date(t+e));n.dialog("close"),a.hasOwnProperty("callbackSave")&&a.callbackSave(s)}),n.find(".cancel-link").on("click",function(){n.dialog("close")})},portRenderComments:function(e,a,o){var i=this;i.portRequestGet(a,o,function(e){var o=t(r.template(i,"port-commentsPopup",{isAdmin:r.apps.auth.originalAccount.superduper_admin})),s=e.hasOwnProperty("comments")?e.comments:[],d=function(){var t={width:"960px",position:["center",20],title:i.i18n.active().port.commentsPopup.title},n=r.ui.dialog(o,t);i.portBindCommentsEvents(n,a,e,s)};n.isEmpty(s)?(o.find(".comments").hide(),d()):i.portRequestListUsers(a,function(e){e=function(e){var t={};return e.forEach(function(e,n){t[e.id]=e.first_name.concat(" ",e.last_name)}),t}(e),s.forEach(function(t,n){t.author=e[t.user_id],t.isAdmin=r.apps.auth.originalAccount.superduper_admin,(t.superduper_comment?r.apps.auth.originalAccount.superduper_admin:!0)&&(o.find(".comments").append(r.template(i,"port-comment",t)),o.find(".comments .comment:last-child .comment-body").html(t.content))}),d()})})},portBindCommentsEvents:function(e,o,i,s){var d=this;r.ui.wysiwyg(e.find(".wysiwyg-container")),e.find(".comments").on("click",".delete-comment",function(){var c=t(this),u=c.parents(".comment"),p=c.data("id"),l=n.findIndex(s,function(e){return e.timestamp===p});r.ui.confirm(d.i18n.active().port.infoPopup.confirm.deleteComment,function(){d.portRequestDeleteComment(o,i.id,l,function(n){s=n,u.fadeOut("400",function(){t(this).remove(),0===e.find(".comment").length&&e.find(".comments").slideUp(),a.success(d.i18n.active().port.toastr.success.comment["delete"])})})})}),e.find(".actions .add-comment").on("click",function(){var n=r.apps.auth.currentUser,a={user_id:d.userId,timestamp:r.util.dateToGregorian(new Date),content:e.find(".wysiwyg-editor").html(),superduper_comment:e.find("#superduper_comment").is(":checked")};d.portRequestAddComment(o,i.id,a,function(o){s=o,a.author=n.first_name.concat(" ",n.last_name),a.isAdmin=r.apps.auth.originalAccount.superduper_admin,e.find(".comments").show().append(t(r.template(d,"port-comment",a))),e.find(".comments .comment:last-child .comment-body").html(a.content),e.find(".comments").animate({scrollTop:e.find(".comments").scrollTop()+e.find(".comments .comment:last-child").position().top},300,function(){r.ui.highlight(t(this).find(".comment:last-child"))}),e.find(".wysiwyg-editor").empty()})})},portRequestAddComment:function(e,t,r,a){var o=this,i={comments:n.isArray(r)?r:[r]};o.callApi({resource:"port.addComment",data:{accountId:e,portRequestId:t,data:i},success:function(e,t){a&&a(e.data&&e.data.comments)}})},portRequestDeleteComment:function(e,t,n,r){var a=this;a.callApi({resource:"port.deleteComment",data:{accountId:e,portRequestId:t,commentId:n},success:function(e,t){r&&r(e.data&&e.data.comments)}})},portRenderAddNumber:function(e,t){var n=this,a=r.template(n,"port-addNumbers");e.empty().append(a),n.portBindAddNumberEvents(e,t)},portBindAddNumberEvents:function(e,t){var n=this,r=e.find("div#add_numbers");n.portPositionDialogBox(),n.portComingSoon(r,[".help-links li:not(.separator) a"]),r.find("#add_numbers_link").on("click",function(o){var i=r.find("input").val().split(" ");i.forEach(function(e,t,n){/^(\+1|1[0-9]{10})/.test(e)&&(n[t]=e.replace(/(\+1|1)?([0-9]{10})/,"$2"))}),i=i.filter(function(e,t,n){return e&&/^[0-9]{10}$/.test(e)}),0===i.length?(a.error(n.i18n.active().port.toastr.error.numbers),r.find("div.row-fluid").addClass("error")):n.portFormatNumbers(i,function(a){a.orders.length>0?(r.find("div.row-fluid").removeClass("error"),r.find("#numbers_list")[0].value="",r.find("button").unbind("click"),n.portRenderManagerOrders(e,t,a)):r.find("#numbers_list")[0].value=""})})},portRenderManagerOrders:function(e,n,a){var o=this,i=t(r.template(o,"port-manageOrders",a));i.insertAfter(e.find("#add_numbers")),o.portBindManageOrdersEvents(e,n,a)},portBindManageOrdersEvents:function(e,o,i){var s=this,d=e.find("#port_container");s.portPositionDialogBox(),s.portCancelOrder(e,o,d),s.portComingSoon(d,["#footer .help-links li:not(.separator) a"]),d.find("#add_numbers_link").on("click",function(){var e=d.find("div#add_numbers").find("input").val().split(" "),o=[];d.find("#manage_orders li").each(function(){o.push(t(this).data("value").toString())}),e.forEach(function(e){/^(\+1|1[0-9]{10})/.test(e)&&(e=e.replace(/^(\+1|1)?([0-9]{10})$/,"$2"))}),e=e.filter(function(e){return e&&/^[0-9]{10}$/.test(e)&&o.indexOf(e)<0}),0===e.length?(a.error(s.i18n.active().port.toastr.error.numbers),d.find("div#add_numbers").find("div.row-fluid").addClass("error")):s.portFormatNumbers(e,function(e){d.find("#numbers_list")[0].value="",d.find("div#add_numbers").find("div.row-fluid").removeClass("error"),n.each(e.orders,function(a,o){d.find("#manage_orders .order").each(function(){var i=t(this),s=i.data("carrier");s===a.carrier&&(n.each(a.numbers,function(e){i.find("ul").append('<li data-value="'+e+'" data-carrier="'+s+'"><i class="fa fa-exclamation-triangle"></i>'+r.util.formatPhoneNumber(e)+'<i class="fa fa-times-circle pull-right"></i></li>')}),e.orders.splice(o,1))}),0!==e.orders.length&&d.find("#manage_orders").find(".row-fluid:last-child").append(t(r.template(s,"port-order",e.orders[o])))})})}),d.on("click","#manage_orders li .remove-number",function(){var n=t(this),r=n.parent().parent();n.parent().remove(),r.is(":empty")&&r.parent().parent().remove(),d.find("div#manage_orders").find(".row-fluid:last-child").is(":empty")&&(d.find("div#manage_orders").find(".row-fluid:last-child").animate({height:"0px"},500),s.portRenderAddNumber(e,o))}),d.find("#manage_orders_next_link").on("click",function(){var n=d.find("#eula form");if(r.ui.validate(n,{messages:{"conditions[]":{required:s.i18n.active().port.requiredConditions,minlength:s.i18n.active().port.requiredConditions}},errorPlacement:function(e,t){e.insertAfter(d.find("#eula form .control-group:last-child"))}}),r.ui.valid(n)){var a={orders:[]};d.find("div#manage_orders").find("div.order").each(function(){var e=t(this),n={},r=[];t.each(e.find("li"),function(e,n){r.push(t(n).data("value"))}),n.carrier=e.find("li:first-child").data("carrier"),n.numbers=r,a.orders.push(n)}),i.orders.forEach(function(e,n){for(var r=0,o=a.orders.length;o>r;r++)if(a.orders[r].carrier===e.carrier){t.extend(!0,a.orders[r],e);break}}),s[1===a.orders.length?"portRenderSubmitDocuments":"portRenderResumeOrders"](e,o,a)}else d.find("div#eula").find("input").each(function(){t(this).is(":checked")?t(this).parents(".control-group").removeClass("error"):t(this).parents(".control-group").addClass("error")})})},portRenderResumeOrders:function(e,n,a){var o=this,i=t(r.template(o,"port-resumeOrders",a));t.each(i.find(".row-fluid"),function(e,n){n=t(n),n.find(".order-key").text((parseInt(n.find(".order-key").text(),10)+1).toString())}),e.empty().append(i),o.portBindResumeOrdersEvents(e,n,a)},portBindResumeOrdersEvents:function(e,n,r){var a=this,o=e.find("#resume_orders");a.portPositionDialogBox(),o.find(".resume-order-btn").on("click",function(){var o=t(this).data("index");a.portRenderSubmitDocuments(e,n,r,o)})},portRenderSubmitDocuments:function(e,n,a,o){var i=this,o=o||0,s=t(r.template(i,"port-submitDocuments",{whitelabelPort:r.config.whitelabel.port,port:a.orders[o]}));e.empty().append(s),i.portBindSubmitDocumentsEvents(e,n,a,o)},portBindSubmitDocumentsEvents:function(e,n,o,i){var s=this,d=e.find("#port_container");s.portPositionDialogBox(),s.portCancelOrder(e,n,d,o,i),s.portComingSoon(d,["#upload_bill .row-fluid.info a","#loa p a:not(#sign_doc)","#footer .help-links li:not(.separator) a"]),d.find(".file-upload-container input").each(function(e,r){var d=t(r),c=d.data("name"),u={btnText:s.i18n.active().port.submitDocuments.changeButton,mimeTypes:["application/pdf"],wrapperClass:"input-append",success:function(e){console.log(c),o.orders[i].hasOwnProperty("id")?(console.log("existing order"),o.orders[i].hasOwnProperty(c.concat(".pdf"))?(console.log("existing file"),s.portRequestUpdateAttachment(n,o.orders[i].id,c.concat(".pdf"),e[0].file,function(){console.log("file uploaded"),o.orders[i][c.concat("_attachment")]=e[0].file})):(console.log("new file"),s.portRequestAddAttachment(n,o.orders[i].id,c.concat(".pdf"),e[0].file,function(){console.log("file uploaded"),o.orders[i][c.concat("_attachment")]=e[0].file}))):(console.log("new order"),o.orders[i][c.concat("_attachment")]=e[0].file)},error:function(e){for(var t in e)e[t].length>0&&a.error(s.i18n.active().port.toastr.error[t].concat(e[t].join(", ")))}};o.orders[i].hasOwnProperty("uploads")&&o.orders[i].uploads.hasOwnProperty(c.concat(".pdf"))&&(u.filesList=[c.concat(".pdf")]),"bill"===c?(u.bigBtnClass="btn btn-success span12",u.bigBtnText=s.i18n.active().port.submitDocuments.uploadBillButton,u.btnClass="btn btn-success"):(u.bigBtnClass="btn span10",u.btnClass="btn","loa"===c?u.bigBtnText=s.i18n.active().port.submitDocuments.loaUploadStep:"resporg"===c&&(u.bigBtnText=s.i18n.active().port.submitDocuments.resporg.uploadStep)),d.fileUpload(u)}),d.find("#upload_bill .remove-number").on("click",function(){var r=t(this).parent(),a=r.parent(),d=r.data("value"),c=o.orders[i].numbers.indexOf(d);c>=0&&(o.orders[i].numbers.slice(c,1),r.remove()),a.is(":empty")&&(o.orders.length>1?(o.orders.splice(i,1),s.portRenderResumeOrders(e,n,o)):s.portReloadApp(e,n))}),d.find("#submit_documents_add_numbers_link").on("click",function(){e.empty().append(r.template(s,"port-addNumbers")),s.portRenderManagerOrders(e,n,o)}),d.find("#submit_documents_save_link").on("click",function(){var a=d.find("#transfer_name_form");if(r.ui.validate(a),r.ui.valid(a)){var c=r.ui.getFormData("transfer_name_form",".",!0),u=r.ui.getFormData("bill_form",".",!0);t.extend(!0,o.orders[i],u,c),s.portSaveOrder(e,n,o,i)}else d.find(".monster-invalid").length>0&&t("html, body").animate({scrollTop:d.find(".monster-invalid").first().offset().top-10},300)}),d.find("#submit_documents_next_link").on("click",function(){var a=o.orders[i],c=a.hasOwnProperty("bill_attachment")||a.hasOwnProperty("uploads")&&a.uploads.hasOwnProperty("bill.pdf")?!0:!1,u=a.hasOwnProperty("loa_attachment")||a.hasOwnProperty("uploads")&&a.uploads.hasOwnProperty("loa.pdf")?!0:!1,p=d.find("#transfer_name_form"),l=d.find("#bill_form"),f=!0;if(r.ui.validate(p),r.ui.validate(l),r.ui.valid(p)||(f=!1),r.ui.valid(l)||(f=!1),c&&u||(f=!1,r.ui.alert("error",s.i18n.active().port.toastr.error.submit.document)),f){var m=r.ui.getFormData("transfer_name_form"),h=r.ui.getFormData("bill_form");a.hasOwnProperty("id")&&(delete a.bill_attachment,delete a.loa_attachment,delete a.resporg_attachment),t.extend(!0,a,h,m),s.portRenderConfirmOrder(e,n,o,i)}else d.find(".monster-invalid").length>0&&t("html, body").animate({scrollTop:d.find(".monster-invalid").first().offset().top-10},300)})},portRenderConfirmOrder:function(e,n,a,o){var i=this,s=a.orders[o],d=new Date,c=r.util.getBusinessDate(4),u=s.hasOwnProperty("created")?s.created:d,p=s.hasOwnProperty("transfer_date")?r.util.gregorianToDate(s.transfer_date):c,l=c.getTime()>=p.getTime(),f=t.extend(!0,{},s,{total:s.numbers.length,transfer_date:l?c:p,created:u}),m=t(r.template(i,"port-confirmOrder",f));e.empty().append(m),i.portBindConfirmOrderEvents(e,n,a,o)},portBindConfirmOrderEvents:function(e,n,a,o){var i=this,s=e.find("#port_container"),d=s.find("input.date-input"),c=a.orders[o];i.portPositionDialogBox(),i.portCancelOrder(e,n,s,a,o),i.portComingSoon(s,["#footer .help-links li:not(.separator) a"]),r.ui.datepicker(d,{minDate:r.util.getBusinessDate(4),beforeShowDay:t.datepicker.noWeekends,onSelect:function(e,t){var n=s.find("#transfer_schedule_date"),r=n.css("color"),a=200;n.animate({color:n.css("backgroundColor")},a,function(){n.text(e),n.animate({color:r},a)})}}),s.find("#numbers_to_buy option").last().prop("selected","selected"),s.find("#numbers_to_buy option").each(function(e,n){var r=t(n);r.val(parseInt(r.val(),10)+1).text(r.val())}),s.find("#confirm_order_save_link").on("click",function(){var s=r.ui.getFormData("notification_email_form",".",!0),d=r.ui.getFormData("transfer_date_form");t.extend(!0,c,s,d),c.transfer_date=r.util.dateToGregorian(new Date(c.transfer_date)),i.portSaveOrder(e,n,a,o)}),s.find("#confirm_order_add_numbers_link").on("click",function(){e.empty().append(r.template(i,"port-addNumbers")),i.portRenderManagerOrders(e,n,a)}),s.find("#confirm_order_submit_link").on("click",function(){var d=s.find("#notification_email_form");if(r.ui.validate(d),r.ui.valid(d)){var u=r.ui.getFormData("notification_email_form"),p=r.ui.getFormData("transfer_date_form");t.extend(!0,c,u,p),c.transfer_date=r.util.dateToGregorian(new Date(c.transfer_date)),c.hasOwnProperty("id")?i.portRequestUpdate(n,c.id,c,function(){c.hasOwnProperty("port_sate")?i.portReloadApp(e,n):i.portRequestChangeState(n,c.id,"submitted",function(){i.portReloadApp(e,n)})}):i.portRequestAdd(n,c,function(t){a.orders.splice(o,1),i.portRequestChangeState(n,t,"submitted",function(){a.orders.length>0?i.portRenderResumeOrders(e,n,a):i.portReloadApp(e,n)},function(){},function(){i.portRequestDelete(n,t)})})}else s.find(".monster-invalid").length>0&&t("html, body").animate({scrollTop:s.find(".monster-invalid").first().offset().top-10},300)})},portSearchNumber:function(e){var t=this,a=e.data.accountId,o=e.data.number;r.parallel({account:function(e){t.portRequestSearchNumber(a,o,function(t){e(null,t)})},descendants:function(e){t.isLaunchedInAppMode?t.portRequestSearchNumberByDescendants(a,o,function(t){e(null,t)}):e(null,[])}},function(r,a){var o=a.account.concat(a.descendants);o.length>1&&(o=n.uniq(o,function(e,t){return e.id})),1===o.length?t.portRequestGetAccount(o[0].account_id,function(t){e.success([{account_id:o[0].account_id,account_name:t.name,port_requests:o}])}):e.success([])})},portListRequests:function(e,t,n){var a=this;r.parallel({requests:function(n){var r={accountId:e,state:a.isLaunchedInAppMode?t:"all",withDescendants:!1,success:function(e){n(null,e)}};a.portRequestList(r)},descendants:function(n){if(a.isLaunchedInAppMode){var r={accountId:e,state:t,withDescendants:!0,success:function(e){n(null,e)}};a.portRequestList(r)}else n(null,[])}},function(t,a){var o=a.descendants.sort(function(e,t){return e.account_name.toLowerCase()>t.account_name.toLowerCase()?1:-1});a.requests.length&&o.unshift({account_id:e,account_name:r.apps.auth.currentAccount.name,port_requests:a.requests});for(var i=0,s=o.length;s>i;i++)o[i].amount=o[i].port_requests.length;n(o)})},portRenderDynamicCells:function(e,a){var o=this,i=function(e){var t=o.states,r=[];return e=n.find(t,function(t,n){return t.value===e}),n.each(e.next,function(e,n){r.push(t[e])}),r.unshift(e),r},s=function(n){var a=e.find('.request-box[data-id="'+n.id+'"]'),s=r.apps.auth.originalAccount.superduper_admin,d=a.find(".scheduled-date"),c=a.find(".request-state"),u=n.port_state;if(a.data({state:u,scheduled_date:n.hasOwnProperty("scheduled_date")?n.scheduled_date:"",updated_date:n.updated}),s)if("completed"===u)c.empty().text(o.i18n.active().port.state[u]),d.empty();else{var p;c.empty().append(t(r.template(o,"port-selectStates",{states:i(u)}))),"scheduled"===u?(n.hasOwnProperty("scheduled_date")&&(p={scheduledDate:n.scheduled_date}),d.empty().append(t(r.template(o,"port-scheduledDateCell",p)))):d.empty().text(o.i18n.active().port.noScheduledDate)}else c.empty().text(o.i18n.active().port.state[u]),"scheduled"===u?d.empty().text(r.util.toFriendlyDate(n.scheduled_date,"shortdatetime")):d.empty().text(o.i18n.active().port.noScheduledDate)};a instanceof Array?n.each(a,function(e,t){n.each(e.port_requests,function(e,t){s(e)})}):s(a)},portPositionDialogBox:function(){t("html, body").animate({scrollTop:"0"},100),t("body").height()-(t(".ui-dialog").height()+80)<=0?t(".ui-dialog").animate({top:"80"},200):t(".ui-dialog").animate({top:t("body").height()/2-t(".ui-dialog").height()/2},200)},portObjectsToArray:function(e){if("undefined"!=typeof e.length)for(var t in e){var n=new Array;for(var r in e[t].numbers)n.push(r);delete e[t].numbers,e[t].numbers=n}else{var n=new Array;for(var r in e.numbers)n.push(r);delete e.numbers,e.numbers=n}return e},portArrayToObjects:function(e){if(Array.isArray(e.numbers)){var t=e.numbers;delete e.numbers,e.numbers=new Object;for(var n in t)e.numbers[t[n]]=new Object}return e},portReloadApp:function(e,n){var r=this,a={};e.hasClass("ui-dialog-content")?(e.dialog("close"),a.accountId=n):(e.empty(),a.parent=t("#monster-content")),r.portRender(a)},portComingSoon:function(e,n){var a=this;n.forEach(function(n,o){e.find(n).on("click",function(e){e.preventDefault();var n=t(this).data("type");if("faq"===n){var o=r.ui.dialog(r.template(a,"port-faqPopup"),{title:"Porting Manager FAQ",width:"800px"}),i=o.find(".accordion-toggle");i.on("click",function(){i.removeClass("in"),t(this).addClass("in")})}else r.ui.alert(a.i18n.active().port.comingSoon)})})},portFormatNumbers:function(e,t){var a=this,o={orders:[]},i=function(){var n={carrier:a.i18n.active().port.unknownCarrier,numbers:e};o.orders.push(n),t&&t(o)};r.config.api.hasOwnProperty("phonebook")?r.request({resource:"common.numbers.metadata",data:{data:e,country:"US"},success:function(e){var r={orders:[]},o={},i=function(e,t){if(o.hasOwnProperty(e))r.orders[o[e]].numbers.push(t);else{var n=r.orders.length;r.orders.push({carrier:e,numbers:[t]}),o[e]=n}};n.each(e.data,function(e,t){e.hasOwnProperty("lrn")&&e.lrn.hasOwnProperty("lerg")&&e.lrn.lerg.hasOwnProperty("company")&&e.lrn.lerg.company?i(e.lrn.lerg.company,t):e.hasOwnProperty("lrn")&&e.lrn.hasOwnProperty("carrier")&&e.lrn.carrier.hasOwnProperty("dba")&&e.lrn.carrier.dba?i(e.lrn.carrier.dba,t):e.hasOwnProperty("carrier")&&e.carrier.hasOwnProperty("dba")&&e.carrier.dba?i(e.carrier.dba,t):i(a.i18n.active().port.unknownCarrier,t)}),t(r)},error:i}):i()},portSaveOrder:function(e,t,n,r){var a=this,o=n.orders[r].hasOwnProperty("id");o?a.portRequestUpdate(t,n.orders[r].id,n.orders[r],function(){a.portReloadApp(e,t)}):a.portRequestAdd(t,n.orders[r],function(){n.orders.length>1?(n.orders.splice(r,1),a.portRenderResumeOrders(e,t,n)):a.portReloadApp(e,t)})},portCancelOrder:function(e,t,n,a,o){var i=this,a=a||void 0,o=o||0;n.find("div#footer").find("button.btn-danger").on("click",function(){"undefined"==typeof a?i.portReloadApp(e,t):r.ui.confirm(i.i18n.active().port.cancelOrderPopup,function(){a.orders[o].hasOwnProperty("id")?i.portRequestDelete(t,a.orders[o].id,function(){i.portReloadApp(e,t)}):a.orders.length>1?(a.orders.splice(o,1),i.portRenderResumeOrders(e,t,a)):i.portReloadApp(e,t)})})},portGetRequest:function(e,t,n){return n.filter(function(t,n){return t.account_id===e})[0].port_requests.filter(function(e,n){return e.id===t})[0]},portUpdateData:function(e,t,n){for(var r in n){if(n[r].account_id===e)for(var a in n[r].port_requests){n[r].port_requests[a].id===t.id&&(n[r].port_requests[a]=t);break}break}},portGhettoAttachmentDownload:function(e,t){var n=document.getElementById("download_attachment");n.href=t,n.download=e,n.click()},portRequestAdd:function(e,a,o,i){var s=this,d={};a.hasOwnProperty("bill_attachment")&&(d.bill=a.bill_attachment,delete a.bill_attachment),a.hasOwnProperty("loa_attachment")&&(d.loa=a.loa_attachment,delete a.loa_attachment),a.hasOwnProperty("resporg_attachment")&&(d.resporg=a.resporg_attachment,delete a.resporg_attachment),a=t.extend(!0,a,{port_state:"unconfirmed"}),a=s.portArrayToObjects(a),s.callApi({resource:"port.create",data:{accountId:e,data:a},success:function(t,a){var c=t.data.id,u={};n.each(d,function(t,n){u[n]=function(r){s.portRequestAddAttachment(e,c,n.concat(".pdf"),t,function(e){r(null,e)})}}),r.series(u,function(e,t){e?i&&i():o&&o(c)})},error:function(e,t){i&&i()}})},portRequestUpdate:function(e,t,n,r,a){var o=this;n=o.portArrayToObjects(n),n.hasOwnProperty("bill_attachment")&&delete n.bill_attachment,n.hasOwnProperty("loa_attachment")&&delete n.loa_attachment,n.hasOwnProperty("resporg_attachment")&&delete n.resporg_attachment,o.callApi({resource:"port.update",data:{accountId:e,portRequestId:t,data:n},success:function(e,t){r&&r(e.data)},error:function(e,t){a&&a()}})},portRequestDelete:function(e,t,n,r){var a=this;a.callApi({resource:"port.delete",data:{accountId:e,portRequestId:t,data:{}},success:function(e,t){n&&n()},error:function(e,t){r&&r()}})},portRequestList:function(e){var t=this,a={allOpenState:["unconfirmed","submitted","pending","scheduled","rejected"],allState:["all"]},o=e.withDescendants?"portRequestListByDescendants":"portRequestListUniqueState";if(a.hasOwnProperty(e.state)){var i={},s=[];n.each(a[e.state],function(n){i[n]=function(r){t[o](e.accountId,n,function(e){r(null,e)})}}),r.parallel(i,function(t,r){n.each(r,function(e){s=s.concat(e)}),e.success(s)})}else t[o](e.accountId,e.state,e.success,e.error)},portRequestListUniqueState:function(e,t,n,r){var a=this,o="all"===t?"port.list":"port.listByState",i={accountId:e,filters:{paginate:!1}};"all"!==t&&(i.state=t||"submitted"),a.callApi({resource:o,data:i,success:function(e,t){var r=1===e.data.length&&"port_requests"in e.data[0]?e.data[0].port_requests:e.data;n&&n(a.portObjectsToArray(r))},error:function(e,t){r&&r()}})},portRequestListByDescendants:function(e,t,n,r){var a=this,o="all"===t?"port.listDescendants":"port.listDescendantsByState",i={accountId:e,filters:{paginate:!1}};"all"!==t&&(i.state=t||"submitted"),a.callApi({resource:o,data:i,success:function(e,t){var e=e.data;for(var r in e)e[r].port_requests=a.portObjectsToArray(e[r].port_requests);n&&n(e)},error:function(e,t){r&&r()}})},portRequestGet:function(e,t,n,r){var a=this;a.callApi({resource:"port.get",data:{accountId:e,portRequestId:t,data:{}},success:function(e,t){n&&n(a.portObjectsToArray(e.data))},error:function(e,t){r&&r()}})},portRequestGetDescendants:function(e,t,n){var r=this;r.callApi({resource:"port.listDescendants",data:{accountId:e,data:{}},success:function(e,n){t&&t(e.data)},error:function(e,t){n&&n()}})},portRequestListAttachments:function(e,t,n,r){var a=this;a.callApi({resource:"port.listAttachments",data:{accountId:e,portRequestId:t,data:{}},success:function(e,t){n&&n(e.data)},error:function(e,t){r&&r()}})},portRequestAddAttachment:function(e,t,n,r,a,o){var i=this;i.callApi({resource:"port.createAttachment",data:{accountId:e,portRequestId:t,documentName:n,data:r},success:function(e,t){a&&a(e.data)},error:function(e,t){o&&o()}})},portRequestUpdateAttachment:function(e,t,n,r,a,o){var i=this;i.callApi({resource:"port.updateAttachment",data:{accountId:e,portRequestId:t,documentName:n,data:r},success:function(e,t){a&&a()},error:function(e,t){o&&o()}})},portRequestDeleteAttachment:function(e,t,n){var r=this;r.callApi({resource:"port.deleteAttachment",data:{accountId:e,portRequestId:t,documentName:n,data:{}},success:function(e,t){callbackSuccess&&callbackSuccess()},error:function(e,t){callbackError&&callbackError()}})},portRequestGetAttachment:function(e,t,n,r,a){var o=this;o.callApi({resource:"port.getAttachment",data:{accountId:e,portRequestId:t,documentName:n,data:{},generateError:!1},success:function(e,t){r&&r(e)},error:function(e,t){a&&a(e)}})},portRequestChangeState:function(e,t,n,r,a,o){var i=this;i.callApi({resource:"port.changeState",data:{accountId:e,portRequestId:t,state:n},success:function(e,t){r&&r(e.data)},error:function(e,t){402!==parseInt(e.error,10)&&a&&a()},onChargesCancelled:function(){o&&o()}})},portRequestReadyState:function(e,t,n,r,a){var o=this;n.port_state="submitted",o.callApi({resource:"port.update",
data:{accountId:e,portRequestId:t,data:n},success:function(e,t){r&&r()},error:function(e,t){a&&a()}})},portRequestListUsers:function(e,t,n){var r=this;r.callApi({resource:"user.list",data:{accountId:e},success:function(e,n){t&&t(e.data)},error:function(e,t){n&&n()}})},portRequestSearchNumber:function(e,t,n,r){var a=this;a.callApi({resource:"port.searchNumber",data:{accountId:e,number:t},success:function(e,t){n&&n(e.data)},error:function(e,t){r&&r()}})},portRequestSearchNumberByDescendants:function(e,t,n,r){var a=this;a.callApi({resource:"port.searchNumberByDescendants",data:{accountId:e,number:t},success:function(e,t){n&&n(e.data)},error:function(e,t){r&&r()}})},portRequestGetAccount:function(e,t,n){var r=this;r.callApi({resource:"account.get",data:{accountId:e},success:function(e,n){t&&t(e.data)},error:function(e,t){n&&n()}})}};return o});