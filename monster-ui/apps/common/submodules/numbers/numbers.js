define(["require","jquery","underscore","monster","toastr"],function(e){var n=e("jquery"),t=e("underscore"),r=e("monster"),a=e("toastr"),u={requests:{},subscribe:{"common.numbers.dialogSpare":"numbersDialogSpare","common.numbers.render":"numbersRender","common.numbers.getListFeatures":"numbersGetFeatures","common.numbers.editFeatures":"numbersEditFeatures"},numbersRender:function(e){var t=this,a=e||{},u=a.container||n("#monster-content"),s=a.callbackAfterRender,c=a.viewType||"manager";t.numbersGetData(c,function(e){e.viewType=c,e=t.numbersFormatData(e);var a=n(r.template(t,"numbers-layout",e)),i=r.template(t,"numbers-spare",e),o=r.template(t,"numbers-used",e);a.find('.list-numbers[data-type="spare"]').append(i),a.find('.list-numbers[data-type="used"]').append(o),t.numbersBindEvents(a,e),u.empty().append(a),setTimeout(function(){var e=u.find(".half-box.selected").data("type");u.find('.list-numbers[data-type="'+e+'"] .search-custom input').focus()}),s&&s(u)})},numbersFormatNumber:function(e){var n=this;return e.viewFeatures=n.numbersGetFeatures(),"locality"in e&&(e.isoCountry=e.locality.country||"",e.friendlyLocality="city"in e.locality?e.locality.city+("state"in e.locality?", "+e.locality.state:""):""),t.each(e.features,function(n){n in e.viewFeatures&&(e.viewFeatures[n].active="active")}),"used_by"in e&&(e.friendlyUsedBy=n.i18n.active().numbers[e.used_by]),e.isLocal=e.features.indexOf("local")>-1,e},numbersGetFeatures:function(e){var n=this,t={mobile:{icon:"monster-grey fa fa-mobile-phone",help:n.i18n.active().numbers.mobileIconHelp},failover:{icon:"monster-green fa fa-thumbs-down feature-failover",help:n.i18n.active().numbers.failoverIconHelp},local:{icon:"monster-purple fa fa-rocket feature-local",help:n.i18n.active().numbers.localIconHelp},port:{icon:"fa fa-phone monster-yellow feature-port",help:n.i18n.active().numbers.portIconHelp},prepend:{icon:"monster-orange fa fa-file-text-o feature-prepend",help:n.i18n.active().numbers.prependIconHelp}};return r.util.isNumberFeatureEnabled("e911")&&(t.dash_e911={icon:"monster-red fa fa-ambulance feature-dash_e911",help:n.i18n.active().numbers.e911IconHelp}),r.util.isNumberFeatureEnabled("cnam")&&(t.outbound_cnam={icon:"monster-blue fa fa-user feature-outbound_cnam",help:n.i18n.active().numbers.cnamOutboundIconHelp},t.inbound_cnam={icon:"monster-green fa fa-user feature-inbound_cnam",help:n.i18n.active().numbers.cnamInboundIconHelp}),e?void(e&&e(t)):t},numbersFormatData:function(e){var n=this,a={},u={spareNumbers:[],usedNumbers:[]},s={hidePort:r.config.whitelabel.hasOwnProperty("hide_port")?r.config.whitelabel.hide_port:!1,viewType:e.viewType,canAddExternalNumbers:r.util.canAddExternalNumbers(),listAccounts:[]},c=t.extend(r.apps.auth.currentAccount,u);"pbx"!==e.viewType&&t.each(e.accounts,function(e){a[e.id]=e}),t.each(e.numbers.numbers,function(t,r){t.phoneNumber=r,t=n.numbersFormatNumber(t),t.used_by?"pbx"!==e.viewType?c.usedNumbers.push(t):("callflow"===t.used_by||"mobile"===t.used_by)&&c.usedNumbers.push(t):c.spareNumbers.push(t)}),c.countUsedNumbers=c.usedNumbers.length,c.countSpareNumbers=c.spareNumbers.length,c.open="open",a[n.accountId]=c;var i=function(e,n){return e.phoneNumber>n.phoneNumber};return t.each(a,function(e){e.id!==n.accountId?s.listAccounts.push(e):(e.spareNumbers.sort(i),e.usedNumbers.sort(i))}),s.listAccounts.sort(function(e,n){return e.name.toLowerCase()>n.name.toLowerCase()?1:-1}),s.listAccounts.unshift(a[n.accountId]),s.isE911Enabled=r.util.isNumberFeatureEnabled("e911"),s.isCnamEnabled=r.util.isNumberFeatureEnabled("cnam"),s},numbersBindEvents:function(e,u){function s(e){c.numbersSyncUsedBy(e,function(n){d(e,function(e){a.success(c.i18n.active().numbers.sync.success)},!0)})}var c=this,i=u.viewType&&"manager"===u.viewType?"full":"partial",o=[c.accountId],m=function(){e.find(".number-box.selected").size()>0?e.find("#trigger_links").show():e.find("#trigger_links").hide()},d=function(n,a,s){var m=t.indexOf(o,n)>=0,s=s||!1;!m||s?c.numbersList(n,function(s){var d=[],l=[],b=function(e,n){return e.phoneNumber>n.phoneNumber};m||o.push(n),t.each(s.numbers,function(e,n){"id"!==n&&"quantity"!==n&&(e.phoneNumber=n,e=c.numbersFormatNumber(e),e.used_by?"full"===i?l.push(e):("callflow"===e.used_by||"mobile"===e.used_by)&&l.push(e):d.push(e))}),t.each(u.listAccounts,function(t){return t.id===n?(t.spareNumbers=d.sort(b),t.usedNumbers=l.sort(b),t.countSpareNumbers=d.length,t.countUsedNumbers=l.length,e.find('.list-numbers[data-type="spare"] .account-section[data-id="'+n+'"] .numbers-wrapper').empty().append(r.template(c,"numbers-spareAccount",{viewType:u.viewType,spareNumbers:d})).parent().find(".count").html("("+d.length+")"),e.find('.list-numbers[data-type="used"] .account-section[data-id="'+n+'"] .numbers-wrapper').empty().append(r.template(c,"numbers-usedAccount",{viewType:u.viewType,usedNumbers:l,isCnamEnabled:r.util.isNumberFeatureEnabled("cnam"),isE911Enabled:r.util.isNumberFeatureEnabled("e911")})).parent().find(".count").html("("+l.length+")"),!1):void 0}),a&&a()},i):a&&a()};r.ui.tooltips(e),"pbx"===u.viewType?(e.find('.list-numbers[data-type="spare"]').hide(),e.find('.half-box[data-type="used"]').addClass("selected")):(e.find('.list-numbers[data-type="used"]').hide(),e.find('.half-box[data-type="spare"]').addClass("selected")),e.find(".half-box").on("click",function(){var t=n(this),r=t.data("type");t.hasClass("selected")||(e.find(".half-box").removeClass("selected"),e.find(".list-numbers").hide(),setTimeout(function(){e.find('.list-numbers[data-type="'+r+'"] .search-custom input').focus()}),t.addClass("selected"),e.find('.list-numbers[data-type="'+r+'"]').show())}),e.on("click",'.account-header input[type="checkbox"]',function(e){var t=n(this).parents(".account-section").first().find('.number-box input[type="checkbox"]'),r=n(this).prop("checked");t.prop("checked",r),r?t.parent().addClass("selected"):t.parent().removeClass("selected"),m()}),e.on("click",".expandable",function(e){var r=n(this).parents(".account-section"),a=r.data("id"),s=function(){r.toggleClass("open"),r.hasClass("open")||(r.find('input[type="checkbox"]:checked').prop("checked",!1),r.find(".number-box.selected").removeClass("selected")),t.each(u.listAccounts,function(e){e.id===a&&(e.open=r.hasClass("open")?"open":"")})};d(a,function(){s()}),m()}),e.on("click",".account-header .buy-numbers-link",function(t){var a=n(this).parents(".account-section").data("id");r.pub("common.buyNumbers",{accountId:a,searchType:n(this).data("type"),callbacks:{success:function(n){d(a,function(n){e.find('.account-section[data-id="'+a+'"]').addClass("open")},!0)}}})}),e.on("click",".actions-wrapper .buy-numbers-dropdown .buy-numbers-link",function(e){c.accountId;r.pub("common.buyNumbers",{accountId:c.accountId,searchType:n(this).data("type"),callbacks:{success:function(e){d(c.accountId,function(e){},!0)}}})}),e.on("click",".account-header .action-number.port",function(t){var a=n(this).parents(".account-section").data("id");r.pub("common.port.render",{accountId:a,callbacks:{success:function(n){d(a,function(n){e.find('.account-section[data-id="'+a+'"]').addClass("open")},!0)}}})}),e.on("click",".actions-wrapper .action-number.port",function(e){var t=c.accountId;r.pub("common.port.render",{accountId:t,searchType:n(this).data("type"),callbacks:{success:function(e){d(t,function(e){},!0)}}})}),e.on("click",".account-header .action-number.add-external",function(e){c.numbersAddExternalNumbers(n(this).parents(".account-section").data("id"),function(){c.numbersRender({container:n("#number_manager")})})}),e.on("click",".account-header .action-number.sync",function(e){s(n(this).parents(".account-section").data("id"))}),e.on("click",".actions-wrapper .action-number.sync",function(e){s(c.accountId)}),e.on("click",".number-box:not(.disabled)",function(e){var t=n(this);if(!t.hasClass("no-data")){var r=t.parents(".account-section").first(),a=r.find('.account-header input[type="checkbox"]');if(t.toggleClass("selected"),!n(e.target).is("input:checkbox")){var u=t.find('input[type="checkbox"]'),s=u.prop("checked");u.prop("checked",!s)}r.find('.numbers-wrapper input[type="checkbox"]:checked').size()===r.find('.numbers-wrapper input[type="checkbox"]').size()?a.prop("checked",!0):a.prop("checked",!1)}m()}),e.on("click","#delete_numbers",function(a){var s=[],i={},o={"delete":!0,accountList:[]};if(e911ErrorMessage="",e.find(".number-box.selected").each(function(e,t){var r=n(t),a=r.data("phonenumber");accountId=r.parents(".account-section").data("id"),accountName=r.parents(".account-section").data("name").toString(),accountId in i||(i[accountId]={},o.accountList.push({accountName:accountName}));for(var u in o.accountList)"undefined"==typeof o.accountList[u].numbers&&(o.accountList[u].numbers=new Array),o.accountList[u].accountName==accountName&&o.accountList[u].numbers.push(a);i[accountId][a]=!0,s.push(a)}),o.numberCount=s.length,t.each(o.accountList,function(e){var n=t.find(u.listAccounts,function(n){return n.name===e.accountName}),r=t.filter(n.spareNumbers,function(e){return e.features.indexOf("dash_e911")>=0}).concat(t.filter(n.usedNumbers,function(e){return e.features.indexOf("dash_e911")>=0})),a=[];r.length>0&&(t.each(r,function(n){e.numbers.indexOf(n.phoneNumber)>=0&&a.push(n.phoneNumber)}),r.length===a.length&&(e911ErrorMessage||(e911ErrorMessage=c.i18n.active().numbers.deleteE911Error.message),e911ErrorMessage+="<br><br>"+c.i18n.active().numbers.deleteE911Error.account+" "+e.accountName,e911ErrorMessage+="<br>"+c.i18n.active().numbers.deleteE911Error.numbers+" "+a.join(", ")))}),e911ErrorMessage)r.ui.alert("error",e911ErrorMessage);else{var m=n(r.template(c,"numbers-actionsConfirmation",o)),d={numbers:s,accountId:c.accountId},l=r.ui.dialog(m,{width:"540px",title:"Delete Numbers - Confirmation"});m.on("click",".remove-number",function(){for(var e in d.numbers){if(n(this).parent().data("number")==d.numbers[e]){var t=n(this).parent().parent().parent(),r=t[0].childElementCount,a=m.find("h4").find(".monster-blue");d.numbers.splice(e,1),n(this).parent().parent().remove(),1==r&&(t[0].previousElementSibling.remove(),t.remove()),a.text(a.text()-1)}0==d.numbers.length&&m.parent().parent().remove()}}),m.on("click",".cancel-link",function(){l.remove()}),m.on("click","#delete_action",function(){c.numbersDelete(d,function(n){var r=0;t.each(u.listAccounts,function(e,a){if(e.id in i){var s=[];t.each(e.spareNumbers,function(e,t){n.hasOwnProperty("success")&&e.phoneNumber in n.success?r++:s.push(e)}),u.listAccounts[a].spareNumbers=s,u.listAccounts[a].countSpareNumbers=s.length}}),l.remove(),c.numbersShowDeletedNumbers(n),c.numbersPaintSpare(e,u,function(){})})})}});var l=function(s,i){var m=[],d=s,l=-1,b={},p={destinationAccountName:i,move:!0,accountList:[]};e.find(".number-box.selected").each(function(e,t){var r=n(t),a=r.data("phonenumber");s=r.parents(".account-section").data("id"),i=r.parents(".account-section").data("name"),s in b||(b[s]={},p.accountList.push({accountName:i}));for(var u in p.accountList)"undefined"==typeof p.accountList[u].numbers&&(p.accountList[u].numbers=new Array),p.accountList[u].accountName==i&&p.accountList[u].numbers.push(a);b[s][a]=!0,m.push(a)}),p.numberCount=m.length;var f=n(r.template(c,"numbers-actionsConfirmation",p)),h={numbers:m,accountId:d};r.ui.dialog(f,{width:"540px",title:"Move Numbers - Confirmation"}),f.on("click",".remove-number",function(){for(var e in h.numbers){if(n(this).parent().data("number")==h.numbers[e]){var t=n(this).parent().parent().parent(),r=t[0].childElementCount,a=f.find("h4").find(".monster-blue:first-child");h.numbers.splice(e,1),n(this).parent().parent().remove(),1==r&&(t[0].previousElementSibling.remove(),t.remove()),a.text(a.text()-1)}0==h.numbers.length&&f.parent().parent().remove()}}),f.on("click",".cancel-link",function(){f.parent().parent().remove()}),f.on("click","#move_action",function(){c.numbersMove(h,function(n){var s=0;t.each(u.listAccounts,function(e,r){if(e.id===d&&(l=r),e.id in b){var a=[];t.each(e.spareNumbers,function(e,t){e.phoneNumber in n.success?(n.success[e.phoneNumber]=e,s++):a.push(e)}),u.listAccounts[r].spareNumbers=a,u.listAccounts[r].countSpareNumbers=a.length}}),t.indexOf(o,d)>-1&&(t.each(n.success,function(e,n){u.listAccounts[l].spareNumbers.push(e)}),u.listAccounts[l].countSpareNumbers=u.listAccounts[l].spareNumbers.length),c.numbersPaintSpare(e,u,function(){var e={count:s,accountName:u.listAccounts[l].name},n=r.template(c,"!"+c.i18n.active().numbers.successMove,e);f.parent().parent().remove(),a.success(n)})})})};e.on("click","#move_numbers",function(){r.pub("common.accountBrowser.render",{container:e.find('.list-numbers[data-type="spare"] .accounts-dropdown'),customClass:"ab-dropdown",addCurrentAccount:!0,addBackButton:!0,onAccountClick:function(n,t){l(n,t),e.find('.list-numbers[data-type="spare"] .dropdown-move').removeClass("open")}})}),r.util.isNumberFeatureEnabled("cnam")&&e.on("click",".cnam-number",function(){var e=n(this).parents(".number-box"),t=e.first(),a=t.data("phonenumber");if(a){var u={phoneNumber:a,callbacks:{success:function(n){r.ui.highlight(e),"cnam"in n.data&&n.data.cnam.display_name?t.find(".features i.feature-outbound_cnam").addClass("active"):t.find(".features i.feature-outbound_cnam").removeClass("active"),"cnam"in n.data&&n.data.cnam.inbound_lookup?t.find(".features i.feature-inbound_cnam").addClass("active"):t.find(".features i.feature-inbound_cnam").removeClass("active")}}};r.pub("common.callerId.renderPopup",u)}}),r.util.isNumberFeatureEnabled("e911")&&e.on("click",".e911-number",function(){var e=n(this).parents(".number-box"),t=e.first(),a=t.data("phonenumber");if(a){var u={phoneNumber:a,callbacks:{success:function(a){r.ui.highlight(e),n.isEmptyObject(a.data.dash_e911)?t.find(".features i.feature-dash_e911").removeClass("active"):t.find(".features i.feature-dash_e911").addClass("active")}}};r.pub("common.e911.renderPopup",u)}}),e.on("click",".failover-number",function(){var e=n(this).parents(".number-box"),t=e.first(),a=t.data("phonenumber");if(a){var u={phoneNumber:a,callbacks:{success:function(a){r.ui.highlight(e),n.isEmptyObject(a.data.failover)?t.find(".features i.feature-failover").removeClass("active"):t.find(".features i.feature-failover").addClass("active")}}};r.pub("common.failover.renderPopup",u)}}),e.on("click",".prepend-number",function(){var e=n(this).parents(".number-box"),t=e.first(),a=t.data("phonenumber");if(a){var u={phoneNumber:a,callbacks:{success:function(n){r.ui.highlight(e),"prepend"in n.data&&n.data.prepend.enabled?t.find(".features i.feature-prepend").addClass("active"):t.find(".features i.feature-prepend").removeClass("active")}}};r.pub("common.numberPrepend.renderPopup",u)}});var b=function(e,n){var s=n;e=r.util.unformatPhoneNumber(e),c.numbersSearchAccount(e,function(i){i.account_id&&(t.find(u.listAccounts,function(e){return e.id===i.account_id})?d(i.account_id,function(){var e=s.find('[data-id="'+i.account_id+'"]'),t=e.find('[data-phonenumber="'+i.number+'"]');if(t.size()>0)e.addClass("open"),r.ui.highlight(t,{timer:5e3});else{var u="spare"===n.attr("data-type")?"notSpareNumber":"notUsedNumber",o=r.template(c,"!"+c.i18n.active().numbers[u],{number:i.number,accountName:e.data("name")});a.warning(o)}}):c.numbersRenderAccountAncestorsPopup(e,i.account_id))})};e.on("click",'.list-numbers[data-type="spare"] button.search-numbers',function(n){var t=e.find('.list-numbers[data-type="spare"]'),r=t.find('.search-custom input[type="text"]').val().toLowerCase();b(r,t)}),e.on("keyup",'.list-numbers[data-type="spare"] .search-custom input[type="text"]',function(n){if(13===n.keyCode){var t=n.target.value.toLowerCase(),r=e.find('.list-numbers[data-type="spare"]');t&&b(t,r)}}),e.on("click",'.list-numbers[data-type="used"] button.search-numbers',function(n){var t=e.find('.list-numbers[data-type="used"]'),r=t.find('.search-custom input[type="text"]').val().toLowerCase();b(r,t)}),e.on("keyup",'.list-numbers[data-type="used"] .search-custom input[type="text"]',function(n){if(13===n.keyCode){var t=n.target.value.toLowerCase(),r=e.find('.list-numbers[data-type="used"]');t&&b(t,r)}})},numbersRenderAccountAncestorsPopup:function(e,n){var t=this;t.callApi({resource:"numbers.get",data:{accountId:n,phoneNumber:e},success:function(e,t){r.pub("common.accountAncestors.render",{accountId:n,entity:{type:"number",data:e.data}})}})},numbersAddIndividualNumber:function(e,n,t,a){var u=this;r.util.canAddExternalNumbers()?u.numbersCreateNumber(e,n,function(){u.numbersActivateNumber(e,n,function(){t&&t()},a)},a):a()},numbersAddFreeformNumbers:function(e,n,a){var u=this,s={};t.each(e,function(e){s[e]=function(t){u.numbersAddIndividualNumber(e,n,function(e){t(null,e)},function(e){t(null,{})})}}),r.parallel(s,function(e,n){a&&a(n)})},numbersAddExternalNumbers:function(e,a){var u=this,s=n(r.template(u,"numbers-addExternal"));s.on("click",".cancel-link",function(){c.remove()}),s.on("click","#add_numbers",function(n){n.preventDefault();var i,o=s.find(".list-numbers").val(),m=[];o=o.replace(/[\n]/g," "),o=o.replace(/[-\(\)\.]/g,"").split(" "),t.each(o,function(e){i=e.match(/^\+(.*)$/),i&&i[1]&&m.push(e)}),m.length>0?u.numbersAddFreeformNumbers(m,e,function(){c.dialog("close"),a&&a()}):r.ui.alert(u.i18n.active().numbers.addExternal.dialog.invalidNumbers)});var c=r.ui.dialog(s,{title:u.i18n.active().numbers.addExternal.dialog.title})},numbersShowDeletedNumbers:function(e){var a=this,u=n(r.template(a,"numbers-deleteConfirmation")),s={errors:[],successes:[],countTotal:0};t.each(e.error,function(e,n){s.errors.push({id:n,value:r.util.formatPhoneNumber(n)})}),t.each(e.success,function(e,n){s.successes.push({id:n,value:r.util.formatPhoneNumber(n)})}),s.countTotal=s.successes.length+s.errors.length,u.find(".results-wrapper").append(r.ui.results(s)),u.find("#continue").on("click",function(){c.remove()});var c=r.ui.dialog(u,{title:a.i18n.active().numbers.deleteRecapDialog.title})},numbersPaintSpare:function(e,n,t){var a=this,u=r.template(a,"numbers-spare",n);e.find('.list-numbers[data-type="spare"]').empty().append(u),t&&t()},numbersGetData:function(e,n){var t=this,a=e&&"manager"===e?"full":"partial";r.parallel({numbers:function(e){t.numbersList(t.accountId,function(n){e(null,n)},a)},accounts:function(e){t.numbersListAccounts(function(n){e(null,n)})}},function(e,t){n(t)})},numbersMove:function(e,n){var t=this;t.callApi({resource:"numbers.activateBlock",data:{accountId:e.accountId,data:{numbers:e.numbers}},success:function(e,t){n&&n(e.data)}})},numbersSearchAccount:function(e,n,t){var r=this;r.callApi({resource:"numbers.identify",data:{accountId:r.accountId,phoneNumber:e,generateError:!1},success:function(e,t){n&&n(e.data)},error:function(e,n){t&&t(e),a.error(r.i18n.active().numbers.numberNotFound)}})},numbersDelete:function(e,n){var t=this;t.callApi({resource:"numbers.deleteBlock",data:{accountId:e.accountId,data:{numbers:e.numbers}},success:function(e,t){n&&n(e.data)}})},numbersCreateNumber:function(e,n,t,r){var a=this;a.callApi({resource:"numbers.create",data:{accountId:n,phoneNumber:encodeURIComponent(e)},success:function(e){t&&t(e.data)},error:function(e){"402"!==e.error&&r&&r(e)}})},numbersActivateNumber:function(e,n,t,r){var a=this;a.callApi({resource:"numbers.activate",data:{accountId:n,phoneNumber:encodeURIComponent(e)},success:function(e){t&&t(e.data)},error:function(e){"402"!==e.error&&r&&r(e)}})},numbersFormatDialogSpare:function(e,r,a,u){var s=this,c={accountName:e.accountName,numbers:{}},i=function(e,n){n.phoneNumber=e,n=s.numbersFormatNumber(n),c.numbers[e]=n};return t.each(e.numbers,function(e,t){a.indexOf(t)>=0?i(t,e):""===e.used_by&&-1===r.indexOf(t)&&(u&&0!==u.length?n.each(u,function(n,r){return e.features&&e.features.indexOf(r)>=0?(i(t,e),!1):void 0}):i(t,e))}),c},numbersDialogSpare:function(e){var n=this,t=e.accountId,a=e.accountName||"",u=e.ignoreNumbers||[],s=e.extraNumbers||[],c=e.featureFilters||[],i=e.singleSelect||!1;e.callback;n.numbersList(t,function(t){t.accountName=a;var o=n.numbersFormatDialogSpare(t,u,s,c);r.pub("common.monsterListing.render",{dataList:o.numbers,dataType:"numbers",labels:{title:n.i18n.active().numbers.dialogSpare.title,headline:o.accountName?n.i18n.active().numbers.dialogSpare.headline+" "+o.accountName:n.i18n.active().numbers.dialogSpare.headlineNoAccount,okButton:n.i18n.active().numbers.dialogSpare.proceed},singleSelect:i,okCallback:e.callback})})},numbersList:function(e,n,t){var a=this;r.parallel({callflows:function(n){a.numbersListCallflows(e,function(e){n&&n(null,e)})},devices:function(n){a.numbersListMobileDevices(e,function(e){n&&n(null,e)})},groups:function(n){a.numbersListGroups(e,function(e){n&&n(null,e)})},users:function(n){a.numbersListUsers(e,function(e){n&&n(null,e)})},numbers:function(n){a.numbersListNumbers(e,function(e){n&&n(null,e)},t)}},function(t,r){a.numbersFormatList(e,r),n&&n(r.numbers)})},numbersFormatList:function(e,r){var a=this,u={},s={};return t.each(r.users,function(e){u[e.id]=e}),t.each(r.groups,function(e){s[e.id]=e}),t.each(r.callflows,function(e){t.each(e.numbers,function(n){if(n in r.numbers.numbers)if(e.owner_id&&e.owner_id in u){var t=u[e.owner_id];r.numbers.numbers[n].owner=t.first_name+" "+t.last_name,r.numbers.numbers[n].ownerType="user"}else e.group_id?(r.numbers.numbers[n].owner=s[e.group_id].name,r.numbers.numbers[n].ownerType="group"):e.type&&"main"===e.type?(r.numbers.numbers[n].owner=a.i18n.active().numbers.mainNumber,r.numbers.numbers[n].ownerType="main"):e.type&&"conference"===e.type?(r.numbers.numbers[n].owner=a.i18n.active().numbers.conferenceNumber,r.numbers.numbers[n].ownerType="conference"):(r.numbers.numbers[n].owner=a.i18n.active().numbers.callflows,r.numbers.numbers[n].ownerType="callflows")})}),t.each(r.devices,function(t,s){var c="+1"+t.mobile.mdn;r.numbers.numbers[c]={assigned_to:e,features:["mobile"],isLocal:!1,phoneNumber:c,state:"in_service",used_by:"mobile"};var i={};i=t.hasOwnProperty("owner_id")?{owner_id:t.owner_id,ownerType:"mobileUser",owner:u[t.owner_id].first_name+" "+u[t.owner_id].last_name}:{owner:a.i18n.active().numbers.unassigned},n.extend(!0,r.numbers.numbers[c],i)}),r},numbersSyncUsedBy:function(e,n){var t=this;t.callApi({resource:"numbers.sync",data:{accountId:e},success:function(e){n&&n(e.data)}})},numbersListUsers:function(e,n){var t=this;t.callApi({resource:"user.list",data:{accountId:e,filters:{paginate:!1}},success:function(e,t){n&&n(e.data)}})},numbersListCallflows:function(e,n){var t=this;t.callApi({resource:"callflow.list",data:{accountId:e,filters:{paginate:!1}},success:function(e,t){n&&n(e.data)}})},numbersListGroups:function(e,n){var t=this;t.callApi({resource:"group.list",data:{accountId:e,filters:{paginate:!1}},success:function(e,t){n&&n(e.data)}})},numbersListNumbers:function(e,n,t){var r=this,a=t||"partial",u="partial"===a?"numbers.list":"numbers.listAll";r.callApi({resource:u,data:{accountId:e,filters:{paginate:!1}},success:function(e,t){n&&n(e.data)}})},numbersListAccounts:function(e){var n=this;n.callApi({resource:"account.listChildren",data:{accountId:n.accountId},success:function(n,t){e&&e(n.data)}})},numbersListMobileDevices:function(e,n){var t=this;t.callApi({resource:"device.list",data:{accountId:e,filters:{filter_device_type:"mobile",has_key:"mobile"}},success:function(e,t){n&&n(e.data)}})},numbersGetNumber:function(e,n,t){var r=this;r.callApi({resource:"numbers.get",data:{accountId:r.accountId,phoneNumber:encodeURIComponent(e)},success:function(e,t){n&&n(e.data)},error:function(e,n){t&&t(e.data)}})},numbersEditFeatures:function(e){var n=this,t=e.number,a=!1;n.numbersGetNumber(t,function(t){if("in_service"===t.state&&(a=!0),a)e.success&&e.success(t);else if(e.hasOwnProperty("error"))e.error("invalid");else{var u=r.template(n,"!"+n.i18n.active().numbers.notInService,{variable:r.util.formatPhoneNumber(t.id)});r.ui.alert("warning",u)}},function(){if(e.hasOwnProperty("error"))e.error("errorGetNumber");else{var t=r.template(n,"!"+n.i18n.active().numbers.errorFetchingNumber,{variable:r.util.formatPhoneNumber(number.id)});r.ui.alert(t)}})}};return u});