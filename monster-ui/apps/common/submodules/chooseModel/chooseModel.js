define(["require","jquery","underscore","monster"],function(e){var o=e("jquery"),n=e("underscore"),a=e("monster"),d={requests:{"common.chooseModel.getProvisionerData":{apiRoot:a.config.api.provisioner,url:"phones",verb:"GET"}},subscribe:{"common.chooseModel.render":"chooseModelRender"},chooseModelRender:function(e){var o=this;a.request({resource:"common.chooseModel.getProvisionerData",data:{},success:function(n){var a=o.chooseModelFormatProvisionerData(n.data);a.show_not_listed_links=e.callbackMissingBrand?!0:!1,o.chooseModelRenderProvisioner(a,e.callback,e.callbackMissingBrand)}})},chooseModelFormatProvisionerData:function(e){var o,a,d={brands:[]};return n.each(e,function(e,s){o=[],n.each(e.families,function(e,d){a=[],n.each(e.models,function(e,o){a.push({id:o.toLowerCase(),name:e.name})}),o.push({id:d.toLowerCase(),name:e.name,models:a})}),d.brands.push({id:s.toLowerCase(),name:e.name,families:o})}),d},chooseModelRenderProvisioner:function(e,n,d){var s,i,r,t=this,c=o(a.template(t,"chooseModel-provisioner",e));a.ui.validate(c.find("#device_form"),{rules:{name:{required:!0},mac_address:{required:!0,mac:!0}}}),a.ui.mask(c.find("#mac_address"),"macAddress"),c.find(".brand-box").on("click",function(){var e=o(this),n=e.data("brand");s=n,e.hasClass("unselected")||e.hasClass("selected")?e.hasClass("unselected")&&c.find('.models-brand[data-brand="'+c.find(".brand-box.selected").data("brand")+'"]').fadeOut("fast",function(){c.find(".brand-box.selected").removeClass("selected").addClass("unselected"),e.removeClass("unselected").addClass("selected"),c.find('.models-brand[data-brand="'+n+'"]').fadeIn("fast")}):(e.addClass("selected"),o.each(e.siblings(),function(e,n){o(n).addClass("unselected")}),c.find('.models-brand[data-brand="'+n+'"]').show(0,function(){c.find(".block-model").slideDown()}))}),c.find(".model-box").on("click",function(){var e=o(this);r=e.data("model"),i=e.data("family"),c.find(".model-box").removeClass("selected"),e.addClass("selected"),c.find(".actions .selection").text(a.template(t,"!"+t.i18n.active().chooseModel.deviceSelected,{brand:s,model:r})),c.find(".block-footer").slideDown(function(){o("html, body").animate({scrollTop:c.find("div.block-device-info div.title-bar").offset().top},function(){c.find("#name").focus()})})}),c.find(".missing-brand").on("click",function(){l.dialog("close").remove(),d&&d()}),c.find(".action-device").on("click",function(){if(a.ui.valid(c.find("#device_form"))){var e=a.ui.getFormData("device_form"),o={device_type:"sip_device",enabled:!0,mac_address:e.mac_address,name:e.name,provision:{endpoint_brand:s,endpoint_family:i,endpoint_model:r},sip:{password:a.util.randomString(12),realm:a.apps.auth.currentAccount.realm,username:"user_"+a.util.randomString(10)},suppress_unregister_notifications:!1},d=function(){l.dialog("close").remove()};n&&n(o,d)}});var l=a.ui.dialog(c,{position:["center",20],title:t.i18n.active().chooseModel.title})}};return d});