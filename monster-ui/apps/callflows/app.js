define("apps/callflows/app",["require","jquery","underscore","monster"],function(t){var e=t("jquery"),a=t("underscore"),n=t("monster"),i={name:"callflows",css:["app","icons"],i18n:{"en-US":{customCss:!1}},requests:{},subscribe:{"callflows.fetchActions":"define_callflow_nodes"},subModules:["misc","conference","device","directory","faxbox","groups","media","menu","resource","timeofday","user","vmbox","featurecodes"],appFlags:{flow:{},appData:{},showAllCallflows:n.config.hasOwnProperty("developerFlags")&&n.config.developerFlags.showAllCallflows||n.apps.auth.originalAccount.superduper_admin},actions:{},categories:{},flow:{},load:function(t){var e=this;e.initApp(function(){t&&t(e)})},initApp:function(t){var e=this;n.pub("auth.initApp",{app:e,callback:t})},render:function(t){var i=this,o=a.isEmpty(t)?e("#monster-content"):t;n.pub("callflows.fetchActions",{actions:i.actions}),i.renderEntityManager(o)},renderCallflows:function(t){var a=this,i=e(n.template(a,"callflow-manager"));a.bindCallflowsEvents(i),a.repaintList({template:i,callback:function(){t.empty().append(i),t.find(".search-query").focus(),a.hackResize(i)}})},bindCallflowsEvents:function(t){var a=this,i=t.find(".list-container .list"),o=!1,l=e('<li class="content-centered list-loader"> <i class="fa fa-spinner fa-spin"></i></li>'),c=e(n.template(a,"callflowList-searchLink"));t.find(".list-add").on("click",function(){t.find(".callflow-content").removeClass("listing-mode").addClass("edition-mode"),a.editCallflow()}),i.on("click",".list-element",function(){var n=e(this),i=n.data("id");t.find(".callflow-content").removeClass("listing-mode").addClass("edition-mode"),a.editCallflow({id:i})}),i.on("scroll",function(){!o&&i.data("next-key")&&i.scrollTop()>=i[0].scrollHeight-i.innerHeight()-100&&(o=!0,i.append(l),a.listData({callback:function(t){var e=n.template(a,"callflowList",{callflows:t.data});l.remove(),i.append(e).data("next-key",t.next_start_key||null),o=!1},nextStartKey:i.data("next-key"),searchValue:i.data("search-value")}))}),t.find(".search-query").on("keyup",function(){var a=e(this).val();c.find(".search-value").text(a),a?(e.each(t.find(".list-element"),function(){var t=e(this);t.data("search").toLowerCase().indexOf(a.toLowerCase())>=0?t.show():t.hide()}),i.prepend(c)):(t.find(".list-element").show(),c.remove())}),i.on("click",".search-link",function(){if(c.hasClass("active"))i.data("search-value",null),c.removeClass("active").remove(),t.find(".search-query").prop("disabled",!1).val(""),a.repaintList({template:t});else{var e=c.find(".search-value").text();c.addClass("active").remove(),i.data("search-value",e),t.find(".search-query").prop("disabled",!0),a.repaintList({template:t,searchValue:e,callback:function(){i.prepend(c)}})}})},renderEntityManager:function(t){var i=this,o=a.indexBy(a.filter(i.actions,function(t){return t.hasOwnProperty("listEntities")}),"module"),l=e(n.template(i,"layout",{actions:o}));i.bindEntityManagerEvents({parent:t,template:l,actions:o}),t.empty().append(l)},bindEntityManagerEvents:function(t){var a=this,i=(t.parent,t.template),o=t.actions,l=function(t,c){n.pub(o[t].editEntity,{data:c?{id:c}:{},parent:i,target:i.find(".entity-edition .entity-content"),callbacks:{after_render:function(){e(window).trigger("resize"),i.find(".entity-edition .callflow-content").animate({scrollTop:0})},save_success:function(e){a.refreshEntityList({template:i,actions:o,entityType:t}),l(t,e.id)},delete_success:function(e){a.refreshEntityList({template:i,actions:o,entityType:t}),i.find(".entity-edition .entity-content").empty()}}})};a.hackResize(i.find(".entity-edition")),i.find(".entity-manager .entity-element").on("click",function(){var t=e(this);if(t.hasClass("callflow-element"))a.renderCallflows(i.find(".callflow-edition")),i.find(".callflow-app-section").hide(),i.find(".callflow-edition").show();else if(t.hasClass("account-element"))a.renderAccountSettings(i.find(".callflow-edition")),i.find(".callflow-app-section").hide(),i.find(".callflow-edition").show();else if(t.hasClass("feature-code-element"))n.pub("callflows.featurecode.render",i.find(".callflow-edition")),i.find(".callflow-app-section").hide(),i.find(".callflow-edition").show();else{var l=t.data("type");i.find(".entity-edition .entity-header .entity-title").text(o[l].name),a.refreshEntityList({template:i,actions:o,entityType:l})}}),i.on("click",".entity-header .back-button",function(){i.find(".entity-edition .entity-content").empty(),i.find(".entity-edition .list-container .list").empty(),i.find(".entity-edition .search-query").val(""),i.find(".callflow-edition").empty(),i.find(".callflow-app-section").hide(),i.find(".entity-manager").show()}),i.find(".entity-edition .list-add").on("click",function(){var t=i.find(".entity-edition .list-container .list").data("type");l(t)}),i.find(".entity-edition .list-container .list").on("click",".list-element",function(){var t=e(this),a=t.data("id"),n=t.parents(".list").data("type");l(n,a)}),i.find(".entity-edition .search-query").on("keyup",function(){var t=e(this).val();t?e.each(i.find(".entity-edition .list-element"),function(){var a=e(this);a.data("search").toLowerCase().indexOf(t.toLowerCase())>=0?a.show():a.hide()}):i.find(".entity-edition .list-element").show()})},refreshEntityList:function(t){var a=this,i=t.template,o=t.actions,l=t.entityType,c=t.callbacks;o[l].listEntities(function(t){a.formatEntityData(t,l);var o=n.template(a,"entity-list",{entities:t});i.find(".entity-edition .list-container .list").empty().append(o).data("type",l),i.find(".callflow-app-section").hide(),i.find(".entity-edition").show(),i.find(".search-query").focus(),e(window).trigger("resize"),c&&c()})},formatEntityData:function(t,e){var n=this;a.each(t,function(t){switch(t.first_name&&t.last_name?t.displayName=t.first_name+" "+t.last_name:t.name?t.displayName=t.name:t.displayName=t.id,e){case"play":t.media_source&&(t.additionalInfo=n.i18n.active().callflows.media.mediaSources[t.media_source])}})},renderAccountSettings:function(t){var a=this,i="silence_stream://300000";a.loadAccountSettingsData(function(o){var l=e(n.template(a,"accountSettings",e.extend(!0,{silenceMedia:i},o)));l.find(".cid-number-select").chosen({search_contains:!0,width:"220px"}),t.empty().append(l),a.bindAccountSettingsEvents(l,o)})},bindAccountSettingsEvents:function(t,a){var i,o=this,l=function(e){if(i=void 0,t.find(".upload-div input").val(""),t.find(".upload-div").slideUp(function(){t.find(".upload-toggle").removeClass("active")}),e){var a=t.find(".media-dropdown");a.append('<option value="'+e.id+'">'+e.name+"</option>"),a.val(e.id)}};t.find(".upload-input").fileUpload({inputOnly:!0,wrapperClass:"file-upload input-append",btnText:o.i18n.active().callflows.accountSettings.musicOnHold.audioUploadButton,btnClass:"monster-button",maxSize:5,success:function(t){i=t[0]},error:function(e){e.hasOwnProperty("size")&&e.size.length>0&&n.ui.alert(o.i18n.active().callflows.accountSettings.musicOnHold.fileTooBigAlert),t.find(".upload-div input").val(""),i=void 0}}),t.find(".upload-toggle").on("click",function(){e(this).hasClass("active")?t.find(".upload-div").stop(!0,!0).slideUp():t.find(".upload-div").stop(!0,!0).slideDown()}),t.find(".upload-cancel").on("click",function(){l()}),t.find(".upload-submit").on("click",function(){i?o.callApi({resource:"media.create",data:{accountId:o.accountId,data:{streamable:!0,name:i.name,media_source:"upload",description:i.name}},success:function(t,e){var a=t.data;o.callApi({resource:"media.upload",data:{accountId:o.accountId,mediaId:a.id,data:i.file},success:function(t,e){l(a)},error:function(t,e){o.callApi({resource:"media.delete",data:{accountId:o.accountId,mediaId:a.id,data:{}},success:function(t,e){}})}})}}):n.ui.alert(o.i18n.active().callflows.accountSettings.musicOnHold.emptyUploadAlert)}),t.find(".account-settings-update").on("click",function(){var t=n.ui.getFormData("account_settings_form"),i=e.extend(!0,{},a.account,t);""===t.music_on_hold.media_id&&delete i.music_on_hold.media_id,""===t.caller_id.external.name&&delete i.caller_id.external.name,""===t.caller_id.external.number&&delete i.caller_id.external.number,o.callApi({resource:"account.update",data:{accountId:i.id,data:i},success:function(t,e){o.render()}})})},loadAccountSettingsData:function(t){var e=this;n.parallel({account:function(t){e.callApi({resource:"account.get",data:{accountId:e.accountId},success:function(e,a){t&&t(null,e.data)}})},mediaList:function(t){e.callApi({resource:"media.list",data:{accountId:e.accountId},success:function(e,a){t&&t(null,e.data)}})},numberList:function(t){e.callApi({resource:"numbers.list",data:{accountId:e.accountId},success:function(e,a){t&&t(null,e.data.numbers)}})}},function(e,a){t&&t(a)})},hackResize:function(t){e(window).resize(function(a){var n=t.find(".list-container"),i=t.find(".callflow-content"),o=t.find(".tools"),l=t.find(".flowchart"),c=window.innerHeight-e("#main_topbar").outerHeight(),s=c+"px",d=c-71+"px";n.css("height",window.innerHeight-n.position().top+"px"),i.css("height",s),o.css("height",d),l.css("height",d)}),e(window).resize()},repaintList:function(t){var a=this,t=t||{},i=t.template||e("#callflow_container"),o=t.callback;a.listData({callback:function(t){var e=n.template(a,"callflowList",{callflows:t.data});i.find(".list-container .list").empty().append(e).data("next-key",t.next_start_key||null),o&&o(t.data)},searchValue:t.searchValue})},listData:function(t){var a=this,n=t.nextStartKey,i=t.searchValue,o=t.callback,l="callflow.list",c={accountId:a.accountId};n&&e.extend(!0,c,{filters:{start_key:encodeURIComponent(n)}}),a.appFlags.showAllCallflows||e.extend(!0,c,{filters:{"filter_not_ui_metadata.origin":"voip"}}),i&&(l="callflow.searchByNameAndNumber",c.value=encodeURIComponent(i)),a.callApi({resource:l,data:c,success:function(t){var e=a.formatData(t);o&&o(e)}})},listNumbers:function(t){var e=this;e.callApi({resource:"numbers.list",data:{accountId:e.accountId},success:function(a){a=e.formatListSpareNumbers(a.data.numbers),t&&t(a)}})},formatListSpareNumbers:function(t){var e=[];return a.each(t,function(t,a){t.hasOwnProperty("used_by")&&""!==t.used_by||(t.phoneNumber=a,e.push(t))}),e},formatData:function(t){var e=[];return a.each(t.data,function(t){var n=(t.numbers||"-").toString(),i=t.featurecode!==!1&&!a.isEmpty(t.featurecode);i||(t.name?(t.description=n,t.title=t.name):t.title=n,e.push(t))}),e.sort(function(t,e){return t.title.toLowerCase()<e.title.toLowerCase()?-1:1}),t.data=e,t},editCallflow:function(t){var a=this;delete a.original_flow,e("#callflow-view .callflow_help").hide(),a.resetFlow(),t&&t.id?a.callApi({resource:"callflow.get",data:{accountId:a.accountId,callflowId:t.id},success:function(t){var t=t.data;a.dataCallflow=t,a.flow.id=t.id,a.flow.name=t.name,a.flow.contact_list={exclude:"contact_list"in t?t.contact_list.exclude||!1:!1},a.flow.caption_map=t.metadata,void 0!=t.flow.module&&(a.flow.root=a.buildFlow(t.flow,a.flow.root,0,"_")),a.flow.numbers=t.numbers||[],a.repaintFlow()}}):(a.resetFlow(),a.dataCallflow={},a.repaintFlow()),a.renderButtons(),a.renderTools()},renderButtons:function(){var t=this,a=e(n.template(t,"buttons"));e(".buttons").empty(),e(".save",a).click(function(){t.flow.numbers&&t.flow.numbers.length>0?t.save():n.ui.alert(t.i18n.active().oldCallflows.invalid_number+"<br/><br/>"+t.i18n.active().oldCallflows.please_select_valid_number)}),e(".delete",a).click(function(){t.flow.id?n.ui.confirm(t.i18n.active().oldCallflows.are_you_sure,function(){t.callApi({resource:"callflow.delete",data:{accountId:t.accountId,callflowId:t.flow.id},success:function(){e("#ws_cf_flow").empty(),e(".buttons").empty(),e("#ws_cf_tools").empty(),e("#hidden_callflow_warning").hide(),t.repaintList(),t.resetFlow()}}),t.show_pending_change(!1)}):n.ui.alert(t.i18n.active().oldCallflows.this_callflow_has_not_been_created)}),e(".buttons").append(a)},buildFlow:function(t,a,n,i){var o=this,l=o.branch(o.construct_action(t));return l.data.data="data"in t?t.data:{},l.id=++n,l.key=i,l.caption=o.actions.hasOwnProperty(l.actionName)?o.actions[l.actionName].caption(l,o.flow.caption_map):"",o.actions.hasOwnProperty(a.actionName)&&o.actions[a.actionName].hasOwnProperty("key_caption")&&(l.key_caption=o.actions[a.actionName].key_caption(l,o.flow.caption_map)),e.each(t.children,function(t,e){l=o.buildFlow(e,l,n,t)}),a.addChild(l),a},construct_action:function(t){var e="";return"data"in t&&("id"in t.data&&(e="id=*,"),"action"in t.data&&(e+="action="+t.data.action+",")),e=""!=e?"["+e.replace(/,$/,"]"):"[]",t.module+e},resetFlow:function(){var t=this;t.flow={},t.flow.root=t.branch("root"),t.flow.root.key="flow",t.flow.numbers=[],t.flow.caption_map={},t.formatFlow()},formatFlow:function(){var t=this;t.flow.root.index(0),t.flow.nodes=t.flow.root.nodes()},branch:function(t){function a(t){var a=this,i=n.actions[t]||{};this.id=-1,this.actionName=t,this.module=i.module,this.key="_",this.parent=null,this.children=[],this.data={data:e.extend(!0,{},i.data)},this.caption="",this.key_caption="",this.potentialChildren=function(){var t=[];for(var e in n.actions)n.actions[e].isUsable&&(t[e]=e);for(var e in i.rules){var a=i.rules[e];switch(a.type){case"quantity":this.children.length>=a.maxSize&&(t=[])}}return t},this.contains=function(t){for(var e=t;e.parent;){if(this.id==e.id)return!0;e=e.parent}return!1},this.removeChild=function(t){e.each(this.children,function(e,n){return n.id==t.id?(a.children.splice(e,1),!1):void 0})},this.addChild=function(t){return t.actionName in this.potentialChildren()?t.contains(this)?!1:(t.parent&&t.parent.removeChild(t),t.parent=this,this.children.push(t),!0):!1},this.getMetadata=function(t){var e;return"data"in this.data&&t in this.data.data?(e=this.data.data[t],"null"==e?null:e):!1},this.setMetadata=function(t,e){"data"in this.data||(this.data.data={}),this.data.data[t]=null==e?"null":e},this.deleteMetadata=function(t){"data"in this.data&&t in this.data.data&&delete this.data.data[t]},this.index=function(t){return this.id=t,e.each(this.children,function(){t=this.index(t+1)}),t},this.nodes=function(){var t={};return t[this.id]=this,e.each(this.children,function(){var a=this.nodes();e.each(a,function(){t[this.id]=this})}),t},this.serialize=function(){var t=e.extend(!0,{},this.data);return t.module=this.module,t.children={},e.each(this.children,function(){t.children[this.key]=this.serialize()}),t}}var n=this;return new a(t)},repaintFlow:function(){var t=this;t.flow.savable=!0;var n=e("#ws_cf_flow").empty();n.append(this.getUIFlow());var i=t.stringify_flow(t.flow);"original_flow"in t&&t.original_flow.split("|")[0]===i.split("|")[0]?t.show_pending_change(t.original_flow!==i):(t.original_flow=i,t.show_pending_change(!1));var o=t.dataCallflow.hasOwnProperty("ui_metadata")?t.dataCallflow.ui_metadata:!1,l=o&&o.hasOwnProperty("origin")&&a.contains(["voip","migration","mobile"],o.origin);l?e("#hidden_callflow_warning").show():e("#hidden_callflow_warning").hide()},show_pending_change:function(t){t?(e("#pending_change","#ws_callflow").show(),e(".save","#ws_callflow").addClass("pulse-box")):(e("#pending_change","#ws_callflow").hide(),e(".save","#ws_callflow").removeClass("pulse-box"))},stringify_flow:function(t){var a,n=t.id+"|"+(t.name?t.name:"undefined");return n+="|NUMBERS",e.each(t.numbers,function(t,e){n+="|"+e}),n+="|NODES",e.each(t.nodes,function(t,i){n+="|"+t+"::",a=!0,e.each(i.data.data,function(t,e){a?a=!1:n+="//",n+=t+":"+e})}),n},getUIFlow:function(){var t=this;t.formatFlow();var i=t.renderBranch(t.flow.root);return e(".node",i).hover(function(){e(this).addClass("over")},function(){e(this).removeClass("over")}),e(".node",i).each(function(){var o,l=t.flow.nodes[e(this).attr("id")],c=e(this);if("root"==l.actionName){c.removeClass("icons_black root"),o=e(n.template(t,"root",{name:t.flow.name||"Callflow"})),e(".edit_icon",o).click(function(){t.flow=e.extend(!0,{contact_list:{exclude:!1}},t.flow);var a=n.template(t,"editName",{name:t.flow.name,exclude:t.flow.contact_list.exclude,ui_is_main_number_cf:t.dataCallflow.hasOwnProperty("ui_is_main_number_cf")?t.dataCallflow.ui_is_main_number_cf:!1}),o=n.ui.dialog(a,{title:t.i18n.active().oldCallflows.popup_title});e("#add",o).click(function(){var a=e("#callflow_name",o);""!=a.val()?(t.flow.name=a.val(),e(".root .top_bar .name",i).html(t.flow.name)):(t.flow.name="",e(".root .top_bar .name",i).html("Callflow")),t.flow.contact_list={exclude:e("#callflow_exclude",o).prop("checked")},t.dataCallflow.ui_is_main_number_cf=e("#ui_is_main_number_cf",o).prop("checked"),t.repaintFlow(),o.dialog("close")})}),e(".tooltip",o).click(function(){n.ui.dialog(n.template(t,"help_callflow"))});for(var s,d=t.flow.numbers.length,r=Math.floor(d/2)+1,f=0;r>f;f++){s=2*f;var u=t.flow.numbers.slice(s,d>s+2?s+2:d),p=n.template(t,"rowNumber",{numbers:u});o.find(".content").append(p)}e(".number_column.empty",o).click(function(){t.listNumbers(function(i){var o=[];a.each(i,function(a){e.inArray(a.phoneNumber,t.flow.numbers)<0&&o.push(a)});var l=e(n.template(t,"addNumber",{phoneNumbers:o})),c=n.ui.dialog(l,{title:t.i18n.active().oldCallflows.add_number});0===o.length&&(e("#list_numbers",l).attr("disabled","disabled"),e('<option value="select_none">'+t.i18n.active().oldCallflows.no_phone_numbers+"</option>").appendTo(e("#list_numbers",l)));e(".extensions_content",c).hide(),e('input[name="number_type"]',c).click(function(){"your_numbers"===e(this).val()?(e(".list_numbers_content",c).show(),e(".extensions_content",c).hide()):(e(".extensions_content",c).show(),e(".list_numbers_content",c).hide())}),c.find(".buy-link").on("click",function(t){t.preventDefault(),n.pub("common.buyNumbers",{searchType:e(this).data("type"),callbacks:{success:function(t){a.each(t,function(t,a){e('<option value="'+a+'">'+a+"</option>").appendTo(e("#list_numbers",c))})}}})}),e(".add_number",c).click(function(a){a.preventDefault();var i="your_numbers"===e('input[name="number_type"]:checked',c).val()?e("#list_numbers option:selected",c).val():e("#add_number_text",c).val();"select_none"!==i&&""!==i?(t.flow.numbers.push(i),c.dialog("close"),t.repaintFlow()):n.ui.alert(t.i18n.active().oldCallflows.you_didnt_select)})})}),e(".number_column .delete",o).click(function(){var a=e(this).parent(".number_column").data("number")+"",n=e.inArray(a,t.flow.numbers);n>=0&&t.flow.numbers.splice(n,1),t.repaintFlow()})}else o=e(n.template(t,"node",{node:l,callflow:t.actions[l.actionName]})),e(".module",o).click(function(){t.actions[l.actionName].edit(l,function(){t.repaintFlow()})});e(this).append(o),e(this).droppable({drop:function(a,n){var i,o=t.flow.nodes[e(this).attr("id")];if(n.draggable.hasClass("action")&&(i=n.draggable.attr("name"),l=t.branch(i),l.caption=t.actions[i].caption(l,t.flow.caption_map),o.addChild(l)&&(l.parent&&"key_caption"in t.actions[l.parent.actionName]?(l.key_caption=t.actions[l.parent.actionName].key_caption(l,t.flow.caption_map),t.actions[l.parent.actionName].key_edit(l,function(){t.actions[i].edit(l,function(){t.repaintFlow()})})):t.actions[i].edit(l,function(){t.repaintFlow()}),t.repaintFlow())),n.draggable.hasClass("node")){var l=t.flow.nodes[n.draggable.attr("id")];o.addChild(l)&&(l.key="_",l.parent&&"key_caption"in t.actions[l.parent.actionName]&&(l.key_caption=t.actions[l.parent.actionName].key_caption(l,t.flow.caption_map)),n.draggable.remove(),t.repaintFlow())}}}),"root"!=e(this).attr("name")&&e(this).draggable({start:function(){var a=e(this).next(),n=a.offset().top-e(this).offset().top,i=a.offset().left-e(this).offset().left;t.enableDestinations(e(this)),e(this).attr("t",n),e(this).attr("l",i)},drag:function(){var t=e(this).next(),a=e(this).offset().top+parseInt(e(this).attr("t")),n=e(this).offset().left+parseInt(e(this).attr("l"));t.offset({top:a,left:n})},stop:function(){t.disableDestinations(),t.repaintFlow()}})}),e(".node-options .delete",i).click(function(){var a=t.flow.nodes[e(this).attr("id")];a.parent&&(a.parent.removeChild(a),t.repaintFlow())}),i},renderBranch:function(t){var a,i=this,o=e(n.template(i,"branch",{node:t,display_key:t.parent&&"key_caption"in i.actions[t.parent.actionName]}));return t.parent&&"key_edit"in i.actions[t.parent.actionName]&&e(".div_option",o).click(function(){i.actions[t.parent.actionName].key_edit(t,function(){i.repaintFlow()})}),a=e(".children",o),e.each(t.children,function(){a.append(i.renderBranch(this))}),o},renderTools:function(){function t(t){t.draggable({start:function(){o.enableDestinations(e(this)),e(this).addClass("inactive")},drag:function(){e(".callflow_helpbox_wrapper","#callflow-view").hide()},stop:function(){o.disableDestinations(),e(this).removeClass("inactive")},containment:e("body"),helper:"clone"})}var a,i,o=this,l=o.i18n.active().oldCallflows.advanced_cat,c=o.i18n.active().oldCallflows.basic_cat,s={categories:[]},d={};d[c]=[],d[l]=[],e.each(o.actions,function(t,e){"category"in e&&(e.category in d?!0:d[e.category]=[],e.key=t,d[e.category].push(e))}),e.each(d,function(t,e){t!==c&&t!==l&&s.categories.push({key:t,actions:e})}),s.categories.sort(function(t,e){return t.key<e.key?1:-1}),s.categories.unshift({key:c,actions:d[c]},{key:l,actions:d[l]}),e.each(d,function(t,e){e.sort(function(t,e){return t.hasOwnProperty("weight")?t.weight>e.weight?1:-1:void 0})}),i=e(n.template(o,"tools",s)),e(".tooltip",i).click(function(){n.ui.dialog(n.template(o,"help_callflow"))}),e("#Basic",i).removeClass("inactive").addClass("active"),e(".category .open",i).click(function(){i.find(".category").removeClass("active").addClass("inactive"),e(this).parent(".category").removeClass("inactive").addClass("active")});var r=e(".callflow_helpbox_wrapper","#callflow-view").first();e(".tool",i).hover(function(){e(this).addClass("active"),e(".tool_name","#callflow-view").removeClass("active"),e(".tool_name",e(this)).addClass("active"),e(this).attr("help")&&(e("#help_box",r).html(e(this).attr("help")),e(".callflow_helpbox_wrapper","#callflow-view").css("top",e(this).offset().top-72).show())},function(){e(this).removeClass("active"),e(".callflow_helpbox_wrapper","#callflow-view").hide()}),e(".action",i).each(function(){t(e(this))}),a=e("#ws_cf_tools").empty(),a.append(i),e("#ws_cf_tools","#callflow-view").disableSelection()},enableDestinations:function(t){var a=this;e(".node").each(function(){var n=!0,i=a.flow.nodes[e(this).attr("id")];t.attr("name")in i.potentialChildren()?t.hasClass("node")&&a.flow.nodes[t.attr("id")].contains(i)&&(n=!1):n=!1,n?e(this).addClass("active"):(e(this).addClass("inactive"),e(this).droppable("disable"))})},disableDestinations:function(){e(".node").each(function(){e(this).removeClass("active"),e(this).removeClass("inactive"),e(this).droppable("enable")}),e(".tool").removeClass("active")},save:function(){var t=this;if(t.flow.numbers&&t.flow.numbers.length>0){var a={numbers:t.flow.numbers,flow:void 0==t.flow.root.children[0]?{}:t.flow.root.children[0].serialize()};""!==t.flow.name?a.name=t.flow.name:(delete a.name,delete t.dataCallflow.name),"contact_list"in t.flow&&(a.contact_list={exclude:t.flow.contact_list.exclude||!1}),t.dataCallflow.flow=a.flow,a=e.extend(!0,{},t.dataCallflow,a),delete a.metadata,t.flow.id?t.callApi({resource:"callflow.update",data:{accountId:t.accountId,callflowId:t.flow.id,data:a},success:function(e){t.repaintList(),t.editCallflow({id:e.data.id})}}):t.callApi({resource:"callflow.create",data:{accountId:t.accountId,data:a},success:function(e){t.repaintList(),t.editCallflow({id:e.data.id})}})}else n.ui.alert(t.i18n.active().oldCallflows.you_need_to_select_a_number)},winkstartTabs:function(t,a){var i=t.find(".view-buttons"),o=t.find(".tabs");a?(i.find(".btn").removeClass("activate"),i.find(".advanced").addClass("activate")):n.config.advancedView?(i.find(".btn").removeClass("activate"),i.find(".advanced").addClass("activate")):o.hide("blind"),o.find("li").length<2&&i.hide(),i.find(".basic").on("click",function(){var t=e(this);t.hasClass("activate")||(i.find(".btn").removeClass("activate"),t.addClass("activate"),o.find("li:first-child > a").trigger("click"),o.hide("blind"))}),i.find(".advanced").click(function(){var t=e(this);t.hasClass("activate")||(i.find(".btn").removeClass("activate"),t.addClass("activate"),o.show("blind"))}),o.find("li").on("click",function(a){a.preventDefault();var n=e(this),i=n.find("a").attr("href");o.find("li").removeClass("active"),t.find(".pill-content >").removeClass("active"),n.addClass("active"),t.find(i).addClass("active")})},winkstartLinkForm:function(t){e("input",t).bind("change.link keyup.link focus.link",function(){var a=e(this),n=a.attr("name"),i=a.attr("type"),o=a.val(),l=a.attr("id"),c=e('input[name="'+n+'"]',t);c.size()>1?"checkbox"==i?(c=c.filter("[value="+o+"]"),a.attr("checked")?c.attr("checked","checked"):c.removeAttr("checked")):e.each(c,function(t,a){var n=e(a);n.attr("id")!==l&&n.val(o)}):a.unbind(".link")})}};return i});