define(["require","jquery","underscore","monster","monster-timezone"],function(e){var t=e("jquery"),a=(e("underscore"),e("monster")),n=e("monster-timezone"),i={requests:{},subscribe:{"callflows.fetchActions":"faxboxDefineActions","callflows.faxbox.edit":"_faxboxEdit"},faxboxDefineActions:function(e){var n=this,i=e.actions;t.extend(i,{"faxbox[id=*]":{name:n.i18n.active().callflows.faxbox.faxboxes_label,icon:"printer2",category:n.i18n.active().oldCallflows.advanced_cat,module:"faxbox",tip:n.i18n.active().callflows.faxbox.faxbox_tip,data:{},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:130,caption:function(e,t){var a=e.getMetadata("id"),n="";return a in t&&(n=t[a].name),n},edit:function(e,i){n.faxboxList(function(o,s){var c,r=t(a.template(n,"faxbox-callflowEdit",{items:a.util.sort(o),selected:e.getMetadata("id")||""}));void 0==t("#faxbox_selector option:selected",r).val()&&t("#edit_link",r).hide(),t(".inline_action",r).click(function(a){var i="edit"==t(this).data("action")?{id:t("#faxbox_selector",r).val()}:{};a.preventDefault(),n.faxboxPopupEdit({data:i,callback:function(t){e.setMetadata("id",t.id||"null"),e.caption=t.name||"",c.dialog("close")}})}),t("#add",r).click(function(){e.setMetadata("id",t("#faxbox_selector",r).val()),e.caption=t("#faxbox_selector option:selected",r).text(),c.dialog("close")}),c=a.ui.dialog(r,{title:n.i18n.active().callflows.faxbox.voicemail_title,minHeight:"0",beforeClose:function(){"function"==typeof i&&i()}})})},listEntities:function(e){n.callApi({resource:"faxbox.list",data:{accountId:n.accountId,filters:{paginate:!1}},success:function(t,a){e&&e(t.data)}})},editEntity:"callflows.faxbox.edit"}})},faxboxPopupEdit:function(e){var n,i=this,o=o=t('<div class="inline_popup callflows-port"><div class="inline_content main_content"/></div>'),s=e.data,c=e.callback,r=e.data_defaults||{};i.faxboxEdit(s,o,t(".inline_content",o),{save_success:function(e){n.dialog("close"),"function"==typeof c&&c(e)},delete_success:function(){n.dialog("close"),"function"==typeof c&&c({data:{}})},after_render:function(){n=a.ui.dialog(o,{title:i.i18n.active().callflows.faxbox[(s.id?"edit":"create").concat("_faxbox")]})}},r)},_faxboxEdit:function(e){var t=this;t.faxboxEdit(e.data,e.parent,e.target,e.callbacks,e.data_defaults)},faxboxEdit:function(e,n,i,o){var s=this,c=n||t("#faxbox-content"),r=i||t("#faxbox-view",c),o=o||{},l={save_success:o.save_success||function(e){s.faxboxRenderList(c),s.faxboxEdit({id:e.id},c,r,l)},save_error:o.save_error,delete_success:o.delete_success||function(){r.empty(),s.faxboxRenderList(c)},delete_error:o.delete_error,after_render:o.after_render};a.parallel({faxbox:function(t){"object"==typeof e&&e.id?s.faxboxGet(e.id,function(a,n){a.id=e.id,t(null,a)}):t(null,{})},user_list:function(e){s.callApi({resource:"user.list",data:{accountId:s.accountId,filters:{paginate:!1}},success:function(t,a){t.data.sort(function(e,t){return e.hasOwnProperty("first_name")&&e.hasOwnProperty("last_name")&&t.hasOwnProperty("first_name")&&t.hasOwnProperty("last_name")?e.first_name.concat(" ",e.last_name).toLowerCase()>t.first_name.concat(" ",t.last_name).toLowerCase()?1:-1:1}),t.data.unshift({id:"",first_name:s.i18n.active().callflows.faxbox.no,last_name:s.i18n.active().callflows.faxbox.owner}),e(null,t.data)}})},current_user:function(e){a.util.isMasquerading()?e(null,{}):s.faxboxGetUser(s.userId,function(t,a){e(null,t)})}},function(a,n){e.hasOwnProperty("id")||(0===Object.keys(n.current_user).length?n.faxbox=t.extend(!0,s.faxboxGetDefaultSettings(),n.faxbox):n.faxbox=t.extend(!0,s.faxboxGetDefaultSettings(n.current_user),n.faxbox)),delete n.current_user,s.faxboxRender(n,r,l),"function"==typeof l.after_render&&l.after_render()})},faxboxRender:function(e,i,o){var s=this,c=t(a.template(s,"faxbox-edit",{faxbox:s.faxboxNormalizedData(e.faxbox),users:e.user_list}));n.populateDropdown(t("#fax_timezone",c),e.faxbox.fax_timezone||"inherit",{inherit:s.i18n.active().defaultTimezone}),t('*[rel=popover]:not([type="text"])',c).popover({trigger:"hover"}),t('*[rel=popover][type="text"]',c).popover({trigger:"focus"}),s.winkstartTabs(c),e.faxbox.hasOwnProperty("id")?t("#owner_id",c).change(function(n){var r=a.ui.getFormData("faxbox_form");t(this).val()?(t('[id$="bound_notification_email"]',c).each(function(e,a){t(a).attr("disabled",!0)}),s.faxboxGetUser(t(this).val(),function(a,n){e.faxbox=t.extend(!0,{},s.faxboxGetDefaultSettings(),e.faxbox,r,{cloud_connector_claim_url:c.find("#cloud_connector_claim_url").attr("href"),notifications:{inbound:{email:{send_to:a.email||a.username}},outbound:{email:{send_to:a.email||a.username}}}}),t("#edit_link",c).hide(),s.faxboxRender(e,i,o)})):t('[id$="bound_notification_email"]',c).each(function(e,a){t(a).attr("disabled",!1)})}):t("#owner_id",c).change(function(a){t(this).val()?s.faxboxGetUser(t(this).val(),function(a,n){e.faxbox=s.faxboxGetDefaultSettings(a),t("#edit_link",c).show(),s.faxboxRender(e,i,o)}):(e.faxbox=s.faxboxGetDefaultSettings(),t("#edit_link",c).hide(),s.faxboxRender(e,i,o))}),t("#owner_id",c).val()||t("#edit_link",c).hide(),t(".inline-action",c).click(function(e){var n="edit"==t(this).data("action")?{id:t("#owner_id",c).val()}:{},i=n.id;a.pub("callflows.user.popupEdit",{data:n,callflow:function(e){i?"id"in e?t("#owner_id #"+e.id,c).text(e.first_name+" "+e.last_name):t("#owner_id #"+i,c).remove():(t("#owner_id",c).append('<option id="'+e.id+'" value="'+e.id+'">'+e.first_name+" "+e.last_name+"</option>"),t("#owner_id",c).val(e.id))}})}),t("#caller_id",c).change(function(e){var a=t(this).val(),n=t("#fax_identity",c);/^(\+1|1)([0-9]{10})$|^([0-9]{10})$/.test(a)?/^(\+1)/.test(a)?n.val(a.replace(/^\+1([0-9]{3})([0-9]{3})([0-9]{4})$/,"+1 ($1) $2-$3")):/^1([0-9]{10})$/.test(a)?n.val(a.replace(/^1([0-9]{3})([0-9]{3})([0-9]{4})$/,"+1 ($1) $2-$3")):n.val(a.replace(/^([0-9]{3})([0-9]{3})([0-9]{4})$/,"+1 ($1) $2-$3")):n.val("")}),t(".faxbox-save",c).click(function(n){n.preventDefault();var i=t("#faxbox_form",c),r=a.ui.getFormData("faxbox_form"),l=/^[\w\s'-]+/;a.ui.validate(i,{rules:{name:{required:!0},caller_name:{regex:l},fax_header:{regex:l},retries:{regex:/^[0-4]/}},messages:{caller_name:{regex:s.i18n.active().callflows.faxbox.validation.words},fax_header:{regex:s.i18n.active().callflows.faxbox.validation.words},retries:{regex:"Please enter a numeric value between 0 and 4"}}}),a.ui.valid(i)&&s.faxboxSave(r,e.faxbox,o.save_success,o.save_error)}),t(".faxbox-delete",c).click(function(t){t.preventDefault(),a.ui.confirm(s.i18n.active().callflows.faxbox.are_you_sure_you_want_to_delete,function(){s.faxboxDelete(e.faxbox,o.delete_success,o.delete_error)})}),i.empty().append(c)},faxboxRenderList:function(e){var t=this;t.faxboxList(function(e,t){})},faxboxGetDefaultSettings:function(e){var n=this,i={name:"",caller_name:"",fax_header:"",fax_timezone:"inherit",retries:1,notifications:{inbound:{email:{send_to:""}},outbound:{email:{send_to:""}}}};return"undefined"==typeof e?i:t.extend(!0,{},i,{name:e.first_name.concat(" ",e.last_name,n.i18n.active().callflows.faxbox.default_settings_name_extension),caller_name:e.first_name.concat(" ",e.last_name),fax_header:a.config.whitelabel.companyName.concat(n.i18n.active().callflows.faxbox.default_settings_header_extension),owner_id:e.id,notifications:{inbound:{email:{send_to:e.email||e.username}},outbound:{email:{send_to:e.email||e.username}}}})},faxboxSave:function(e,a,n,i){var o=this,s=o.faxboxNormalizedData(t.extend(!0,{},a,e));"object"==typeof a&&a.id?o.faxboxUpdate(s,function(e,t){"function"==typeof n&&n(e,t,"update")},function(e,t){"function"==typeof i&&i(e,t,"update")}):o.faxboxCreate(s,function(e,t){"function"==typeof n&&n(e,t,"create")},function(e,t){"function"==typeof i&&i(e,t,"create")})},faxboxNormalizedData:function(e){if(e.hasOwnProperty("notifications")){var t=e.notifications.inbound.email.send_to,a=e.notifications.outbound.email.send_to;e.notifications.inbound.email.send_to=t instanceof Array?t.join(","):t.replace(/\s/g,"").split(","),e.notifications.outbound.email.send_to=a instanceof Array?a.join(","):a.replace(/\s/g,"").split(",")}if(e.hasOwnProperty("smtp_permission_list"))if(""===e.smtp_permission_list)delete e.smtp_permission_list;else{var n=e.smtp_permission_list;e.smtp_permission_list=n instanceof Array?n.join(","):n.replace(/\s/g,"").split(",")}return e.hasOwnProperty("custom_smtp_email_address")&&""===e.custom_smtp_email_address&&delete e.custom_smtp_email_address,e.hasOwnProperty("owner_id")&&""===e.owner_id&&delete e.owner_id,e.fax_timezone&&"inherit"===e.fax_timezone&&delete e.fax_timezone,e},faxboxList:function(e){var t=this;t.callApi({resource:"faxbox.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t){e&&e(t.data)}})},faxboxGet:function(e,t){var a=this;a.callApi({resource:"faxbox.get",data:{accountId:a.accountId,faxboxId:e},success:function(e){t&&t(e.data)}})},faxboxCreate:function(e,t){var a=this;a.callApi({resource:"faxbox.create",data:{accountId:a.accountId,data:e},success:function(e){t&&t(e.data)}})},faxboxUpdate:function(e,t){var a=this;a.callApi({resource:"faxbox.update",data:{accountId:a.accountId,faxboxId:e.id,data:e},success:function(e){t&&t(e.data)}})},faxboxDelete:function(e,t,a){var n=this;"object"==typeof e&&e.hasOwnProperty("id")&&n.callApi({resource:"faxbox.delete",data:{accountId:n.accountId,faxboxId:e.id},success:function(e){t&&t(e.data)},error:function(e){a&&a()}})},faxboxGetUser:function(e,t,a){var n=this;n.callApi({resource:"user.get",data:{accountId:n.accountId,userId:e},success:function(e,a){t&&t(e.data)},error:function(e,t){a&&a()}})}};return i});