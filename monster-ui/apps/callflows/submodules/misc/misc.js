define(["require","jquery","underscore","monster"],function(e){var t=e("jquery"),a=e("underscore"),i=e("monster"),l={requests:{},subscribe:{"callflows.fetchActions":"miscDefineActions"},miscGetGroupPickupData:function(e){var t=this;i.parallel({groups:function(e){t.miscGroupList(function(t){e(null,t)})},users:function(e){t.miscUserList(function(t){a.each(t,function(e){e.name=e.first_name+" "+e.last_name}),e(null,t)})},devices:function(e){t.miscDeviceList(function(t){e(null,t)})}},function(t,a){e&&e(a)})},miscDefineActions:function(e){var a=this,l=e.actions;t.extend(l,{root:{name:"Root",rules:[{type:"quantity",maxSize:"1"}],isUsable:"false"},"callflow[id=*]":{name:a.i18n.active().oldCallflows.callflow,icon:"callflow",category:a.i18n.active().oldCallflows.advanced_cat,module:"callflow",tip:a.i18n.active().oldCallflows.callflow_tip,data:{id:"null"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:20,caption:function(e,t){var a=e.getMetadata("id"),i="";return a in t&&(t[a].hasOwnProperty("name")?i=t[a].name:t[a].hasOwnProperty("numbers")&&(i=t[a].numbers.toString())),i},edit:function(e,l){a.callApi({resource:"callflow.list",data:{accountId:a.accountId,filters:{paginate:!1}},success:function(n,o){var c,d,r=[];t.each(n.data,function(){this.featurecode||this.id===a.flow.id||(this.name=this.name?this.name:this.numbers?this.numbers.toString():a.i18n.active().oldCallflows.no_numbers,r.push(this))}),d=t(i.template(a,"callflow-edit_dialog",{objects:{type:"callflow",items:i.util.sort(r),selected:e.getMetadata("id")||""}})),t("#add",d).click(function(){e.setMetadata("id",t("#object-selector",d).val()),e.caption=t("#object-selector option:selected",d).text(),c.dialog("close")}),c=i.ui.dialog(d,{title:a.i18n.active().oldCallflows.callflow_title,beforeClose:function(){"function"==typeof l&&l()}})}})}},"call_forward[action=activate]":{name:a.i18n.active().oldCallflows.enable_call_forwarding,icon:"rightarrow",category:a.i18n.active().oldCallflows.call_forwarding_cat,module:"call_forward",tip:a.i18n.active().oldCallflows.enable_call_forwarding_tip,data:{action:"activate"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:10,caption:function(e,t){return""},edit:function(e,t){"function"==typeof t&&t()}},"call_forward[action=deactivate]":{name:a.i18n.active().oldCallflows.disable_call_forwarding,icon:"rightarrow",category:a.i18n.active().oldCallflows.call_forwarding_cat,module:"call_forward",tip:a.i18n.active().oldCallflows.disable_call_forwarding_tip,data:{action:"deactivate"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:20,caption:function(e,t){return""},edit:function(e,t){"function"==typeof t&&t()}},"call_forward[action=update]":{name:a.i18n.active().oldCallflows.update_call_forwarding,icon:"rightarrow",category:a.i18n.active().oldCallflows.call_forwarding_cat,module:"call_forward",tip:a.i18n.active().oldCallflows.update_call_forwarding_tip,data:{action:"update"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:30,caption:function(e,t){return""},edit:function(e,t){"function"==typeof t&&t()}},"dynamic_cid[]":{name:a.i18n.active().oldCallflows.dynamic_cid,icon:"rightarrow",category:a.i18n.active().oldCallflows.caller_id_cat,module:"dynamic_cid",tip:a.i18n.active().oldCallflows.dynamic_cid_tip,isUsable:"true",weight:10,caption:function(e,t){return""},edit:function(e,t){"function"==typeof t&&t()}},"prepend_cid[action=prepend]":{name:a.i18n.active().oldCallflows.prepend,icon:"plus_circle",category:a.i18n.active().oldCallflows.caller_id_cat,module:"prepend_cid",tip:a.i18n.active().oldCallflows.prepend_tip,data:{action:"prepend",caller_id_name_prefix:"",caller_id_number_prefix:""},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:20,caption:function(e,t){return(e.getMetadata("caller_id_name_prefix")||"")+" "+(e.getMetadata("caller_id_number_prefix")||"")},edit:function(e,l){var n,o;o=t(i.template(a,"misc-prepend_cid_callflow",{data_cid:{caller_id_name_prefix:e.getMetadata("caller_id_name_prefix")||"",caller_id_number_prefix:e.getMetadata("caller_id_number_prefix")||""}})),t("#add",o).click(function(){var a=t("#cid_name_prefix",o).val(),i=t("#cid_number_prefix",o).val();e.setMetadata("caller_id_name_prefix",a),e.setMetadata("caller_id_number_prefix",i),e.caption=a+" "+i,n.dialog("close")}),n=i.ui.dialog(o,{title:a.i18n.active().oldCallflows.prepend_caller_id_title,beforeClose:function(){"function"==typeof l&&l()}}),"function"==typeof l&&l()}},"prepend_cid[action=reset]":{name:a.i18n.active().oldCallflows.reset_prepend,icon:"loop2",category:a.i18n.active().oldCallflows.caller_id_cat,module:"prepend_cid",tip:a.i18n.active().oldCallflows.reset_prepend_tip,data:{action:"reset"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:30,caption:function(e,t){return""},edit:function(e,t){"function"==typeof t&&t()}},"manual_presence[]":{name:a.i18n.active().oldCallflows.manual_presence,icon:"lightbulb_on",category:a.i18n.active().oldCallflows.advanced_cat,module:"manual_presence",tip:a.i18n.active().oldCallflows.manual_presence_tip,data:{},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:40,caption:function(e,t){return e.getMetadata("presence_id")||""},edit:function(e,l){var n,o=t(i.template(a,"presence-callflowEdit",{data_presence:{presence_id:e.getMetadata("presence_id")||"",status:e.getMetadata("status")||"busy"}}));t("#add",o).click(function(){var a=t("#presence_id_input",o).val();e.setMetadata("presence_id",a),e.setMetadata("status",t("#presence_status option:selected",o).val()),e.caption=a,n.dialog("close")}),n=i.ui.dialog(o,{title:a.i18n.active().oldCallflows.manual_presence_title,beforeClose:function(){"function"==typeof l&&l()}})}},"language[]":{name:a.i18n.active().oldCallflows.language,icon:"earth",category:a.i18n.active().oldCallflows.advanced_cat,module:"language",tip:a.i18n.active().oldCallflows.language_tip,data:{},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:50,caption:function(e,t){return e.getMetadata("language")||""},edit:function(e,l){var n,o;o=t(i.template(a,"misc-language",{data_language:{language:e.getMetadata("language")||""}})),t("#add",o).click(function(){var a=t("#language_id_input",o).val();e.setMetadata("language",a),e.caption=a,n.dialog("close")}),n=i.ui.dialog(o,{title:a.i18n.active().oldCallflows.language_title,beforeClose:function(){"function"==typeof l&&l()}})}},"group_pickup[]":{name:a.i18n.active().oldCallflows.group_pickup,icon:"sip",category:a.i18n.active().oldCallflows.advanced_cat,module:"group_pickup",tip:a.i18n.active().oldCallflows.group_pickup_tip,data:{},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",weight:60,caption:function(e,t){return e.getMetadata("name")||""},edit:function(e,l){a.miscGetGroupPickupData(function(n){var o,c;c=t(i.template(a,"misc-group_pickup",{data:{items:n,selected:e.getMetadata("device_id")||e.getMetadata("group_id")||e.getMetadata("user_id")||""}})),t("#add",c).click(function(){var a=t("#endpoint_selector",c),i=a.val(),l=a.find("#"+i).html(),n=t("#"+i,c).parents("optgroup").data("type"),d=n.substring(n,n.length-1)+"_id";e.data.data={},e.setMetadata(d,i),e.setMetadata("name",l),e.caption=l,o.dialog("close")}),o=i.ui.dialog(c,{title:a.i18n.active().oldCallflows.select_endpoint_title,beforeClose:function(){l&&l()}})})}},"receive_fax[]":{name:a.i18n.active().oldCallflows.receive_fax,icon:"sip",category:a.i18n.active().oldCallflows.advanced_cat,module:"receive_fax",tip:a.i18n.active().oldCallflows.receive_fax_tip,data:{owner_id:null},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",weight:70,caption:function(e,t){return""},edit:function(e,l){a.miscUserList(function(n,o){var c,d;t.each(n,function(){this.name=this.first_name+" "+this.last_name}),d=t(i.template(a,"fax-callflowEdit",{objects:{items:n,selected:e.getMetadata("owner_id")||"",t_38:e.getMetadata("media")&&e.getMetadata("media").fax_option||!1}})),void 0==t("#user_selector option:selected",d).val()&&t("#edit_link",d).hide(),t(".inline_action",d).click(function(a){var l="edit"==t(this).data("action")?{id:t("#user_selector",d).val()}:{};a.preventDefault(),i.pub("callflows.user.popupEdit",{data:l,callback:function(t){e.setMetadata("owner_id",t.id||"null"),c.dialog("close")}})}),t("#add",d).click(function(){e.setMetadata("owner_id",t("#user_selector",d).val()),e.setMetadata("media",{fax_option:t("#t_38_checkbox",d).is(":checked")}),c.dialog("close")}),c=i.ui.dialog(d,{title:a.i18n.active().oldCallflows.select_user_title,minHeight:"0",beforeClose:function(){"function"==typeof l&&l()}})})}},"record_call[action=start]":{name:a.i18n.active().oldCallflows.start_call_recording,icon:"conference",category:a.i18n.active().oldCallflows.call_recording_cat,module:"record_call",tip:a.i18n.active().oldCallflows.start_call_recording_tip,data:{action:"start"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:10,caption:function(e){return""},edit:function(e,l){var n,o=t(i.template(a,"recordCall-callflowEdit",{data_call_record:{format:e.getMetadata("format")||"mp3",url:e.getMetadata("url")||"",time_limit:e.getMetadata("time_limit")||"600"}}));t("#add",o).click(function(){e.setMetadata("url",t("#url",o).val()),e.setMetadata("format",t("#format",o).val()),e.setMetadata("time_limit",t("#time_limit",o).val()),n.dialog("close")}),n=i.ui.dialog(o,{title:a.i18n.active().oldCallflows.start_call_recording,minHeight:"0",beforeClose:function(){"function"==typeof l&&l()}})}},"record_call[action=stop]":{name:a.i18n.active().oldCallflows.stop_call_recording,icon:"conference",category:a.i18n.active().oldCallflows.call_recording_cat,module:"record_call",tip:a.i18n.active().oldCallflows.stop_call_recording_tip,data:{action:"stop"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:20,caption:function(e){return""},edit:function(e,t){}},"pivot[]":{name:a.i18n.active().oldCallflows.pivot,icon:"conference",category:a.i18n.active().oldCallflows.advanced_cat,module:"pivot",tip:a.i18n.active().oldCallflows.pivot_tip,data:{method:"get",req_timeout:"5",req_format:"twiml",voice_url:""},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",weight:80,caption:function(e){return""},edit:function(e,l){var n,o;o=t(i.template(a,"misc-pivot",{data_pivot:{method:e.getMetadata("method")||"get",voice_url:e.getMetadata("voice_url")||"",req_timeout:e.getMetadata("req_timeout")||"5",req_format:e.getMetadata("req_format")||"twiml"}})),t("#add",o).click(function(){e.setMetadata("voice_url",t("#pivot_voiceurl_input",o).val()),e.setMetadata("method",t("#pivot_method_input",o).val()),e.setMetadata("req_format",t("#pivot_format_input",o).val()),n.dialog("close")}),n=i.ui.dialog(o,{title:a.i18n.active().oldCallflows.pivot_title,minHeight:"0",beforeClose:function(){"function"==typeof l&&l()}})}},"disa[]":{name:a.i18n.active().oldCallflows.disa,icon:"conference",category:a.i18n.active().oldCallflows.advanced_cat,module:"disa",tip:a.i18n.active().oldCallflows.disa_tip,data:{pin:"",use_account_caller_id:!0},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",weight:90,caption:function(e){return""},edit:function(e,l){var n,o;o=t(i.template(a,"misc-disa",{data_disa:{pin:e.getMetadata("pin"),retries:e.getMetadata("retries"),interdigit:e.getMetadata("interdigit"),max_digits:e.getMetadata("max_digits"),preconnect_audio:e.getMetadata("preconnect_audio"),use_account_caller_id:e.getMetadata("use_account_caller_id")}})),i.ui.tooltips(o),t("#add",o).click(function(){var l=function(){var a=function(t,a){"default"!==a?e.setMetadata(t,a):e.deleteMetadata(t)};a("pin",t("#disa_pin_input",o).val()),a("retries",t("#disa_retries_input",o).val()),a("interdigit",t("#disa_interdigit_input",o).val()),a("preconnect_audio",t("#preconnect_audio",o).val()),a("use_account_caller_id",!t("#disa_keep_original_caller_id",o).is(":checked")),a("max_digits",t("#disa_max_digits_input",o).val()),n.dialog("close")};""==t("#disa_pin_input",o).val()?i.ui.confirm(a.i18n.active().oldCallflows.not_setting_a_pin,function(){l()}):l()}),n=i.ui.dialog(o,{title:a.i18n.active().callflows.disa.title,beforeClose:function(){"function"==typeof l&&l()}})}},"response[]":{name:a.i18n.active().oldCallflows.response,icon:"rightarrow",category:a.i18n.active().oldCallflows.advanced_cat,module:"response",tip:a.i18n.active().oldCallflows.response_tip,data:{code:"",message:"",media:"null"},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",weight:100,caption:function(e,t){return a.i18n.active().oldCallflows.sip_code_caption+e.getMetadata("code")},edit:function(e,l){a.miscMediaList(function(n){var o,c;c=t(i.template(a,"misc-response",{response_data:{items:n,media_enabled:e.getMetadata("media")?!0:!1,selected_media:e.getMetadata("media")||"",code:e.getMetadata("code")||"",message:e.getMetadata("message")||""}})),(void 0==t("#media_selector option:selected",c).val()||"null"==t("#media_selector option:selected",c).val())&&t("#edit_link",c).hide(),t("#media_selector",c).change(function(){void 0==t("#media_selector option:selected",c).val()||"null"==t("#media_selector option:selected",c).val()?t("#edit_link",c).hide():t("#edit_link",c).show()}),t(".inline_action",c).click(function(a){var l="edit"==t(this).data("action")?{id:t("#media_selector",c).val()}:{};a.preventDefault(),i.pub("callflows.media.editPopup",{data:l,callback:function(t){e.setMetadata("media",t.data.id||"null"),o.dialog("close")}})}),t("#add",c).click(function(){t("#response_code_input",c).val().match(/^[1-6][0-9]{2}$/)?(e.setMetadata("code",t("#response_code_input",c).val()),e.setMetadata("message",t("#response_message_input",c).val()),t("#media_selector",c).val()&&"null"!=t("#media_selector",c).val()?e.setMetadata("media",t("#media_selector",c).val()):e.deleteMetadata("media"),e.caption=a.i18n.active().oldCallflows.sip_code_caption+t("#response_code_input",c).val(),o.dialog("close")):i.ui.alert("error",a.i18n.active().oldCallflows.please_enter_a_valide_sip_code)}),o=i.ui.dialog(c,{title:a.i18n.active().oldCallflows.response_title,minHeight:"0",beforeClose:function(){"function"==typeof l&&l()}})})}}})},miscDeviceList:function(e){var t=this;t.callApi({resource:"device.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t,a){e&&e(t.data)}})},miscGroupList:function(e){var t=this;t.callApi({resource:"group.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t,a){e&&e(t.data)}})},miscUserList:function(e){var t=this;t.callApi({resource:"user.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t,a){e&&e(t.data)}})},miscMediaList:function(e){var t=this;t.callApi({resource:"media.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t,a){e&&e(t.data)}})}};return l});