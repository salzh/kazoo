define(["require","jquery","underscore","monster","monster-timezone"],function(e){var i=e("jquery"),t=(e("underscore"),e("monster")),a=e("monster-timezone"),n={requests:{},subscribe:{"callflows.fetchActions":"vmboxDefineActions","callflows.vmbox.edit":"_vmboxEdit"},vmboxPopupEdit:function(e){var a,n=this,o=e.data,c=e.callback,l=e.data_defaults||{},d=i('<div class="inline_popup callflows-port"><div class="inline_content main_content"/></div>');n.vmboxEdit(o,d,i(".inline_content",d),{save_success:function(e){a.dialog("close"),"function"==typeof c&&c(e)},delete_success:function(){a.dialog("close"),"function"==typeof c&&c({data:{}})},after_render:function(){a=t.ui.dialog(d,{title:o.id?n.i18n.active().callflows.vmbox.edit_voicemail_box_title:n.i18n.active().callflows.vmbox.create_voicemail_box_title})}},l)},_vmboxEdit:function(e){var i=this;i.vmboxEdit(e.data,e.parent,e.target,e.callbacks,e.data_defaults)},vmboxEdit:function(e,a,n,o,c){var l=this,d=a||i("#vmbox-content"),s=n||i("#vmbox-view",d),o=o||{},u={save_success:o.save_success,save_error:o.save_error,delete_success:o.delete_success,delete_error:o.delete_error,after_render:o.after_render},r={data:i.extend(!0,{require_pin:!0,check_if_owner:!0,pin:"",media:{},timezone:"inherit"},c||{}),field_data:{users:[],media:[]}};t.parallel({media_list:function(e){l.vmboxMediaList(function(i){i.unshift({id:"",name:l.i18n.active().callflows.vmbox.not_set}),r.field_data.media=i,e(null,i)})},user_list:function(e){l.vmboxUserList(function(i){i.unshift({id:"",first_name:l.i18n.active().callflows.vmbox.no,last_name:l.i18n.active().callflows.vmbox.owner}),r.field_data.users=i,e(null,i)})},get_vmbox:function(i){"object"==typeof e&&e.id?l.vmboxGet(e.id,function(e){i(null,e)}):i(null,{})}},function(t,a){var n=r;"object"==typeof e&&e.id&&(n=i.extend(!0,r,{data:a.get_vmbox})),l.vmboxRender(n,s,u),"function"==typeof u.after_render&&u.after_render()})},vmboxRender:function(e,n,o){var c=this,l=i(t.template(c,"vmbox-edit",e)),d=l.find("#vmbox-form");a.populateDropdown(i("#timezone",l),e.data.timezone||"inherit",{inherit:c.i18n.active().defaultTimezone}),t.ui.validate(d,{rules:{mailbox:{required:!0,digits:!0},pin:{digits:!0,minlength:4},name:{required:!0}}}),i('*[rel=popover]:not([type="text"])',l).popover({trigger:"hover"}),i('*[rel=popover][type="text"]',l).popover({trigger:"focus"}),c.winkstartTabs(l),i("#owner_id",l).change(function(){i(this).val()&&c.callApi({resource:"user.get",data:{accountId:c.accountId,userId:i(this).val()},success:function(e){"timezone"in e.data&&i("#timezone",l).val(e.data.timezone)}})}),i("#owner_id",l).val()||i("#edit_link",l).hide(),i("#owner_id",l).change(function(){i("#owner_id option:selected",l).val()?i("#edit_link",l).show():(i("#edit_link",l).hide(),i("#timezone",l).val(a.getLocaleTimezone()))}),i(".inline_action",l).click(function(e){var a="edit"==i(this).data("action")?{id:i("#owner_id",l).val()}:{},n=a.id;e.preventDefault(),t.pub("callflows.user.popupEdit",{data:a,callback:function(e){n?"id"in e.data?(i("#owner_id #"+e.data.id,l).text(e.data.first_name+" "+e.data.last_name),i("#timezone",l).val(e.data.timezone)):(i("#owner_id #"+n,l).remove(),i("#edit_link",l).hide(),i("#timezone",l).val("America/Los_Angeles")):(i("#owner_id",l).append('<option id="'+e.data.id+'" value="'+e.data.id+'">'+e.data.first_name+" "+e.data.last_name+"</option>"),i("#owner_id",l).val(e.data.id),i("#edit_link",l).show(),i("#timezone",l).val(e.data.timezone))}})}),i("#media_unavailable",l).val()||i("#edit_link_media",l).hide(),i("#media_unavailable",l).change(function(){i("#media_unavailable option:selected",l).val()?i("#edit_link_media",l).show():i("#edit_link_media",l).hide()}),i(".inline_action_media",l).click(function(e){var a="edit"==i(this).data("action")?{id:i("#media_unavailable",l).val()}:{},n=a.id;e.preventDefault(),t.pub("callflows.media.editPopup",{data:a,callback:function(e){n?"id"in e.data?i("#media_unavailable #"+e.data.id,l).text(e.data.name):(i("#media_unavailable #"+n,l).remove(),i("#edit_link_media",l).hide()):(i("#media_unavailable",l).append('<option id="'+e.data.id+'" value="'+e.data.id+'">'+e.data.name+"</option>"),i("#media_unavailable",l).val(e.data.id),i("#edit_link_media",l).show())}})}),i(".vmbox-save",l).click(function(i){if(i.preventDefault(),t.ui.valid(d)){var a=t.ui.getFormData("vmbox-form");"field_data"in e&&delete e.field_data,c.vmboxSave(a,e,o.save_success)}}),i(".vmbox-delete",l).click(function(i){i.preventDefault(),t.ui.confirm(c.i18n.active().callflows.vmbox.are_you_sure_you_want_to_delete,function(){c.vmboxDelete(e.data.id,o.delete_success)})}),n.empty().append(l)},vmboxSave:function(e,t,a,n){var o=this,c=o.vmboxNormalizeData(i.extend(!0,{},t.data,e));"object"==typeof t.data&&t.data.id?o.vmboxUpdate(c,function(e,i){"function"==typeof a&&a(e,i,"update")}):o.vmboxCreate(c,function(e,i){"function"==typeof a&&a(e,i,"create")})},vmboxNormalizeData:function(e){return e.owner_id||delete e.owner_id,e.media.unavailable||delete e.media.unavailable,""===e.pin&&delete e.pin,e.timezone&&"inherit"===e.timezone&&delete e.timezone,e.not_configurable=!e.extra.allow_configuration,delete e.extra,e},vmboxDefineActions:function(e){var a=this,n=e.actions;i.extend(n,{"voicemail[id=*]":{name:a.i18n.active().callflows.vmbox.voicemail,icon:"voicemail",category:a.i18n.active().oldCallflows.basic_cat,module:"voicemail",tip:a.i18n.active().callflows.vmbox.voicemail_tip,data:{id:"null"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:50,caption:function(e,i){var t=e.getMetadata("id"),a="";return t in i&&(a=i[t].name),a},edit:function(e,n){a.vmboxList(function(o){var c,l;l=i(t.template(a,"vmbox-callflowEdit",{items:t.util.sort(o),selected:e.getMetadata("id")||""})),void 0==i("#vmbox_selector option:selected",l).val()&&i("#edit_link",l).hide(),i(".inline_action",l).click(function(t){var n="edit"==i(this).data("action")?{id:i("#vmbox_selector",l).val()}:{};t.preventDefault(),a.vmboxPopupEdit({data:n,callback:function(i){e.setMetadata("id",i.id||"null"),e.caption=i.name||"",c.dialog("close")}})}),i("#add",l).click(function(){e.setMetadata("id",i("#vmbox_selector",l).val()),e.caption=i("#vmbox_selector option:selected",l).text(),c.dialog("close")}),c=t.ui.dialog(l,{title:a.i18n.active().callflows.vmbox.voicemail_title,minHeight:"0",beforeClose:function(){"function"==typeof n&&n()}})})},listEntities:function(e){a.callApi({resource:"voicemail.list",data:{accountId:a.accountId,filters:{paginate:!1}},success:function(i,t){e&&e(i.data)}})},editEntity:"callflows.vmbox.edit"},"voicemail[action=check]":{name:a.i18n.active().callflows.vmbox.check_voicemail,icon:"voicemail",category:a.i18n.active().oldCallflows.advanced_cat,module:"voicemail",tip:a.i18n.active().callflows.vmbox.check_voicemail_tip,data:{action:"check"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:120,caption:function(e,i){return""},edit:function(e,i){"function"==typeof i&&i()}}})},vmboxList:function(e){var i=this;i.callApi({resource:"voicemail.list",data:{accountId:i.accountId,filters:{paginate:!1}},success:function(i){e&&e(i.data)}})},vmboxGet:function(e,i){var t=this;t.callApi({resource:"voicemail.get",data:{accountId:t.accountId,voicemailId:e},success:function(e){i&&i(e.data)}})},vmboxCreate:function(e,i){var t=this;t.callApi({resource:"voicemail.create",data:{accountId:t.accountId,data:e},success:function(e){i&&i(e.data)}})},vmboxUpdate:function(e,i){var t=this;t.callApi({resource:"voicemail.update",data:{accountId:t.accountId,voicemailId:e.id,data:e},success:function(e){i&&i(e.data)}})},vmboxDelete:function(e,i){var t=this;t.callApi({resource:"voicemail.delete",data:{accountId:t.accountId,voicemailId:e},success:function(e){i&&i(e.data)}})},vmboxMediaList:function(e){var i=this;i.callApi({resource:"media.list",data:{accountId:i.accountId,filters:{paginate:!1}},success:function(i){e&&e(i.data)}})},vmboxUserList:function(e){var i=this;i.callApi({resource:"user.list",data:{accountId:i.accountId,filters:{paginate:!1}},success:function(i){e&&e(i.data)}})}};return n});