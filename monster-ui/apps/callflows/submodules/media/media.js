define(["require","jquery","underscore","monster"],function(e){var a=e("jquery"),t=(e("underscore"),e("monster")),i={requests:{},subscribe:{"callflows.fetchActions":"mediaDefineActions","callflows.media.editPopup":"mediaPopupEdit","callflows.media.edit":"_mediaEdit"},mediaRender:function(e,i,d){function n(e){var t=e.val();switch(t){case"tts":a(".tts",o).show(),a(".file",o).hide();break;case"upload":a(".tts",o).hide(),a(".file",o).show()}}var c=this,o=a(t.template(c,"media-edit",e)),s=o.find("#media-form");t.ui.validate(s,{rules:{name:{required:!0}}}),a('*[rel=popover]:not([type="text"])',o).popover({trigger:"hover"}),a('*[rel=popover][type="text"]',o).popover({trigger:"focus"}),c.winkstartTabs(o),e.data.id&&a("#upload_div",o).hide(),a("#change_link",o).click(function(e){e.preventDefault(),a("#upload_div",o).show(),a(".player_file",o).hide()}),a("#download_link",o).click(function(a){a.preventDefault(),window.location.href=c.apiUrl+("/"!=c.apiUrl.substring(c.apiUrl.length-1)?"/":"")+"accounts/"+c.accountId+"/media/"+e.data.id+"/raw?auth_token="+c.authToken}),a("#file",o).bind("change",function(e){var a=e.target.files;if(a.length>0){var t=new FileReader;file="updating",t.onloadend=function(e){var a=e.target.result;file=a},t.readAsDataURL(a[0])}}),n(a("#media_type",o)),a("#media_type",o).change(function(){n(a(this))}),a(".media-save",o).click(function(i){if(i.preventDefault(),t.ui.valid(s)){var n=t.ui.getFormData("media-form");n=c.mediaCleanFormData(n),c.mediaSave(n,e,function(i,s){n.tts?"function"==typeof d.save_success&&d.save_success(i,s):a("#upload_div",o).is(":visible")&&""!=a("#file").val()?"updating"===file?t.ui.alert(c.i18n.active().callflows.media.the_file_you_want_to_apply):c.mediaUpload(file,i.id,function(){"function"==typeof d.save_success&&d.save_success(i,s)},function(){e&&e.data&&e.data.id?c.mediaSave({},e,function(){"function"==typeof d.save_success&&d.save_success(i,s)}):c.mediaDelete(i.id,d.delete_success,d.delete_error),"function"==typeof d.save_error&&d.save_error(i,s)}):"function"==typeof d.save_success&&d.save_success(i,s)})}else t.ui.alert(c.i18n.active().callflows.media.there_were_errors_on_the_form)}),a(".media-delete",o).click(function(a){a.preventDefault(),t.ui.confirm(c.i18n.active().callflows.media.are_you_sure_you_want_to_delete,function(){c.mediaDelete(e.data.id,d.delete_success,d.delete_error)})}),i.empty().append(o)},mediaCleanFormData:function(e){return e.description=e.upload_media,""==e.description&&delete e.description,"tts"==e.media_source?e.description="tts file":delete e.tts,delete e.media_type,e},_mediaEdit:function(e){var a=this;a.mediaEdit(e.data,e.parent,e.target,e.callbacks,e.data_defaults)},mediaEdit:function(e,t,i,d,n){var c=this,o=t||a("#media-content"),s=i||a("#media-view",o),d=d||{},l={save_success:d.save_success,save_error:d.save_error,delete_success:d.delete_success,delete_error:d.delete_error,after_render:d.after_render},r={data:a.extend(!0,{streamable:!0},n||{})};"object"==typeof e&&e.id?c.mediaGet(e.id,function(e){c.mediaFormatData(e),c.mediaRender(a.extend(!0,r,{data:e}),s,l),"function"==typeof l.after_render&&l.after_render()}):(c.mediaRender(r,s,l),"function"==typeof l.after_render&&l.after_render())},mediaSave:function(e,t,i,d){var n=this,c=n.mediaNormalizeData(a.extend(!0,{},t.data,e));"object"==typeof t.data&&t.data.id?n.mediaUpdate(c,function(e,a){"function"==typeof i&&i(e,a,"update")}):n.mediaCreate(c,function(e,a){"function"==typeof i&&i(e,a,"create")})},mediaNormalizeData:function(e){return delete e.upload_media,"field_data"in e&&delete e.field_data,"upload"==e.media_source&&delete e.tts,e},mediaFormatData:function(e){return"false"==e.streamable?e.streamable=!1:"true"==e.streamable&&(e.streamable=!0),void 0!=e.description&&"C:\\fakepath\\"==e.description.substr(0,12)&&(e.description=e.description.substr(12)),e},mediaPopupEdit:function(e){var i,d=this,n=e.data,c=e.callback,o=e.data_defaults||{},s=a('<div class="inline_popup callflows-port"><div class="inline_content main_content"/></div>');d.mediaEdit(n,s,a(".inline_content",s),{save_success:function(e){i.dialog("close"),"function"==typeof c&&c(e)},delete_success:function(){i.dialog("close"),"function"==typeof c&&c({data:{}})},after_render:function(){i=t.ui.dialog(s,{title:n.id?d.i18n.active().callflows.media.edit_media:d.i18n.active().callflows.media.create_media})}},o)},mediaDefineActions:function(e){var i=this,d=e.actions;a.extend(d,{"play[id=*]":{name:i.i18n.active().callflows.media.play_media,icon:"play",category:i.i18n.active().oldCallflows.basic_cat,module:"play",tip:i.i18n.active().callflows.media.play_media_tip,data:{id:"null"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:10,caption:function(e,a){var t=e.getMetadata("id"),i="";return t in a&&(i=a[t].name),i},edit:function(e,d){i.mediaList(function(n){var c,o;o=a(t.template(i,"media-callflowEdit",{items:t.util.sort(n),selected:e.getMetadata("id")||""})),void 0==a("#media_selector option:selected",o).val()&&a("#edit_link",o).hide(),a(".inline_action",o).click(function(t){var d="edit"==a(this).data("action")?{id:a("#media_selector",o).val()}:{};t.preventDefault(),i.mediaPopupEdit({data:d,callback:function(a){e.setMetadata("id",a.id||"null"),e.caption=a.name||"",c.dialog("close")}})}),a("#add",o).click(function(){e.setMetadata("id",a("#media_selector",o).val()),e.caption=a("#media_selector option:selected",o).text(),c.dialog("close")}),c=t.ui.dialog(o,{title:i.i18n.active().callflows.media.media,minHeight:"0",beforeClose:function(){"function"==typeof d&&d()}})})},listEntities:function(e){i.callApi({resource:"media.list",data:{accountId:i.accountId,filters:{paginate:!1}},success:function(a,t){e&&e(a.data)}})},editEntity:"callflows.media.edit"}})},mediaList:function(e){var a=this;a.callApi({resource:"media.list",data:{accountId:a.accountId,filters:{paginate:!1}},success:function(a){e&&e(a.data)}})},mediaGet:function(e,a){var t=this;t.callApi({resource:"media.get",data:{accountId:t.accountId,mediaId:e},success:function(e){a&&a(e.data)}})},mediaCreate:function(e,a){var t=this;t.callApi({resource:"media.create",data:{accountId:t.accountId,data:e},success:function(e){a&&a(e.data)}})},mediaUpdate:function(e,a){var t=this;t.callApi({resource:"media.update",data:{accountId:t.accountId,mediaId:e.id,data:e},success:function(e){a&&a(e.data)}})},mediaDelete:function(e,a){var t=this;t.callApi({resource:"media.delete",data:{accountId:t.accountId,mediaId:e},success:function(e){a&&a(e.data)}})},mediaUpload:function(e,a,t){var i=this;i.callApi({resource:"media.upload",data:{accountId:i.accountId,mediaId:a,data:e},success:function(e,a){t&&t(e,a)}})}};return i});