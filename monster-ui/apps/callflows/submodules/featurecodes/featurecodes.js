define(["require","jquery","underscore","monster","toastr"],function(e){var a=e("jquery"),t=e("underscore"),n=e("monster"),r=e("toastr"),o={requests:{},subscribe:{"callflows.featurecode.render":"featureCodeRender"},featureCodeRender:function(e){var t=this,r={},o={},l=e||a(".callflow-edition");t.featureCodesDefine(r),a.each(r,function(e,a){this.tag=e,this.number="undefined"==typeof a.number?a.default_number:a.number,a.hasOwnProperty("category")&&(o[a.category]=o[a.category]||[],o[a.category].push(a))}),t.featureCodeGetData(function(e){var u=(t.featureCodeFormatData(e,r),a(n.template(t,"featurecodes-view",{categories:o})));t.featureCodeBindEvents(u,r),l.empty().append(u)})},featureCodeGetData:function(e){var a=this;a.featureCodeList(function(a){e&&e(a)})},featureCodeFormatData:function(e,a){return t.each(e,function(e){e.hasOwnProperty("featurecode")&&e.featurecode!==!1&&a.hasOwnProperty(e.featurecode.name)&&(a[e.featurecode.name].id=e.id,a[e.featurecode.name].enabled=!0,a[e.featurecode.name].number=e.featurecode.number.replace("\\",""))}),a},featureCodeBindEvents:function(e,t){var r=this;n.ui.tooltips(e),e.find(".featurecode_enabled").each(function(){var e=a(this).parents(".action_wrapper"),t=e.find(".featurecode-number");a(this).is(":checked")?a(t).removeAttr("disabled"):a(t).attr("disabled","")}),e.find(".featurecode-number").on("blur keyup focus",function(){var e=a(this).parents(".action_wrapper");e.data("number",a(this).val()),a(this).val()!==t[e.data("action")].number?e.addClass("changed"):e.removeClass("changed")}),e.find(".featurecode_enabled").on("change",function(){var e=a(this),t=e.parents(".action_wrapper"),n=t.find(".featurecode-number");e.is(":checked")||t.data("enabled")!==!0?e.is(":checked")&&t.data("enabled")===!1?t.addClass("enabled"):(t.removeClass("enabled"),t.removeClass("disabled")):t.addClass("disabled"),e.is(":checked")?n.removeAttr("disabled"):n.attr("disabled","")}),e.find(".featurecode-save").on("click",function(a){a.preventDefault();var n=r.featureCodeCleanFormData(e,t);r.featureCodeMassUpdate(n)})},featureCodeList:function(e){var a=this;a.callApi({resource:"callflow.list",data:{accountId:a.accountId,filters:{paginate:!1}},success:function(a){e&&e(a.data)}})},featureCodeCleanFormData:function(e,t){var n={created_callflows:[],deleted_callflows:[],updated_callflows:[]};return e.find(".enabled").each(function(){var e=a(this).data();e.number+="",e.flow={data:t[e.action].data,module:t[e.action].module,children:{}},"patterns"===e.type&&"string"==typeof e.number&&(e.number=e.number.replace(/([*])/g,"\\$1")),e[e.type]=[t[e.action].build_regex(e.number)],n.created_callflows.push(e)}),e.find(".disabled").each(function(){var e=a(this).data();e.number+="",n.deleted_callflows.push(e)}),e.find(".changed:not(.enabled, .disabled)").each(function(){if(a(this).data("enabled")){var e=a(this).data();e.number+="",e.flow={data:t[e.action].data,module:t[e.action].module,children:{}},"patterns"===e.type&&(e.number=e.number.replace(/([*])/g,"\\$1")),e[e.type]=[t[e.action].build_regex(e.number)],n.updated_callflows.push(e)}}),n},featureCodeCreate:function(e,a){var t=this;t.callApi({resource:"callflow.create",data:{accountId:t.accountId,data:e},success:function(e){a&&a(e.data)}})},featureCodeDelete:function(e,a){var t=this;t.callApi({resource:"callflow.delete",data:{accountId:t.accountId,callflowId:e},success:function(e){a&&a(e.data)}})},featureCodeUpdate:function(e,a,t){var n=this;n.callApi({resource:"callflow.update",data:{accountId:n.accountId,callflowId:e,data:a},success:function(e){t&&t(e.data)}})},featureCodeMassUpdate:function(e){var a=this,o=e.created_callflows.length+e.deleted_callflows.length+e.updated_callflows.length;if(o){var l={};t.each(e.created_callflows,function(e){l["create_"+e.action]=function(t){var n={flow:e.flow,patterns:e.patterns,numbers:e.numbers,featurecode:{name:e.action,number:e.number}};a.featureCodeCreate(n,function(e){t&&t(null,e)})}}),t.each(e.updated_callflows,function(e){l["update_"+e.action]=function(t){var n={flow:e.flow,patterns:e.patterns,numbers:e.numbers,featurecode:{name:e.action,number:e.number}};a.featureCodeUpdate(e.id,n,function(e){t&&t(null,e)})}}),t.each(e.deleted_callflows,function(e){l["delete_"+e.action]=function(t){a.featureCodeDelete(e.id,function(e){t&&t(null,e)})}}),n.parallel(l,function(e,t){r.success(a.i18n.active().callflows.featureCodes.successUpdate),a.featureCodeRender()})}else r.error(a.i18n.active().callflows.featureCodes.nothing_to_save)},featureCodesDefine:function(e){var t=this;a.extend(e,{"call_forward[action=activate]":{name:t.i18n.active().callflows.featureCodes.enable_call_forward,icon:"phone",category:t.i18n.active().callflows.featureCodes.call_forward_cat,module:"call_forward",number_type:"numbers",data:{action:"activate"},enabled:!1,default_number:"72",number:this.default_number,build_regex:function(e){return"*"+e}},"call_forward[action=deactivate]":{name:t.i18n.active().callflows.featureCodes.disable_call_forward,icon:"phone",category:t.i18n.active().callflows.featureCodes.call_forward_cat,module:"call_forward",number_type:"numbers",data:{action:"deactivate"},enabled:!1,default_number:"73",number:this.default_number,build_regex:function(e){return"*"+e}},"call_forward[action=toggle]":{name:t.i18n.active().callflows.featureCodes.toggle_call_forward,icon:"phone",category:t.i18n.active().callflows.featureCodes.call_forward_cat,module:"call_forward",number_type:"patterns",data:{action:"toggle"},enabled:!1,default_number:"74",number:this.default_number,build_regex:function(e){return"^\\*"+e+"([0-9]*)$"}},"call_forward[action=update]":{name:t.i18n.active().callflows.featureCodes.update_call_forward,icon:"phone",category:t.i18n.active().callflows.featureCodes.call_forward_cat,module:"call_forward",number_type:"numbers",data:{action:"update"},enabled:!1,default_number:"56",number:this.default_number,build_regex:function(e){return"*"+e}},"hotdesk[action=login]":{name:t.i18n.active().callflows.featureCodes.enable_hot_desking,icon:"phone",category:t.i18n.active().callflows.featureCodes.hot_desking_cat,module:"hotdesk",number_type:"numbers",data:{action:"login"},enabled:!1,default_number:"11",number:this.default_number,build_regex:function(e){return"*"+e}},"hotdesk[action=logout]":{name:t.i18n.active().callflows.featureCodes.disable_hot_desking,icon:"phone",category:t.i18n.active().callflows.featureCodes.hot_desking_cat,module:"hotdesk",number_type:"numbers",data:{action:"logout"},enabled:!1,default_number:"12",number:this.default_number,build_regex:function(e){return"*"+e}},"hotdesk[action=toggle]":{name:t.i18n.active().callflows.featureCodes.toggle_hot_desking,icon:"phone",category:t.i18n.active().callflows.featureCodes.hot_desking_cat,module:"hotdesk",number_type:"numbers",data:{action:"toggle"},enabled:!1,default_number:"13",number:this.default_number,build_regex:function(e){return"*"+e}},"voicemail[action=check]":{name:t.i18n.active().callflows.featureCodes.check_voicemail,icon:"phone",category:t.i18n.active().callflows.featureCodes.miscellaneous_cat,module:"voicemail",number_type:"numbers",data:{action:"check"},enabled:!1,default_number:"97",number:this.default_number,build_regex:function(e){return"*"+e}},"voicemail[single_mailbox_login]":{name:t.i18n.active().callflows.featureCodes.single_mailbox_login,icon:"phone",category:t.i18n.active().callflows.featureCodes.miscellaneous_cat,module:"voicemail",number_type:"numbers",data:{action:"check",single_mailbox_login:!0},enabled:!1,default_number:"98",number:this.default_number,build_regex:function(e){return"*"+e}},'voicemail[action="direct"]':{name:t.i18n.active().callflows.featureCodes.direct_to_voicemail,category:t.i18n.active().callflows.featureCodes.miscellaneous_cat,module:"voicemail",number_type:"patterns",data:{action:"compose"},enabled:!1,default_number:"*",number:this.default_number,build_regex:function(e){return"^\\*"+e+"([0-9]*)$"}},intercom:{name:t.i18n.active().callflows.featureCodes.intercom,icon:"phone",category:t.i18n.active().callflows.featureCodes.miscellaneous_cat,module:"intercom",number_type:"patterns",data:{},enabled:!1,default_number:"0",number:this.default_number,build_regex:function(e){return"^\\*"+e+"([0-9]*)$"}},"privacy[mode=full]":{name:t.i18n.active().callflows.featureCodes.privacy,icon:"phone",category:t.i18n.active().callflows.featureCodes.miscellaneous_cat,module:"privacy",number_type:"patterns",data:{mode:"full"},enabled:!1,default_number:"67",number:this.default_number,build_regex:function(e){return"^\\*"+e+"([0-9]*)$"}},park_and_retrieve:{name:t.i18n.active().callflows.featureCodes.park_and_retrieve,icon:"phone",category:t.i18n.active().callflows.featureCodes.parking_cat,module:"park",number_type:"patterns",data:{action:"auto"},enabled:!1,default_number:"3",number:this.default_number,build_regex:function(e){return"^\\*"+e+"([0-9]*)$"}},valet:{name:t.i18n.active().callflows.featureCodes.valet,icon:"phone",category:t.i18n.active().callflows.featureCodes.parking_cat,module:"park",number_type:"numbers",data:{action:"park"},enabled:!1,default_number:"4",number:this.default_number,build_regex:function(e){return"*"+e}},retrieve:{name:t.i18n.active().callflows.featureCodes.retrieve,icon:"phone",category:t.i18n.active().callflows.featureCodes.parking_cat,module:"park",number_type:"patterns",data:{action:"retrieve"},enabled:!1,default_number:"5",number:this.default_number,build_regex:function(e){return"^\\*"+e+"([0-9]*)$"}}})}};return o});