define(["require","jquery","underscore","monster"],function(e){var t=e("jquery"),n=e("underscore"),i=e("monster"),a={requests:{},subscribe:{"callflows.fetchActions":"menuDefineActions","callflows.menu.edit":"_menuEdit"},_menuEdit:function(e){var t=this;t.menuEdit(e.data,e.parent,e.target,e.callbacks,e.data_defaults)},menuEdit:function(e,a,d,c,o){var u=this,l=a||t("#menu-content"),r=d||t("#menu-view",l),c=c||{},s={save_success:c.save_success,save_error:c.save_error,delete_success:c.delete_success,delete_error:c.delete_error,after_render:c.after_render},m={data:t.extend(!0,{retries:"3",timeout:"10",max_extension_length:"4",media:{}},o||{}),field_data:{media:[]}};i.parallel({media_list:function(e){u.callApi({resource:"media.list",data:{accountId:u.accountId,filters:{paginate:!1}},success:function(t,i){n.each(t.data,function(e){e.media_source&&(e.name="["+e.media_source.substring(0,3).toUpperCase()+"] "+e.name)}),t.data.unshift({id:"",name:u.i18n.active().callflows.menu.not_set}),m.field_data.media=t.data,e(null,t)}})},menu_get:function(t){"object"==typeof e&&e.id?u.menuGet(e.id,function(e,n){u.menuformatData(e),t(null,{data:e})}):t(null,{})}},function(n,i){var a=m;"object"==typeof e&&e.id&&(a=t.extend(!0,m,i.menu_get)),u.menuRender(a,r,s),"function"==typeof s.after_render&&s.after_render()})},menuPopupEdit:function(e,n,a){var d,c=this,o=t('<div class="inline_popup callflows-port"><div class="inline_content main_content"/></div>');c.menuEdit(e,o,t(".inline_content",o),{save_success:function(e){d.dialog("close"),"function"==typeof n&&n(e)},delete_success:function(){d.dialog("close"),"function"==typeof n&&n({data:{}})},after_render:function(){d=i.ui.dialog(o,{title:e.id?c.i18n.active().callflows.menu.edit_menu:c.i18n.active().callflows.menu.create_menu})}},a)},menuRender:function(e,n,a){var d=this,c=t(i.template(d,"menu-edit",e)),o=c.find("#menu-form");i.ui.validate(o,{rules:{retries:{digits:!0},record_pin:{digits:!0},timeout:{number:!0,max:10},max_extension_length:{digits:!0}}}),t('*[rel=popover]:not([type="text"])',c).popover({trigger:"hover"}),t('*[rel=popover][type="text"]',c).popover({trigger:"focus"}),d.winkstartTabs(c),t("#media_greeting",c).val()||t("#edit_link_media",c).hide(),t("#media_greeting",c).change(function(){t("#media_greeting option:selected",c).val()?t("#edit_link_media",c).show():t("#edit_link_media",c).hide()}),t(".inline_action_media",c).click(function(e){var n="edit"==t(this).data("action")?{id:t("#media_greeting",c).val()}:{},a=n.id;e.preventDefault(),i.pub("callflows.media.editPopup",{data:n,callback:function(e){a?"id"in e.data?t("#media_greeting #"+e.data.id,c).text(e.data.name):(t("#media_greeting #"+a,c).remove(),t("#edit_link_media",c).hide()):(t("#media_greeting",c).append('<option id="'+e.data.id+'" value="'+e.data.id+'">'+e.data.name+"</option>"),t("#media_greeting",c).val(e.data.id),t("#edit_link_media",c).show())}})}),t(".menu-save",c).click(function(t){if(t.preventDefault(),i.ui.valid(o)){var n=i.ui.getFormData("menu-form");d.menuCleanFormData(n),"field_data"in e&&delete e.field_data,d.menuSave(n,e,a.save_success)}else i.ui.alert("error",d.i18n.active().callflows.menu.there_were_errors_on_the_form)}),t(".menu-delete",c).click(function(t){t.preventDefault(),i.ui.confirm(d.i18n.active().callflows.menu.are_you_sure_you_want_to_delete,function(){d.menuDelete(e.data.id,a.delete_success,a.delete_error)})}),n.empty().append(c)},menuSave:function(e,n,i){var a=this,d=a.menuNormalizeData(t.extend(!0,{},n.data,e));"object"==typeof n.data&&n.data.id?a.menuUpdate(d,function(e,t){i&&i(e,t,"update")}):a.menuCreate(d,function(e,t){i&&i(e,t,"create")})},menuformatData:function(e){e.timeout&&(e.timeout/=1e3),e.media&&(e.media.invalid_media===!1&&e.media.transfer_media===!1&&e.media.exit_media===!1?e.suppress_media=!0:e.suppress_media=!1)},menuCleanFormData:function(e){0==e.record_pin.length?e.max_extension_length=4:e.max_extension_length<e.record_pin.length&&(e.max_extension_length=e.record_pin.length),e.timeout=1e3*e.timeout,"suppress_media"in e&&(e.media=e.media||{},e.suppress_media===!0?(e.media.invalid_media=!1,e.media.transfer_media=!1,e.media.exit_media=!1):(e.media.invalid_media=!0,e.media.transfer_media=!0,e.media.exit_media=!0))},menuNormalizeData:function(e){return e.media.greeting||delete e.media.greeting,""==e.hunt_allow&&delete e.hunt_allow,""==e.hunt_deny&&delete e.hunt_deny,""==e.record_pin&&delete e.record_pin,e},menuDefineActions:function(e){var n=this,a=e.actions;t.extend(a,{"menu[id=*]":{name:n.i18n.active().callflows.menu.menu_title,icon:"menu1",category:n.i18n.active().oldCallflows.basic_cat,module:"menu",tip:n.i18n.active().callflows.menu.menu_tip,data:{id:"null"},rules:[{type:"quantity",maxSize:"9999"}],isUsable:"true",weight:60,key_caption:function(e,t){var i=e.key;return"_"!=i?i:n.i18n.active().callflows.menu.default_action},key_edit:function(e,a){var d,c;c=t(i.template(n,"menu-callflowKey",{items:{_:n.i18n.active().callflows.menu.default_action,0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9","*":"*","#":"#"},selected:e.key})),c.find("#add").on("click",function(){e.key=t("#menu_key_selector",d).val(),e.key_caption=t("#menu_key_selector option:selected",d).text(),d.dialog("close")}),d=i.ui.dialog(c,{title:n.i18n.active().callflows.menu.menu_option_title,minHeight:"0",beforeClose:function(){a&&a()}})},caption:function(e,t){var n=e.getMetadata("id"),i="";return n in t&&(i=t[n].name),i},edit:function(e,a){n.menuList(function(d){var c,o;o=t(i.template(n,"menu-callflowEdit",{items:i.util.sort(d),selected:e.getMetadata("id")||""})),void 0==t("#menu_selector option:selected",o).val()&&t("#edit_link",o).hide(),t(".inline_action",o).click(function(i){var a="edit"==t(this).data("action")?{id:t("#menu_selector",o).val()}:{};i.preventDefault(),n.menuPopupEdit(a,function(t){e.setMetadata("id",t.id||"null"),e.caption=t.name||"",c.dialog("close")})}),o.find("#add").on("click",function(){e.setMetadata("id",t("#menu_selector",c).val()),e.caption=t("#menu_selector option:selected",c).text(),c.dialog("close")}),c=i.ui.dialog(o,{title:n.i18n.active().callflows.menu.menu_title,minHeight:"0",beforeClose:function(){"function"==typeof a&&a()}})})},listEntities:function(e){n.callApi({resource:"menu.list",data:{accountId:n.accountId,filters:{paginate:!1}},success:function(t,n){e&&e(t.data)}})},editEntity:"callflows.menu.edit"}})},menuList:function(e){var t=this;t.callApi({resource:"menu.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t){e&&e(t.data)}})},menuGet:function(e,t){var n=this;n.callApi({resource:"menu.get",data:{accountId:n.accountId,menuId:e},success:function(e){t&&t(e.data)}})},menuCreate:function(e,t){var n=this;n.callApi({resource:"menu.create",data:{accountId:n.accountId,data:e},success:function(e){t&&t(e.data)}})},menuUpdate:function(e,t){var n=this;n.callApi({resource:"menu.update",data:{accountId:n.accountId,menuId:e.id,data:e},success:function(e){t&&t(e.data)}})},menuDelete:function(e,t){var n=this;n.callApi({resource:"menu.delete",data:{accountId:n.accountId,menuId:e},success:function(e){t&&t(e.data)}})}};return a});