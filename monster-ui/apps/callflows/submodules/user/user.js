define(["require","jquery","underscore","monster","monster-timezone"],function(e){var t=e("jquery"),a=(e("underscore"),e("monster")),i=e("monster-timezone"),n={requests:{},subscribe:{"callflows.fetchActions":"userDefineActions","callflows.user.popupEdit":"userPopupEdit","callflows.user.edit":"userEdit"},random_id:!1,userDefineActions:function(e){var i=this,n=e.actions;t.extend(n,{"user[id=*]":{name:i.i18n.active().callflows.user.user,icon:"user",category:i.i18n.active().oldCallflows.basic_cat,module:"user",tip:i.i18n.active().callflows.user.user_tip,data:{id:"null"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:40,caption:function(e,t){var a=e.getMetadata("id"),i="";return a in t&&(i=t[a].name),i},edit:function(e,n){i.userList(function(d){var c,l;t.each(d,function(){this.name=this.first_name+" "+this.last_name}),l=t(a.template(i,"user-callflowEdit",{can_call_self:e.getMetadata("can_call_self")||!1,parameter:{name:"timeout (s)",value:e.getMetadata("timeout")||"20"},objects:{items:a.util.sort(d),selected:e.getMetadata("id")||""}})),void 0==t("#user_selector option:selected",l).val()&&t("#edit_link",l).hide(),t(".inline_action",l).click(function(a){var n="edit"==t(this).data("action")?{id:t("#user_selector",l).val()}:{};a.preventDefault(),i.userPopupEdit({data:n,callback:function(a){e.setMetadata("id",a.id||"null"),e.setMetadata("timeout",t("#parameter_input",l).val()),e.setMetadata("can_call_self",t("#user_can_call_self",l).is(":checked")),e.caption=(a.first_name||"")+" "+(a.last_name||""),c.dialog("close")}})}),t("#add",l).click(function(){e.setMetadata("id",t("#user_selector",l).val()),e.setMetadata("timeout",t("#parameter_input",l).val()),e.setMetadata("can_call_self",t("#user_can_call_self",l).is(":checked")),e.caption=t("#user_selector option:selected",l).text(),c.dialog("close")}),c=a.ui.dialog(l,{title:i.i18n.active().callflows.user.select_user,beforeClose:function(){"function"==typeof n&&n()}})})},listEntities:function(e){i.callApi({resource:"user.list",data:{accountId:i.accountId,filters:{paginate:!1}},success:function(t,a){e&&e(t.data)}})},editEntity:"callflows.user.edit"},"hotdesk[action=login]":{name:i.i18n.active().callflows.user.hot_desk_login,icon:"hotdesk_login",category:i.i18n.active().callflows.user.hotdesking_cat,module:"hotdesk",tip:i.i18n.active().callflows.user.hot_desk_login_tip,data:{action:"login"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:10,caption:function(e,t){return""},edit:function(e,t){"function"==typeof t&&t()}},"hotdesk[action=logout]":{name:i.i18n.active().callflows.user.hot_desk_logout,icon:"hotdesk_logout",category:i.i18n.active().callflows.user.hotdesking_cat,module:"hotdesk",tip:i.i18n.active().callflows.user.hot_desk_logout_tip,data:{action:"logout"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:20,caption:function(e,t){return""},edit:function(e,t){"function"==typeof t&&t()}},"hotdesk[action=toggle]":{name:i.i18n.active().callflows.user.hot_desk_toggle,icon:"hotdesk_toggle",category:i.i18n.active().callflows.user.hotdesking_cat,module:"hotdesk",tip:i.i18n.active().callflows.user.hot_desk_toggle_tip,data:{action:"toggle"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:30,caption:function(e,t){return""},edit:function(e,t){"function"==typeof t&&t()}}})},userPopupEdit:function(e){var i,n=this,d=t('<div class="inline_popup callflows-port"><div class="inline_content main_content"/></div>'),c=e.data,l=e.callback,r=e.data_defaults;d.css({height:500,"overflow-y":"scroll"}),n.userEdit({data:c,parent:d,target:t(".inline_content",d),callbacks:{save_success:function(e){i.dialog("close"),"function"==typeof l&&l(e)},delete_success:function(){i.dialog("close"),"function"==typeof l&&l({data:{}})},after_render:function(){i=a.ui.dialog(d,{title:c.id?n.i18n.active().callflows.user.edit_user:n.i18n.active().callflows.user.create_user})}},data_defaults:r})},userEdit:function(e){var i=this,n=e.data,d=e.parent||t("#user-content"),c=e.target||t("#user-view",d),l=e.callbacks||{},r={save_success:l.save_success||function(e){i.userRenderList(d),i.userEdit({data:{id:e.data.id},parent:d,target:c,callbacks:r})},save_error:l.save_error,delete_success:l.delete_success||function(){c.empty(),i.userRenderList(d)},delete_error:l.delete_error,after_render:l.after_render},s={data:t.extend(!0,{apps:{},call_forward:{substitute:!0},call_restriction:{closed_groups:{action:"inherit"}},caller_id:{internal:{},external:{},emergency:{}},hotdesk:{},contact_list:{exclude:!1},priv_level:"user",music_on_hold:{},timezone:"inherit"},e.data_defaults||{}),field_data:{device_types:{sip_device:i.i18n.active().callflows.user.sip_device_type,cellphone:i.i18n.active().callflows.user.cell_phone_type,fax:i.i18n.active().callflows.user.fax_type,smartphone:i.i18n.active().callflows.user.smartphone_type,landline:i.i18n.active().callflows.user.landline_type,softphone:i.i18n.active().callflows.user.softphone_type,sip_uri:i.i18n.active().callflows.user.sip_uri_type},call_restriction:{}}};i.random_id=!1,a.parallel({list_classifiers:function(e){i.callApi({resource:"numbers.listClassifiers",data:{accountId:i.accountId,filters:{paginate:!1}},success:function(a,i){"data"in a&&t.each(a.data,function(e,t){s.field_data.call_restriction[e]={friendly_name:t.friendly_name},s.data.call_restriction[e]={action:"inherit"}}),e(null,a)}})},media_list:function(e){i.callApi({resource:"media.list",data:{accountId:i.accountId,filters:{paginate:!1}},success:function(t,a){t.data&&t.data.unshift({id:"",name:i.i18n.active().callflows.user.default_music},{id:"silence_stream://300000",name:i.i18n.active().callflows.user.silence}),s.field_data.media=t.data,e(null,t)}})},user_get:function(e){"object"==typeof n&&n.id?i.userGet(n.id,function(t,a){i.userMigrateData(t),e(null,t)}):(i.random_id=t.md5(a.util.randomString(10)+(new Date).toString()),s.field_data.new_user=i.random_id,e(null,s))},user_hotdesks:function(e){"object"==typeof n&&n.id?i.callApi({resource:"user.hotdesks",data:{accountId:i.accountId,userId:n.id},success:function(a){s.field_data.hotdesk_enabled=!0,s.field_data.device_list={},t.each(a.data,function(e,t){s.field_data.device_list[t.device_id]={name:t.device_name}}),t.isEmptyObject(s.field_data.device_list)&&delete s.field_data.device_list,e(null,a)},error:function(t,a){e(null,s)}}):e(null,s)}},function(e,a){var d=s;"object"==typeof n&&n.id&&(t.each(a.user_get.call_restriction,function(e,t){s.field_data.call_restriction.hasOwnProperty(e)&&(s.field_data.call_restriction[e].action=t.action)}),d=t.extend(!0,s,{data:a.user_get})),i.userRender(d,c,r),"function"==typeof r.after_render&&r.after_render()})},userRender:function(e,n,d){var c,l=this,r=t(a.template(l,"user-edit",e)),s=r.find("#user-form"),o=t(".hotdesk_pin",r),u=t("#hotdesk_require_pin",r);l.userRenderDeviceList(e,r),a.ui.validate(s,{rules:{username:{required:!0,minlength:3,regex:/^[0-9a-zA-Z+@._-]*$/},first_name:{required:!0,minlength:1,maxlength:256,regex:/^[0-9a-zA-Z\s\-\']+$/},last_name:{required:!0,minlength:1,maxlength:256,regex:/^[0-9a-zA-Z\s\-\']+$/},email:{required:!0,email:!0},pwd_mngt_pwd1:{required:!0,minlength:3},pwd_mngt_pwd2:{required:!0,minlength:3,equalTo:"#pwd_mngt_pwd1"},"hotdesk.pin":{regex:/^[0-9]*$/},"hotdesk.id":{regex:/^[0-9\+\#\*]*$/},call_forward_number:{regex:/^[\+]?[0-9]*$/},"caller_id.internal.name":{regex:/^[0-9A-Za-z ,]{0,30}$/},"caller_id.external.name":{regex:/^[0-9A-Za-z ,]{0,30}$/},"caller_id.internal.number":{regex:/^[\+]?[0-9\s\-\.\(\)]*$/},"caller_id.external.number":{regex:/^[\+]?[0-9\s\-\.\(\)]*$/},"caller_id.emergency.name":{regex:/^[0-9A-Za-z ,]{0,30}$/},"caller_id.emergency.number":{regex:/^[\+]?[0-9\s\-\.\(\)]*$/}},messages:{username:{regex:l.i18n.active().callflows.user.validation.username},first_name:{regex:l.i18n.active().callflows.user.validation.name},last_name:{regex:l.i18n.active().callflows.user.validation.name},"hotdesk.pin":{regex:l.i18n.active().callflows.user.validation.hotdesk.pin},"hotdesk.id":{regex:l.i18n.active().callflows.user.validation.hotdesk.id},"caller_id.internal.name":{regex:l.i18n.active().callflows.user.validation.caller_id.name},"caller_id.external.name":{regex:l.i18n.active().callflows.user.validation.caller_id.name},"caller_id.emergency.name":{regex:l.i18n.active().callflows.user.validation.caller_id.name},"caller_id.internal.number":{regex:l.i18n.active().callflows.user.validation.caller_id.number},"caller_id.external.number":{regex:l.i18n.active().callflows.user.validation.caller_id.number},"caller_id.emergency.number":{regex:l.i18n.active().callflows.user.validation.caller_id.number}}}),i.populateDropdown(t("#timezone",r),e.data.timezone||"inherit",{inherit:l.i18n.active().defaultTimezone}),e.data.id===a.apps.auth.userId&&t(".user-delete",r).hide(),t('*[rel=popover]:not([type="text"])',r).popover({trigger:"hover"}),t('*[rel=popover][type="text"]',r).popover({trigger:"focus"}),l.winkstartTabs(r),l.winkstartLinkForm(r),u.is(":checked")?o.show():o.hide(),u.change(function(){t(this).is(":checked")?o.show("blind"):o.hide("blind")}),t(".user-save",r).click(function(i){if(i.preventDefault(),a.ui.valid(s)){var n=a.ui.getFormData("user-form");n.enable_pin===!1&&(delete e.data.queue_pin,delete e.data.record_call),l.userCleanFormData(n),"field_data"in e&&delete e.field_data,l.callApi({resource:"account.get",data:{accountId:l.accountId},success:function(i,c){"admin"==n.priv_level?(n.apps=n.apps||{},!("voip"in n.apps)&&t.inArray("voip",i.data.available_apps||[])>-1&&(n.apps.voip={label:l.i18n.active().callflows.user.voip_services_label,icon:"device",api_url:a.config.api["default"]})):"user"==n.priv_level&&t.inArray("userportal",i.data.available_apps||[])>-1&&(n.apps=n.apps||{},"userportal"in n.apps||(n.apps.userportal={label:l.i18n.active().callflows.user.user_portal_label,icon:"userportal",api_url:a.config.api["default"]})),l.userSave(n,e,function(e,t,a){"create"==a?l.userAcquireDevice(e,function(){"function"==typeof d.save_success&&d.save_success(e,t,a)},function(){"function"==typeof d.save_error&&d.save_error(e,t,a)}):"function"==typeof d.save_success&&d.save_success(e,t,a)})}})}else a.ui.alert(l.i18n.active().callflows.user.there_were_errors_on_the_form)}),t(".user-delete",r).click(function(t){t.preventDefault(),a.ui.confirm(l.i18n.active().callflows.user.are_you_sure_you_want_to_delete,function(){l.userDelete(e.data.id,d.delete_success,d.delete_error)})}),t("#music_on_hold_media_id",r).val()||t("#edit_link_media",r).hide(),t("#music_on_hold_media_id",r).change(function(){t("#music_on_hold_media_id option:selected",r).val()?t("#edit_link_media",r).show():t("#edit_link_media",r).hide()}),t(".inline_action_media",r).click(function(e){var i="edit"==t(this).data("action")?{id:t("#music_on_hold_media_id",r).val()}:{},n=i.id;e.preventDefault(),a.pub("callflows.media.editPopup",{data:i,callback:function(e){n?e.hasOwnProperty("id")?t("#music_on_hold_media_id #"+e.id,r).text(e.name):(t("#music_on_hold_media_id #"+n,r).remove(),t("#edit_link_media",r).hide()):(t("#music_on_hold_media_id",r).append('<option id="'+e.id+'" value="'+e.id+'">'+e.name+"</option>"),t("#music_on_hold_media_id",r).val(e.id),t("#edit_link_media",r).show())}})}),t(r).delegate(".enabled_checkbox","click",function(){l.userUpdateSingleDevice(t(this),r)}),t(r).delegate(".action_device.edit","click",function(){var i={id:t(this).data("id"),hide_owner:e.data.id?!1:!0},n={};e.data.id?n.owner_id=e.data.id:n.new_user=l.random_id,a.pub("callflows.device.popupEdit",{data:i,callback:function(t){c={data:{},field_data:{device_types:e.field_data.device_types}},c.data=t.data.new_user?{new_user:!0,id:l.random_id}:{id:e.data.id},l.userRenderDeviceList(c,r)},data_defaults:n})}),t(r).delegate(".action_device.delete","click",function(){var i=t(this).data("id");a.ui.confirm(l.i18n.active().callflows.user.do_you_really_want_to_delete,function(){l.userDeleteDevice(i,function(){c={data:{},field_data:{device_types:e.field_data.device_types}},c.data=l.random_id?{new_user:!0,id:l.random_id}:{id:e.data.id},l.userRenderDeviceList(c,r)})})}),t(".add_device",r).click(function(t){var i={hide_owner:!0},n={};t.preventDefault(),e.data.id?n.owner_id=e.data.id:n.new_user=l.random_id,a.pub("callflows.device.popupEdit",{data:i,callback:function(t){var a={data:{},field_data:{device_types:e.field_data.device_types}};a.data=l.random_id?{new_user:!0,id:l.random_id}:{id:e.data.id},l.userRenderDeviceList(a,r)},data_defaults:n})}),n.empty().append(r)},userRenderList:function(e,t){var a=this;a.userList(function(e,a){t&&t()})},userRenderDeviceList:function(e,i){var n=this,i=t("#tab_devices",i);if(e.data.id){var d=e.data.new_user?{filter_new_user:e.data.id}:{filter_owner_id:e.data.id};n.userListDevice(d,function(d,c){t(".rows",i).empty(),d.length>0?(t.each(d,function(d,c){c.display_type=e.field_data.device_types[c.device_type],c.not_enabled=this.enabled===!1?!0:!1,t(".rows",i).append(t(a.template(n,"user-deviceRow",c)))}),n.callApi({resource:"device.getStatus",data:{accountId:n.accountId},success:function(e,a){t.each(e.data,function(e,a){t("#"+a.device_id+" .column.third",i).addClass("registered")})}})):t(".rows",i).append(t(a.template(n,"user-deviceRow")))})}else t(".rows",i).empty().append(t(a.template(n,"user-deviceRow")))},userMigrateData:function(e){return"priv_level"in e||("apps"in e&&"voip"in e.apps?e.priv_level="admin":e.priv_level="user"),e},userUpdateSingleDevice:function(e,a){e.attr("disabled","disabled");var i=this,n=e.data("device_id"),d=e.is(":checked");i.userGetDevice(n,function(c){t.inArray(c.device_type,["cellphone","smartphone","landline"])>-1&&(c.call_forward.enabled=d),c.enabled=d,i.userUpdateDevice(n,c,function(i){e.removeAttr("disabled"),i.enabled===!0?t("#"+i.id+" .column.third",a).removeClass("disabled"):t("#"+i.id+" .column.third",a).addClass("disabled")},function(){e.removeAttr("disabled"),d?e.removeAttr("checked"):e.attr("checked","checked")})},function(){e.removeAttr("disabled"),d?e.removeAttr("checked"):e.attr("checked","checked")})},userAcquireDevice:function(e,a,i){var n=this,d=e.id;n.random_id?n.userListDevice({filter_new_user:n.random_id},function(e,i){var c,l=e.length;0!=l?t.each(e,function(e,t){c=this.id,n.userGetDevice(c,function(t,i){t.owner_id=d,delete t.new_user,n.userUpdateDevice(c,t,function(t,i){e==l-1&&a({},i,"create")})})}):a({},i,"create")}):a({},status,"create")},userCleanFormData:function(e){return e.caller_id.internal.number=e.caller_id.internal.number.replace(/\s|\(|\)|\-|\./g,""),e.caller_id.external.number=e.caller_id.external.number.replace(/\s|\(|\)|\-|\./g,""),e.caller_id.emergency.number=e.caller_id.emergency.number.replace(/\s|\(|\)|\-|\./g,""),e.call_restriction.closed_groups={action:e.extra.closed_groups?"deny":"inherit"},e.hotdesk.require_pin||delete e.hotdesk.pin,"fakePassword"!=e.pwd_mngt_pwd1&&(e.password=e.pwd_mngt_pwd1),delete e.pwd_mngt_pwd1,delete e.pwd_mngt_pwd2,delete e.extra,e},userSave:function(e,a,i,n){var d=this,c=d.userNormalizeData(t.extend(!0,{},a.data,e));"object"==typeof a.data&&a.data.id?d.userUpdate(c,function(e,t){"function"==typeof i&&i(e,t,"update")},function(e,t){"function"==typeof n&&n(e,t,"update")}):d.userCreate(c,function(e,t){"function"==typeof i&&i(e,t,"create")},function(e,t){"function"==typeof n&&n(e,t,"create")})},userNormalizeData:function(e){if(t.isArray(e.directories)&&(e.directories={}),t.each(e.caller_id,function(a,i){t.each(i,function(e,t){""==t&&delete i[e]}),t.isEmptyObject(i)&&delete e.caller_id[a]}),t.isEmptyObject(e.caller_id)&&delete e.caller_id,e.music_on_hold.media_id||delete e.music_on_hold.media_id,e.hotdesk.hasOwnProperty("enable")&&delete e.hotdesk.enable,e.hotdesk.hasOwnProperty("log_out")){var a=[];t.each(e.hotdesk.endpoint_ids,function(t,i){e.hotdesk.log_out.indexOf(i)<0&&a.push(i)}),e.hotdesk.endpoint_ids=a,delete e.hotdesk.log_out}return e.hotdesk.hasOwnProperty("endpoint_ids")&&0===e.hotdesk.endpoint_ids.length&&delete e.hotdesk.endpoint_ids,e.hasOwnProperty("call_forward")&&""===e.call_forward.number&&delete e.call_forward.number,e.hasOwnProperty("presence_id")&&""===e.presence_id&&delete e.presence_id,e.timezone&&"inherit"===e.timezone&&delete e.timezone,e},userList:function(e){var t=this;t.callApi({resource:"user.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t){e&&e(t.data)}})},userGet:function(e,t){var a=this;a.callApi({resource:"user.get",data:{accountId:a.accountId,userId:e},success:function(e){t&&t(e.data)}})},userCreate:function(e,t){var a=this;a.callApi({resource:"user.create",data:{accountId:a.accountId,data:e},success:function(e){t&&t(e.data)}})},userUpdate:function(e,t){var a=this;a.callApi({resource:"user.update",data:{accountId:a.accountId,userId:e.id,data:e},success:function(e){t&&t(e.data)}})},userDelete:function(e,t,a){var i=this;i.callApi({resource:"user.delete",data:{accountId:i.accountId,userId:e},success:function(e){t&&t(e.data)},error:function(e){a&&a()}})},userListDevice:function(e,a){var i=this,n=t.extend(!0,e,{paginate:!1});i.callApi({resource:"device.list",data:{accountId:i.accountId,filters:n},success:function(e){a&&a(e.data)}})},userGetDevice:function(e,t,a){var i=this;i.callApi({resource:"device.get",data:{accountId:i.accountId,deviceId:e},success:function(e){t&&t(e.data)},error:function(e){a&&a()}})},userUpdateDevice:function(e,t,a,i){var n=this;n.callApi({resource:"device.update",data:{accountId:n.accountId,deviceId:e,data:t},success:function(e){a&&a(e.data)},error:function(){i&&i()}})},userDeleteDevice:function(e,t){var a=this;a.callApi({resource:"device.delete",data:{accountId:a.accountId,deviceId:e},success:function(){t&&t()}})}};return n});