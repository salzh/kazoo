define(["require","jquery","underscore","monster"],function(e){var i=e("jquery"),a=e("underscore"),t=e("monster"),d={requests:{"callflows.device.getProvisionerPhones":{apiRoot:t.config.api.provisioner,url:"phones/",verb:"GET",headers:{Accept:"*/*"}}},subscribe:{"callflows.fetchActions":"deviceDefineActions","callflows.device.popupEdit":"devicePopupEdit","callflows.device.edit":"_deviceEdit"},devicePopupEdit:function(e){var a,d,n=this,o=e.data,c=e.callback,r=e.data_defaults;d=i('<div class="inline_popup callflows-port"><div class="inline_content main_content"/></div>'),n.deviceEdit(o,d,i(".inline_content",d),{save_success:function(e){a.dialog("close"),"function"==typeof c&&c(e)},delete_success:function(){a.dialog("close"),"function"==typeof c&&c({data:{}})},after_render:function(){a=t.ui.dialog(d,{title:o.id?n.i18n.active().callflows.device.edit_device:n.i18n.active().callflows.device.create_device})}},r)},_deviceEdit:function(e){var i=this;i.deviceEdit(e.data,e.parent,e.target,e.callbacks,e.data_defaults)},deviceEdit:function(e,d,n,o,c){var r=this,s=d||i("#device-content"),l=n||i("#device-view",s),o=o||{},_={save_success:o.save_success,save_error:o.save_error||function(e,i,a){200==i&&"mac_address"==a&&t.ui.alert(r.i18n.active().callflows.device.this_mac_address_is_already_in_use)},delete_success:o.delete_success,delete_error:o.delete_error,after_render:o.after_render},p={data:i.extend(!0,{enabled:!0,caller_id:{external:{},internal:{},emergency:{}},ringtones:{},call_restriction:{closed_groups:"inherit"},media:{secure_rtp:"none",peer_to_peer:"auto",audio:{codecs:["PCMU","PCMA"]},video:{codecs:[]},fax:{option:"false"},fax_option:!1},sip:{method:"password",invite_format:"username",username:"user_"+t.util.randomString(6),password:t.util.randomString(12),expire_seconds:"360"},contact_list:{exclude:!1},call_forward:{},music_on_hold:{}},c||{}),field_data:{users:[],call_restriction:{},sip:{methods:{password:r.i18n.active().callflows.device.password,ip:"IP"},invite_formats:{username:"Username",npan:"NPA NXX XXXX",e164:"E. 164"}},media:{secure_rtp:{value:"none",options:{none:r.i18n.active().callflows.device.none,srtp:r.i18n.active().callflows.device.srtp,zrtp:r.i18n.active().callflows.device.zrtp}},peer_to_peer_options:{auto:r.i18n.active().callflows.device.automatic,"true":r.i18n.active().callflows.device.always,"false":r.i18n.active().callflows.device.never},fax:{options:{auto:r.i18n.active().callflows.device.auto_detect,"true":r.i18n.active().callflows.device.always_force,"false":r.i18n.active().callflows.device.disabled}},audio:{codecs:{OPUS:"OPUS","CELT@32000h":"Siren @ 32Khz","G7221@32000h":"G722.1 @ 32khz","G7221@16000h":"G722.1 @ 16khz",G722:"G722","speex@32000h":"Speex @ 32khz","speex@16000h":"Speex @ 16khz",PCMU:"G711u / PCMU - 64kbps (North America)",PCMA:"G711a / PCMA - 64kbps (Elsewhere)",G729:"G729 - 8kbps (Requires License)",GSM:"GSM","CELT@48000h":"Siren (HD) @ 48kHz","CELT@64000h":"Siren (HD) @ 64kHz"}},video:{codecs:{VP8:"VP8",H264:"H264",H263:"H263",H261:"H261"}}},hide_owner:e.hide_owner||!1,outbound_flags:e.outbound_flags?e.outbound_flags.join(", "):e.outbound_flags},functions:{inArray:function(e,a){return a?-1==i.inArray(e,a)?!1:!0:!1}}},u=function(d){t.parallel({list_classifier:function(e){r.callApi({resource:"numbers.listClassifiers",data:{accountId:r.accountId,filters:{paginate:!1}},success:function(a){"data"in a&&i.each(a.data,function(e,i){p.field_data.call_restriction[e]={friendly_name:i.friendly_name},p.data.call_restriction[e]={action:"inherit"}}),e(null,a)}})},account:function(e){r.callApi({resource:"account.get",data:{accountId:r.accountId},success:function(a,t){i.extend(p.field_data.sip,{realm:a.data.realm}),e(null,a)}})},user_list:function(e){r.callApi({resource:"user.list",data:{accountId:r.accountId,filters:{paginate:!1}},success:function(i,t){if(i.data.sort(function(e,i){return(e.first_name+e.last_name).toLowerCase()<(i.first_name+i.last_name).toLowerCase()?-1:1}),i.data.unshift({id:"",first_name:"- No",last_name:"owner -"}),d.hasOwnProperty("device_type")&&"mobile"===d.device_type){var n=a.find(i.data,function(e,i){return e.id===d.owner_id});n?p.field_data.users=n:p.field_data.users={first_name:"- No",last_name:"owner -"}}else p.field_data.users=i.data;e(null,i)}})},media_list:function(e){r.callApi({resource:"media.list",data:{accountId:r.accountId,filters:{paginate:!1}},success:function(i,a){i.data.unshift({id:"",name:r.i18n.active().callflows.device.default_music},{id:"silence_stream://300000",name:r.i18n.active().callflows.device.silence}),p.field_data.music_on_hold=i.data,e(null,i)}})},provisionerData:function(e){t.config.api.hasOwnProperty("provisioner")&&t.config.api.provisioner?r.deviceGetDataProvisoner(function(i){e(null,i)}):e(null,{})}},function(a,t){var n=r.devicePrepareDataForTemplate(e,p,i.extend(!0,t,{get_device:d}));r.deviceRender(n,l,_),"function"==typeof _.after_render&&_.after_render()})};"object"==typeof e&&e.id?r.deviceGet(e.id,function(e,i){p.data.device_type="sip_device","media"in e&&"encryption"in e.media&&(p.field_data.media.secure_rtp.value=e.media.encryption.enforce_security?e.media.encryption.methods[0]:"none"),"sip"in e&&"realm"in e.sip&&(p.field_data.sip.realm=e.sip.realm),r.deviceMigrateData(e),u(e)}):u(p)},devicePrepareDataForTemplate:function(e,t,d){var n=d.get_device,o=d.provisionerData;if("object"==typeof e&&e.id&&(t=i.extend(!0,t,{data:n})),n.hasOwnProperty("media")&&n.media.hasOwnProperty("audio")&&(n.media.audio.hasOwnProperty("codecs")&&(t.data.media.audio.codecs=n.media.audio.codecs),n.media.video.hasOwnProperty("codecs")&&(t.data.media.video.codecs=n.media.video.codecs)),a.each(t.field_data.call_restriction,function(e,i){e.value=t.data.call_restriction[i].action}),t.field_data.provisioner=o,t.field_data.provisioner.isEnabled=!a.isEmpty(o),t.field_data.provisioner.isEnabled){var c={voicemail_beep:1,time_format:"12",hotline:"",vlan:{enable:!1,number:""},date_format:"middle-endian"};t.data.provision=i.extend(!0,{},c,t.data.provision)}return t},deviceGetValidationByDeviceType:function(e){var i={sip_uri:{},sip_device:{mac_address:{mac:!0},sip_expire_seconds:{digits:!0}},fax:{mac_address:{mac:!0},sip_expire_seconds:{digits:!0}},cellphone:{},smartphone:{sip_expire_seconds:{digits:!0}},landline:{},softphone:{sip_expire_seconds:{digits:!0}},mobile:{mdn:{digits:!0},sip_expire_seconds:{digits:!0}}};return{rules:i[e]}},deviceRender:function(e,a,d){var n,o=this;if("media"in e.data&&"fax_option"in e.data.media&&(e.data.media.fax_option="auto"===e.data.media.fax_option||e.data.media.fax_option===!0),"object"==typeof e.data&&e.data.device_type){n=i(t.template(o,"device-"+e.data.device_type,e));var c=n.find("#device-form");t.config.api.hasOwnProperty("provisioner")&&t.config.api.provisioner&&o.deviceSetProvisionerStuff(n,e),i.inArray(e.data.device_type,["fax","softphone","sip_device","smartphone","mobile"])>-1&&t.ui.protectField(n.find("#sip_password"),n),t.ui.validate(c,o.deviceGetValidationByDeviceType(e.data.device_type)),i("#owner_id",n).val()||i("#edit_link",n).hide(),t.ui.mask(n.find("#mac_address"),"macAddress"),i("#owner_id",n).change(function(){i("#owner_id option:selected",n).val()?i("#edit_link",n).show():i("#edit_link",n).hide()}),i(".inline_action",n).click(function(e){var a="edit"==i(this).data("action")?{id:i("#owner_id",n).val()}:{},d=a.id;e.preventDefault(),t.pub("callflows.user.popupEdit",{data:a,callback:function(e){d?a.hasOwnProperty("id")?i("#owner_id #"+e.id,n).text(e.first_name+" "+e.last_name):(i("#owner_id #"+d,n).remove(),i("#edit_link",n).hide()):(i("#owner_id",n).append('<option id="'+e.id+'" value="'+e.id+'">'+e.first_name+" "+e.last_name+"</option>"),i("#owner_id",n).val(e.id),i("#edit_link",n).show())}})}),i(".device-save",n).click(function(a){if(a.preventDefault(),t.ui.valid(c)){var r=t.ui.getFormData("device-form");o.deviceCleanFormData(r),r.hasOwnProperty("provision")&&r.provision.hasOwnProperty("endpoint_brand")&&"none"!==r.provision.endpoint_brand&&(r.provision.endpoint_model=i('.dropdown_family[data-brand="'+r.provision.endpoint_brand+'"]',n).val(),r.provision.endpoint_family=i("#"+r.provision.endpoint_model,n).parents("optgroup").data("family")),o.deviceSave(r,e,d.save_success)}else t.ui.alert("error",o.i18n.active().callflows.device.there_were_errors_on_the_form)}),"mobile"!==e.device_type&&i(".device-delete",n).click(function(i){i.preventDefault(),t.ui.confirm(o.i18n.active().callflows.device.are_you_sure_you_want_to_delete,function(){o.deviceDelete(e.data.id,d.delete_success)})}),i("#music_on_hold_media_id",n).val()||i("#edit_link_media",n).hide(),e.data.sip&&"ip"===e.data.sip.method?i("#username_block",n).hide():i("#ip_block",n).hide(),n.find("#sip_method").on("change",function(){"ip"===i("#sip_method option:selected",n).val()?(i("#ip_block",n).slideDown(),i("#username_block",n).slideUp()):(i("#username_block",n).slideDown(),i("#ip_block",n).slideUp())}),i("#music_on_hold_media_id",n).change(function(){i("#music_on_hold_media_id option:selected",n).val()?i("#edit_link_media",n).show():i("#edit_link_media",n).hide()}),i(".inline_action_media",n).click(function(e){var a="edit"==i(this).data("action")?{id:i("#music_on_hold_media_id",n).val()}:{},d=a.id;e.preventDefault(),t.pub("callflows.media.editPopup",{data:a,callback:function(e){d?e.hasOwnProperty("id")?i("#music_on_hold_media_id #"+e.id,n).text(e.name):(i("#music_on_hold_media_id #"+d,n).remove(),i("#edit_link_media",n).hide()):(i("#music_on_hold_media_id",n).append('<option id="'+e.id+'" value="'+e.id+'">'+e.name+"</option>"),i("#music_on_hold_media_id",n).val(e.id),i("#edit_link_media",n).show())}})})}else n=i(t.template(o,"device-general_edit")),i(".media_pane",n).hide(),i(".media_tabs .buttons",n).click(function(){var a=i(this);i(".media_pane",n).show(),a.hasClass("current")||(i(".media_tabs .buttons").removeClass("current"),a.addClass("current"),e.data.device_type=a.attr("device_type"),o.deviceFormatData(e),o.deviceRender(e,i(".media_pane",n),d))});i('*[rel=popover]:not([type="text"])',n).popover({trigger:"hover"}),i('*[rel=popover][type="text"]',n).popover({trigger:"focus"}),o.winkstartTabs(n),a.empty().append(n),i('.media_tabs .buttons[device_type="sip_device"]',n).trigger("click")},deviceSetProvisionerStuff:function(e,a){var t=function(i,t){e.find(".dropdown_family").hide(),i in a.field_data.provisioner.brands&&(e.find("#dropdown_brand").val(i),e.find('.dropdown_family[data-brand="'+i+'"]').show().val(t))},d=a.data.provision,n={"00085d":"aastra","0010bc":"aastra","00036b":"cisco","00000c":"cisco","000142":"cisco","000143":"cisco","000163":"cisco","000164":"cisco","000196":"cisco","000197":"cisco","0001c7":"cisco","0001c9":"cisco","000f23":"cisco","0013c4":"cisco","0016c8":"cisco","001818":"cisco","00175a":"cisco","001795":"cisco","001A2f":"cisco","001c58":"cisco","001dA2":"cisco","002155":"cisco","000e84":"cisco","000e38":"cisco","00070e":"cisco","001bd4":"cisco","001930":"cisco","0019aa":"cisco","001d45":"cisco","001ef7":"cisco","000e08":"cisco","1cdf0f":"cisco",e05fb9:"cisco","5475d0":"cisco",c46413:"cisco","000Ffd3":"digium","000b82":"grandstream","08000f":"mitel","1045bE":"norphonic","0050c2":"norphonic","0004f2":"polycom","00907a":"polycom","000413":"snom","001f9f":"thomson","00147f":"thomson",642400:"xorcom","001565":"yealink"};t(d.endpoint_brand,d.endpoint_model),e.find("#dropdown_brand").on("change",function(){t(i(this).val())}),e.find("#mac_address").on("keyup",function(){var e=i(this).val().replace(/[^0-9a-fA-F]/g,"");e in n&&t(n[e])})},deviceFormatData:function(e){"smartphone"===e.data.device_type||"landline"===e.data.device_type||"cellphone"===e.data.device_type?e.data.call_forward={enabled:!0,require_keypress:!0,keep_caller_id:!0}:e.data.call_forward={enabled:!1},"sip_uri"===e.data.device_type&&(e.data.sip.invite_format="route"),"mobile"===e.data.device_type&&("mobile"in e.data||(e.data.mobile={mdn:""})),"fax"===e.data.device_type?(e.data.media.fax_option=!0,e.data.media.fax.option="true"):(e.data.media.fax_option=!1,e.data.media.fax.option="false")},deviceMigrateData:function(e){if(e.hasOwnProperty("media")&&e.media.hasOwnProperty("audio")&&e.media.audio.hasOwnProperty("codecs")){var i={Speex:"speex@16000h",G722_16:"G7221@16000h",G722_32:"G7221@32000h",CELT_48:"CELT@48000h",CELT_64:"CELT@64000h"},t=[];a.each(e.media.audio.codecs,function(e){i.hasOwnProperty(e)?t.push(i[e]):t.push(e)}),e.media.audio.codecs=t}return"cell_phone"==e.device_type&&(e.device_type="cellphone"),"object"==typeof e.media&&"object"==typeof e.media.fax&&"codecs"in e.media.fax&&delete e.media.fax.codecs,"status"in e&&(e.enabled=e.status,delete e.status),e.hasOwnProperty("ignore_complete_elsewhere")&&(e.ignore_completed_elsewhere=e.ignore_complete_elsewhere,delete e.ignore_complete_elsewhere),e},deviceNormalizeData:function(e){if(e.hasOwnProperty("provision")&&("none"===e.provision.endpoint_brand?delete e.provision:0!==e.provision.voicemail_beep&&delete e.provision.voicemail_beep),e.hasOwnProperty("media")&&e.media.hasOwnProperty("fax_option")&&"auto"===e.media.fax_option&&delete e.media.fax_option,"media"in e&&"fax"in e.media&&"fax_option"in e.media&&(e.media.fax.option=e.media.fax_option.toString()),"media"in e&&"secure_rtp"in e.media&&delete e.media.secure_rtp,"media"in e&&"bypass_media"in e.media&&delete e.media.bypass_media,""==e.caller_id.internal.number&&""==e.caller_id.internal.name&&delete e.caller_id.internal,""==e.caller_id.external.number&&""==e.caller_id.external.name&&delete e.caller_id.external,""==e.caller_id.emergency.number&&""==e.caller_id.emergency.name&&delete e.caller_id.emergency,e.music_on_hold.media_id||delete e.music_on_hold.media_id,e.owner_id||delete e.owner_id,i.isEmptyObject(e.call_forward)&&delete e.call_forward,e.mac_address||delete e.mac_address,"ip"!=e.sip.method&&delete e.sip.ip,"string"==typeof e.outbound_flags){e.outbound_flags=e.outbound_flags.split(/,/);var a=[];i.each(e.outbound_flags,function(e,i){""!==i.replace(/\s/g,"")&&a.push(i)}),e.outbound_flags=a}return"fax"===e.device_type&&("outbound_flags"in e?e.outbound_flags.indexOf("fax")<0&&e.outbound_flags.splice(0,0,"fax"):e.outbound_flags=["fax"]),e.ringtones&&"internal"in e.ringtones&&""===e.ringtones.internal&&delete e.ringtones.internal,e.ringtones&&"external"in e.ringtones&&""===e.ringtones.external&&delete e.ringtones.external,i.inArray(e.device_type,["fax","mobile","softphone","sip_device","smartphone"])<0&&delete e.call_restriction,e.hasOwnProperty("presence_id")&&""===e.presence_id&&delete e.presence_id,e},deviceCleanFormData:function(e){return"provision"in e&&e.provision.voicemail_beep===!0&&(e.provision.voicemail_beep=0),e.mac_address&&(e.mac_address=e.mac_address.toLowerCase(),e.mac_address.match(/^(((\d|([a-f]|[A-F])){2}-){5}(\d|([a-f]|[A-F])){2})$/)?e.mac_address=e.mac_address.replace(/-/g,":"):e.mac_address.match(/^(((\d|([a-f]|[A-F])){2}){5}(\d|([a-f]|[A-F])){2})$/)&&(e.mac_address=e.mac_address.replace(/(.{2})/g,"$1:").slice(0,-1))),e.caller_id&&(e.caller_id.internal.number=e.caller_id.internal.number.replace(/\s|\(|\)|\-|\./g,""),e.caller_id.external.number=e.caller_id.external.number.replace(/\s|\(|\)|\-|\./g,""),e.caller_id.emergency.number=e.caller_id.emergency.number.replace(/\s|\(|\)|\-|\./g,"")),"media"in e&&"audio"in e.media&&(e.media.audio.codecs=i.map(e.media.audio.codecs,function(e){return e?e:null})),"media"in e&&"video"in e.media&&(e.media.video.codecs=i.map(e.media.video.codecs,function(e){return e?e:null})),("smartphone"==e.device_type||"landline"==e.device_type||"cellphone"==e.device_type)&&(e.call_forward.number=e.call_forward.number.replace(/\s|\(|\)|\-|\./g,""),e.enabled=e.call_forward.enabled),"extra"in e&&e.extra.notify_unregister===!0?e.suppress_unregister_notifications=!1:e.suppress_unregister_notifications=!0,"extra"in e&&"closed_groups"in e.extra&&(e.call_restriction.closed_groups={action:e.extra.closed_groups?"deny":"inherit"}),i.inArray(e.device_type,["sip_device","mobile","softphone"])>-1&&"extra"in e&&(e.media.encryption=e.media.encryption||{},i.inArray(e.extra.encryptionMethod,["srtp","zrtp"])>-1?(e.media.encryption.enforce_security=!0,e.media.encryption.methods=[e.extra.encryptionMethod]):(e.media.encryption.methods=[],e.media.encryption.enforce_security=!1)),delete e.extra,e},deviceFixArrays:function(e,i){return"object"==typeof e.media&&"object"==typeof i.media&&((e.media.audio||{}).codecs=(i.media.audio||{}).codecs,(e.media.video||{}).codecs=(i.media.video||{}).codecs),"media"in i&&"encryption"in i.media&&"methods"in i.media.encryption&&(e.media.encryption=e.media.encryption||{},e.media.encryption.methods=i.media.encryption.methods),e},deviceSave:function(e,a,t){var d=this,n="object"==typeof a.data&&a.data.id?a.data.id:void 0,o=d.deviceFixArrays(d.deviceNormalizeData(i.extend(!0,{},a.data,e)),e);n?d.deviceUpdate(o,function(e,i){t&&t(e,i,"update")}):d.deviceCreate(o,function(e,i){t&&t(e,i,"create")})},deviceList:function(e){var i=this;i.callApi({resource:"device.list",data:{accountId:i.accountId,filters:{paginate:!1}},success:function(i){e&&e(i.data)}})},deviceGet:function(e,i){var a=this;a.callApi({resource:"device.get",data:{accountId:a.accountId,deviceId:e},success:function(e){i&&i(e.data)}})},deviceCreate:function(e,i){var a=this;a.callApi({resource:"device.create",data:{accountId:a.accountId,data:e},success:function(e){i&&i(e.data)}})},deviceUpdate:function(e,i){var a=this;a.callApi({resource:"device.update",data:{accountId:a.accountId,deviceId:e.id,data:e},success:function(e){i&&i(e.data)}})},deviceDelete:function(e,i){var a=this;a.callApi({resource:"device.delete",data:{accountId:a.accountId,deviceId:e},success:function(e){i&&i(e.data)}})},deviceGetDataProvisoner:function(e){var i=this;t.request({resource:"callflows.device.getProvisionerPhones",data:{},success:function(a){a=i.deviceFormatDataProvisioner(a.data),e&&e(a)}})},deviceFormatDataProvisioner:function(e){var i={brands:e};return i},deviceDefineActions:function(e){var a=this,d=e.actions;i.extend(d,{"device[id=*]":{name:a.i18n.active().callflows.device.device,icon:"phone",category:a.i18n.active().oldCallflows.advanced_cat,module:"device",tip:a.i18n.active().callflows.device.device_tip,data:{id:"null"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:10,caption:function(e,i){var a=e.getMetadata("id"),t="";return a in i&&(t=i[a].name),t},edit:function(e,d){a.deviceList(function(n){var o,c;c=i(t.template(a,"device-callflowEdit",{can_call_self:e.getMetadata("can_call_self")||!1,parameter:{name:"timeout (s)",value:e.getMetadata("timeout")||"20"},objects:{items:t.util.sort(n),selected:e.getMetadata("id")||""}})),void 0==i("#device_selector option:selected",c).val()&&i("#edit_link",c).hide(),i(".inline_action",c).click(function(t){var d="edit"===i(this).data("action")?{id:i("#device_selector",c).val()}:{};t.preventDefault(),a.devicePopupEdit({data:d,callback:function(a){e.setMetadata("id",a.id||"null"),e.setMetadata("timeout",i("#parameter_input",c).val()),e.setMetadata("can_call_self",i("#device_can_call_self",c).is(":checked")),e.caption=a.name||"",o.dialog("close")}})}),i("#add",c).click(function(){e.setMetadata("id",i("#device_selector",c).val()),e.setMetadata("timeout",i("#parameter_input",c).val()),e.setMetadata("can_call_self",i("#device_can_call_self",c).is(":checked")),e.caption=i("#device_selector option:selected",c).text(),o.dialog("close")}),o=t.ui.dialog(c,{title:a.i18n.active().callflows.device.device_title,beforeClose:function(){"function"==typeof d&&d()}})})},listEntities:function(e){a.callApi({resource:"device.list",data:{accountId:a.accountId,filters:{paginate:!1}},success:function(i,a){e&&e(i.data)}})},editEntity:"callflows.device.edit"}})}};return d});