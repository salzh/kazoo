define(["require","jquery","underscore","monster"],function(e){var n=e("jquery"),t=(e("underscore"),e("monster")),c={requests:{},subscribe:{"callflows.conference.popupEdit":"conferencePopupEdit","callflows.fetchActions":"conferenceDefineActions","callflows.conference.edit":"_conferenceEdit"},conferenceDefineActions:function(e){var c=this,r=e.actions;n.extend(r,{"conference[id=*]":{name:c.i18n.active().callflows.conference.conference,icon:"conference",category:c.i18n.active().oldCallflows.basic_cat,module:"conference",tip:c.i18n.active().callflows.conference.conference_tip,data:{id:"null"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:30,caption:function(e,n){var t=e.getMetadata("id"),c="";return t in n&&(c=n[t].name),c},edit:function(e,r){c.conferenceList(function(i,o){var a,s=n(t.template(c,"conference-callflowEdit",{items:t.util.sort(i),selected:e.getMetadata("id")||""}));void 0==n("#conference_selector option:selected",s).val()&&n("#edit_link",s).hide(),n(".inline_action",s).click(function(t){var r="edit"==n(this).data("action")?{id:n("#conference_selector",s).val()}:{};t.preventDefault(),c.conferencePopupEdit(r,function(n){e.setMetadata("id",n.id||"null"),e.caption=n.name||"",a.dialog("close")})}),n("#add",s).click(function(){e.setMetadata("id",n("#conference_selector",s).val()),e.caption=n("#conference_selector option:selected",s).text(),a.dialog("close")}),a=t.ui.dialog(s,{title:c.i18n.active().callflows.conference.conference,minHeight:"0",beforeClose:function(){"function"==typeof r&&r()}})})},listEntities:function(e){c.callApi({resource:"conference.list",data:{accountId:c.accountId,filters:{paginate:!1}},success:function(n,t){e&&e(n.data)}})},editEntity:"callflows.conference.edit"},"conference[]":{name:c.i18n.active().callflows.conference.conference_service,icon:"conference",category:c.i18n.active().oldCallflows.advanced_cat,module:"conference",tip:c.i18n.active().callflows.conference.conference_service_tip,data:{},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:110,caption:function(e){return""},edit:function(e,n){"function"==typeof n&&n()}}})},conferencePopupEdit:function(e,c,r){var i,o=this,a=n('<div class="inline_popup callflows-port"><div class="inline_content main_content"/></div>');o.conferenceEdit(e,a,n(".inline_content",a),{save_success:function(e){i.dialog("close"),"function"==typeof c&&c(e)},delete_success:function(){i.dialog("close"),"function"==typeof c&&c({data:{}})},after_render:function(){i=t.ui.dialog(a,{title:e.id?o.i18n.active().callflows.conference.edit_conference:o.i18n.active().callflows.conference.create_conference})}},r)},_conferenceEdit:function(e){var n=this;n.conferenceEdit(e.data,e.parent,e.target,e.callbacks,e.data_defaults)},conferenceEdit:function(e,c,r,i,o){var a=this,s=c||n("#conference-content"),f=r||n("#conference-view",s),i=i||{},l={save_success:i.save_success||function(e){a.conferenceRenderList(s),a.conferenceEdit({id:e.id},s,f,l)},save_error:i.save_error,delete_success:i.delete_success||function(){f.empty(),a.conferenceRenderList(s)},delete_error:i.delete_error,after_render:i.after_render},d={data:n.extend(!0,{member:{},play_entry_tone:!0,play_exit_tone:!0},o||{}),field_data:{users:[]}};t.parallel({user_list:function(e){a.callApi({resource:"user.list",data:{accountId:a.accountId,filters:{paginate:!1}},success:function(n,t){n.data.unshift({id:"",first_name:"- No",last_name:"owner -"}),d.field_data.users=n.data,e(null,n)}})},get_conference:function(n){"object"==typeof e&&e.id?a.conferenceGet(e.id,function(e,t){a.conferenceMigrateData(e),a.conferenceFormatData(e),n(null,e)}):n(null,{})}},function(t,c){var r=d;"object"==typeof e&&e.id&&(r=n.extend(!0,d,{data:c.get_conference})),a.conferenceRender(r,f,l),"function"==typeof l.after_render&&l.after_render()})},conferenceRender:function(e,c,r){var i=this,o=n(t.template(i,"conference-edit",e)),a=o.find("#conference_form");t.ui.validate(a,{rules:{name:{required:!0},"member.pins_string":{regex:/^[a-z0-9A-Z,\s]*$/},"member.numbers_string":{regex:/^[0-9,\s]*$/}},messages:{"member.pins_string":{regex:i.i18n.active().callflows.conference.validation.member_pins_string},"member.numbers_string":{regex:i.i18n.active().callflows.conference.validation.member_numbers_string}}}),n('*[rel=popover]:not([type="text"])',o).popover({trigger:"hover"}),n('*[rel=popover][type="text"]',o).popover({trigger:"focus"}),i.winkstartTabs(o),n("#owner_id",o).val()||n("#edit_link",o).hide(),n("#owner_id",o).change(function(){n("#owner_id option:selected",o).val()?n("#edit_link",o).show():n("#edit_link",o).hide()}),n(".inline_action",o).click(function(e){var c="edit"==n(this).data("action")?{id:n("#owner_id",o).val()}:{},r=c.id;e.preventDefault(),t.pub("callflows.user.popupEdit",{data:c,callback:function(e){r?"id"in e?n("#owner_id #"+e.id,o).text(e.first_name+" "+e.last_name):(n("#owner_id #"+r,o).remove(),n("#edit_link",o).hide()):(n("#owner_id",o).append('<option id="'+e.id+'" value="'+e.id+'">'+e.first_name+" "+e.last_name+"</option>"),n("#owner_id",o).val(e.id),n("#edit_link",o).show())}})}),n(".conference-save",o).click(function(n){if(n.preventDefault(),t.ui.valid(a)){var c=t.ui.getFormData("conference_form");i.conferenceCleanFormData(c),e.data.member.pins=c.member.pins,"field_data"in e&&delete e.field_data,i.conferenceSave(c,e,r.save_success,r.save_error)}else t.ui.alert(i.i18n.active().callflows.conference.there_were_errors_on_the_form)}),n(".conference-delete",o).click(function(n){n.preventDefault(),t.ui.confirm(i.i18n.active().callflows.conference.are_you_sure_you_want_to_delete,function(){i.conferenceDelete(e.data.id,r.delete_success,r.delete_error)})}),c.empty().append(o)},conferenceRenderList:function(e){var n=this;n.conferenceList(function(e,n){})},conferenceMigrateData:function(e){return n.isArray(e.conference_numbers)&&(void 0==e.member.numbers&&(e.member.numbers=e.conference_numbers),delete e.conference_numbers),e.member_play_name&&(void 0==e.play_name_on_join&&(e.play_name_on_join=e.member_play_name),delete e.member_play_name),e.member_join_muted&&(void 0==e.member.join_muted&&(e.member.join_muted=e.member_join_muted),delete e.member_join_muted),e.member_join_deaf&&(void 0==e.member.join_deaf&&(e.member.join_deaf=e.member_join_deaf),delete e.member_join_deaf),e},conferenceFormatData:function(e){return"object"==typeof e.member&&(n.isArray(e.member.pins)&&(e.member.pins_string=e.member.pins.join(", ")),n.isArray(e.member.numbers)&&(e.member.numbers_string=e.member.numbers.join(", "))),e},conferenceCleanFormData:function(e){var t=this;return e.member.pins_string=t.conferenceLettersToNumbers(e.member.pins_string),e.member.pins=n.map(e.member.pins_string.split(","),function(e){var t=n.trim(e);return""!=t?t:null}),e.member.numbers=n.map(e.member.numbers_string.split(","),function(e){var t=n.trim(e);return""!=t?t:null}),e},conferenceLettersToNumbers:function(e){var t="";return n.each(e.split(""),function(e,n){t+=n.match(/^[aAbBcC]$/)?"2":n.match(/^[dDeEfF]$/)?"3":n.match(/^[gGhHiI]$/)?"4":n.match(/^[jJkKlL]$/)?"5":n.match(/^[mMnNoO]$/)?"6":n.match(/^[pPqQrRsS]$/)?"7":n.match(/^[tTuUvV]$/)?"8":n.match(/^[wWxXyYzZ]$/)?"9":n}),t},conferenceSave:function(e,t,c,r){var i=this,o=i.conferenceFixArrays(i.conferenceNormalizeData(n.extend(!0,{},t.data,e)),e);"object"==typeof t.data&&t.data.id?i.conferenceUpdate(o,function(e,n){"function"==typeof c&&c(e,n,"update")},function(e,n){"function"==typeof r&&r(e,n,"update")}):i.conferenceCreate(o,function(e,n){"function"==typeof c&&c(e,n,"create")},function(e,n){"function"==typeof r&&r(e,n,"create")})},conferenceFixArrays:function(e,n){return"member"in n&&"numbers"in n.member&&(e.member.numbers=n.member.numbers),e},conferenceNormalizeData:function(e){return e.member.pins.length||delete e.member.pins,e.member.numbers.length||delete e.member.numbers,e.owner_id||delete e.owner_id,delete e.member.pins_string,delete e.member.numbers_string,e},conferenceList:function(e){var n=this;n.callApi({resource:"conference.list",data:{accountId:n.accountId,filters:{paginate:!1}},success:function(n){e&&e(n.data)}})},conferenceGet:function(e,n){var t=this;t.callApi({resource:"conference.get",data:{accountId:t.accountId,conferenceId:e},success:function(e){n&&n(e.data)}})},conferenceCreate:function(e,n){var t=this;t.callApi({resource:"conference.create",data:{accountId:t.accountId,data:e},success:function(e){n&&n(e.data)}})},conferenceUpdate:function(e,n){var t=this;t.callApi({resource:"conference.update",data:{accountId:t.accountId,conferenceId:e.id,data:e},success:function(e){n&&n(e.data)}})},conferenceDelete:function(e,n){var t=this;t.callApi({resource:"conference.delete",data:{accountId:t.accountId,conferenceId:e},success:function(e){n&&n(e.data)}})}};return c});