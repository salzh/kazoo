define(["require","jquery","underscore","monster","monster-timezone","slider"],function(e){var a=e("jquery"),t=(e("underscore"),e("monster")),i=e("monster-timezone"),o=(e("slider"),{requests:{},subscribe:{"callflows.fetchActions":"timeofdayDefineActions","callflows.timeofday.edit":"_timeofdayEdit"},timeofdaySave:function(e,t,i,o){var l=this,d=l.timeofdayNormalizeData(a.extend(!0,{},t.data,e));"object"==typeof t.data&&t.data.id?l.temporalRuleUpdate(d,function(e,a){i&&i(e,a,"update")}):l.temporalRuleCreate(d,function(e,a){i&i(e,a,"create")})},timeofdayPopupEdit:function(e){var i,o,l=this,d=e.data,n=e.callback,c=e.data_defaults;o=a('<div class="inline_popup callflows-port"><div class="main_content inline_content"/></div>'),l.timeofdayEdit(d,o,a(".inline_content",o),{save_success:function(e){i.dialog("close"),"function"==typeof n&&n(e)},delete_success:function(){i.dialog("close"),"function"==typeof n&&n({data:{}})},after_render:function(){i=t.ui.dialog(o,{title:d.id?l.i18n.active().callflows.timeofday.edit_time_of_day:l.i18n.active().callflows.timeofday.create_time_of_day})}},c)},_timeofdayEdit:function(e){var a=this;a.timeofdayEdit(e.data,e.parent,e.target,e.callbacks,e.data_defaults)},timeofdayEdit:function(e,t,i,o,l){var d=this,n=t||a("#timeofday-content"),c=i||a("#timeofday-view",n);o=o||{},callbacks={save_success:o.save_success,save_error:o.save_error,delete_success:o.delete_success,delete_error:o.delete_error,after_render:o.after_render},defaults={data:a.extend(!0,{time_window_start:32400,time_window_stop:61200,wdays:[],days:[],interval:1,showSave:!0},l||{}),field_data:{wdays:{sunday:{friendlyName:d.i18n.active().callflows.timeofday.sunday.friendlyName,shortName:d.i18n.active().callflows.timeofday.sunday.shortName},monday:{friendlyName:d.i18n.active().callflows.timeofday.monday.friendlyName,shortName:d.i18n.active().callflows.timeofday.monday.shortName},tuesday:{friendlyName:d.i18n.active().callflows.timeofday.tuesday.friendlyName,shortName:d.i18n.active().callflows.timeofday.tuesday.shortName},wednesday:{friendlyName:d.i18n.active().callflows.timeofday.wednesday.friendlyName,shortName:d.i18n.active().callflows.timeofday.wednesday.shortName},thursday:{friendlyName:d.i18n.active().callflows.timeofday.thursday.friendlyName,shortName:d.i18n.active().callflows.timeofday.thursday.shortName},friday:{friendlyName:d.i18n.active().callflows.timeofday.friday.friendlyName,shortName:d.i18n.active().callflows.timeofday.friday.shortName},saturday:{friendlyName:d.i18n.active().callflows.timeofday.saturday.friendlyName,shortName:d.i18n.active().callflows.timeofday.saturday.shortName}},day:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"],cycle:[{id:"weekly",value:"Weekly"},{id:"monthly",value:"Monthly"},{id:"yearly",value:"Yearly"}],ordinals:[{id:"first",value:"First"},{id:"second",value:"Second"},{id:"third",value:"Third"},{id:"fourth",value:"Fourth"},{id:"fifth",value:"Fifth"},{id:"last",value:"Last"},{id:"every",value:"Day"}],months:[{id:1,value:"January"},{id:2,value:"February"},{id:3,value:"March"},{id:4,value:"April"},{id:5,value:"May"},{id:6,value:"June"},{id:7,value:"July"},{id:8,value:"August"},{id:9,value:"September"},{id:10,value:"October"},{id:11,value:"November"},{id:12,value:"December"}]}},"object"==typeof e&&e.id?d.temporalRuleGet(e.id,function(e,t){var i={data:e};d.timeofdayMigrateData(i),d.timeofdayFormatData(i),d.timeofdayRender(a.extend(!0,defaults,i),c,callbacks),"function"==typeof callbacks.after_render&&callbacks.after_render()}):(d.timeofdayRender(defaults,c,callbacks),"function"==typeof callbacks.after_render&&callbacks.after_render())},timeofdayRender:function(e,i,o){var l,d=this,n=a(t.template(d,"timeofday-callflowEdit",e)),c=n.find("#timeofday-form");t.ui.validate(c),a("*[rel=popover]",n).popover({trigger:"focus"}),d.winkstartTabs(n),t.ui.datepicker(n.find("#start_date")),a("#yearly_every",n).hide(),a("#monthly_every",n).hide(),a("#weekly_every",n).hide(),a("#ordinal",n).hide(),a("#days_checkboxes",n).hide(),a("#weekdays",n).hide(),a("#specific_day",n).hide(),void 0==e.data.id?(a("#weekly_every",n).show(),a("#days_checkboxes",n).show()):"monthly"==e.data.cycle?(a("#monthly_every",n).show(),a("#ordinal",n).show(),void 0!=e.data.days&&void 0!=e.data.days[0]?a("#specific_day",n).show():a("#weekdays",n).show()):"yearly"==e.data.cycle?(a("#yearly_every",n).show(),a("#ordinal",n).show(),void 0!=e.data.days&&void 0!=e.data.days[0]?a("#specific_day",n).show():a("#weekdays",n).show()):(e.data.cycle="weekly")&&(a("#weekly_every",n).show(),a("#days_checkboxes",n).show()),a(".fake_checkbox",n).click(function(){a(this).toggleClass("checked")}),a("#ordinal",n).change(function(){"every"==a(this).val()?(a("#weekdays",n).hide(),a("#specific_day",n).show()):(a("#weekdays",n).show(),a("#specific_day",n).hide())}),a("#cycle",n).change(function(){switch(a("#yearly_every",n).hide(),a("#monthly_every",n).hide(),a("#weekly_every",n).hide(),a("#ordinal",n).hide(),a("#days_checkboxes",n).hide(),a("#weekdays",n).hide(),a("#specific_day",n).hide(),a(this).val()){case"yearly":a("#yearly_every",n).show(),a("#ordinal",n).show(),"every"==a("#ordinal",n).val()?a("#specific_day",n).show():a("#weekdays",n).show();break;case"monthly":a("#monthly_every",n).show(),a("#ordinal",n).show(),"every"==a("#ordinal",n).val()?a("#specific_day",n).show():a("#weekdays",n).show();break;case"weekly":a("#weekly_every",n).show(),a("#days_checkboxes",n).show()}}),a(".timeofday-save",n).click(function(i){if(i.preventDefault(),t.ui.valid(c)){var l=t.ui.getFormData("timeofday-form");l.wdays=[],e.data.wdays=[],a(".fake_checkbox.checked",n).each(function(){l.wdays.push(a(this).data("value"))}),l.interval="monthly"==a("#cycle",n).val()?a("#interval_month",n).val():a("#interval_week",n).val(),l.start_date=n.find("#start_date").datepicker("getDate"),l=d.timeofdayCleanFormData(l),d.timeofdaySave(l,e,o.save_success)}else t.ui.alert("error",d.i18n.active().callflows.timeofday.there_were_errors_on_the_form)}),a(".timeofday-delete",n).click(function(a){a.preventDefault(),t.ui.confirm(d.i18n.active().callflows.timeofday.are_you_sure_you_want_to_delete,function(){d.temporalRuleDelete(e.data.id,o.delete_success)})}),l=o.after_render,o.after_render=function(){"function"==typeof l&&l(),a("#time",n).jslider({from:0,to:86400,step:900,dimension:"",scale:["12:00am","1:00am","2:00am","3:00am","4:00am","5:00am","6:00am","7:00am","8:00am","9:00am","10:00am","11:00am","12:00pm","1:00pm","2:00pm","3:00pm","4:00pm","5:00pm","6:00pm","7:00pm","8:00pm","9:00pm","10:00pm","11:00pm","12:00am"],limits:!1,calculate:function(e){var a=Math.floor(e/3600),t=(e-3600*a)/60,i=12>a?"am":"pm";return a%=12,0==a&&(a=12),a+":"+(t?t:"0"+t)+i},onstatechange:function(){}})},i.empty().append(n)},timeofdayCleanFormData:function(e){var i=[],o=e.time.split(";");return"weekly"!=e.cycle&&void 0!=e.weekday&&(e.wdays=[],e.wdays.push(e.weekday)),a.each(e.wdays,function(e,a){a&&("wednesday"==a&&(a="wensday"),i.push(a))}),i.length>0&&"sunday"==i[0]&&i.push(i.shift()),e.wdays=i,""===e.start_date?delete e.start_date:e.start_date=t.util.dateToGregorian(e.start_date),e.time_window_start=o[0],e.time_window_stop=o[1],e.month&&(e.month=parseInt(e.month)),e},timeofdayNormalizeData:function(e){return"weekly"==e.cycle?(delete e.ordinal,delete e.days,delete e.month):("yearly"==e.cycle?delete e.interval:delete e.month,"every"!=e.ordinal?delete e.days:delete e.wdays),delete e.time,delete e.weekday,"true"===e.enabled?e.enabled=!0:"false"===e.enabled?e.enabled=!1:delete e.enabled,e},timeofdayFormatData:function(e){return void 0!=e.data.wdays&&"weekly"!=e.data.cycle&&(e.data.weekday=e.data.wdays[0]),e.data.showSave=!0,e.data.showDelete=e.data.id?!0:!1,e.data.hasOwnProperty("ui_metadata")&&e.data.ui_metadata.hasOwnProperty("origin")&&"voip"===e.data.ui_metadata.origin&&(e.data.showSave=!1,t.util.isSuperDuper()||(e.data.showDelete=!1)),e},timeofdayMigrateData:function(e){return"wdays"in e.data&&(wday=a.inArray("wensday",e.data.wdays))>-1&&(e.data.wdays[wday]="wednesday"),e},timeofdayDefineActions:function(e){var o=this,l=e.actions;a.extend(l,{"temporal_route[]":{name:o.i18n.active().callflows.timeofday.time_of_day,icon:"temporal_route",category:o.i18n.active().callflows.timeofday.time_of_day_cat,module:"temporal_route",data:{},rules:[{type:"quantity",maxSize:"9999"}],isUsable:"true",weight:10,key_caption:function(e,a){var t=e.key;return"_"===t?caption=o.i18n.active().callflows.timeofday.all_other_times:a.hasOwnProperty(t)?caption=a[t].name:caption="",caption},key_edit:function(e,i){o.temporalRuleList(function(l){var d,n;l.push({id:"_",name:o.i18n.active().callflows.timeofday.all_other_times}),n=a(t.template(o,"timeofday-callflowKey",{items:t.util.sort(l),selected:e.key})),a(".inline_action",n).click(function(t){var i="edit"==a(this).data("action")?{id:a("#timeofday_selector",n).val()}:{};t.preventDefault(),o.timeofdayPopupEdit({data:i,callback:function(a){e.key=a.id||"null",e.key_caption=a.name||"",d.dialog("close")}})}),"_"==a("#timeofday_selector option:selected",n).val()&&a("#edit_link",n).hide(),a("#timeofday_selector",n).change(function(){"_"==a("#timeofday_selector option:selected",n).val()?a("#edit_link",n).hide():a("#edit_link",n).show()}),a("#add",n).click(function(){e.key=a("#timeofday_selector",n).val(),e.key_caption=a("#timeofday_selector option:selected",n).text(),d.dialog("close")}),d=t.ui.dialog(n,{title:o.i18n.active().callflows.timeofday.time_of_day,beforeClose:function(){"function"==typeof i&&i()}})})},caption:function(e,a){return e.getMetadata("timezone")||o.i18n.active().defaultTimezone},edit:function(e,l){var d,n;n=a(t.template(o,"timeofday-callflowTimezone",{items:{},selected:{}})),i.populateDropdown(a("#timezone_selector",n),e.getMetadata("timezone")||"inherit",{inherit:o.i18n.active().defaultTimezone}),a("#add",n).click(function(){var t=a("#timezone_selector",n).val();t&&"inherit"!==t&&e.setMetadata("timezone",t),e.caption=a("#timezone_selector option:selected",n).text(),d.dialog("close")}),d=t.ui.dialog(n,{title:o.i18n.active().callflows.timeofday.select_a_timezone_title,beforeClose:function(){"function"==typeof l&&l()}})},listEntities:function(e){o.callApi({resource:"temporalRule.list",data:{accountId:o.accountId,filters:{paginate:!1}},success:function(a,t){e&&e(a.data)}})},editEntity:"callflows.timeofday.edit"},"temporal_route[action=disable]":{name:o.i18n.active().callflows.timeofday.disable_time_of_day,icon:"temporal_route",category:o.i18n.active().callflows.timeofday.time_of_day_cat,module:"temporal_route",data:{action:"disable",rules:[]},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:20,caption:function(e,a){return""},edit:function(e,i){o.temporalRuleList(function(l){var d,n,c,r=[],s=[];(c=e.getMetadata("rules"))?a.each(l,function(e,t){-1!=a.inArray(t.id,c)?s.push(t):r.push(t)}):r=l,n=a(t.template(o,"timeofday-two_column",{left:{title:o.i18n.active().callflows.timeofday.unselected_time_of_day_rules,items:r},right:{title:o.i18n.active().callflows.timeofday.selected_time_of_day_rules,items:s}})),a("#add",n).click(function(){var t=[];a(".right .connect li",n).each(function(){t.push(a(this).data("id"))}),e.setMetadata("rules",t),d.dialog("close")}),d=t.ui.dialog(n,{title:o.i18n.active().callflows.timeofday.disable_time_of_day_rules_title,beforeClose:function(){"function"==typeof i&&i()}}),a(".connect",d).sortable({connectWith:a(".connect",d),zIndex:2e3,helper:"clone",appendTo:a(".wrapper",d),scroll:!1,tolerance:"pointer",receive:function(){},remove:function(){}})})}},"temporal_route[action=enable]":{name:o.i18n.active().callflows.timeofday.enable_time_of_day,icon:"temporal_route",category:o.i18n.active().callflows.timeofday.time_of_day_cat,module:"temporal_route",data:{action:"enable",rules:[]},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:30,caption:function(e,a){return""},edit:function(e,i){o.temporalRuleList(function(l){var d,n,c,r=[],s=[];(c=e.getMetadata("rules"))?a.each(l,function(e,t){-1!=a.inArray(t.id,c)?s.push(t):r.push(t)}):r=l,n=a(t.template(o,"timeofday-two_column",{left:{title:o.i18n.active().callflows.timeofday.unselected_time_of_day_rules,items:r},right:{title:o.i18n.active().callflows.timeofday.selected_time_of_day_rules,items:s}})),a("#add",n).click(function(){var t=[];a(".right .connect li",n).each(function(){t.push(a(this).data("id"))}),e.setMetadata("rules",t),d.dialog("close")}),d=t.ui.dialog(n,{title:o.i18n.active().callflows.timeofday.enable_time_of_day_rules,beforeClose:function(){"function"==typeof i&&i()}}),a(".connect",d).sortable({connectWith:a(".connect",d),zIndex:2e3,helper:"clone",appendTo:a(".wrapper",d),scroll:!1,tolerance:"pointer",receive:function(){},remove:function(){}})})}},"temporal_route[action=reset]":{name:o.i18n.active().callflows.timeofday.reset_time_of_day,icon:"temporal_route",category:o.i18n.active().callflows.timeofday.time_of_day_cat,module:"temporal_route",data:{action:"reset",rules:[]},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:40,caption:function(e,a){return""},edit:function(e,i){o.temporalRuleList(function(l){var d,n,c,r=[],s=[];(c=e.getMetadata("rules"))?a.each(l,function(e,t){-1!=a.inArray(t.id,c)?s.push(t):r.push(t)}):r=l,n=a(t.template(o,"timeofday-two_column",{left:{title:o.i18n.active().callflows.timeofday.unselected_time_of_day_rules,items:r},right:{title:o.i18n.active().callflows.timeofday.selected_time_of_day_rules,items:s}})),a("#add",n).click(function(){var t=[];a(".right .connect li",n).each(function(){t.push(a(this).data("id"))}),e.setMetadata("rules",t),d.dialog("close")}),d=t.ui.dialog(n,{title:o.i18n.active().callflows.timeofday.reset_time_of_day_rules,beforeClose:function(){"function"==typeof i&&i()}}),a(".connect",d).sortable({connectWith:a(".connect",d),zIndex:2e3,helper:"clone",appendTo:a(".wrapper",d),scroll:!1,tolerance:"pointer",receive:function(){},remove:function(){}})})}}})},temporalRuleList:function(e){var a=this;a.callApi({resource:"temporalRule.list",data:{accountId:a.accountId,filters:{paginate:!1}},success:function(a){e&&e(a.data)}})},temporalRuleGet:function(e,a){var t=this;t.callApi({resource:"temporalRule.get",data:{accountId:t.accountId,ruleId:e},success:function(e){a&&a(e.data)}})},temporalRuleCreate:function(e,a){var t=this;t.callApi({resource:"temporalRule.create",data:{accountId:t.accountId,data:e},success:function(e){a&&a(e.data)}})},temporalRuleUpdate:function(e,a){var t=this;t.callApi({resource:"temporalRule.update",data:{accountId:t.accountId,ruleId:e.id,data:e},success:function(e){a&&a(e.data)}})},temporalRuleDelete:function(e,a){var t=this;t.callApi({resource:"temporalRule.delete",data:{accountId:t.accountId,ruleId:e},success:function(e){a&&a(e.data)}})}});return o});