define(["require","jquery","underscore","monster","monster-timezone","toastr"],function(e){var t=e("jquery"),a=e("underscore"),n=e("monster"),i=e("monster-timezone"),l=e("toastr"),o={requests:{},subscribe:{"voip.strategy.render":"strategyRender","auth.currentAccountUpdated":"_strategyOnCurrentAccountUpdated"},weekdays:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],weekdayLabels:["MainMonday","MainTuesday","MainWednesday","MainThursday","MainFriday","MainSaturday","MainSunday"],subCallflowsLabel:["MainOpenHours","MainAfterHours","MainLunchHours","MainHolidays"],featureCodes:[{name:"call_forward[action=deactivate]",number:"73",callflowNumber:"*73",moduleName:"call_forward",actionName:"deactivate"},{name:"call_forward[action=activate]",number:"72",callflowNumber:"*72",moduleName:"call_forward",actionName:"activate"},{name:"call_forward[action=toggle]",number:"74",pattern:"^\\*74([0-9]*)$",moduleName:"call_forward",actionName:"toggle"},{name:"call_forward[action=update]",number:"56",callflowNumber:"*56",moduleName:"call_forward",actionName:"update"},{name:"hotdesk[action=login]",number:"11",callflowNumber:"*11",moduleName:"hotdesk",actionName:"login"},{name:"hotdesk[action=logout]",number:"12",callflowNumber:"*12",moduleName:"hotdesk",actionName:"logout"},{name:"hotdesk[action=toggle]",number:"13",callflowNumber:"*13",moduleName:"hotdesk",actionName:"toggle"},{name:"voicemail[action=check]",number:"97",callflowNumber:"*97",moduleName:"voicemail",actionName:"check"},{name:"voicemail[single_mailbox_login]",number:"98",callflowNumber:"*98",moduleName:"voicemail",actionName:"check",extraData:{single_mailbox_login:!0}},{name:'voicemail[action="direct"]',number:"*",pattern:"^\\*\\*([0-9]*)$",moduleName:"voicemail",actionName:"compose"},{name:"intercom",number:"0",pattern:"^\\*0([0-9]*)$",moduleName:"intercom",actionName:"compose"},{name:"privacy[mode=full]",number:"67",pattern:"^\\*67([0-9]*)$",moduleName:"privacy",actionName:"full"},{name:"park_and_retrieve",number:"3",pattern:"^\\*3([0-9]*)$",moduleName:"park",actionName:"auto"},{name:"valet",number:"4",callflowNumber:"*4",moduleName:"park",actionName:"park"},{name:"retrieve",number:"5",pattern:"^\\*5([0-9]*)$",moduleName:"park",actionName:"retrieve"}],strategyRender:function(e){var a,i=this,e=e||{},l=e.parent||t(".right-content"),o=e.openElement,c=e.callback;n.parallel({temporalRules:function(e){i.strategyGetTemporalRules(function(t){e(null,t)})},callflows:function(e){i.strategyGetMainCallflows(function(t){e(null,t)})},callEntities:function(e){i.strategyGetCallEntities(function(t){e(null,t)})},voicemails:function(e){i.strategyGetVoicesmailBoxes(function(t){e(null,t)})},numberFeatures:function(e){n.pub("common.numbers.getListFeatures",function(t){e(null,t)})},directories:function(e){i.strategyListDirectories(function(t){e(null,t)})}},function(e,r){var s=r.callflows.MainCallflow.numbers.length>1,u=r.callflows.MainConference.numbers.length>0&&"undefinedconf"!==r.callflows.MainConference.numbers[0],d=r.callflows.MainFaxing.numbers.length>0&&"undefinedfaxing"!==r.callflows.MainFaxing.numbers[0],f={mainNumbers:s?r.callflows.MainCallflow.numbers.slice(1):[i.i18n.active().strategy.noNumberTitle],confNumbers:u?r.callflows.MainConference.numbers:[i.i18n.active().strategy.noNumberTitle],customConfGreeting:r.callflows.MainConference&&"welcome_prompt"in r.callflows.MainConference.flow.data?!0:!1,faxingNumbers:d?r.callflows.MainFaxing.numbers:[i.i18n.active().strategy.noNumberTitle]};if(a=t(n.template(i,"strategy-layout",f)),i.strategyBindEvents(a,r),l.empty().append(a),n.ui.tooltips(a),s?(a.find(".element-container.helper").css("display","none"),a.find(".element-container.main-number").css("margin-top","0px"),i.strategyCheckSecondWalkthrough()):(a.find(".element-container.strategy-hours,.element-container.strategy-holidays,.element-container.strategy-calls").hide(),a.find(".element-container.helper").css("display","block"),a.find(".element-container.main-number").css("margin-top","10px"),i.strategyCheckFirstWalkthrough()),o){var m=a.find(".element-container."+o+":visible");m.length>0&&i.strategyRefreshTemplate(m,r,function(){m.addClass("open"),m.find(".element-content").show()})}c&&c()}),i.strategyCreateFeatureCodes()},strategyCheckFirstWalkthrough:function(){var e=this,t="showStrategyFirstWalkthrough";e.strategyHasWalkthrough(t,function(){e.strategyShowFirstWalkthrough(function(){e.strategyUpdateWalkthroughFlagUser(t)})})},strategyCheckSecondWalkthrough:function(){var e=this,t="showStrategySecondWalkthrough";e.strategyHasWalkthrough(t,function(){e.strategyShowSecondWalkthrough(function(){e.strategyUpdateWalkthroughFlagUser(t)})})},strategyHasWalkthrough:function(e,t){var a=this,n=a.uiFlags.user.get(e);n!==!1&&t&&t()},strategyUpdateWalkthroughFlagUser:function(e,t){var a=this,n=a.uiFlags.user.set(e,!1);a.strategyUpdateOriginalUser(n,function(e){t&&t(e)})},strategyShowFirstWalkthrough:function(e){var a=this,i=t("#strategy_container"),l=[{element:i.find(".element-container.main-number")[0],intro:a.i18n.active().strategy.walkthrough.first.steps[1],position:"bottom"}];n.ui.stepByStep(l,function(){e&&e()})},strategyShowSecondWalkthrough:function(e){var a=this,i=t("#strategy_container"),l=[{element:i.find(".element-container.strategy-hours")[0],intro:a.i18n.active().strategy.walkthrough.second.steps[1],position:"bottom"},{element:i.find(".element-container.strategy-holidays")[0],intro:a.i18n.active().strategy.walkthrough.second.steps[2],position:"bottom"},{element:i.find(".element-container.strategy-calls")[0],intro:a.i18n.active().strategy.walkthrough.second.steps[3],position:"top"},{element:i.find(".element-container.strategy-confnum")[0],intro:a.i18n.active().strategy.walkthrough.second.steps[4],position:"top"},{element:i.find(".element-container.strategy-faxingnum")[0],intro:a.i18n.active().strategy.walkthrough.second.steps[5],position:"top"}];n.ui.stepByStep(l,function(){e&&e()})},strategyBindEvents:function(e,a){var n=this,i=e.find(".element-container"),l=e.find(".element-container.main-number .element-content"),o=e.find(".element-container.strategy-confnum .element-content"),c=e.find(".element-container.strategy-faxingnum .element-content"),r=e.find(".element-container.strategy-hours .element-content"),s=e.find(".element-container.strategy-holidays .element-content"),u=e.find(".element-container.strategy-calls .element-content");e.find(".element-header-inner").on("click",function(e){var l=t(this).parents(".element-container");l.hasClass("open")?l.find(".element-content").slideUp(function(){l.removeClass("open")}):(t.each(i,function(){var e=t(this);e.hasClass("open")&&e.find(".element-content").slideUp(function(){e.removeClass("open")})}),n.strategyRefreshTemplate(l,a,function(){l.addClass("open"),l.find(".element-content").slideDown()}))}),e.find(".element-container").on("click",".cancel-link",function(e){e.preventDefault();var a=t(this).parents(".element-container");a.find(".element-content").slideUp(function(){a.removeClass("open")})}),n.strategyNumbersBindEvents(l,a),n.strategyConfNumBindEvents(o,a),n.strategyFaxingNumBindEvents(c,a),n.strategyHoursBindEvents(r,a),n.strategyHolidaysBindEvents(s,a),n.strategyCallsBindEvents(u,a)},strategyRefreshTemplate:function(e,l,o){var c=this,r=e.data("template");switch(r){case"numbers":c.strategyListAccountNumbers(function(i){var s=l.callflows.MainCallflow,u=s.numbers,d={numbers:t.map(u,function(e,n){if("0"!==e){var o={number:e,features:t.extend(!0,{},l.numberFeatures)};return i.hasOwnProperty(e)&&(a.each(i[e].features,function(e){o.features[e].active="active"}),o.isLocal=i[e].features.indexOf("local")>-1),o}}),isCnamEnabled:n.util.isNumberFeatureEnabled("cnam"),isE911Enabled:n.util.isNumberFeatureEnabled("e911"),spareLinkEnabled:a.countBy(i,function(e){return e.used_by?"assigned":"spare"}).spare>0},f=t(n.template(c,"strategy-"+r,d));n.ui.tooltips(f),e.find(".element-content").empty().append(f),o&&o()});break;case"confnum":c.strategyListAccountNumbers(function(i){var s=l.callflows.MainConference,u=s.numbers,d={numbers:t.map(u,function(e,t){return"undefinedconf"!==e?{number:e}:void 0}),spareLinkEnabled:a.countBy(i,function(e){return e.used_by?"assigned":"spare"}).spare>0},f=n.template(c,"strategy-"+r,d);e.find(".element-content").empty().append(f),o&&o()});break;case"faxingnum":c.strategyListAccountNumbers(function(i){var s=l.callflows.MainFaxing,u=s.numbers,d={numbers:t.map(u,function(e,t){return"undefinedfaxing"!==e?{number:e}:void 0}),actionLinksEnabled:a.isEmpty(s.flow.data),spareLinkEnabled:a.countBy(i,function(e){return e.used_by?"assigned":"spare"}).spare>0},f=n.template(c,"strategy-"+r,d);e.find(".element-content").empty().append(f),o&&o()});break;case"hours":var s,u=n.apps.auth.currentUser.ui_flags&&n.apps.auth.currentUser.ui_flags.twelve_hours_mode?!0:!1,d=function(e){var t=parseInt(e/3600)%24,a=(parseInt(e/60)%60).toString(),n="";return u&&(n=t>=12?"PM":"AM",t=t>12?t-12:0===t?12:t),t.toString()+":"+(a.length<2?"0"+a:a)+n},f=l.temporalRules.weekdays,m={alwaysOpen:!0,companyTimezone:i.formatTimezone(l.callflows.MainCallflow.flow.data.timezone||n.apps.auth.currentAccount.timezone),days:[],lunchbreak:{enabled:l.temporalRules.lunchbreak.id in l.callflows.MainCallflow.flow.children,from:d(parseInt(l.temporalRules.lunchbreak.time_window_start,10)),to:d(parseInt(l.temporalRules.lunchbreak.time_window_stop,10))}};a.each(c.weekdayLabels,function(e){var t=f[e].id in l.callflows.MainCallflow.flow.children;m.days.push({name:e,label:c.i18n.active().strategy.weekdays[e.substring(4).toLowerCase()],open:t,from:d(parseInt(f[e].time_window_start,10)),to:d(parseInt(f[e].time_window_stop,10))}),t&&(m.alwaysOpen=!1)}),m.alwaysOpen&&a.each(m.days,function(e){"MainSaturday"!==e.name&&"MainSunday"!==e.name&&(e.open=!0,e.from=u?"9:00AM":"9:00",e.to=u?"5:00PM":"17:00")}),s=t(n.template(c,"strategy-"+r,m));var p={rules:{"lunchbreak.from":{},"lunchbreak.to":{greaterDate:s.find('input[name="lunchbreak.from"]')}},groups:{lunchbreak:"lunchbreak.from lunchbreak.to"},errorPlacement:function(e,t){e.appendTo(t.parent())}};u?(p.rules["lunchbreak.from"].time12h=!0,p.rules["lunchbreak.to"].time12h=!0):(p.rules["lunchbreak.from"].time24h=!0,p.rules["lunchbreak.to"].time24h=!0),a.each(c.weekdayLabels,function(e){p.rules["weekdays."+e+".from"]={},p.rules["weekdays."+e+".to"]={greaterDate:s.find('input[name="weekdays.'+e+'.from"]')},u?(p.rules["weekdays."+e+".from"].time12h=!0,p.rules["weekdays."+e+".to"].time12h=!0):(p.rules["weekdays."+e+".from"].time24h=!0,p.rules["weekdays."+e+".to"].time24h=!0),p.groups[e]="weekdays."+e+".from weekdays."+e+".to"}),n.ui.validate(s.find("#strategy_custom_hours_form"),p),e.find(".element-content").empty().append(s),n.ui.timepicker(s.find(".timepicker")),o&&o();break;case"holidays":var m={enabled:!t.isEmptyObject(l.temporalRules.holidays)},s=t(n.template(c,"strategy-"+r,m)),g=s.find(".holidays-list");e.find(".element-content").empty().append(s),g.empty(),a.each(l.temporalRules.holidays,function(e,t){if(e.id in l.callflows.MainCallflow.flow.children){var a,n={id:e.id,name:e.name,fromMonth:e.month};e.hasOwnProperty("ordinal")?(a="advanced",n.ordinal=e.ordinal,n.wday=e.wdays[0]):e.hasOwnProperty("viewData")?(a="range",n.fromDay=e.viewData.fromDay,n.fromMonth=e.viewData.fromMonth,n.toDay=e.viewData.toDay,n.toMonth=e.viewData.toMonth,n.set=!0):(n.fromDay=e.days[0],e.days.length>1?(a="range",n.toDay=e.days[e.days.length-1],n.toMonth=e.month):a="single"),c.strategyRenderHolidayLine(g,a,n)}}),o&&o();break;case"calls":var s,m={lunchbreak:l.temporalRules.lunchbreak.id in l.callflows.MainCallflow.flow.children,holidays:!t.isEmptyObject(l.temporalRules.holidays),afterhours:!1};a.each(c.weekdayLabels,function(e){l.temporalRules.weekdays[e].id in l.callflows.MainCallflow.flow.children&&(m.afterhours=!0)}),s=t(n.template(c,"strategy-"+r,m)),e.find(".element-content").empty().append(s),t.each(s.find(".callflow-tab"),function(){var e=t(this),i=e.data("callflow"),o=i+"Menu",r={callOption:{type:"default"},hideAdvancedCallflows:a.isEmpty(l.callEntities.advancedCallflows),callflow:i,callEntities:c.strategyGetCallEntitiesDropdownData(l.callEntities,!0,!0),voicemails:l.voicemails,tabMessage:c.i18n.active().strategy.calls.callTabsMessages[i]};l.callflows[i].flow.hasOwnProperty("is_main_number_cf")?(r.callOption.callEntityId=l.callflows[i].flow.data.id,r.callOption.type="advanced-callflow"):"voicemail"===l.callflows[i].flow.module?(r.callOption.callEntityId="none",r.callOption.voicemailId=l.callflows[i].flow.data.id,r.callOption.type="user-voicemail"):a.isEmpty(l.callflows[i].flow.children)||(r.callOption.callEntityId=l.callflows[i].flow.data.id,"_"in l.callflows[i].flow.children&&"voicemail"===l.callflows[i].flow.children._.module?(r.callOption.type="user-voicemail",r.callOption.voicemailId=l.callflows[i].flow.children._.data.id):r.callOption.type="user-menu"),o in l.callflows&&(r.menu=o),t(this).empty().append(n.template(c,"strategy-callsTab",r))}),t.each(s.find(".user-select select"),function(){var e=t(this);e.chosen({search_contains:!0,width:"160px"}),e.siblings(".title").text(e.find("option:selected").closest("optgroup").prop("label"))}),s.find(".voicemail-select select").chosen({search_contains:!0,width:"160px"}),s.find(".advancedCallflows-select select").chosen({search_contains:!0,width:"160px"}),o&&o();break;default:o&&o()}},strategyNumbersBindEvents:function(e,i){var o=this,c=function(t){if(t.length){var a=i.callflows.MainCallflow;a.numbers=a.numbers.concat(t),o.strategyUpdateCallflow(a,function(t){var a=e.parents(".element-container");i.callflows.MainCallflow=t,r(a),o.strategyRefreshTemplate(a,i)})}},r=function(t){var a=i.callflows.MainCallflow,l=t.find(".element-header-inner .summary > span");a.numbers.length>1?(l.html(n.util.formatPhoneNumber(a.numbers[1])),a.numbers.length>3?l.append('<i class="icon-telicon-multiple-items icon-small"></i>'):3===a.numbers.length&&l.append(", "+n.util.formatPhoneNumber(a.numbers[2])),e.parents("#strategy_container").find(".element-container:not(.main-number,.strategy-confnum)").show(),e.parents("#strategy_container").find(".element-container:not(.main-number,.strategy-faxingnum)").show(),e.parents("#strategy_container").find(".element-container.helper").hide(),e.parents("#strategy_container").find(".element-container.main-number").css("margin-top","0px"),o.strategyCheckSecondWalkthrough()):(l.html(o.i18n.active().strategy.noNumberTitle),e.parents("#strategy_container").find(".element-container:not(.main-number,.strategy-confnum)").hide(),e.parents("#strategy_container").find(".element-container:not(.main-number,.strategy-faxingnum)").hide(),e.parents("#strategy_container").find(".element-container.helper").show(),e.parents("#strategy_container").find(".element-container.main-number").css("margin-top","10px"))};e.on("click",".action-links .spare-link:not(.disabled)",function(e){e.preventDefault();var a={accountName:n.apps.auth.currentAccount.name,accountId:o.accountId,callback:function(e){var a=t.map(e,function(e){return e.phoneNumber});c(a)}};n.pub("common.numbers.dialogSpare",a)}),e.on("click",".action-links .buy-link",function(e){e.preventDefault(),n.pub("common.buyNumbers",{searchType:t(this).data("type"),callbacks:{success:function(e){c(Object.keys(e)),l.success(o.i18n.active().strategy.toastrMessages.buyNumbersSuccess)},error:function(e){l.error(o.i18n.active().strategy.toastrMessages.buyNumbersError)}}})}),e.on("click",".action-links .port-link",function(e){e.preventDefault()}),e.on("click",".number-element .remove-number",function(c){c.preventDefault();var s=t(this),u=s.data("number"),d=s.data("e911"),f=n.util.isNumberFeatureEnabled("e911"),m=i.callflows.MainCallflow.numbers.indexOf(u.toString());"active"===d&&1===e.find('.number-element .remove-number[data-e911="active"]').length&&f?n.ui.alert("error",o.i18n.active().strategy.alertMessages.lastE911Error):m>=0&&o.strategyGetNumber(u,function(c){var s,d,f={phoneNumber:u},p=[],g=function(){i.callflows.MainCallflow.numbers.splice(m,1),o.strategyUpdateCallflow(i.callflows.MainCallflow,function(t){var a=e.parents(".element-container");l.success(o.i18n.active().strategy.toastrMessages.removeNumberSuccess),i.callflows.MainCallflow=t,r(a),o.strategyRefreshTemplate(a,i),o.callApi({resource:"account.get",data:{accountId:o.accountId},success:function(e){var t=!1;"caller_id"in e.data&&"external"in e.data.caller_id&&e.data.caller_id.external.number===u&&(delete e.data.caller_id.external,t=!0),"caller_id"in e.data&&"emergency"in e.data.caller_id&&e.data.caller_id.emergency.number===u&&(delete e.data.caller_id.emergency,t=!0),t&&o.callApi({resource:"account.update",data:{accountId:o.accountId,data:e.data},success:function(e){}})}})})};a.each(c,function(e,t){("cnam"===t||"dash_e911"===t)&&p.push({name:t,friendlyName:o.i18n.active().strategy.popupRemoveFeatures.features[t]})}),p.length>0?(f.featureList=p,s=t(n.template(o,"strategy-popupRemoveFeatures",f)),d=n.ui.dialog(s,{title:o.i18n.active().strategy.popupRemoveFeatures.title,width:"540px"}),d.find(".cancel-link").on("click",function(){d.dialog("close")}),d.find("#remove_features").on("click",function(){d.find(".table td").each(function(e,a){t(a).find("input").is(":checked")&&delete c[t(a).data("name")]}),o.strategyUpdateNumber(u,c,function(){d.dialog("close"),g()})})):g()})}),n.util.isNumberFeatureEnabled("cnam")&&e.on("click",".number-element .callerId-number",function(){var e=t(this).parents(".number-element").first(),a=e.find(".remove-number").data("number");if(a){var i={phoneNumber:a,callbacks:{success:function(t){"cnam"in t.data&&t.data.cnam.display_name?e.find(".features i.feature-outbound_cnam").addClass("active"):e.find(".features i.feature-outbound_cnam").removeClass("active"),"cnam"in t.data&&t.data.cnam.inbound_lookup?e.find(".features i.feature-inbound_cnam").addClass("active"):e.find(".features i.feature-inbound_cnam").removeClass("active")}}};n.pub("common.callerId.renderPopup",i)}}),n.util.isNumberFeatureEnabled("e911")&&e.on("click",".number-element .e911-number",function(){var e=t(this).parents(".number-element").first(),a=e.find(".remove-number").data("number");if(a){var i={phoneNumber:a,callbacks:{success:function(a){t.isEmptyObject(a.data.dash_e911)?e.find(".features i.feature-dash_e911").removeClass("active"):e.find(".features i.feature-dash_e911").addClass("active")}}};n.pub("common.e911.renderPopup",i)}}),e.on("click",".number-element .prepend-number",function(){var e=t(this).parents(".number-element").first(),a=e.find(".remove-number").data("number");if(a){var i={phoneNumber:a,callbacks:{success:function(t){"prepend"in t.data&&t.data.prepend.enabled?e.find(".features i.feature-prepend").addClass("active"):e.find(".features i.feature-prepend").removeClass("active")}}};n.pub("common.numberPrepend.renderPopup",i)}})},strategyConfNumBindEvents:function(e,a){var i=this,o=function(t){if(t.length){var n=a.callflows.MainConference;n.numbers.length<=1&&"undefinedconf"===n.numbers[0]&&(n.numbers=[]),n.numbers=n.numbers.concat(t),i.strategyUpdateCallflow(n,function(t){var n=e.parents(".element-container");a.callflows.MainConference=t,c(n),i.strategyRefreshTemplate(n,a)})}},c=function(e){var t=a.callflows.MainConference,l=e.find(".element-header-inner .summary > span");t.numbers.length>0&&"undefinedconf"!==t.numbers[0]?(l.html(n.util.formatPhoneNumber(t.numbers[0])),t.numbers.length>2?l.append('<i class="icon-telicon-multiple-items icon-small"></i>'):2===t.numbers.length&&l.append(", "+n.util.formatPhoneNumber(t.numbers[1]))):l.html(i.i18n.active().strategy.noNumberTitle)};e.on("click",".action-links .spare-link:not(.disabled)",function(e){e.preventDefault();var a={accountName:n.apps.auth.currentAccount.name,accountId:i.accountId,callback:function(e){var a=t.map(e,function(e){return e.phoneNumber});o(a)}};n.pub("common.numbers.dialogSpare",a)}),e.on("click",".action-links .greeting-link",function(e){e.preventDefault();var l=a.callflows.MainConference;l?i.getMainConferenceGreetingMedia(function(e){var o=t(n.template(i,"strategy-customConferenceGreeting",{enabled:"welcome_prompt"in l.flow.data,greeting:e&&e.tts?e.tts.text:""})),c=n.ui.dialog(o,{title:i.i18n.active().strategy.customConferenceGreeting.title,position:["center",20]});o.find(".switch-state").on("change",function(){t(this).prop("checked")?o.find(".content").slideDown():o.find(".content").slideUp()}),o.find(".cancel").on("click",function(){c.dialog("close").remove()}),o.find(".save").on("click",function(){if(o.find(".switch-state").prop("checked")){var n=function(t){e?(e.description="<Text to Speech>",e.media_source="tts",e.tts={text:o.find(".custom-greeting-text").val(),voice:"female/en-US"},i.callApi({resource:"media.update",data:{accountId:i.accountId,mediaId:e.id,data:e},success:function(e,a){t&&t(e.data)}})):i.callApi({resource:"media.create",data:{accountId:i.accountId,data:{description:"<Text to Speech>",media_source:"tts",name:"MainConferenceGreeting",streamable:!0,type:"mainConfGreeting",tts:{text:o.find(".custom-greeting-text").val(),voice:"female/en-US"}}},success:function(e,a){t&&t(e.data)}})};n(function(e){l.flow.data.welcome_prompt={media_id:e.id},i.strategyUpdateCallflow(l,function(e){a.callflows.MainConference=e,c.dialog("close").remove(),t("#strategy_container .custom-greeting-icon").show()})})}else"welcome_prompt"in l.flow.data?(delete l.flow.data.welcome_prompt,i.strategyUpdateCallflow(l,function(e){a.callflows.MainConference=e,c.dialog("close").remove(),t("#strategy_container .custom-greeting-icon").hide()})):c.dialog("close").remove()})}):n.ui.alert("error",i.i18n.active().strategy.customConferenceGreeting.mainConfMissing)}),e.on("click",".action-links .buy-link",function(e){e.preventDefault(),n.pub("common.buyNumbers",{searchType:t(this).data("type"),callbacks:{success:function(e){o(Object.keys(e)),l.success(i.i18n.active().strategy.toastrMessages.buyNumbersSuccess)},error:function(e){l.error(i.i18n.active().strategy.toastrMessages.buyNumbersError)}}})}),e.on("click",".number-element .remove-number",function(n){n.preventDefault();var o=t(this).data("number").toString(),r=a.callflows.MainConference.numbers.indexOf(o);r>=0&&(a.callflows.MainConference.numbers.splice(r,1),0===a.callflows.MainConference.numbers.length&&(a.callflows.MainConference.numbers=["undefinedconf"]),i.strategyUpdateCallflow(a.callflows.MainConference,function(t){var n=e.parents(".element-container");l.success(i.i18n.active().strategy.toastrMessages.removeNumberSuccess),a.callflows.MainConference=t,c(n),i.strategyRefreshTemplate(n,a)}))})},getMainConferenceGreetingMedia:function(e){var t=this;t.callApi({resource:"media.list",data:{accountId:t.accountId,filters:{filter_type:"mainConfGreeting"}},success:function(a,n){a.data&&a.data.length>0?t.callApi({resource:"media.get",data:{accountId:t.accountId,mediaId:a.data[0].id},success:function(t,a){e&&e(t.data)},error:function(t,a){e&&e(null)}}):e&&e(null)},error:function(t,a){e&&e(null)}})},strategyFaxingNumBindEvents:function(e,a){var i=this,o=function(t){if(t.length){var n=a.callflows.MainFaxing,l=function(){i.strategyUpdateCallflow(n,function(t){var n=e.parents(".element-container");a.callflows.MainFaxing=t,c(n),i.strategyRefreshTemplate(n,a)})};n.numbers.length<=1&&"undefinedfaxing"===n.numbers[0]&&(n.numbers=[]),n.numbers=n.numbers.concat(t),n.flow.data.hasOwnProperty("id")?l():i.strategyBuildFaxbox({data:{number:n.numbers[0]},success:function(e){n.flow.data.id=e.id,l()}})}},c=function(e){var t=a.callflows.MainFaxing,l=e.find(".element-header-inner .summary > span");t.numbers.length>0&&"undefinedfaxing"!==t.numbers[0]?(l.html(n.util.formatPhoneNumber(t.numbers[0])),t.numbers.length>2?l.append('<i class="icon-telicon-multiple-items icon-small"></i>'):2===t.numbers.length&&l.append(", "+n.util.formatPhoneNumber(t.numbers[1]))):l.html(i.i18n.active().strategy.noNumberTitle)};e.on("click",".action-links .spare-link:not(.disabled)",function(e){e.preventDefault();var a={accountName:n.apps.auth.currentAccount.name,accountId:i.accountId,singleSelect:!0,callback:function(e){var a=t.map(e,function(e){return e.phoneNumber});o(a)}};n.pub("common.numbers.dialogSpare",a)}),e.on("click",".action-links .buy-link",function(e){e.preventDefault(),n.pub("common.buyNumbers",{searchType:t(this).data("type"),singleSelect:!0,callbacks:{success:function(e){o(Object.keys(e)),l.success(i.i18n.active().strategy.toastrMessages.buyNumbersSuccess)},error:function(e){l.error(i.i18n.active().strategy.toastrMessages.buyNumbersError)}}})}),e.on("click",".number-element .remove-number",function(n){n.preventDefault();var o=t(this).data("number"),r=a.callflows.MainFaxing,s=r.numbers.indexOf(o);s>=0&&(r.numbers.splice(s,1),0===r.numbers.length&&(r.numbers=["undefinedfaxing"]),i.strategyDeleteFaxbox({data:{id:r.flow.data.id},success:function(t){delete r.flow.data.id,i.strategyUpdateCallflow(r,function(t){var n=e.parents(".element-container");l.success(i.i18n.active().strategy.toastrMessages.removeNumberSuccess),a.callflows.MainFaxing=t,c(n),i.strategyRefreshTemplate(n,a)})}}))})},strategyHoursBindEvents:function(e,i){var l=this;e.on("change",'.custom-hours-toggler input[type="radio"]',function(a){var n=e.find(".custom-hours-div");"true"==t(this).val()?n.slideDown():n.slideUp()}),e.on("change",'.custom-days input[type="checkbox"]',function(e){var a=t(this).parents(".custom-day"),n=a.find(".timepickers"),i=a.find(".status");t(this).prop("checked")?(n.fadeIn(200),i.fadeOut(100,function(){i.html(l.i18n.active().strategy.open),i.fadeIn(100)})):(n.fadeOut(200),i.fadeOut(100,function(){i.html(l.i18n.active().strategy.closed),i.fadeIn(100)}))}),e.on("change",'.custom-hours-lunchbreak input[type="checkbox"]',function(e){t(this).prop("checked")?t(this).parents(".custom-hours-lunchbreak").find(".timepickers").fadeIn(200):t(this).parents(".custom-hours-lunchbreak").find(".timepickers").fadeOut(200)}),e.on("click",".save-button",function(o){if(o.preventDefault(),n.ui.valid(e.find("#strategy_custom_hours_form"))){var c=t(this).parents(".element-container"),r=n.ui.getFormData("strategy_custom_hours_form"),s=i.callflows.MainCallflow,u=function(e){return{children:{},data:{id:e},module:"callflow"}};if(a.each(i.temporalRules.weekdays,function(e,t){delete s.flow.children[e.id]}),delete s.flow.children[i.temporalRules.lunchbreak.id],"false"!==r.enabled&&r.opendays&&0!==r.opendays.length){var d={};if(s.flow.children._=u(i.callflows.MainAfterHours.id),r.lunchbreak.enabled){var f=i.temporalRules.lunchbreak;f.time_window_start=n.util.timeToSeconds(r.lunchbreak.from),f.time_window_stop=n.util.timeToSeconds(r.lunchbreak.to),d.lunchbreak=function(e){l.callApi({resource:"temporalRule.update",data:{accountId:l.accountId,ruleId:f.id,data:f},success:function(t,a){e(null,t.data)}})},s.flow.children[f.id]=u(i.callflows.MainLunchHours.id)}a.each(r.opendays,function(e){var t=i.temporalRules.weekdays[e];t.time_window_start=n.util.timeToSeconds(r.weekdays[e].from),t.time_window_stop=n.util.timeToSeconds(r.weekdays[e].to),d[e]=function(e){l.callApi({resource:"temporalRule.update",data:{accountId:l.accountId,ruleId:t.id,data:t},success:function(t,a){e(null,t.data)}})},s.flow.children[t.id]=u(i.callflows.MainOpenHours.id)}),n.parallel(d,function(e,t){})}else s.flow.children._=u(i.callflows.MainOpenHours.id);l.strategyRebuildMainCallflowRuleArray(i),l.strategyUpdateCallflow(s,function(e){i.callflows.MainCallflow=e,c.find(".element-content").hide(),c.removeClass("open")})}})},strategyHolidaysBindEvents:function(e,i){var o=this;e.on("change",'.holidays-toggler input[type="checkbox"]',function(a){t(this).prop("checked")?e.find(".holidays-div").slideDown():e.find(".holidays-div").slideUp()}),e.on("click",".add-holidays-link",function(a){a.preventDefault(),o.strategyRenderHolidayLine(e.find(".holidays-list"),t(this).data("type"))}),e.on("click",".delete-holiday",function(e){var a=t(this).parents(".holidays-element"),l=a.data("id"),c=a.data("type");l?n.ui.confirm(o.i18n.active().strategy.confirmMessages.deleteHoliday,function(){var e=i.callflows.MainCallflow;delete e.flow.children[l],o.strategyRebuildMainCallflowRuleArray(i),o.strategyUpdateCallflow(e,function(e){i.callflows.MainCallflow=e;var t=function(e){delete i.temporalRules.holidays[e.name],a.remove()};"set"===c?o.strategyDeleteRuleSetAndRules(l,t):o.strategyDeleteHoliday(l,t)})}):a.remove()}),e.on("click",".save-button",function(c){c.preventDefault();var r=t(this).parents(".element-container"),s=i.callflows.MainCallflow,u=r.find('.holidays-toggler input[type="checkbox"]')[0].checked,d={},f=!1;u?(t.each(e.find(".holidays-element"),function(){var e=o.strategyBuildHolidayRule(t(this),d);return e?void(d[e.name]=function(t){e.hasOwnProperty("isRange")?o.strategyBuildMultiMonthRangeHoliday(e,function(a){a.viewData=e,t&&t(null,a)}):o.strategyCleanUpdateHoliday(e,function(e){t&&t(null,e)})}):(f=!0,!1)}),f?n.ui.alert(o.i18n.active().strategy.alertMessages.uniqueHoliday):n.parallel(d,function(e,t){var n=[],c=a.pluck(d,"id");a.each(s.flow.children,function(e,t){"_"!==t&&e.data.id===i.callflows.MainHolidays.id&&n.push(t)}),a.each(n,function(e){c.indexOf(e)<0&&delete s.flow.children[e]}),a.each(t,function(e,t){s.flow.children[e.id]={children:{},data:{id:i.callflows.MainHolidays.id},module:"callflow"},i.temporalRules.holidays[e.name]=e}),o.strategyRebuildMainCallflowRuleArray(i),o.strategyUpdateCallflow(s,function(e){i.callflows.MainCallflow=e,r.find(".element-content").hide(),r.removeClass("open"),l.success(o.i18n.active().strategy.toastrMessages.updateHolidaySuccess)})})):n.ui.confirm(o.i18n.active().strategy.confirmMessages.disableHolidays,function(){a.each(i.temporalRules.holidays,function(e,t){d[t]=function(t){e.hasOwnProperty("temporal_rules")?o.strategyDeleteRuleSetAndRules(e.id,function(){delete s.flow.children[e.id],t(null,{})}):o.strategyDeleteHoliday(e.id,function(){delete s.flow.children[e.id],t(null,{})})}}),n.parallel(d,function(e,t){i.temporalRules.holidays={},o.strategyRebuildMainCallflowRuleArray(i),o.strategyUpdateCallflow(s,function(e){i.callflows.MainCallflow=e,r.find(".element-content").hide(),r.removeClass("open"),l.success(o.i18n.active().strategy.toastrMessages.updateHolidaySuccess)})})})})},strategyCleanUpdateHoliday:function(e,t){var a=this,n=function(){delete e.extra,a.strategyUpdateHoliday(e,function(e){t&&t(e)})};"set"===e.extra.oldType?a.strategyDeleteRuleSetAndRules(e.id,function(){delete e.id,n()}):n()},strategyBuildMultiMonthRangeHoliday:function(e,t){var i=this,l=parseInt(e.fromDay),o=parseInt(e.fromMonth),c=parseInt(e.toDay),r=parseInt(e.toMonth),s=e.name,u=function(e,t,a,n){for(var i=parseInt(t),l=a||1,o=n||31,c=[],r=l;o>=r;r++)c.push(r);return{name:e+"_"+i,cycle:"yearly",days:c,interval:1,month:i}},d=[],f={name:s,temporal_rules:[],type:"main_holidays"},m={},p=s+"_"+n.util.randomString(6);if(o!==r){d.push(u(p,o,l,31));for(var g=12===o?1:o+1,h=g;h!==r&&h-12!==r;h++)13===h&&(h=1),d.push(u(p,h,1,31));d.push(u(p,r,1,c))}else d.push(u(p,o,l,c));a.each(d,function(e){m[e.name]=function(t){i.strategyUpdateHoliday(e,function(e){t&&t(null,e)})}});var y=function(){n.parallel(m,function(e,n){a.each(d,function(e){f.temporal_rules.push(n[e.name].id)}),i.strategyCreateRuleSet(f,function(e){t(e)})})};e.hasOwnProperty("id")?"rule"===e.extra.oldType?i.strategyDeleteHoliday(e.id,function(){y()}):i.strategyDeleteRuleSetAndRules(e.id,function(){y()}):y()},strategyGetDetailRuleSet:function(e,t){var i=this;i.strategyGetRuleSet(e,function(e){var l={};a.each(e.temporal_rules,function(e){l[e]=function(t){i.strategyGetRule(e,function(e){e.hasOwnProperty("message")&&"bad identifier"===e.message&&(e={}),t&&t(null,e)})}}),n.parallel(l,function(n,l){var o=[],c=[],r={};a.each(e.temporal_rules,function(e){a.isEmpty(l[e])||(c.push(e),o.push(l[e]))}),o.length&&(r.fromDay=o[0].days[0],r.toDay=o[o.length-1].days[o[o.length-1].days.length-1],r.fromMonth=o[0].month,r.toMonth=o[o.length-1].month),a.isEqual(c,e.temporal_rules)?(e.viewData=r,t&&t(e)):c.length>0?(e.temporal_rules=c,i.strategyUpdateRuleSet(e,function(e){
e.viewData=r,t&&t(e)})):i.strategyDeleteRuleSet(e.id,function(){t&&t({})})})})},strategyGetRuleSet:function(e,t){var a=this;a.callApi({resource:"temporalSet.get",data:{accountId:a.accountId,setId:e},success:function(e,a){t(e.data)}})},strategyUpdateRuleSet:function(e,t){var a=this;a.callApi({resource:"temporalSet.update",data:{accountId:a.accountId,setId:e.id,data:e},success:function(e,a){t(e.data)}})},strategyCreateRuleSet:function(e,t){var a=this;a.callApi({resource:"temporalSet.create",data:{accountId:a.accountId,data:e},success:function(e,a){t(e.data)}})},strategyDeleteRuleSetAndRules:function(e,t){var i=this;i.strategyGetRuleSet(e,function(l){var o={};a.each(l.temporal_rules,function(e){o[e]=function(t){i.strategyDeleteHoliday(e,function(){t&&t(null,{})})}}),n.parallel(o,function(a,n){i.strategyDeleteRuleSet(e,function(e){t&&t(e)})})})},strategyDeleteRuleSet:function(e,t){var a=this;a.callApi({resource:"temporalSet.delete",data:{accountId:a.accountId,setId:e},success:function(e,a){t&&t(e.data)}})},strategyBuildHolidayRule:function(e,a){var n=t(e),i=n.find(".name").val().trim(),l=parseInt(n.find(".month.from :selected").val()),o=parseInt(n.find(".month.to :selected").val()),c=parseInt(n.find(".day.from :selected").val()),r=parseInt(n.find(".day.to :selected").val()),s=n.find(".ordinal :selected").val(),u=n.find(".wday :selected").val(),d=n.data("id"),f=n.data("type"),m={};if(!i||Object.keys(a).indexOf(i)>=0)m=!1;else if(o&&l!==o)m={isRange:!0,name:i,fromDay:c,fromMonth:l,toDay:r,toMonth:o};else if(m={name:i,cycle:"yearly",interval:1,month:l,type:"main_holidays"},c){var p=c;if(m.days=[p],r)for(var g=p+1;r>=g;g++)m.days.push(g)}else m.ordinal=s,m.wdays=[u];return d&&(m.id=d),m.extra={oldType:f},m},strategyUpdateHoliday:function(e,t){var a=this;e.id?a.callApi({resource:"temporalRule.update",data:{accountId:a.accountId,ruleId:e.id,data:e},success:function(e,a){t(e.data)}}):a.callApi({resource:"temporalRule.create",data:{accountId:a.accountId,data:e},success:function(e,a){t(e.data)}})},strategyDeleteHoliday:function(e,t){var a=this;a.callApi({resource:"temporalRule.delete",data:{accountId:a.accountId,ruleId:e,generateError:!1},success:function(e,a){t(e.data)},error:function(e,a){t(e.data)}})},strategyCallsBindEvents:function(e,i){function o(e){e.siblings().removeClass("active"),e.addClass("active")}var c=this;e.on("click",".calls-tabs a",function(e){e.preventDefault(),t(this).tab("show")}),e.on("click",".call-option",function(e){var a=t(this);o(a),a.find('.radio-div input[type="radio"]').prop("checked",!0)}),e.on("change",'input[type="radio"]',function(e){t(this).prop("checked")&&o(t(this).parents(".call-option"))}),e.on("click",".menu-div a",function(a){a.preventDefault();var n=t(this).parents(".callflow-tab");c.strategyShowMenuPopup({strategyData:i,name:n.data("callflow")+"Menu",label:e.find('a[href="#'+n.prop("id")+'"]').text()})}),e.on("change",".user-select select",function(e){var a=t(this);a.siblings(".title").text(a.find("option:selected").closest("optgroup").prop("label"))}),e.on("click",".save-button",function(o){o.preventDefault();var r=null,s={};if(t.each(e.find(".callflow-tab"),function(){var e=t(this),a=e.data("callflow"),n=e.find(".call-option.active"),l=n.find(".menu-div"),o=n.find(".user-select"),c=n.find(".voicemail-select"),u=n.find(".advancedCallflows-select"),d={};if(o.length){var f=o.find("option:selected"),m={children:{},module:f.data("type"),data:{}};switch(m.module){case"user":case"device":case"callflow":case"play":m.data.id=f.val();break;case"ring_group":m.data.endpoints=[{endpoint_type:"group",id:f.val()}];break;case"none":m={}}d=m}if(c.length){var p=c.find("option:selected"),m={children:{},module:"voicemail",data:{id:p.val()}};"children"in d?d.children._=m:d=m}if(l.length){var g=l.data("callflow");if(!g)return r=this.id,!1;var m={children:{},module:"callflow",data:{id:i.callflows[g].id}};"children"in d?d.children._=m:d=m}u.length&&(d={children:{},module:"callflow",data:{id:u.find("option:selected").val()},is_main_number_cf:!0}),s[a]=d}),r)n.ui.alert(c.i18n.active().strategy.alertMessages.undefinedMenu),e.find('a[href="#'+r+'"]').tab("show");else{var u={};a.each(s,function(e,t){i.callflows[t].flow=e,u[t]=function(e){c.strategyUpdateCallflow(i.callflows[t],function(a){i.callflows[t]=a,e(null,a)})}}),n.parallel(u,function(t,a){e.hide(),e.parents(".element-container").removeClass("open"),l.success(c.i18n.active().strategy.toastrMessages.updateCallSuccess)})}})},strategyRenderHolidayLine:function(e,a,i,l){for(var o=this,c=t.extend(!0,{resources:{months:[{value:1,label:o.i18n.active().strategy.monthsShort.january},{value:2,label:o.i18n.active().strategy.monthsShort.february},{value:3,label:o.i18n.active().strategy.monthsShort.march},{value:4,label:o.i18n.active().strategy.monthsShort.april},{value:5,label:o.i18n.active().strategy.monthsShort.may},{value:6,label:o.i18n.active().strategy.monthsShort.june},{value:7,label:o.i18n.active().strategy.monthsShort.july},{value:8,label:o.i18n.active().strategy.monthsShort.august},{value:9,label:o.i18n.active().strategy.monthsShort.september},{value:10,label:o.i18n.active().strategy.monthsShort.october},{value:11,label:o.i18n.active().strategy.monthsShort.november},{value:12,label:o.i18n.active().strategy.monthsShort.december}],days:[],wdays:t.map(o.weekdays,function(e){return{value:e,label:o.i18n.active().strategy.weekdays[e].substring(0,3)}}),ordinals:[{value:"first",label:o.i18n.active().strategy.ordinals.first},{value:"second",label:o.i18n.active().strategy.ordinals.second},{value:"third",label:o.i18n.active().strategy.ordinals.third},{value:"fourth",label:o.i18n.active().strategy.ordinals.fourth},{value:"fifth",label:o.i18n.active().strategy.ordinals.fifth},{value:"last",label:o.i18n.active().strategy.ordinals.last}]}},i,{holidayType:a}),r=1;31>=r;r++)c.resources.days.push({value:r});e.append(n.template(o,"strategy-holidayLine",c))},strategyShowMenuPopup:function(e,i){var l,o,c,r=this,s=e.strategyData,u=e.name,d=e.label,f=function(){l=t(n.template(r,"strategy-menuPopup",{menu:o,greeting:c})),popup=n.ui.dialog(l,{title:r.i18n.active().strategy.popup.title+" - "+d,dialogClass:"overflow-visible"});var i=l.find(".menu-block .left .content"),f=t.extend(!0,{},s.callEntities,{voicemail:s.voicemails},{directory:s.directories}),m=r.strategyGetCallEntitiesDropdownData(f);a.each(s.callflows[u].flow.children,function(e,t){i.append(n.template(r,"strategy-menuLine",{number:t,callEntities:m,selectedId:e.data.id||e.data.endpoints[0].id}))}),t.each(i.find(".target-input"),function(){var e=t(this),a=e.find(".target-select option:selected").parents("optgroup").data("icon");e.find(".target-icon").addClass(a)}),r.strategyBindMenuPopupEvents(popup,t.extend({menu:o,greeting:c},e))};u in s.callflows?r.callApi({resource:"menu.get",data:{accountId:r.accountId,menuId:s.callflows[u].flow.data.id},success:function(e,t){o=e.data,o.media.greeting?r.callApi({resource:"media.get",data:{accountId:r.accountId,mediaId:o.media.greeting},success:function(e,t){c=e.data,f()}}):f()}}):r.callApi({resource:"menu.create",data:{accountId:r.accountId,data:{name:u,record_pin:n.util.randomString(4,"1234567890"),media:{exit_media:!0,invalid_media:!0,transfer_media:!0},retries:3,max_extension_length:4,type:"main"}},success:function(e,a){o=e.data,r.callApi({resource:"callflow.create",data:{accountId:r.accountId,data:{contact_list:{exclude:!1},numbers:[u],type:"main",flow:{children:{},data:{id:o.id},module:"menu"}}},success:function(e,a){s.callflows[u]=e.data,t(".callflow-tab.active .menu-div").data("callflow",u),t(".callflow-tab.active .menu-div").addClass("has-menu"),f()}})}})},strategyBindMenuPopupEvents:function(e,a){var i,l=this,o=a.strategyData,c=a.name,r=a.menu,s=a.greeting,u=e.find("#strategy_menu_popup"),d=u.find("#strategy_menu_popup_tts_greeting"),f=u.find("#strategy_menu_popup_upload_greeting");u.find(".target-select").chosen({search_contains:!0,width:"150px"}),u.find(".upload-input").fileUpload({inputOnly:!0,wrapperClass:"upload-container",btnText:l.i18n.active().strategy.popup.fileUploadButton,btnClass:"monster-button-secondary",maxSize:5,success:function(e){i=e[0]},error:function(e){e.hasOwnProperty("size")&&e.size.length>0&&n.ui.alert(l.i18n.active().strategy.alertMessages.fileTooBigAlert),u.find(".upload-container input").val(""),i=void 0}}),u.on("change",".target-select",function(e){var a=t(this),n=a.parents(".target-input").find(".target-icon"),i=a.find("option:selected").parents("optgroup").data("icon");n.attr("class","target-icon "+i)}),u.on("click",".remove-btn",function(e){t(this).parents(".menu-line").remove()}),u.find(".add-menu-line a").on("click",function(e){e.preventDefault();var a=t.extend(!0,{},o.callEntities,{voicemail:o.voicemails},{directory:o.directories}),i=t(n.template(l,"strategy-menuLine",{callEntities:l.strategyGetCallEntitiesDropdownData(a)})),c=i.find(".target-select option:selected").parents("optgroup").data("icon");u.find(".menu-block .left .content").append(i),i.find(".target-icon").addClass(c),i.find(".number-input").focus()}),d.find(".update-greeting").on("click",function(e){var t=d.find("textarea").val();t?s&&s.id?(s.type="virtual_receptionist",s.description="<Text to Speech>",s.media_source="tts",s.tts={voice:"female/en-US",text:t},l.callApi({resource:"media.update",data:{accountId:l.accountId,mediaId:s.id,data:s},success:function(e,t){s=e.data,u.find(".greeting-option").removeClass("active"),d.parents(".greeting-option").addClass("active"),d.collapse("hide")}})):l.callApi({resource:"media.create",data:{accountId:l.accountId,data:{streamable:!0,name:c,type:"virtual_receptionist",media_source:"tts",description:"<Text to Speech>",tts:{voice:"female/en-US",text:t}}},success:function(e,t){s=e.data,r.media.greeting=e.data.id,l.callApi({resource:"menu.update",data:{accountId:l.accountId,menuId:r.id,data:r},success:function(e,t){r=e.data}}),u.find(".greeting-option").removeClass("active"),d.parents(".greeting-option").addClass("active"),d.collapse("hide")}}):n.ui.alert(l.i18n.active().strategy.alertMessages.emptyTtsGreeting)}),f.find(".update-greeting").on("click",function(e){var t=function(e,t,a){l.callApi({resource:"media.upload",data:{accountId:l.accountId,mediaId:t,data:e},success:function(e,t){a&&a()}})};i?s&&s.id?(s.type="virtual_receptionist",s.description=i.name,s.media_source="upload",delete s.tts,l.callApi({resource:"media.update",data:{accountId:l.accountId,mediaId:s.id,data:s},success:function(e,a){s=e.data,t(i.file,s.id,function(){u.find(".greeting-option").removeClass("active"),f.parents(".greeting-option").addClass("active"),f.collapse("hide")})}})):l.callApi({resource:"media.create",data:{accountId:l.accountId,data:{streamable:!0,name:c,type:"virtual_receptionist",media_source:"upload",description:i.name}},success:function(e,a){s=e.data,r.media.greeting=s.id,l.callApi({resource:"menu.update",data:{accountId:l.accountId,menuId:r.id,data:r},success:function(e,t){r=e.data}}),t(i.file,s.id,function(){u.find(".greeting-option").removeClass("active"),f.parents(".greeting-option").addClass("active"),f.collapse("hide")})}}):n.ui.alert(l.i18n.active().strategy.alertMessages.emptyUploadGreeting)}),u.find(".cancel-greeting").on("click",function(e){t(this).parents(".collapse").collapse("hide")}),u.find(".cancel-link").on("click",function(t){t.preventDefault(),e.dialog("close")}),u.find(".save-button").on("click",function(a){var i={},r=!1;t.each(u.find(".menu-line"),function(){var e=t(this),a=e.find(".target-select option:selected"),n=e.find(".number-input").val(),l=a.data("type"),o=a.val();if(!n||n in i)return r=!0,!1;switch(i[n]={children:{},module:l,data:{}},l){case"ring_group":i[n].data.endpoints=[{endpoint_type:"group",id:o}];break;default:i[n].data.id=o}}),r?n.ui.alert(l.i18n.active().strategy.alertMessages.uniqueMenuNumbers):(o.callflows[c].flow.children=i,l.strategyUpdateCallflow(o.callflows[c],function(e){o.callflows[c]=e}),e.dialog("close"))})},strategyGetCallEntitiesDropdownData:function(e,n,i){var l=this,n=n===!0||!1,i=i===!0||!1,o=t.extend(!0,{},e),c=[];return n||(o.user=o.userCallflows),delete o.userCallflows,i||(o.ring_group=o.userGroups),delete o.userGroups,a.each(o,function(e,a){var n={groupName:l.i18n.active().strategy.callEntities[a],groupType:a,entities:t.map(e,function(e){var t=e.name;return t||(e.hasOwnProperty("first_name")?t=e.first_name+" "+e.last_name:e.hasOwnProperty("numbers")&&(t=e.numbers.toString())),{id:e.id,name:t,module:e.module||a}})};switch(n.groupType){case"directory":n.groupIcon="fa fa-book";break;case"user":n.groupIcon="fa fa-user";break;case"device":n.groupIcon="icon-telicon-voip-phone";break;case"ring_group":n.groupIcon="fa fa-users";break;case"media":n.groupIcon="fa fa-music";break;case"voicemail":n.groupIcon="icon-telicon-voicemail"}n.entities.sort(function(e,t){return e.name.toLowerCase()>t.name.toLowerCase()}),"directory"===n.groupType?c.unshift(n):"user"===n.groupType?"directory"===c[0].groupType?c.splice(1,0,n):c.unshift(n):c.push(n)}),c},strategyBuildFaxbox:function(e){var t=this;t.strategyGetAccount({success:function(a){var i=a.contact&&a.contact.technical&&a.contact.technical.hasOwnProperty("email")?a.contact.technical.email:void 0;e.data={name:a.name+t.i18n.active().strategy.faxing.nameExtension,caller_name:a.name,caller_id:e.data.number,fax_header:n.config.whitelabel.companyName+t.i18n.active().strategy.faxing.headerExtension,fax_timezone:a.timezone,fax_identity:n.util.formatPhoneNumber(e.data.number),owner_id:a.id,notifications:{inbound:{email:{send_to:i}},outbound:{email:{send_to:i}}}},i||delete e.data.notifications,t.strategyCreateFaxbox(e)}})},strategyGetMainCallflows:function(e){var i=this;i.callApi({resource:"callflow.list",data:{accountId:i.accountId,filters:{has_value:"type",key_missing:["owner_id","group_id"]}},success:function(l,o){var c={},r={};a.each(l.data,function(e,t){if("main"===e.type||"conference"===e.type||"faxing"===e.type){var a=e.name||e.numbers[0];"conference"===e.type?a="MainConference":"faxing"===e.type&&(a="MainFaxing"),c[a]=function(t){i.callApi({resource:"callflow.get",data:{accountId:i.accountId,callflowId:e.id},success:function(e,a){t(null,e.data)}})}}}),c.MainConference||(c.MainConference=function(e){i.callApi({resource:"callflow.create",data:{accountId:i.accountId,data:{contact_list:{exclude:!1},numbers:["undefinedconf"],name:"MainConference",type:"conference",flow:{children:{},data:{},module:"conference"}}},success:function(t,a){e(null,t.data)}})}),c.MainFaxing||(c.MainFaxing=function(e){i.callApi({resource:"callflow.create",data:{accountId:i.accountId,data:{contact_list:{exclude:!1},numbers:["undefinedfaxing"],name:"MainFaxing",type:"faxing",flow:{children:{},data:{},module:"faxbox"}}},success:function(t,a){e(null,t.data)}})}),a.each(i.subCallflowsLabel,function(e){var t=e+"Menu";c[t]?c[e]||(r[t]=c[t],delete c[t]):r[t]=function(e){i.callApi({resource:"menu.create",data:{accountId:i.accountId,data:{name:t,record_pin:n.util.randomString(4,"1234567890"),media:{exit_media:!0,invalid_media:!0,transfer_media:!0},retries:3,max_extension_length:4,type:"main"}},success:function(a,n){i.callApi({resource:"callflow.create",data:{accountId:i.accountId,data:{contact_list:{exclude:!1},numbers:[t],type:"main",flow:{children:{},data:{id:a.data.id},module:"menu"}}},success:function(t,a){e&&e(null,t.data)}})}})}}),n.parallel(r,function(l,o){var r=o;a.each(i.subCallflowsLabel,function(e){c[e]||(c[e]=function(t){i.callApi({resource:"callflow.create",data:{accountId:i.accountId,data:{contact_list:{exclude:!1},numbers:[e],type:"main",flow:{children:{},data:{id:r[e+"Menu"].id},module:"callflow"}}},success:function(e,a){t(null,e.data)}})})}),n.parallel(c,function(a,n){c.MainCallflow?(delete n.MainCallflow.flow.data.timezone,"0"!==n.MainCallflow.numbers[0]?("undefined"===n.MainCallflow.numbers[0]?n.MainCallflow.numbers[0]="0":n.MainCallflow.numbers.splice(0,0,"0"),i.strategyUpdateCallflow(n.MainCallflow,function(a){n.MainCallflow=a,e(t.extend(!0,r,n))})):e(t.extend(!0,r,n))):i.callApi({resource:"callflow.create",data:{accountId:i.accountId,data:{contact_list:{exclude:!1},numbers:["0"],name:"MainCallflow",type:"main",flow:{children:{_:{children:{},data:{id:n.MainOpenHours.id},module:"callflow"}},data:{},module:"temporal_route"}}},success:function(a,i){n.MainCallflow=a.data,e(t.extend(!0,r,n))}})})})}})},strategyCreateFeatureCodes:function(e){var i=this;i.strategyGetFeatureCodes(function(l){var o=t.map(l,function(e){return e.featurecode.name}),c=[];a.each(i.featureCodes,function(e){if(-1==o.indexOf(e.name)){var a={flow:{children:{},data:t.extend(!0,e.extraData||{},{action:e.actionName}),module:e.moduleName},featurecode:{name:e.name,number:e.number}};"pattern"in e?a.patterns=[e.pattern]:a.numbers=[e.callflowNumber],c.push(function(e){i.strategyCreateCallflow(a,function(t){e&&e(null,t)})})}}),c.length>0?n.parallel(c,function(t,a){e&&e()}):e&&e()})},strategyGetFeatureCodes:function(e){var t=this,a={paginate:"false",has_key:"featurecode"};t.strategyGetCallflows(function(t){e&&e(t)},a)},strategyGetAllRules:function(e){var t=this;n.parallel({rules:function(e){t.callApi({resource:"temporalRule.list",data:{accountId:t.accountId,filters:{has_key:"type"}},success:function(t,a){e&&e(null,t.data)}})},sets:function(e){t.callApi({resource:"temporalSet.list",data:{accountId:t.accountId,filters:{has_key:"type",filter_type:"main_holidays"}},success:function(i,l){var o={};a.each(i.data,function(e){o[e.id]=function(a){t.strategyGetDetailRuleSet(e.id,function(e){a&&a(null,e)})}}),n.parallel(o,function(t,a){e&&e(null,a)})}})}},function(t,a){e&&e(a)})},strategyGetRule:function(e,t){var a=this;a.callApi({resource:"temporalRule.get",data:{accountId:a.accountId,ruleId:e,generateError:!1},success:function(e,a){t&&t(e.data)},error:function(e,a){t&&t(e.data)}})},strategyGetTemporalRules:function(e){var t=this;t.strategyGetAllRules(function(i){var l={};a.each(i.rules,function(e,a){l[e.name]=function(a){t.strategyGetRule(e.id,function(e){a(null,e)})}}),a.each(t.weekdayLabels,function(e){e in l||(l[e]=function(a){t.callApi({resource:"temporalRule.create",data:{accountId:t.accountId,data:{cycle:"weekly",interval:1,name:e,type:"main_weekdays",time_window_start:32400,time_window_stop:61200,wdays:[e.substring(4).toLowerCase()]}},success:function(e,t){a(null,e.data)}})})}),"MainLunchHours"in l||(l.MainLunchHours=function(e){t.callApi({resource:"temporalRule.create",data:{accountId:t.accountId,data:{cycle:"weekly",interval:1,name:"MainLunchHours",type:"main_lunchbreak",time_window_start:43200,time_window_stop:46800,wdays:t.weekdays}},success:function(t,a){e(null,t.data)}})}),n.parallel(l,function(t,n){var l={weekdays:{},lunchbreak:{},holidays:{}};a.each(n,function(e,t){switch(e.type){case"main_weekdays":l.weekdays[t]=e;break;case"main_lunchbreak":l.lunchbreak=e;break;case"main_holidays":l.holidays[t]=e}}),a.each(i.sets,function(e){a.isEmpty(e)||(l.holidays[e.name]=e)}),e(l)})})},strategyGetCallEntities:function(e){var i=this;n.parallel({users:function(e){i.callApi({resource:"user.list",data:{accountId:i.accountId,filters:{paginate:"false"}},success:function(t,a){e(null,t.data)}})},media:function(e){i.strategyListMedia(function(t){e(null,t)})},userCallflows:function(e){i.callApi({resource:"callflow.list",data:{accountId:i.accountId,filters:{has_key:"owner_id"}},success:function(t,n){var i=a.filter(t.data,function(e){return"mainUserCallflow"===e.type||!("type"in e)});e(null,i)}})},groups:function(e){i.callApi({resource:"group.list",data:{accountId:i.accountId,filters:{paginate:"false"}},success:function(t,a){e(null,t.data)}})},ringGroups:function(e){i.callApi({resource:"callflow.list",data:{accountId:i.accountId,filters:{has_key:"group_id",filter_type:"baseGroup"}},success:function(t,a){e(null,t.data)}})},userGroups:function(e){i.callApi({resource:"callflow.list",data:{accountId:i.accountId,filters:{has_key:"group_id",filter_type:"userGroup"}},success:function(t,a){e(null,t.data)}})},devices:function(e){i.callApi({resource:"device.list",data:{accountId:i.accountId,filters:{paginate:"false"}},success:function(t,a){e(null,t.data)}})},advancedCallflows:function(e){i.strategyGetCallflows(function(t){e(null,t)},{filter_ui_is_main_number_cf:!0})}},function(n,i){var l={device:i.devices,user:t.extend(!0,[],i.users),play:i.media,userCallflows:[],ring_group:[],userGroups:t.map(i.userGroups,function(e){var t=a.find(i.groups,function(t){return e.group_id===t.id});return e.name=t&&t.name||e.name,e.module="callflow",e}),advancedCallflows:i.advancedCallflows};a.each(l.play,function(e){e.module="play"}),a.each(l.device,function(e){e.module="device"}),a.each(i.users,function(e){var t=a.find(i.userCallflows,function(t){return t.owner_id===e.id});t?(e.id=t.id,e.module="callflow"):e.module="user",l.userCallflows.push(e)}),a.each(i.groups,function(e){var t=a.find(i.ringGroups,function(t){return t.group_id===e.id});t?(e.id=t.id,e.module="callflow"):e.module="ring_group",l.ring_group.push(e)}),a.each(i.advancedCallflows,function(e){e.module="callflow"}),e(l)})},strategyGetVoicesmailBoxes:function(e){var t=this;t.callApi({resource:"voicemail.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t,a){t.data.sort(function(e,t){return e.name.toLowerCase()>t.name.toLowerCase()}),e(t.data)}})},strategyListAccountNumbers:function(e){var t=this;t.callApi({resource:"numbers.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t,a){e(t.data.numbers)}})},strategyGetNumber:function(e,t){var a=this;a.callApi({resource:"numbers.get",data:{accountId:a.accountId,phoneNumber:encodeURIComponent(e)},success:function(e,a){t(e.data)}})},strategyUpdateNumber:function(e,t,a){var n=this;n.callApi({resource:"numbers.update",data:{accountId:n.accountId,phoneNumber:encodeURIComponent(e),data:t},success:function(e,t){a()}})},strategyRebuildMainCallflowRuleArray:function(e){var t=e.callflows.MainCallflow,n=e.temporalRules,i=[];a.each(n.holidays,function(e,a){e.id in t.flow.children&&i.push(e.id)}),n.lunchbreak.id in t.flow.children&&i.push(n.lunchbreak.id),a.each(n.weekdays,function(e,a){e.id in t.flow.children&&i.push(e.id)}),t.flow.data.rules=i},strategyGetCallflows:function(e,t){var a=this;a.callApi({resource:"callflow.list",data:{accountId:a.accountId,filters:t||{}},success:function(t){e&&e(t.data)}})},strategyCreateCallflow:function(e,t){var a=this;a.callApi({resource:"callflow.create",data:{accountId:a.accountId,data:e},success:function(e){t&&t(e.data)}})},strategyUpdateCallflow:function(e,t){var a=this,n=e.id;delete e.metadata,delete e.id,a.callApi({resource:"callflow.update",data:{accountId:a.accountId,callflowId:n,data:e},success:function(e,a){t(e.data)}})},strategyListDirectories:function(e,t){var a=this;a.callApi({resource:"directory.list",data:{accountId:a.accountId},success:function(t,a){e&&e(t.data)},error:function(e,a){t&&t()}})},strategyListMedia:function(e){var t=this;t.callApi({resource:"media.list",data:{accountId:t.accountId},success:function(t,a){e&&e(t.data)}})},_strategyOnCurrentAccountUpdated:function(e){t("#strategy_custom_hours_timezone").text(i.formatTimezone(e.timezone))},strategyUpdateOriginalUser:function(e,t){var a=this;a.callApi({resource:"user.update",data:{userId:e.id,accountId:n.apps.auth.originalAccount.id,data:e},success:function(e){t&&t(e.data)}})},strategyGetAccount:function(e){var t=this;t.callApi({resource:"account.get",data:{accountId:t.accountId},success:function(t,a){e.hasOwnProperty("success")&&e.success(t.data)},error:function(t,a){e.hasOwnProperty("error")&&e.error()}})},strategyCreateFaxbox:function(e){var t=this;t.callApi({resource:"faxbox.create",data:{accountId:t.accountId,data:e.data},success:function(t,a){e.hasOwnProperty("success")&&e.success(t.data)},error:function(t,a){e.hasOwnProperty("error")&&e.error()}})},strategyDeleteFaxbox:function(e){var t=this;t.callApi({resource:"faxbox.delete",data:{accountId:t.accountId,faxboxId:e.data.id},success:function(t,a){e.hasOwnProperty("success")&&e.success(t.data)},error:function(t,a){e.hasOwnProperty("error")&&e.error()}})}};return o});