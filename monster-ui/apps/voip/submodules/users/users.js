define(["require","jquery","underscore","chosen","monster","monster-timezone","toastr"],function(e){var n=e("jquery"),i=e("underscore"),t=(e("chosen"),e("monster")),a=e("monster-timezone"),s=e("toastr"),r={requests:{},subscribe:{"voip.users.render":"usersRender"},deviceIcons:{cellphone:"fa fa-phone",smartphone:"icon-telicon-mobile-phone",landline:"icon-telicon-home",mobile:"icon-telicon-sprint-phone",softphone:"icon-telicon-soft-phone",sip_device:"icon-telicon-voip-phone",sip_uri:"icon-telicon-voip-phone",fax:"icon-telicon-fax",ata:"icon-telicon-fax"},usersRender:function(e){var a=this,e=e||{},s=e.parent||n(".right-content"),r=e.userId,o=e.openedTab,c=e.callback;a.usersRemoveOverlay(),a.usersGetData(function(e){var l,u=a.usersFormatListData(e),d=n(t.template(a,"users-layout",u));if(i.each(u.users,function(e){l=t.template(a,"users-row",e),d.find(".user-rows").append(l)}),t.ui.tooltips(d,{options:{container:"body"}}),d.find('[data-toggle="popover"]').popover({container:"body"}),a.usersBindEvents(d,s,u),s.empty().append(d),a.usersCheckWalkthrough(),r){var f=s.find(".grid-row[data-id="+r+"] .grid-cell");t.ui.highlight(f)}0==u.users.length?(s.find(".grid-row.title").css("display","none"),s.find(".no-users-row").css("display","block")):(s.find(".grid-row.title").css("display","block"),s.find(".no-users-row").css("display","none")),r&&o&&d.find('.grid-row[data-id="'+r+'"] .grid-cell[data-type="'+o+'"]').click(),c&&c()})},usersCheckWalkthrough:function(){var e=this;e.usersHasWalkthrough(function(){e.usersShowWalkthrough(function(){e.usersUpdateWalkthroughFlagUser()})})},usersHasWalkthrough:function(e){var n=this,i=n.uiFlags.user.get("showUsersWalkthrough");i!==!1&&e&&e()},usersUpdateWalkthroughFlagUser:function(e){var n=this,i=n.uiFlags.user.set("showUsersWalkthrough",!1);n.usersUpdateOriginalUser(i,function(n){e&&e(n)})},usersShowWalkthrough:function(e){var i=this,a=n("#voip_container"),s=a.find(".grid-row:not(.title):first"),r=[{element:a.find(".add-user")[0],intro:i.i18n.active().users.walkthrough.steps[1],position:"right"},{element:s.find(".name")[0],intro:i.i18n.active().users.walkthrough.steps[2],position:"right"},{element:s.find(".extension")[0],intro:i.i18n.active().users.walkthrough.steps[3],position:"bottom"},{element:s.find(".phone-number")[0],intro:i.i18n.active().users.walkthrough.steps[4],position:"bottom"},{element:s.find(".devices")[0],intro:i.i18n.active().users.walkthrough.steps[5],position:"left"},{element:s.find(".features")[0],intro:i.i18n.active().users.walkthrough.steps[6],position:"left"}];t.ui.stepByStep(r,function(){e&&e()})},usersFormatUserData:function(e,n,a,s,r){var o=this,c={additionalDevices:0,additionalExtensions:0,additionalNumbers:0,devices:[],extension:e.hasOwnProperty("presence_id")?e.presence_id:"",hasFeatures:!1,isAdmin:"admin"===e.priv_level,listCallerId:[],listExtensions:[],listNumbers:[],phoneNumber:"",differentEmail:e.email!==e.username,mapFeatures:{caller_id:{icon:"fa fa-user",iconColor:"monster-blue",title:o.i18n.active().users.caller_id.title},call_forward:{icon:"fa fa-share",iconColor:"monster-yellow",title:o.i18n.active().users.call_forward.title},hotdesk:{icon:"fa fa-fire",iconColor:"monster-orange",title:o.i18n.active().users.hotdesk.title},vm_to_email:{icon:"icon-telicon-voicemail",iconColor:"monster-green",title:o.i18n.active().users.vm_to_email.title},faxing:{icon:"icon-telicon-fax",iconColor:"monster-red",title:o.i18n.active().users.faxing.title},conferencing:{icon:"fa fa-comments",iconColor:"monster-grey",title:o.i18n.active().users.conferencing.title},find_me_follow_me:{icon:"fa fa-sitemap",iconColor:"monster-purple",title:o.i18n.active().users.find_me_follow_me.title},music_on_hold:{icon:"fa fa-music",iconColor:"monster-pink",title:o.i18n.active().users.music_on_hold.title},call_recording:{icon:"fa fa-microphone",iconColor:"monster-blue",title:o.i18n.active().users.callRecording.title}}};if("extra"in e||(e.extra=c),e.extra.countFeatures=0,i.each(e.features,function(n){n in e.extra.mapFeatures&&(e.extra.countFeatures++,e.extra.mapFeatures[n].active=!0)}),e.extra.countFeatures>0&&(e.extra.hasFeatures=!0),n&&(e.extra.mainDirectoryId=n.id,"directories"in e&&n.id in e.directories?e.extra.includeInDirectory=!0:e.extra.includeInDirectory=!1),a&&(e.extra.mainCallflowId=a.id,"flow"in a)){var l=a.flow,u="user";for(e.features.indexOf("find_me_follow_me")>=0&&(u="ring_group",e.extra.groupTimeout=!0);l.module!=u&&"_"in l.children;)l=l.children._;e.extra.ringingTimeout=l.data.timeout}if(s&&(e.extra.vmbox=s),!i.isEmpty(s)&&!i.isEmpty(r)){var d=r.indexOf(s.mailbox);r.splice(d,1),e.extra.existingVmboxes=r}e.extra.adminId=o.userId,e.extra.presenceIdOptions=[];var f,m=!1,p=function(n){f={key:n,value:t.util.formatPhoneNumber(n)},e.extra.presenceIdOptions.push(f)};return i.each(e.extra.listExtensions,function(n){e.hasOwnProperty("presence_id")&&e.presence_id===n&&(m=!0),p(n)}),e.extra.presenceIdOptions.sort(function(e,n){return e.key>n.key?1:-1}),m||e.extra.presenceIdOptions.unshift({key:"unset",value:o.i18n.active().users.editionForm.noPresenceID}),e},usersFormatListData:function(e){var n=this,a={existingExtensions:[],countUsers:e.users.length},s={};i.each(e.users,function(e){s[e.id]=n.usersFormatUserData(e)}),i.each(e.callflows,function(e){if("faxing"!==e.type){var n=e.owner_id;if(i.each(e.numbers,function(e){e&&e.length<7&&a.existingExtensions.push(e)}),n in s){var t=s[n];i.each(e.numbers,function(e){e.length<7?t.extra.listExtensions.push(e):(t.extra.listCallerId.push(e),t.extra.listNumbers.push(e),""===t.extra.phoneNumber?t.extra.phoneNumber=e:t.extra.additionalNumbers++)}),t.extra.additionalExtensions=t.extra.listExtensions.length>=1?t.extra.listExtensions.length-1:0,""===t.extra.extension&&t.extra.listExtensions.length>0&&(t.extra.extension=t.extra.listExtensions[0])}}}),a.existingExtensions.sort(n.usersSortExtensions),i.each(e.devices,function(t){var a=t.owner_id;if(a in s){var r=i.find(e.deviceStatus,function(e){return e.device_id===t.id&&e.registered===!0})?!0:!1;s[a].extra.devices.length>=2&&(0===s[a].extra.additionalDevices&&(s[a].extra.additionalDevices={count:0,tooltip:""}),s[a].extra.additionalDevices.count++,s[a].extra.additionalDevices.tooltip+='<i class="device-popover-icon '+n.deviceIcons[t.device_type]+(r?" monster-green":" monster-red")+'"></i>'+t.name+" ("+t.device_type.replace("_"," ")+")<br>");var o={id:t.id,name:t.name+" ("+t.device_type.replace("_"," ")+")",type:t.device_type,registered:r,icon:n.deviceIcons[t.device_type]};"mobile"===t.device_type&&(o.mobile=t.mobile),s[a].extra.devices.push(o)}});var r=[];return i.each(s,function(e){r.push(e)}),r=t.util.sort(r,"last_name"),a.users=r,a},usersDeleteDialog:function(e,i){var a=this,s={user:e},r=n(t.template(a,"users-deleteDialog",s));t.ui.tooltips(r),r.find("#confirm_button").on("click",function(){var n=r.find("#delete_devices").is(":checked");a.usersDelete(e.id,n,function(e){o.dialog("close").remove(),i&&i(e)})}),r.find("#cancel_button").on("click",function(){o.dialog("close").remove()});var o=t.ui.dialog(r,{title:'<i class="fa fa-question-circle monster-blue"></i>',position:["center",20],dialogClass:"monster-alert"})},usersBindEvents:function(e,a,r){var o,c,l,u,d,f,m,p,v=this,h=r.existingExtensions,b=v.i18n.active().users.toastrMessages,x=r,g=function(e){t.parallel({userDevices:function(e){v.usersListDeviceUser(o.id,function(n){e(null,n)})},userCallflow:function(e){v.usersGetMainCallflow(o.id,function(n){e(null,n)})}},function(i,t){v.usersRenderFindMeFollowMe(n.extend(!0,t,{currentUser:o,saveCallback:e}))})};setTimeout(function(){e.find(".search-query").focus()}),e.find(".grid-row:not(.title) .grid-cell").on("click",function(){var a=n(this),s=a.data("type"),r=a.parents(".grid-row"),b=r.data("id");e.find(".edit-user").slideUp("400",function(){n(this).empty()}),a.hasClass("active")?(e.find(".grid-cell").removeClass("active"),e.find(".grid-row").removeClass("active"),v.usersRemoveOverlay(),a.css({position:"initial","z-index":"0"}),a.parent().siblings(".edit-user").css({position:"initial","z-index":"0","border-top-color":"#a6a7a9"})):(e.find(".grid-cell").removeClass("active"),e.find(".grid-row").removeClass("active"),a.toggleClass("active"),r.toggleClass("active"),a.css({position:"relative","z-index":"2"}),a.parent().siblings(".edit-user").css({position:"relative","z-index":"2","border-top-color":"transparent"}),v.usersGetTemplate(s,b,x,function(e,a){"name"===s?(o=a,e.find("#user_timezone").chosen({search_contains:!0,width:"220px"}),a.extra.differentEmail?e.find(".email-group").show():e.find(".email-group").hide(),a.extra.mainDirectoryId&&(m=a.extra.mainDirectoryId),a.extra.mainCallflowId&&(p=a.extra.mainCallflowId)):"numbers"===s?(l=[],d=[],c=a.callflow,o=a.user,t.ui.tooltips(e),i.each(a.extensions,function(e){l.push(e)})):"extensions"===s?(h=a.allExtensions,c=a.callflow,o=a.user,u=[],i.each(a.assignedNumbers,function(e){u.push(e.phoneNumber)})):"features"===s?o=a:"devices"===s&&(setTimeout(function(){e.find(".search-query").focus()}),o=b,f={}),r.find(".edit-user").append(e).slideDown(400,function(){n("body").animate({scrollTop:r.offset().top-(window.innerHeight-r.height()-10)})}),n("body").append(n('<div id="users_container_overlay"></div>'))}))}),e.find(".users-header .search-query").on("keyup",function(){var t=n(this).val().toLowerCase(),a=e.find(".user-rows .grid-row:not(.title)"),s=e.find(".user-rows .empty-search-row");i.each(a,function(e){var e=n(e);e.data("search").toLowerCase().indexOf(t)<0?e.hide():e.show()}),a.size()>0&&(a.is(":visible")?s.hide():s.show())}),e.find(".users-header .add-user").on("click",function(){t.parallel({callflows:function(e){v.usersListCallflows(function(n){e(null,n)})},vmboxes:function(e){v.usersListVMBoxes(function(n){e(null,n)})}},function(e,i){var a=v.usersFormatAddUser(i),s=n(t.template(v,"users-creation",a));t.ui.mask(s.find("#extension"),"extension"),t.ui.validate(s.find("#form_user_creation"),{rules:{"callflow.extension":{checkList:a.listExtensions},"vmbox.number":{checkList:a.listVMBoxes},"user.password":{minlength:6}},messages:{"user.first_name":{required:v.i18n.active().validation.required},"user.last_name":{required:v.i18n.active().validation.required},"callflow.extension":{required:v.i18n.active().validation.required}}}),t.ui.showPasswordStrength(s.find("#password")),s.find("#create_user").on("click",function(){if(t.ui.valid(s.find("#form_user_creation"))){var e=t.ui.getFormData("form_user_creation"),n=v.usersFormatCreationData(e);v.usersCreate(n,function(e){r.dialog("close").remove(),v.usersRender({userId:e.user.id})})}}),s.find("#notification_email").on("change",function(){s.find(".email-group").toggleClass("hidden")});var r=t.ui.dialog(s,{title:v.i18n.active().users.dialogCreationUser.title})})}),e.on("click",".cancel-link",function(){e.find(".edit-user").slideUp("400",function(){n(this).empty(),e.find(".grid-cell.active").css({position:"inline-block","z-index":"0"}),e.find(".grid-row.active .edit-user").css({position:"block","z-index":"0"}),e.find(".grid-row.active").removeClass("active"),v.usersRemoveOverlay(),e.find(".grid-cell.active").removeClass("active")})}),e.on("click",".save-extensions",function(){var i=n(this),a=n.extend(!0,[],u),r=i.parents(".grid-row").find(".grid-cell.name").text(),l=i.parents(".grid-row").data("id"),d=[];if(e.find(".extensions .list-assigned-items .item-row").each(function(e,i){var t,i=n(i);t=(i.data("id")?i.data("id"):i.find(".input-extension").val())+"",a.push(t),d.push(t)}),a.length>0){var f=function(){v.usersUpdateCallflowNumbers(l,(c||{}).id,a,function(e){s.success(t.template(v,"!"+b.numbersUpdated,{name:r})),v.usersRender({userId:e.owner_id})})};if(v.usersHasProperPresenceId(d,o))f();else{var m=o.presence_id;v.usersUpdatePresenceIDPopup(d,o,function(e){v.usersUpdateUser(e,function(){v.usersSmartUpdateVMBox({user:e,callback:function(){f()},oldPresenceId:m,userExtension:d[0]})})})}}else t.ui.alert("warning",v.i18n.active().users.noNumberCallflow)}),e.on("click","#add_extensions",function(){var i=parseInt(t.util.getNextExtension(h))+"",a={recommendedExtension:i},s=n(t.template(v,"users-newExtension",a)),r=e.find(".extensions .list-assigned-items");t.ui.mask(s.find(".input-extension "),"extension"),r.find(".empty-row").hide(),r.append(s),h.push(i)}),e.on("click",".remove-extension",function(){var i=n(this).parents(".item-row"),t=i.siblings(".empty-row");i.slideUp(function(){i.remove(),e.find(".list-assigned-items .item-row").is(":visible")||t.slideDown()})}),e.on("click",".cancel-extension-link",function(){var e=n(this).siblings("input").val(),i=h.indexOf(e);i>-1&&h.splice(i,1),n(this).parents(".item-row").remove()}),e.on("click","#delete_user",function(){var e=n(this).parents(".grid-row").data();v.usersDeleteDialog(e,function(e){s.success(t.template(v,"!"+v.i18n.active().users.toastrMessages.userDelete,{name:e.first_name+" "+e.last_name})),v.usersRender()})}),e.on("change","#notification_email",function(){e.find(".email-border").hasClass("open")?(e.find(".email-border").removeClass("open",400),e.find(".email-group").slideUp()):(e.find(".email-group").slideDown(),e.find(".email-border").addClass("open",400))}),e.on("click",".save-user",function(){var i=t.ui.getFormData("form-"+o.id),a=e.find("#form-"+o.id);t.util.checkVersion(o,function(){if(t.ui.valid(a)){o.extra.vmbox.timezone=i.timezone;var e=n.extend(!0,{},o,i),r=o.presence_id;t.parallel({vmbox:function(n){v.usersSmartUpdateVMBox({user:e,callback:function(e){n(null,e)},oldPresenceId:r})},user:function(n){v.usersUpdateUser(e,function(e){n(null,e.data)})},callflow:function(n){e.extra.ringingTimeout&&e.features.indexOf("find_me_follow_me")<0?v.usersGetMainCallflow(e.id,function(i){if("flow"in i){for(var t=i.flow;"user"!=t.module&&"_"in t.children;)t=t.children._;t.data.timeout=parseInt(e.extra.ringingTimeout),v.usersUpdateCallflow(i,function(e){n(null,e)})}else n(null,null)}):n(null,null)}},function(e,n){s.success(t.template(v,"!"+b.userUpdated,{name:n.user.first_name+" "+n.user.last_name})),v.usersRender({userId:n.user.id})})}})}),e.on("click","#change_pin",function(){var e=n(t.template(v,"users-changePin")),i=e.find("#form_new_pin");t.ui.validate(i,{rules:{pin:{number:!0,minlength:4,min:0}}}),e.find(".save-new-pin").on("click",function(){var e=t.ui.getFormData("form_new_pin"),r=n.extend(!0,o.extra.vmbox,e);t.ui.valid(i)&&v.usersUpdateVMBox(r,function(e){a.dialog("close").remove(),s.success(t.template(v,"!"+b.pinUpdated,{name:o.first_name+" "+o.last_name}))})}),e.find(".cancel-link").on("click",function(){a.dialog("close").remove()});var a=t.ui.dialog(e,{title:v.i18n.active().users.dialogChangePin.title})}),e.on("click","#change_username",function(){var i=n(t.template(v,"users-changePassword",o)),a=i.find("#form_new_username");t.ui.showPasswordStrength(i.find("#inputPassword")),t.ui.validate(a,{rules:{password:{minlength:6}}}),i.find(".save-new-username").on("click",function(){var i=t.ui.getFormData("form_new_username"),c=n.extend(!0,{},o,i);t.ui.valid(a)&&(o.extra.differentEmail||(c.email=c.username),v.usersUpdateUser(c,function(n){o.username=n.data.username,e.find("#username").html(n.data.username),o.extra.differentEmail||(e.find("#email").val(n.data.email),o.email=n.username),r.dialog("close").remove(),s.success(t.template(v,"!"+b.userUpdated,{name:n.data.first_name+" "+n.data.last_name}))}))}),i.find(".cancel-link").on("click",function(){r.dialog("close").remove()});var r=t.ui.dialog(i,{title:v.i18n.active().users.dialogChangePassword.title})}),e.on("click","#open_fmfm_link",function(){g(function(e){e.openedTab="name",v.usersRender(e)})}),e.on("focus",".ringing-timeout.disabled #ringing_timeout",function(){n(this).blur()}),e.on("click",".create-device",function(){var i=n(this),a=i.data("type");i.parents(".grid-row").data("id");t.pub("voip.devices.renderAdd",{type:a,callback:function(n){var i=t.template(v,"users-rowSpareDevice",n),a=e.find(".list-assigned-items");a.find(".empty-row").hide(),a.append(i)}})}),e.on("click",".spare-devices:not(.disabled)",function(){var a=n.map(e.find(".device-list.list-assigned-items .item-row"),function(e){return n(e).data("id")});v.usersGetDevicesData(function(n){var s={};i.each(n,function(e){"owner_id"in e&&""!==e.owner_id&&e.owner_id!==o||-1!==a.indexOf(e.id)||(s[e.id]=e)}),t.pub("common.monsterListing.render",{dataList:s,dataType:"devices",okCallback:function(n){i.each(n,function(n){var i=t.template(v,"users-rowSpareDevice",n),a=e.find(".list-assigned-items");a.find(".empty-row").hide(),a.append(i),n.owner_id&&delete f[n.id]})}})})}),e.on("click",".save-devices",function(){var i={"new":[],old:[]},a=n(this).parents(".grid-row").find(".grid-cell.name").text(),r=n(this).parents(".grid-row").data("id");e.find(".detail-devices .list-assigned-items .item-row:not(.assigned)").each(function(e,t){i["new"].push(n(t).data("id"))}),i.old=Object.keys(f),v.usersUpdateDevices(i,r,function(){s.success(t.template(v,"!"+b.devicesUpdated,{name:a})),v.usersRender({userId:r})})}),e.on("click",".detail-devices .edit-device-link",function(){var e=n(this).parents(".item-row"),i=e.data("id"),a=n(this).parents(".grid-row").data("id");t.pub("voip.devices.editDevice",{data:{id:i},callbackSave:function(n){e.find(".edit-device").html(n.name)},callbackDelete:function(e){v.usersRender({userId:a,openedTab:"devices"})}})}),e.on("click",".detail-devices .list-assigned-items .remove-device",function(){var a=n(this).parents(".item-row"),s=e.find(".grid-row.active").data("id"),o=a.data("id"),c=i.find(r.users,function(e,n){return e.id===s}),l=i.find(c.extra.devices,function(e,n){return e.id===o}),u=function(){a.hasClass("assigned")&&(f[a.data("id")]=!0),a.remove();var n=e.find(".detail-devices .list-assigned-items .item-row");n.is(":visible")===!1&&e.find(".detail-devices .list-assigned-items .empty-row").show()};l&&"mobile"===l.type?t.ui.confirm(v.i18n.active().users.confirmMobileUnAssignment.replace("{{variable}}",t.util.formatPhoneNumber(l.mobile.mdn)),u):u()}),e.on("click",".detail-numbers .list-assigned-items .remove-number",function(){var i=n(this),t=i.parents(".item-row");"mobile"!==t.data("type")&&(d.push(t.data("id")),t.slideUp(function(){t.remove(),e.find(".list-assigned-items .item-row").is(":visible")||e.find(".list-assigned-items .empty-row").slideDown(),e.find(".spare-link").removeClass("disabled")}))}),e.on("click",".actions .spare-link:not(.disabled)",function(a){a.preventDefault();var s=(n(this),{accountName:t.apps.auth.currentAccount.name,accountId:v.accountId,ignoreNumbers:n.map(e.find(".item-row"),function(e){return n(e).data("id")}),extraNumbers:d,callback:function(a,s){e.find(".empty-row").hide(),i.each(a,function(a,s){a.isLocal=a.features.indexOf("local")>-1,e.find(".list-assigned-items").append(n(t.template(v,"users-numbersItemRow",{isCnamEnabled:t.util.isNumberFeatureEnabled("cnam"),isE911Enabled:t.util.isNumberFeatureEnabled("e911"),number:a}))),d=i.without(d,a.phoneNumber)}),t.ui.tooltips(e),0==s&&e.find(".spare-link").addClass("disabled")}});t.pub("common.numbers.dialogSpare",s)}),e.on("click",".actions .buy-link",function(a){a.preventDefault(),t.pub("common.buyNumbers",{searchType:n(this).data("type"),callbacks:{success:function(a){t.pub("common.numbers.getListFeatures",function(s){i.each(a,function(i,a){i.viewFeatures=n.extend(!0,{},s),i.phoneNumber=i.id;var r=n(t.template(v,"users-numbersItemRow",{isCnamEnabled:t.util.isNumberFeatureEnabled("cnam"),isE911Enabled:t.util.isNumberFeatureEnabled("e911"),number:i}));t.ui.tooltips(r),e.find(".list-assigned-items .empty-row").hide(),e.find(".list-assigned-items").append(r)})})}}})}),e.on("click",".save-numbers",function(){var i=n(this),a=n.extend(!0,[],l),r=i.parents(".grid-row").find(".grid-cell.name").text(),u=i.parents(".grid-row").data("id");e.find(".item-row").each(function(e,i){var i=n(i),t=i.data("id"),s=i.data("type");"mobile"!==s&&a.push(t)}),a.length>0?v.usersUpdateCallflowNumbers(u,(c||{}).id,a,function(e){var n=function(){s.success(t.template(v,"!"+b.numbersUpdated,{name:r})),v.usersRender({userId:e.owner_id})};o.caller_id.hasOwnProperty("external")&&o.caller_id.external.hasOwnProperty("number")&&e.numbers.indexOf(o.caller_id.external.number)<0?(delete o.caller_id.external.number,v.usersUpdateUser(o,function(){n(),s.info(b.callerIDDeleted)})):n()}):t.ui.alert("warning",v.i18n.active().users.noNumberCallflow)}),t.util.isNumberFeatureEnabled("cnam")&&e.on("click",".callerId-number",function(){var e=n(this).parents(".item-row").first(),i=e.data("id");if(i){var a={phoneNumber:i,callbacks:{success:function(n){"cnam"in n.data&&n.data.cnam.display_name?e.find(".features i.feature-outbound_cnam").addClass("active"):e.find(".features i.feature-outbound_cnam").removeClass("active"),"cnam"in n.data&&n.data.cnam.inbound_lookup?e.find(".features i.feature-inbound_cnam").addClass("active"):e.find(".features i.feature-inbound_cnam").removeClass("active")}}};t.pub("common.callerId.renderPopup",a)}}),t.util.isNumberFeatureEnabled("e911")&&e.on("click",".e911-number",function(){var e=n(this).parents(".item-row").first(),i=e.data("id");if(i){var a={phoneNumber:i,callbacks:{success:function(i){n.isEmptyObject(i.data.dash_e911)?e.find(".features i.feature-dash_e911").removeClass("active"):e.find(".features i.feature-dash_e911").addClass("active")}}};t.pub("common.e911.renderPopup",a)}}),e.on("click",".prepend-number",function(){var e=n(this).parents(".item-row").first(),i=e.data("id");if(i){var a={phoneNumber:i,callbacks:{success:function(n){"prepend"in n.data&&n.data.prepend.enabled?e.find(".features i.feature-prepend").addClass("active"):e.find(".features i.feature-prepend").removeClass("active")}}};t.pub("common.numberPrepend.renderPopup",a)}}),e.on("click",'.feature[data-feature="caller_id"]',function(){v.usersRenderCallerId(o)}),e.on("click",'.feature[data-feature="call_forward"]',function(){if(o.features.indexOf("find_me_follow_me")<0){var e=n.extend(!0,{},o);v.usersGetMainCallflow(e.id,function(n){if(n&&"flow"in n){for(var i=n.flow;"user"!=i.module&&"_"in i.children;)i=i.children._;i.data.timeout<30&&(e.extra.timeoutTooShort=!0)}v.usersRenderCallForward(e)})}else v.usersRenderCallForward(o)}),e.on("click",'.feature[data-feature="hotdesk"]',function(){v.usersRenderHotdesk(o)}),e.on("click",'.feature[data-feature="find_me_follow_me"]',function(){g()}),e.on("click",'.feature[data-feature="call_recording"]',function(){v.usersGetMainCallflow(o.id,function(e){e?v.usersRenderCallRecording({userCallflow:e,currentUser:o}):t.ui.alert("error",v.i18n.active().users.callRecording.noNumber)})}),e.on("click",'.feature[data-feature="music_on_hold"]',function(){v.usersRenderMusicOnHold(o)}),e.on("click",'.feature[data-feature="vm_to_email"]',function(){v.usersListVMBoxesUser(o.id,function(e){o.extra.deleteAfterNotify=!0,e.length>0?v.usersGetVMBox(e[0].id,function(e){o.extra.deleteAfterNotify=e.delete_after_notify,v.usersRenderVMToEmail(o)}):v.usersRenderVMToEmail(o)})}),e.on("click",'.feature[data-feature="conferencing"]',function(){v.usersGetConferenceFeature(o.id,function(e){var n={listConferences:e.listConfNumbers,user:o,conference:e.conference};i.isEmpty(n.listConferences)?t.ui.alert("error",v.i18n.active().users.conferencing.noConfNumbers):v.usersRenderConferencing(n)})}),e.on("click",'.feature[data-feature="faxing"]',function(){t.util.isTrial()?t.ui.alert("warning",v.i18n.active().users.faxing.trialError):t.parallel({numbers:function(e){v.usersListNumbers(function(n){var t={};i.each(n.numbers,function(e,n){e.hasOwnProperty("used_by")&&""!==e.used_by||(t[n]=e)}),e&&e(null,t)})},callflows:function(e){v.usersListCallflowsUser(o.id,function(n){var t;i.each(n,function(e){return"faxing"===e.type?(t=e,!1):void 0}),t?v.callApi({resource:"callflow.get",data:{accountId:v.accountId,callflowId:t.id},success:function(n,i){e&&e(null,n.data)}}):e&&e(null,t)})},account:function(e){v.callApi({resource:"account.get",data:{accountId:v.accountId},success:function(n,i){e(null,n.data)}})}},function(e,n){if(n.user=o,"undefined"!=typeof n.callflows){var i=n.callflows.flow.data.hasOwnProperty("faxbox_id")?n.callflows.flow.data.faxbox_id:n.callflows.flow.data.id;v.callApi({resource:"faxbox.get",data:{accountId:v.accountId,faxboxId:i},success:function(e){n.faxbox=e.data,n.faxbox.id=i,v.usersRenderFaxboxes(n)},error:function(){v.usersRenderFaxboxes(n)}})}else v.usersRenderFaxboxes(n)})}),n("body").on("click","#users_container_overlay",function(){e.find(".edit-user").slideUp("400",function(){n(this).empty()}),v.usersRemoveOverlay(),e.find(".grid-cell.active").css({position:"inline-block","z-index":"0"}),e.find(".grid-row.active").parent().siblings(".edit-user").css({position:"block","z-index":"0"}),e.find(".grid-cell.active").removeClass("active"),e.find(".grid-row.active").removeClass("active")})},usersUpdatePresenceIDPopup:function(e,i,a){var s=this,r={numbers:e},o=n(t.template(s,"users-changePresenceIDPopup",r)),c=o.find(".presence-id-option");c.on("click",function(){c.removeClass("active"),n(this).addClass("active")}),o.find(".save-presence-id").on("click",function(){var e=o.find(".presence-id-option.active").data("number");"none"!==e?i.presence_id=e+"":delete i.presence_id,l.dialog("close").remove(),a&&a(i)}),o.find(".cancel-link").on("click",function(){l.dialog("close").remove()});var l=t.ui.dialog(o,{title:s.i18n.active().users.presenceIDPopup.title,position:["center",20]})},usersHasProperPresenceId:function(e,n){if(n.presence_id){var t=!1,a=""+n.presence_id;return i.each(e,function(e){e===a&&(t=!0)}),t}return e.length?!1:!0},usersFormatAddUser:function(e){var n={sendToSameEmail:!0,nextExtension:"",listExtensions:{},listVMBoxes:{}},a=[],s=[],r=[];return i.each(e.callflows,function(e){i.each(e.numbers,function(i){i.length<7&&(n.listExtensions[i]=e,a.push(i))})}),i.each(e.vmboxes,function(e){n.listVMBoxes[e.mailbox]=e,s.push(e.mailbox)}),r=a.concat(s),n.nextExtension=parseInt(t.util.getNextExtension(r))+"",n},usersFormatFaxingData:function(e){var t=[],a={};return i.each(e.numbers,function(e,n){t.push(n)}),t.sort(function(e,n){return n>e?-1:1}),e.callflows&&e.callflows.numbers.length>0&&(a[e.callflows.numbers[0]]=e.callflows.numbers[0]),i.each(t,function(e,n){a[e]=e}),e.extra=n.extend(!0,{},e.extra,{listNumbers:a}),e},usersRenderConferencing:function(e){var i=this,e=i.usersFormatConferencingData(e),a=n(t.template(i,"users-feature-conferencing",e)),s=a.find(".switch-state"),r=a.find("#conferencing_form");t.ui.validate(r),t.ui.mask(a.find("#pin"),"extension"),a.find(".cancel-link").on("click",function(){o.dialog("close").remove()}),s.on("change",function(){n(this).prop("checked")?a.find(".content").slideDown():a.find(".content").slideUp()}),a.find(".save").on("click",function(){var n={openedTab:"features",callback:function(){o.dialog("close").remove()}};t.ui.valid(r)&&(e.conference=t.ui.getFormData("conferencing_form"),s.prop("checked")?i.usersUpdateConferencing(e,function(e){n.userId=e.user.id,i.usersRender(n)}):i.usersDeleteConferencing(e.user.id,function(){n.userId=e.user.id,i.usersRender(n)}))});var o=t.ui.dialog(a,{title:e.user.extra.mapFeatures.conferencing.title,position:["center",20]})},usersFormatConferencingData:function(e){return e},usersRenderFaxboxes:function(e){var a=this,e=a.usersFormatFaxingData(e),s=n(t.template(a,"users-feature-faxing",e)),r=(s.find(".number-mirror"),s.find(".switch-state")),o=t.ui.dialog(s,{title:e.user.extra.mapFeatures.faxing.title,position:["center",20]});r.on("change",function(){n(this).prop("checked")?s.find(".content").slideDown():s.find(".content").slideUp()}),t.pub("common.numberSelector.render",{container:s.find(".number-select"),inputName:"caller_id",number:e.hasOwnProperty("faxbox")?e.faxbox.caller_id:void 0,removeCallback:function(){s.find(".number-mirror").text(a.i18n.active().users.faxing.emailToFax["default"])},globalAddNumberCallback:function(e,n){var t=i.isObject(e)?Object.keys(e)[0]:e;n&&n(t),s.find(".number-mirror").text(t)}}),s.find("#helper_content").on("shown",function(){n(this).siblings("a").find(".text").text(a.i18n.active().users.faxing.emailToFax.help.hideHelp),n(this).find("#destination_number").focus()}),s.find("#helper_content").on("hidden",function(){n(this).siblings("a").find(".text").text(a.i18n.active().users.faxing.emailToFax.help.showHelp)}),s.find(".cancel-link").on("click",function(){o.dialog("close").remove()}),s.find(".save").on("click",function(){var n=s.find('input[name="caller_id"]').val(),i={openedTab:"features",callback:function(){o.dialog("close").remove()}};r.prop("checked")?""!==n?a.usersUpdateFaxing(e,n,function(e){i.userId=e.callflow.owner_id,a.usersRender(i)}):t.ui.alert("error",a.i18n.active().users.faxing.toastr.error.numberMissing):a.usersDeleteFaxing(e.user.id,function(){i.userId=e.user.id,a.usersRender(i)})})},usersRenderHotdesk:function(e){var i=this,a=n(t.template(i,"users-feature-hotdesk",e)),s=a.find(".switch-state"),r=a.find('[name="require_pin"]'),o=a.find("#hotdesk_form");t.ui.validate(o),a.find(".cancel-link").on("click",function(){c.dialog("close").remove()}),s.on("change",function(){n(this).prop("checked")?a.find(".content").slideDown():a.find(".content").slideUp()}),r.on("change",function(){r.is(":checked")?a.find("#pin").removeAttr("disabled","disabled").focus():a.find("#pin").val("").attr("disabled","disabled")}),a.find(".save").on("click",function(){if(t.ui.valid(o)){var a=t.ui.getFormData("hotdesk_form"),r={openedTab:"features",callback:function(){c.dialog("close").remove()}};a.enabled=s.prop("checked"),a.require_pin===!1&&delete a.pin,delete e.hotdesk,userToSave=n.extend(!0,{},e,{hotdesk:a}),i.usersUpdateUser(userToSave,function(e){r.userId=e.data.id,i.usersRender(r)})}});var c=t.ui.dialog(a,{title:e.extra.mapFeatures.hotdesk.title,position:["center",20]})},usersRenderVMToEmail:function(e){var a=this,s=n(t.template(a,"users-feature-vm_to_email",e)),r=s.find(".switch-state"),o=s.find("#vm_to_email_form");t.ui.validate(o),s.find(".cancel-link").on("click",function(){c.dialog("close").remove()}),r.on("change",function(){n(this).prop("checked")?s.find(".content").slideDown():s.find(".content").slideUp()}),s.find(".save").on("click",function(){var s=t.ui.getFormData("vm_to_email_form"),l=n.extend(!0,{},e),u=r.prop("checked"),d={callback:function(){c.dialog("close").remove()},openedTab:"features"},f=function(e){a.usersUpdateUser(e,function(e){d.userId=e.data.id,a.usersRender(d)})},m=function(e,n,s){a.usersListVMBoxesUser(n,function(n){var r=[];i.each(n,function(n){r.push(function(i){a.usersGetVMBox(n.id,function(n){n.delete_after_notify!==e?(n.delete_after_notify=e,a.usersUpdateVMBox(n,function(e){i(null,e)})):i(null,n)})})}),t.parallel(r,function(e,n){s&&s(n)})})};l.vm_to_email_enabled=u,u===!0?t.ui.valid(o)&&(l.email=s.email,m(s.delete_after_notify,l.id,function(){f(l)})):f(l)});var c=t.ui.dialog(s,{title:e.extra.mapFeatures.vm_to_email.title,position:["center",20]})},usersRenderCallerId:function(e){var i=this,a=n(t.template(i,"users-feature-caller_id",e)),s=a.find(".switch-state");if(a.find(".cancel-link").on("click",function(){r.dialog("close").remove()}),s.on("change",function(){n(this).prop("checked")?a.find(".content").slideDown():a.find(".content").slideUp()}),a.find(".save").on("click",function(){var t=a.find(".switch-state"),s=n.extend(!0,{},{caller_id:{external:{}}},e),o={openedTab:"features",callback:function(){r.dialog("close").remove()}};if(t.prop("checked")){var c=a.find(".caller-id-select").val();s.caller_id.external.number=c}else s.caller_id.hasOwnProperty("external")&&delete s.caller_id.external.number;i.usersUpdateUser(s,function(e){o.userId=e.data.id,i.usersRender(o)})}),e.extra.listCallerId.length>0)var r=t.ui.dialog(a,{title:e.extra.mapFeatures.caller_id.title,position:["center",20]});else t.ui.alert("error",i.i18n.active().users.errorCallerId)},usersRenderCallForward:function(e){var i=this,a=n(t.template(i,"users-feature-call_forward",e)),s=a.find(".switch-state"),r=a.find("#call_forward_form"),o={callback:function(){l.dialog("close").remove()},openedTab:"features"},c=a.find(".help-box.red-box");
t.ui.mask(a.find("#number"),"phoneNumber"),e.hasOwnProperty("call_forward")&&e.call_forward.require_keypress&&c.hide(),t.ui.validate(r),a.find('input[name="require_keypress"]').on("change",function(){c.toggle()}),a.find(".cancel-link").on("click",function(){l.dialog("close").remove()}),s.on("change",function(){n(this).prop("checked")?a.find(".content").slideDown():a.find(".content").slideUp()}),a.find(".save").on("click",function(){if(t.ui.valid(r)){var a=t.ui.getFormData("call_forward_form");a.require_keypress=!a.require_keypress,a.enabled=s.prop("checked"),a.number=t.util.unformatPhoneNumber(a.number,"keepPlus"),delete a.phoneType;var l=n.extend(!0,{},e,{call_forward:a});c.is(":visible")&&(o.openedTab="name"),i.usersUpdateUser(l,function(e){o.userId=e.data.id,i.usersRender(o)})}}),e.hasOwnProperty("call_forward")&&e.call_forward.number&&/^(\+1)/.test(e.call_forward.number)?a.find("#phoneType").val("mobile"):a.find("#phoneType").val("deskphone");var l=t.ui.dialog(a,{title:e.extra.mapFeatures.call_forward.title,position:["center",20]})},usersRenderFindMeFollowMe:function(e){var a=this;if(e.userCallflow)if(e.userDevices&&0!==e.userDevices.length){for(var s=e.currentUser,r=e.userCallflow,o=n(t.template(a,"users-feature-find_me_follow_me",{currentUser:s})),c=o.find(".switch-state"),l=o.find("#find_me_follow_me_form"),u={callback:function(){m.dialog("close").remove()},openedTab:"features"},d={},f=r.flow;f.hasOwnProperty("module")&&["ring_group","user"].indexOf(f.module)<0;)f=f.children._;endpoints="ring_group"===f.module?f.data.endpoints:[],i.each(e.userDevices,function(e){d[e.id]=e}),endpoints=n.map(endpoints,function(e){if(d[e.id]){var n=d[e.id];return delete d[e.id],{id:e.id,delay:e.delay,timeout:e.timeout,name:n.name,icon:a.deviceIcons[n.device_type],disabled:!1}}}),i.each(d,function(e){endpoints.push({id:e.id,delay:0,timeout:0,name:e.name,icon:a.deviceIcons[e.device_type],disabled:!0})}),t.pub("common.ringingDurationControl.render",{container:l,endpoints:endpoints,hasDisableColumn:!0}),o.find(".cancel-link").on("click",function(){m.dialog("close").remove()}),c.on("change",function(){n(this).prop("checked")?o.find(".content").slideDown():o.find(".content").slideUp()}),o.find(".save").on("click",function(){var n=c.prop("checked");t.pub("common.ringingDurationControl.getEndpoints",{container:l,callback:function(o){s.smartpbx=s.smartpbx||{},s.smartpbx.find_me_follow_me=s.smartpbx.find_me_follow_me||{},s.smartpbx.find_me_follow_me.enabled=n&&o.length>0;var c={};n&&o.length>0?(c.module="ring_group",c.data={strategy:"simultaneous",timeout:20,endpoints:[]},i.each(o,function(e){c.data.endpoints.push({id:e.id,endpoint_type:"device",delay:e.delay,timeout:e.timeout}),e.delay+e.timeout>c.data.timeout&&(c.data.timeout=e.delay+e.timeout)})):(c.module="user",c.data={can_call_self:!1,id:s.id,timeout:20});for(var l=r.flow;l.hasOwnProperty("module")&&["ring_group","user"].indexOf(l.module)<0;)l=l.children._;l.module=c.module,l.data=c.data,t.parallel({callflow:function(e){a.usersUpdateCallflow(r,function(n){e&&e(null,n.data)})},user:function(e){a.usersUpdateUser(s,function(n){e&&e(null,n.data)})}},function(n,i){u.userId=i.user.id,"function"==typeof e.saveCallback?e.saveCallback(u):a.usersRender(u)})}})});var m=t.ui.dialog(o,{title:s.extra.mapFeatures.find_me_follow_me.title,position:["center",20]})}else t.ui.alert("error",a.i18n.active().users.find_me_follow_me.noDevice);else t.ui.alert("error",a.i18n.active().users.find_me_follow_me.noNumber)},usersRenderCallRecording:function(e){var i,a=this,s=n.extend(!0,{user:e.currentUser},e.currentUser.extra.mapFeatures.call_recording.active?{url:e.userCallflow.flow.data.url,format:e.userCallflow.flow.data.format,timeLimit:e.userCallflow.flow.data.time_limit}:{}),r=n(t.template(a,"users-feature-call_recording",s)),o=r.find(".switch-state"),c=r.find("#call_recording_form");t.ui.validate(c,{rules:{time_limit:{digits:!0}}}),r.find(".cancel-link").on("click",function(){i.dialog("close").remove()}),o.on("change",function(){n(this).prop("checked")?r.find(".content").slideDown():r.find(".content").slideUp()}),r.find(".save").on("click",function(){if(t.ui.valid(c)){var s=t.ui.getFormData("call_recording_form"),r=o.prop("checked");if("smartpbx"in e.currentUser||(e.currentUser.smartpbx={}),"call_recording"in e.currentUser.smartpbx||(e.currentUser.smartpbx.call_recording={enabled:!1}),e.currentUser.smartpbx.call_recording.enabled||r){e.currentUser.smartpbx.call_recording.enabled=r;var l=n.extend(!0,{},e.userCallflow);if(r)if("record_call"===l.flow.module)l.flow.data=n.extend(!0,{action:"start"},s);else{l.flow={children:{_:n.extend(!0,{},e.userCallflow.flow)},module:"record_call",data:n.extend(!0,{action:"start"},s)};for(var u=l.flow;u.children&&"_"in u.children&&("record_call"!==u.children._.module||"stop"!==u.children._.data.action);){if("voicemail"===u.children._.module){var d=n.extend(!0,{},u.children._);u.children._={module:"record_call",data:{action:"stop"},children:{_:d}};break}u=u.children._}}else{l.flow=n.extend(!0,{},e.userCallflow.flow.children._);for(var u=l.flow;u.children&&"_"in u.children;){if("record_call"===u.children._.module){u.children=u.children._.children;break}u=u.children._}}a.usersUpdateCallflow(l,function(n){a.usersUpdateUser(e.currentUser,function(n){i.dialog("close").remove(),a.usersRender({userId:e.currentUser.id,openedTab:"features"})})})}else i.dialog("close").remove(),a.usersRender({userId:e.currentUser.id,openedTab:"features"})}}),i=t.ui.dialog(r,{title:e.currentUser.extra.mapFeatures.call_recording.title,position:["center",20]})},usersRenderMusicOnHold:function(e){var i=this,a="silence_stream://300000",s=void 0;i.usersListMedias(function(r){var o,c={user:e,silenceMedia:a,mediaList:r,media:"music_on_hold"in e&&"media_id"in e.music_on_hold?e.music_on_hold.media_id:a},l=n(t.template(i,"users-feature-music_on_hold",c)),u=l.find(".switch-state"),d=function(e){if(s=void 0,l.find(".upload-div input").val(""),l.find(".upload-div").slideUp(function(){l.find(".upload-toggle").removeClass("active")}),e){var n=l.find(".media-dropdown");n.append('<option value="'+e.id+'">'+e.name+"</option>"),n.val(e.id)}};l.find(".upload-input").fileUpload({inputOnly:!0,wrapperClass:"file-upload input-append",btnText:i.i18n.active().users.music_on_hold.audioUploadButton,btnClass:"monster-button",maxSize:5,success:function(e){s=e[0]},error:function(e){e.hasOwnProperty("size")&&e.size.length>0&&t.ui.alert(i.i18n.active().users.music_on_hold.fileTooBigAlert),l.find(".upload-div input").val(""),s=void 0}}),l.find(".cancel-link").on("click",function(){o.dialog("close").remove()}),u.on("change",function(){n(this).prop("checked")?l.find(".content").slideDown():l.find(".content").slideUp()}),l.find(".upload-toggle").on("click",function(){n(this).hasClass("active")?l.find(".upload-div").stop(!0,!0).slideUp():l.find(".upload-div").stop(!0,!0).slideDown()}),l.find(".upload-cancel").on("click",function(){d()}),l.find(".upload-submit").on("click",function(){s?i.callApi({resource:"media.create",data:{accountId:i.accountId,data:{streamable:!0,name:s.name,media_source:"upload",description:s.name}},success:function(e,n){var t=e.data;i.callApi({resource:"media.upload",data:{accountId:i.accountId,mediaId:t.id,data:s.file},success:function(e,n){d(t)},error:function(e,n){i.callApi({resource:"media.delete",data:{accountId:i.accountId,mediaId:t.id,data:{}},success:function(e,n){}})}})}}):t.ui.alert(i.i18n.active().users.music_on_hold.emptyUploadAlert)}),l.find(".save").on("click",function(){var n=l.find(".media-dropdown option:selected").val(),t=u.prop("checked");"music_on_hold"in e||(e.music_on_hold={}),"media_id"in e.music_on_hold||t?(t?e.music_on_hold={media_id:n}:e.music_on_hold={},i.usersUpdateUser(e,function(n){o.dialog("close").remove(),i.usersRender({userId:e.id,openedTab:"features"})})):(o.dialog("close").remove(),i.usersRender({userId:e.id,openedTab:"features"}))}),o=t.ui.dialog(l,{title:e.extra.mapFeatures.music_on_hold.title,position:["center",20]})})},usersCleanUserData:function(e){var e=n.extend(!0,{},e),i=e.first_name+" "+e.last_name,t=i.substring(0,15),a={caller_id:{internal:{name:t}}};return e=n.extend(!0,e,a),e.extra&&(e.extra.includeInDirectory===!1?"directories"in e&&e.extra.mainDirectoryId&&e.extra.mainDirectoryId in e.directories&&delete e.directories[e.extra.mainDirectoryId]:(e.directories=e.directories||{},e.extra.mainCallflowId&&(e.directories[e.extra.mainDirectoryId]=e.extra.mainCallflowId)),"differentEmail"in e.extra&&e.extra.differentEmail?"email"in e.extra&&(e.email=e.extra.email):e.email=e.username,"language"in e.extra&&("auto"!==e.extra.language?e.language=e.extra.language:delete e.language)),e.hasOwnProperty("call_forward")&&""===e.call_forward.number&&delete e.call_forward.number,e.hasOwnProperty("presence_id")&&"unset"!==e.presence_id&&e.presence_id?e.caller_id.internal.number=e.presence_id+"":(delete e.presence_id,e.caller_id.hasOwnProperty("internal")&&delete e.caller_id.internal.number),"inherit"===e.timezone&&delete e.timezone,delete e.include_directory,delete e.features,delete e.extra,delete e[""],e},usersGetTemplate:function(e,n,i,t){var a=this;"name"===e?a.usersGetNameTemplate(n,i,t):"numbers"===e?a.usersGetNumbersTemplate(n,t):"extensions"===e?a.usersGetExtensionsTemplate(n,t):"features"===e?a.usersGetFeaturesTemplate(n,i,t):"devices"===e&&a.usersGetDevicesTemplate(n,t)},usersGetFeaturesTemplate:function(e,a,s){var r=this;r.usersGetUser(e,function(e){i.each(a.users,function(i){i.id===e.id&&(e=n.extend(!0,e,i))});var o=r.usersFormatUserData(e);template=n(t.template(r,"users-features",o)),s&&s(template,o)})},usersGetNameTemplate:function(e,s,r){var o=this;t.parallel({mainCallflow:function(n){o.usersGetMainCallflow(e,function(e){n(null,e)})},mainDirectory:function(e){o.usersGetMainDirectory(function(n){e(null,n)})},user:function(n){o.usersGetUser(e,function(e){n(null,e)})},vmboxes:function(n){o.usersListVMBoxes(function(t){var a,s={listExisting:[],userVM:{}};i.each(t,function(n){s.listExisting.push(n.mailbox),n.owner_id!==e||a||(a=n.id)}),a?o.usersGetVMBox(a,function(e){s.userVM=e,n(null,s)}):n(null,s)})}},function(e,c){var l=c.user;i.each(s.users,function(e){return e.id===c.user.id?(l=n.extend(!0,e,l),!1):void 0});var u=o.usersFormatUserData(l,c.mainDirectory,c.mainCallflow,c.vmboxes.userVM,c.vmboxes.listExisting);template=n(t.template(o,"users-name",u)),t.ui.validate(template.find("form.user-fields"),{rules:{"extra.ringingTimeout":{digits:!0}},messages:{first_name:{required:o.i18n.active().validation.required},last_name:{required:o.i18n.active().validation.required}}}),a.populateDropdown(template.find("#user_timezone"),u.timezone||"inherit",{inherit:o.i18n.active().defaultTimezone}),t.ui.tooltips(template,{options:{container:"body"}}),r&&r(template,u)})},usersGetDevicesData:function(e){var n=this;n.callApi({resource:"device.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(n){e&&e(n.data)}})},usersGetNumbersData:function(e,i,a){var s=this,r={user:function(n){s.usersGetUser(e,function(e){n&&n(null,e)})},callflow:function(i){var t={};s.usersListCallflows(function(a){t.list=a;var r;n.each(a,function(n,i){return i.owner_id===e&&"mainUserCallflow"===i.type?(r=i.id,!1):void 0}),r?s.callApi({resource:"callflow.get",data:{accountId:s.accountId,callflowId:r},success:function(e){t.userCallflow=e.data,i&&i(null,t)}}):i&&i(null,t)})},numbers:function(e){s.usersListNumbers(function(n){e&&e(null,n)})}};a&&(r.devices=function(n){s.usersListDeviceUser(e,function(e){n&&n(null,e)})}),t.parallel(r,function(e,n){i&&i(n)})},usersGetNumbersTemplate:function(e,i){var a=this;a.usersGetNumbersData(e,function(s){a.usersFormatNumbersData(e,s,function(e){template=n(t.template(a,"users-numbers",n.extend(!0,{},e,{isCnamEnabled:t.util.isNumberFeatureEnabled("cnam"),isE911Enabled:t.util.isNumberFeatureEnabled("e911")}))),i&&i(template,e)})},!0)},usersGetDevicesTemplate:function(e,i){var a=this;a.usersGetDevicesData(function(s){var s=a.usersFormatDevicesData(e,s);template=n(t.template(a,"users-devices",s)),i&&i(template,s)})},usersGetExtensionsTemplate:function(e,i){var a=this;a.usersGetNumbersData(e,function(s){a.usersFormatNumbersData(e,s,function(e){template=n(t.template(a,"users-extensions",e)),i&&i(template,e)})})},usersFormatDevicesData:function(e,n){var t={countSpare:0,assignedDevices:{},unassignedDevices:{}};return i.each(n,function(n){n.owner_id===e?t.assignedDevices[n.id]=n:""!==n.owner_id&&"owner_id"in n||(t.countSpare++,t.unassignedDevices[n.id]=n)}),t.emptyAssigned=i.isEmpty(t.assignedDevices),t.emptySpare=i.isEmpty(t.unassignedDevices),t},usersFormatNumbersData:function(e,a,s){var r={countSpare:0,assignedNumbers:[],unassignedNumbers:{},callflow:a.callflow.userCallflow,extensions:[],user:a.user||{}};a.hasOwnProperty("devices")&&a.devices.length&&i.each(a.devices,function(e,n){"mobile"===e.device_type&&(a.numbers.numbers[e.mobile.mdn]={assigned_to:r.user.id,features:["mobile"],isLocal:!1,phoneNumber:e.mobile.mdn,state:"in_service",used_by:"mobile"})}),t.pub("common.numbers.getListFeatures",function(e){"numbers"in a.numbers&&i.each(a.numbers.numbers,function(t,a){t.viewFeatures=n.extend(!0,{},e),t.localityEnabled="locality"in t?!0:!1,i.each(t.features,function(e){e in t.viewFeatures&&(t.viewFeatures[e].active="active")}),t.hasOwnProperty("used_by")&&""!==t.used_by?"mobile"===t.used_by&&r.assignedNumbers.push(t):(r.countSpare++,r.unassignedNumbers[a]=t)}),r.callflow&&i.each(r.callflow.numbers,function(e){if(e in a.numbers.numbers){var n=a.numbers.numbers[e];n.phoneNumber=e,n.isLocal=n.features.indexOf("local")>-1,r.assignedNumbers.push(n)}else r.extensions.push(e)}),r.assignedNumbers=t.util.sort(r.assignedNumbers,"phoneNumber"),r.allExtensions=[],i.each(a.callflow.list,function(e){i.each(e.numbers,function(e){e in a.numbers.numbers||i.isNaN(parseInt(e))||r.allExtensions.push(e)})}),r.allExtensions.sort(function(e,n){var i=parseInt(e),t=parseInt(n),a=-1;return i>0&&t>0&&(a=i>t),a}),r.emptyAssigned=i.isEmpty(r.assignedNumbers),r.emptySpare=i.isEmpty(r.unassignedNumbers),r.emptyExtensions=i.isEmpty(r.extensions),s&&s(r)})},usersFormatCreationData:function(e,i){var t=e.user.first_name+" "+e.user.last_name,a=t.substring(0,15),s={user:n.extend(!0,{},{caller_id:{internal:{name:a,number:e.callflow.extension}},presence_id:e.callflow.extension,email:e.extra.differentEmail?e.extra.email:e.user.username,priv_level:"user"},e.user),vmbox:{mailbox:e.callflow.extension,name:t+"'s VMBox"},callflow:{contact_list:{exclude:!1},flow:{children:{_:{children:{},data:{},module:"voicemail"}},data:{can_call_self:!1,timeout:20},module:"user"},name:t+" SmartPBX's Callflow",numbers:[(e.callflow||{}).extension]},extra:e.extra};return s},usersDelete:function(e,a,s){var r=this;t.parallel({devices:function(n){r.usersListDeviceUser(e,function(e){n(null,e)})},vmbox:function(n){r.usersListVMBoxesUser(e,function(e){n(null,e)})},callflows:function(n){r.usersListCallflowsUser(e,function(e){n(null,e)})}},function(o,c){var l=[];i.each(c.devices,function(e){l.push(function(n){a?r.usersDeleteDevice(e.id,function(e){n(null,"")}):r.usersUnassignDevice(e.id,function(e){n(null,"")})})}),i.each(c.callflows,function(e){"mobile"===e.type?l.push(function(i){t.parallel({callflow:function(n){r.usersGetCallflow(e.id,function(e){n(null,e)})},mobileDevice:function(n){r.usersGetMobileDevice(e.numbers[0].slice(2),function(e){n(null,e)})}},function(e,t){var a=t.callflow,s=t.mobileDevice.id;delete a.owner_id,n.extend(!0,a,{flow:{module:"device",data:{id:s}}}),r.usersUpdateCallflow(a,function(e){i(null,e)})})}):l.push(function(n){r.usersDeleteCallflow(e.id,function(e){n(null,"")})})}),i.each(c.vmbox,function(e){l.push(function(n){r.usersDeleteVMBox(e.id,function(e){n(null,"")})})}),t.parallel(l,function(n,i){r.usersDeleteUser(e,function(e){s&&s(e)})})})},usersGetCallflow:function(e,n){var i=this;i.callApi({resource:"callflow.get",data:{accountId:i.accountId,callflowId:e},success:function(e,i){n(e.data)}})},usersGetMobileDevice:function(e,n){var i=this;i.callApi({resource:"device.list",data:{accountId:i.accountId,data:{filters:{"filter_mobile.mdn":e}}},success:function(e,i){n(e.data)}})},usersDeleteUser:function(e,n){var i=this;i.callApi({resource:"user.delete",data:{userId:e,accountId:i.accountId,data:{}},success:function(e){n(e.data)}})},usersDeleteVMBox:function(e,n){var i=this;i.callApi({resource:"voicemail.delete",data:{voicemailId:e,accountId:i.accountId,data:{}},success:function(e){n(e.data)}})},usersUnassignDevice:function(e,n){var i=this;i.usersGetDevice(e,function(e){delete e.owner_id,i.usersUpdateDevice(e,function(e){n&&n(e)})})},usersDeleteDevice:function(e,n){var i=this;i.callApi({resource:"device.delete",data:{deviceId:e,accountId:i.accountId,data:{}},success:function(e){n(e.data)}})},usersDeleteCallflow:function(e,n){var i=this;i.callApi({resource:"callflow.delete",data:{callflowId:e,accountId:i.accountId,data:{}},success:function(e){n(e.data)}})},usersCreate:function(e,n){var i=this;i.callApi({resource:"user.create",data:{accountId:i.accountId,data:e.user},success:function(t){var a=t.data.id;e.user.id=a,e.vmbox.owner_id=a,i.usersCreateVMBox(e.vmbox,function(s){e.callflow.owner_id=a,e.callflow.type="mainUserCallflow",e.callflow.flow.data.id=a,e.callflow.flow.children._.data.id=s.id,i.usersCreateCallflow(e.callflow,function(a){e.extra.includeInDirectory?i.usersAddUserToMainDirectory(t.data,a.id,function(i){n(e)}):n(e)})})}})},usersMigrateFromExtensions:function(e,n,i){var t=this;t.usersGetUser(e,function(e){e.extra={vmbox:{mailbox:n[0]}};var a=e.first_name+" "+e.last_name,s={contact_list:{exclude:!1},flow:{children:{_:{children:{},data:{},module:"voicemail"}},data:{id:e.id,can_call_self:!1,timeout:20},module:"user"},name:a+" SmartPBX's Callflow",numbers:n,owner_id:e.id,type:"mainUserCallflow"};t.usersSmartUpdateVMBox({user:e,needVMUpdate:!1,callback:function(e){s.flow.children._.data.id=e.id,t.usersCreateCallflow(s,function(e){i&&i(e)},function(e,n){var a=function(){n&&n(e,{generateError:!0})};"400"===e.error&&e.hasOwnProperty("data")&&e.data.hasOwnProperty("numbers")&&e.data.numbers.hasOwnProperty("unique")?t.usersHasKazooUICallflow(s,function(e){t.usersMigrateKazooUIUser(s,e,i)},a):a()},!1)}})})},usersGetCallflowFromNumber:function(e,n){var t=this,a=!1;t.callApi({resource:"callflow.searchByNumber",data:{accountId:t.accountId,value:e},success:function(s){s.data.length>0?(i.each(s.data,function(s){i.each(s.numbers,function(i){i===e&&a===!1&&(a=!0,t.callApi({resource:"callflow.get",data:{accountId:t.accountId,callflowId:s.id},success:function(e){n&&n(e.data)}}))})}),a===!1&&n&&n({})):n&&n({})}})},usersHasKazooUICallflow:function(e,n,a){var s,r=this,o={},c=0;i.each(e.numbers,function(e){o[e]=function(n){r.usersGetCallflowFromNumber(e,function(e){e.hasOwnProperty("ui_metadata")&&e.ui_metadata.hasOwnProperty("ui")&&"monster-ui"===e.ui_metadata.ui||("undefined"!=typeof s?e.id!==s.id&&c++:(c++,s=e)),n&&n(null,{})})}}),t.parallel(o,function(e,i){0===c?a&&a():c>1?t.ui.alert(r.i18n.active().users.migration.tooManyCallflows):n&&n(s)})},usersMigrateKazooUIUser:function(e,n,a){var s=this,r=[];e.numbers=n.numbers,i.each(n.numbers,function(e){r.push("old_"+e+"_r"+t.util.randomString(6))}),n.numbers=r,t.ui.confirm(s.i18n.active().users.migration.confirmMigration,function(){s.usersUpdateCallflow(n,function(n){s.usersCreateCallflow(e,function(e){a&&a(e)})})})},usersAddUserToMainDirectory:function(e,n,i){var t=this;t.usersGetMainDirectory(function(a){e.directories=e.directories||{},e.directories[a.id]=n,t.usersUpdateUser(e,function(e){i&&i(e)})})},usersGetMainCallflow:function(e,n){var t=this;t.usersListCallflowsUser(e,function(a){var s=-1;i.each(a,function(n,i){return(n.owner_id!==e||"mainUserCallflow"!==n.type)&&"type"in n?void 0:(s=i,!1)}),-1===s?n(null):t.callApi({resource:"callflow.get",data:{accountId:t.accountId,callflowId:a[s].id},success:function(e){n(e.data)},error:function(){n(a[s])}})})},usersSearchMobileCallflowsByNumber:function(e,n,i){var t=this;t.callApi({resource:"callflow.searchByNumber",data:{accountId:t.accountId,value:encodeURIComponent("+1"+n),filter_owner_id:e,filter_type:"mobile"},success:function(e){i(e.data[0])}})},usersGetMainDirectory:function(e){var n=this;n.usersListDirectories(function(t){var a=-1;i.each(t,function(e,n){return"SmartPBX Directory"===e.name?(a=n,!1):void 0}),-1===a?n.usersCreateMainDirectory(function(n){e(n)}):e(t[a])})},usersListDirectories:function(e){var n=this;n.callApi({resource:"directory.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(n){e&&e(n.data)}})},usersCreateMainDirectory:function(e){var n=this,i={confirm_match:!1,max_dtmf:0,min_dtmf:3,name:"SmartPBX Directory",sort_by:"last_name"};n.callApi({resource:"directory.create",data:{accountId:n.accountId,data:i},success:function(n){e&&e(n.data)}})},usersListCallflows:function(e){var n=this;n.callApi({resource:"callflow.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(n){e(n.data)}})},usersListCallflowsUser:function(e,n){var i=this;i.callApi({resource:"callflow.list",data:{accountId:i.accountId,filters:{filter_owner_id:e,paginate:"false"}},success:function(e){n(e.data)}})},usersListVMBoxes:function(e){var n=this;n.callApi({resource:"voicemail.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(n){e(n.data)}})},usersListVMBoxesUser:function(e,n){var i=this;i.callApi({resource:"voicemail.list",data:{accountId:i.accountId,filters:{filter_owner_id:e,paginate:"false"}},success:function(e){n(e.data)}})},usersGetVMBox:function(e,n){var i=this;i.callApi({resource:"voicemail.get",data:{accountId:i.accountId,voicemailId:e},success:function(e){n(e.data)}})},usersCreateVMBox:function(e,n){var i=this;i.callApi({resource:"voicemail.create",data:{accountId:i.accountId,data:e},success:function(e){n(e.data)}})},usersUpdateVMBox:function(e,n){var i=this;delete e.timezone,i.callApi({resource:"voicemail.update",data:{accountId:i.accountId,data:e,voicemailId:e.id},success:function(e){n(e.data)}})},usersGetUser:function(e,n){var i=this;i.callApi({resource:"user.get",data:{accountId:i.accountId,userId:e},success:function(e){n&&n(e.data)}})},usersUpdateOriginalUser:function(e,n){var i=this;i.usersUpdateUserAPI(e,n,t.apps.auth.originalAccount.id)},usersUpdateUser:function(e,n){var i=this;e=i.usersCleanUserData(e),i.usersUpdateUserAPI(e,n,i.accountId)},usersUpdateUserAPI:function(e,n,i){var t=this;t.callApi({resource:"user.update",data:{accountId:i,userId:e.id,data:e},success:function(e){n&&n(e)}})},usersGetConferenceFeature:function(e,n){var i=this,a={conference:{},listConfNumbers:[]};t.parallel({confNumbers:function(e){i.usersListConfNumbers(function(n){e&&e(null,n)})},listConferences:function(n){i.usersListConferences(e,function(e){e.length>0?i.usersGetConference(e[0].id,function(e){n&&n(null,e)}):n&&n(null,{})})}},function(e,i){a.conference=i.listConferences,a.listConfNumbers=i.confNumbers,n&&n(a)})},usersListConfNumbers:function(e){var n=this;n.callApi({resource:"callflow.list",data:{accountId:n.accountId,filters:{filter_type:"conference",paginate:"false"}},success:function(n){var t=[];i.each(n.data,function(e){"MainConference"===e.name&&e.numbers.length>0&&"undefinedconf"!==e.numbers[0]&&(t=t.concat(e.numbers))}),e&&e(t)}})},usersListConferences:function(e,n){var i=this;i.callApi({resource:"conference.list",data:{accountId:i.accountId,filters:{filter_owner_id:e,paginate:"false"}},success:function(e){n(e.data)}})},usersGetConference:function(e,n){var i=this;i.callApi({resource:"conference.get",data:{accountId:i.accountId,conferenceId:e},success:function(e){n(e.data)}})},usersUpdateConference:function(e,n){var i=this;i.callApi({resource:"conference.update",data:{accountId:i.accountId,conferenceId:e.id,data:e},success:function(e){n(e.data)}})},usersCreateConference:function(e,n){var i=this;i.callApi({resource:"conference.create",data:{accountId:i.accountId,data:e},success:function(e){n(e.data)}})},usersDeleteConference:function(e,n){var i=this;i.callApi({resource:"conference.delete",data:{accountId:i.accountId,conferenceId:e,data:{}},success:function(e){n(e.data)}})},usersGetDevice:function(e,n){var i=this;i.callApi({resource:"device.get",data:{accountId:i.accountId,deviceId:e},success:function(e){n(e.data)}})},usersUpdateDevice:function(e,n){var i=this;i.callApi({resource:"device.update",data:{accountId:i.accountId,data:e,deviceId:e.id},success:function(e){n(e.data)}})},usersListDeviceUser:function(e,n){var i=this;i.callApi({resource:"device.list",data:{accountId:i.accountId,filters:{filter_owner_id:e,paginate:"false"}},success:function(e){n(e.data)}})},usersListMedias:function(e){var n=this;n.callApi({resource:"media.list",data:{accountId:n.accountId},success:function(n){e(n.data)}})},usersGetData:function(e){var n=this;t.parallel({users:function(e){n.callApi({resource:"user.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(n){e(null,n.data)}})},callflows:function(e){n.usersListCallflows(function(n){e(null,n)})},devices:function(e){n.usersGetDevicesData(function(n){e(null,n)})},deviceStatus:function(e){n.callApi({resource:"device.getStatus",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(n,i){e(null,n.data)}})}},function(n,i){e&&e(i)})},usersUpdateDevices:function(e,a,s){var r=this,o=function(o){var c=[],l=function(e,n){r.usersUpdateDevice(e,function(e){n(null,e)})};if(i.each(e["new"],function(e){c.push(function(i){r.usersGetDevice(e,function(t){t.owner_id=a,"mobile"===t.device_type?r.usersSearchMobileCallflowsByNumber(a,t.mobile.mdn,function(s){r.callApi({resource:"callflow.get",data:{accountId:r.accountId,callflowId:s.id},success:function(s,c){var u=s.data;o?n.extend(!0,u,{owner_id:a,flow:{module:"callflow",data:{id:o.id}}}):n.extend(!0,u,{owner_id:a,flow:{module:"device",data:{id:e}}}),r.usersUpdateCallflow(u,function(){l(t,i)})}})}):l(t,i)})})}),i.each(e.old,function(e){c.push(function(i){r.usersGetDevice(e,function(t){delete t.owner_id,"mobile"===t.device_type?r.usersSearchMobileCallflowsByNumber(a,t.mobile.mdn,function(a){r.callApi({resource:"callflow.get",data:{accountId:r.accountId,callflowId:a.id},success:function(a,s){var o=a.data;delete o.owner_id,n.extend(!0,o,{flow:{module:"device",data:{id:e}}}),r.usersUpdateCallflow(o,function(){l(t,i)})}})}):l(t,i)})})}),e.old.length>0&&o&&"ring_group"===o.flow.module){var u=o.flow.data.endpoints.length;o.flow.data.endpoints=i.filter(o.flow.data.endpoints,function(n){return e.old.indexOf(n.id)<0}),o.flow.data.endpoints.length<u&&(0===o.flow.data.endpoints.length&&(o.flow.module="user",o.flow.data={can_call_self:!1,id:a,timeout:"20"},c.push(function(e){r.usersGetUser(a,function(n){n.smartpbx.find_me_follow_me.enabled=!1,r.usersUpdateUser(n,function(n){e(null,n)})})})),c.push(function(e){r.usersUpdateCallflow(o,function(n){e(null,n)})}))}t.parallel(c,function(e,n){s&&s(n)})};r.usersGetMainCallflow(a,function(e){o(e)})},usersUpdateCallflowNumbers:function(e,n,i,t){var a=this;i.length>0?n?a.callApi({resource:"callflow.get",data:{accountId:a.accountId,callflowId:n},success:function(e){e.data.numbers=i,a.usersUpdateCallflow(e.data,function(e){t&&t(e)})}}):i[0].length<7?a.usersMigrateFromExtensions(e,i,function(e){t&&t(e)}):s.error(a.i18n.active().users.needExtensionFirst):s.error(a.i18n.active().users.noNumberCallflow)},usersListNumbers:function(e){var n=this;n.callApi({resource:"numbers.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(n){e&&e(n.data)}})},usersUpdateCallflow:function(e,n){var i=this;i.callApi({resource:"callflow.update",data:{accountId:i.accountId,callflowId:e.id,data:e},success:function(e){n&&n(e.data)}})},usersCreateCallflow:function(e,n,i,t){var a=this;a.callApi({resource:"callflow.create",data:{accountId:a.accountId,data:e,generateError:t===!1?!1:!0},success:function(e){n&&n(e.data)},error:function(e,n,t){i&&i(e,t)}})},usersSmartUpdateVMBox:function(e){var n=this,i=e.user,t=e.needVMUpdate||!0,a=e.callback,s=e.oldPresenceId||void 0,r=e.userExtension;n.usersListVMBoxesUser(i.id,function(e){if(e.length>0)t?n.usersGetVMBox(e[0].id,function(e){e.name=i.first_name+" "+i.last_name+"'s VMBox",s===e.mailbox&&(e.mailbox=i.presence_id&&"unset"!==i.presence_id?i.presence_id+"":e.mailbox),n.usersUpdateVMBox(e,function(e){a&&a(e)})}):a&&a(e[0]);else{var o={owner_id:i.id,mailbox:i.presence_id||r||i.extra.vmbox.mailbox,name:i.first_name+" "+i.last_name+"'s VMBox"};n.usersCreateVMBox(o,function(e){a&&a(e)})}})},usersUpdateConferencing:function(e,i){var a=this;t.parallel({conference:function(i){var t={name:e.user.first_name+" "+e.user.last_name+" SmartPBX Conference",owner_id:e.user.id,play_name_on_join:!0,member:{numbers:[],join_muted:!1}};t=n.extend(!0,{},t,e.conference),a.usersListConferences(e.user.id,function(e){var s=t;e.length>0?(s=n.extend(!0,{},e[0],t),a.usersUpdateConference(s,function(e){i&&i(null,e)})):a.usersCreateConference(s,function(e){i&&i(null,e)})})},user:function(n){e.user.smartpbx&&e.user.smartpbx.conferencing&&e.user.smartpbx.conferencing.enabled===!0?n&&n(null,e.user):(e.user.smartpbx=e.user.smartpbx||{},e.user.smartpbx.conferencing=e.user.smartpbx.conferencing||{},e.user.smartpbx.conferencing.enabled=!0,a.usersUpdateUser(e.user,function(e){n&&n(null,e.data)}))}},function(e,n){i&&i(n)})},usersUpdateFaxing:function(e,n,a){var s=this;t.parallel({callflow:function(t){var a={};s.usersListCallflowsUser(e.user.id,function(r){i.each(r,function(e){return"faxing"===e.type?(a.id=e.id,!1):void 0}),s.usersUpdateCallflowFaxing(e,n,a,function(e){t&&t(null,e)})})},user:function(n){e.user.smartpbx&&e.user.smartpbx.faxing&&e.user.smartpbx.faxing.enabled===!0?n&&n(null,e.user):(e.user.smartpbx=e.user.smartpbx||{},e.user.smartpbx.faxing=e.user.smartpbx.faxing||{},e.user.smartpbx.faxing.enabled=!0,s.usersUpdateUser(e.user,function(e){n&&n(null,e.data)}))}},function(e,n){a&&a(n)})},usersUpdateCallflowFaxing:function(e,i,a,s){var r=this,o=e.user,c=e.faxbox,l={type:"faxing",owner_id:o.id,numbers:[i],flow:{module:"faxbox",children:{},data:{id:e.hasOwnProperty("faxbox")?c.id:""}}},u={caller_id:i,fax_identity:t.util.formatPhoneNumber(i)};if(a=n.extend(!0,{},l,a),a.hasOwnProperty("id"))c=n.extend(!0,{},c,u),r.callApi({resource:"faxbox.update",data:{accountId:r.accountId,faxboxId:c.id,data:c},success:function(e,n){r.usersUpdateCallflow(a,function(e){s&&s(e)})}});else{var d={name:o.first_name.concat(" ",o.last_name,r.i18n.active().users.faxing.defaultSettings.nameExtension),caller_name:o.first_name.concat(" ",o.last_name),fax_header:t.config.whitelabel.companyName.concat(r.i18n.active().users.faxing.defaultSettings.headerExtension),fax_timezone:o.timezone,owner_id:o.id};c=n.extend(!0,{},d,u),r.callApi({resource:"faxbox.create",data:{accountId:r.accountId,userId:o.id,data:c},success:function(e,n){a.flow.data.id=e.data.id,r.usersCreateCallflow(a,function(e){s&&s(e)})}})}},usersDeleteConferencing:function(e,n){var a=this;t.parallel({conferences:function(n){a.usersListConferences(e,function(e){var s=[];i.each(e,function(e){s.push(function(n){a.usersDeleteConference(e.id,function(e){n(null,e)})})}),t.parallel(s,function(e,i){n&&n(i)})})},user:function(n){a.usersGetUser(e,function(e){e.smartpbx=e.smartpbx||{},e.smartpbx.conferencing=e.smartpbx.conferencing||{},e.smartpbx.conferencing.enabled=!1,a.usersUpdateUser(e,function(e){n(null,e)})})}},function(e,i){n&&n(i)})},usersDeleteFaxing:function(e,n){var a=this;t.parallel({callflows:function(n){a.usersListCallflowsUser(e,function(e){var s=[];i.each(e,function(e){"faxing"===e.type&&s.push(function(n){a.callApi({resource:"callflow.get",data:{accountId:a.accountId,callflowId:e.id},success:function(i,t){a.callApi({resource:"faxbox.delete",data:{accountId:a.accountId,faxboxId:i.data.flow.data.faxbox_id||i.data.flow.data.id,generateError:!1},success:function(i,t){a.usersDeleteCallflow(e.id,function(e){n(null,e)})},error:function(i,t){a.usersDeleteCallflow(e.id,function(e){n(null,e)});
}})}})})}),t.parallel(s,function(e,i){n&&n(i)})})},user:function(n){a.usersGetUser(e,function(e){e.smartpbx=e.smartpbx||{},e.smartpbx.faxing=e.smartpbx.faxing||{},e.smartpbx.faxing.enabled=!1,a.usersUpdateUser(e,function(e){n(null,e)})})}},function(e,i){n&&n(i)})},usersSortExtensions:function(e,n){var i=parseInt(e),t=parseInt(n),a=-1;return i>0&&t>0&&(a=i>t),a},usersRemoveOverlay:function(){n("body").find("#users_container_overlay").remove()}};return r});