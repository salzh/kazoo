define(["require","jquery","underscore","monster","chart"],function(e){var a=e("jquery"),n=e("underscore"),t=e("monster"),i=(e("chart"),{requests:{},subscribe:{"voip.myOffice.render":"myOfficeRender","auth.continueTrial":"myOfficeWalkthroughRender","myaccount.closed":"myOfficeAfterMyaccountClosed"},chartColors:["#B588B9","#698BF7","#009AD6","#6CC5E9","#719B11","#BDE55F","#F1E87C","#EF8F25","#6F7C7D"],myOfficeRender:function(e){var i=this,c=e.parent||a(".right-content"),o=e.callback;i.myOfficeLoadData(function(e){var r={isCnamEnabled:t.util.isNumberFeatureEnabled("cnam"),account:e.account,totalUsers:e.users.length,totalDevices:e.devices.length,unregisteredDevices:e.devices.length-e.devicesStatus.length,totalNumbers:n.size(e.numbers),totalConferences:e.totalConferences,totalChannels:e.totalChannels,mainNumbers:e.mainNumbers||[],confNumbers:e.confNumbers||[],faxingNumbers:e.faxingNumbers||[],faxNumbers:e.faxNumbers||[],topMessage:e.topMessage,devicesList:n.toArray(e.devicesData).sort(function(e,a){return a.count-e.count}),assignedNumbersList:n.toArray(e.assignedNumbersData).sort(function(e,a){return a.count-e.count}),classifiedNumbers:e.classifiedNumbers,directoryUsers:e.directory.users&&e.directory.users.length||0,directoryLink:e.directoryLink},s=a(t.template(i,"myOffice-layout",r)),u={animateScale:!0,segmentShowStroke:!1,animationSteps:50,animationEasing:"easeOutCirc",percentageInnerCutout:60};new Chart(s.find("#dashboard_devices_chart").get(0).getContext("2d")).Doughnut(e.devicesData.totalCount>0?a.map(e.devicesData,function(e){return"object"==typeof e?{value:e.count,color:e.color}:null}).sort(function(e,a){return a.value-e.value}):[{value:1,color:"#DDD"}],u),new Chart(s.find("#dashboard_assigned_numbers_chart").get(0).getContext("2d")).Doughnut(e.assignedNumbersData.totalCount>0?a.map(e.assignedNumbersData,function(e){return"object"==typeof e?{value:e.count,color:e.color}:null}).sort(function(e,a){return a.value-e.value}):[{value:1,color:"#DDD"}],u),new Chart(s.find("#dashboard_number_types_chart").get(0).getContext("2d")).Doughnut(e.classifiedNumbers.length>0?a.map(e.classifiedNumbers,function(e,a){return"object"==typeof e?{value:e.count,color:e.color}:null}):[{value:1,color:"#DDD"}],u);e.classifiedNumbers.length<=3&&s.find(".number-types-legend").addClass("size-"+e.classifiedNumbers.length),i.myOfficeBindEvents({parent:c,template:s,myOfficeData:e}),c.empty().append(s),i.myOfficeCheckWalkthrough(),o&&o()})},myOfficeCheckWalkthrough:function(){var e=this;t.apps.auth.currentAccount.hasOwnProperty("trial_time_left")||t.pub("myaccount.hasToShowWalkthrough",function(a){a===!1&&e.myOfficeWalkthroughRender()})},myOfficeAfterMyaccountClosed:function(){var e=this;t.apps.auth.currentAccount.hasOwnProperty("trial_time_left")||e.myOfficeWalkthroughRender()},myOfficeCreateMainVMBoxIfMissing:function(e){var a=this;a.myOfficeHasMainVMBox(function(a){e(a)},function(){a.myOfficeCreateMainVMBox(function(a){e(a)})})},myOfficeCreateMainVMBox:function(e){var a=this,n={mailbox:"0",type:"mainVMBox",name:a.i18n.active().myOffice.mainVMBoxName,delete_after_notify:!0};a.callApi({resource:"voicemail.create",data:{accountId:a.accountId,data:n},success:function(a){e&&e(a.data)}})},myOfficeHasMainVMBox:function(e,a){var n=this;n.callApi({resource:"voicemail.list",data:{accountId:n.accountId,filters:{filter_type:"mainVMBox"}},success:function(n){n.data.length>0?e&&e(n[0]):a&&a()}})},myOfficeLoadData:function(e){var a=this;t.parallel({account:function(e){a.callApi({resource:"account.get",data:{accountId:a.accountId},success:function(a){e&&e(null,a.data)}})},mainVoicemailBox:function(e){a.myOfficeCreateMainVMBoxIfMissing(function(a){e(null,a)})},users:function(e){a.callApi({resource:"user.list",data:{accountId:a.accountId,filters:{paginate:"false"}},success:function(a){e&&e(null,a.data)}})},devices:function(e){a.callApi({resource:"device.list",data:{accountId:a.accountId,filters:{paginate:"false"}},success:function(a){e&&e(null,a.data)}})},devicesStatus:function(e){a.callApi({resource:"device.getStatus",data:{accountId:a.accountId,filters:{paginate:"false"}},success:function(a){e&&e(null,a.data)}})},numbers:function(e){a.callApi({resource:"numbers.list",data:{accountId:a.accountId,filters:{paginate:"false"}},success:function(a){e&&e(null,a.data.numbers)}})},numberFeatures:function(e){t.pub("common.numbers.getListFeatures",function(a){e(null,a)})},channels:function(e){a.callApi({resource:"channel.list",data:{accountId:a.accountId,filters:{paginate:"false"}},success:function(a){e&&e(null,a.data)}})},callflows:function(e){a.callApi({resource:"callflow.list",data:{filters:{has_type:"type",paginate:"false"},accountId:a.accountId},success:function(a){e&&e(null,a.data)}})},classifiers:function(e){a.callApi({resource:"numbers.listClassifiers",data:{accountId:a.accountId},success:function(a){e&&e(null,a.data)}})},directory:function(e){a.callApi({resource:"directory.list",data:{accountId:a.accountId},success:function(t,i){var c=n.find(t.data,function(e){return"SmartPBX Directory"===e.name});c?a.callApi({resource:"directory.get",data:{accountId:a.accountId,directoryId:c.id},success:function(a,n){e&&e(null,a.data)},error:function(a,n){e&&e(null,{})}}):e&&e(null,{})},error:function(a,n){e&&e(null,{})}})}},function(n,t){e&&e(a.myOfficeFormatData(t))})},myOfficeFormatData:function(e){var i=this,c={sip_device:{label:i.i18n.active().devices.types.sip_device,count:0,color:i.chartColors[5]},cellphone:{label:i.i18n.active().devices.types.cellphone,count:0,color:i.chartColors[3]},smartphone:{label:i.i18n.active().devices.types.smartphone,count:0,color:i.chartColors[2]},mobile:{label:i.i18n.active().devices.types.mobile,count:0,color:i.chartColors[1]},softphone:{label:i.i18n.active().devices.types.softphone,count:0,color:i.chartColors[0]},landline:{label:i.i18n.active().devices.types.landline,count:0,color:i.chartColors[6]},fax:{label:i.i18n.active().devices.types.fax,count:0,color:i.chartColors[7]},ata:{label:i.i18n.active().devices.types.ata,count:0,color:i.chartColors[8]},sip_uri:{label:i.i18n.active().devices.types.sip_uri,count:0,color:i.chartColors[4]},totalCount:0},o={spare:{label:i.i18n.active().myOffice.numberChartLegend.spare,count:0,color:i.chartColors[8]},assigned:{label:i.i18n.active().myOffice.numberChartLegend.assigned,count:0,color:i.chartColors[3]},totalCount:0},r=0,s=[],u={},l={};n.each(e.numbers,function(a,t){n.find(e.classifiers,function(e,a){return a in u||(u[a]=new RegExp(e.regex)),u[a].test(t)?(a in l?l[a]++:l[a]=1,!0):!1})}),e.classifiedNumbers=n.map(l,function(a,n){return{key:n,label:n in e.classifiers?e.classifiers[n].friendly_name:n,count:a}}).sort(function(e,a){return a.count-e.count});var d=i.chartColors.length;if(e.classifiedNumbers.length>d)for(e.classifiedNumbers[d-1].key="merged_others",e.classifiedNumbers[d-1].label="Others";e.classifiedNumbers.length>d;)e.classifiedNumbers[d-1].count+=e.classifiedNumbers.pop().count;if(n.each(e.classifiedNumbers,function(e,a){e.color=i.chartColors[a]}),n.each(e.devices,function(e){e.device_type in c?(c[e.device_type].count++,c.totalCount++):console.log("Unknown device type: "+e.device_type)}),n.each(e.numbers,function(e){"used_by"in e&&e.used_by.length>0?o.assigned.count++:o.spare.count++,o.totalCount++}),n.each(e.users,function(e){e.features.indexOf("conferencing")>=0&&r++}),n.each(e.callflows,function(t){var i="";"main"===t.type&&"MainCallflow"===t.name?i="mainNumbers":"conference"===t.type&&"MainConference"===t.name?i="confNumbers":"faxing"===t.type&&"MainFaxing"===t.name&&(i="faxingNumbers"),i.length>0&&(i in e||(e[i]=[]),n.each(t.numbers,function(t){if("0"!==t&&"undefined"!==t&&"undefinedconf"!==t&&"undefinedfaxing"!==t){var c={number:t,features:a.extend(!0,{},e.numberFeatures)};t in e.numbers&&n.each(e.numbers[t].features,function(e){c.features[e]=a.extend(!0,c.features[e],{active:"active"})}),e[i].push(c)}}))}),n.each(e.channels,function(e){s.indexOf(e.bridge_id)<0&&s.push(e.bridge_id)}),e.mainNumbers&&e.mainNumbers.length>0){var f=t.util.isNumberFeatureEnabled("cnam")===!1||e.account.hasOwnProperty("caller_id")&&e.account.caller_id.hasOwnProperty("emergency")&&e.account.caller_id.emergency.hasOwnProperty("number")&&e.numbers.hasOwnProperty(e.account.caller_id.emergency.number),m=t.util.isNumberFeatureEnabled("e911")===!1||e.account.hasOwnProperty("caller_id")&&e.account.caller_id.hasOwnProperty("emergency")&&e.account.caller_id.emergency.hasOwnProperty("number")&&e.numbers.hasOwnProperty(e.account.caller_id.emergency.number)&&e.numbers[e.account.caller_id.emergency.number].features.indexOf("dash_e911")>=0;f||m?f?m||(e.topMessage={"class":"btn-danger",message:i.i18n.active().myOffice.missingE911Message}):e.topMessage={"class":"btn-danger",message:i.i18n.active().myOffice.missingCnamMessage}:e.topMessage={"class":"btn-danger",message:i.i18n.active().myOffice.missingCnamE911Message}}return e.totalChannels=s.length,e.devicesData=c,e.assignedNumbersData=o,e.totalConferences=r,e.directory&&e.directory.id&&(e.directoryLink=i.apiUrl+"accounts/"+i.accountId+"/directories/"+e.directory.id+"?accept=pdf&auth_token="+i.authToken),e},myOfficeBindEvents:function(e){var n=this,i=e.parent,c=e.template,o=e.myOfficeData;c.find(".link-box").on("click",function(e){var n=a(this),c=n.data("category"),o=n.data("subcategory");switch(a(".category").removeClass("active"),c){case"users":a(".category#users").addClass("active"),t.pub("voip.users.render",{parent:i});break;case"devices":a(".category#devices").addClass("active"),t.pub("voip.devices.render",{parent:i});break;case"numbers":a(".category#numbers").addClass("active"),t.pub("voip.numbers.render",{parent:i});break;case"strategy":a(".category#strategy").addClass("active"),t.pub("voip.strategy.render",{parent:i,openElement:o})}}),c.find(".header-link.music-on-hold").on("click",function(e){e.preventDefault(),n.myOfficeRenderMusicOnHoldPopup({account:o.account})}),t.util.isNumberFeatureEnabled("cnam")&&c.find(".header-link.caller-id:not(.disabled)").on("click",function(e){e.preventDefault(),n.myOfficeRenderCallerIdPopup({parent:i,myOfficeData:o})}),c.find(".header-link.caller-id.disabled").on("click",function(e){t.ui.alert(n.i18n.active().myOffice.missingMainNumberForCallerId)}),t.ui.tooltips(c)},myOfficeRenderMusicOnHoldPopup:function(e){var n=this,i=e.account,c="silence_stream://300000";n.myOfficeListMedias(function(e){var o={silenceMedia:c,mediaList:e,media:"music_on_hold"in i&&"media_id"in i.music_on_hold?i.music_on_hold.media_id:void 0},r=a(t.template(n,"myOffice-musicOnHoldPopup",o)),s=t.ui.dialog(r,{title:n.i18n.active().myOffice.musicOnHold.title,position:["center",20]});n.myOfficeMusicOnHoldPopupBindEvents({popupTemplate:r,popup:s,account:i})})},myOfficeMusicOnHoldPopupBindEvents:function(e){var n=this,i=e.popupTemplate,c=e.popup,o=e.account,r=function(e){if(mediaToUpload=void 0,i.find(".upload-div input").val(""),i.find(".upload-div").slideUp(function(){i.find(".upload-toggle").removeClass("active")}),e){var a=i.find(".media-dropdown");a.append('<option value="'+e.id+'">'+e.name+"</option>"),a.val(e.id)}};i.find(".upload-input").fileUpload({inputOnly:!0,wrapperClass:"file-upload input-append",btnText:n.i18n.active().myOffice.musicOnHold.audioUploadButton,btnClass:"monster-button",maxSize:5,success:function(e){mediaToUpload=e[0]},error:function(e){e.hasOwnProperty("size")&&e.size.length>0&&t.ui.alert(n.i18n.active().myOffice.musicOnHold.fileTooBigAlert),i.find(".upload-div input").val(""),mediaToUpload=void 0}}),i.find(".cancel-link").on("click",function(){c.dialog("close").remove()}),i.find(".upload-toggle").on("click",function(){a(this).hasClass("active")?i.find(".upload-div").stop(!0,!0).slideUp():i.find(".upload-div").stop(!0,!0).slideDown()}),i.find(".upload-cancel").on("click",function(){r()}),i.find(".upload-submit").on("click",function(){mediaToUpload?n.callApi({resource:"media.create",data:{accountId:n.accountId,data:{streamable:!0,name:mediaToUpload.name,media_source:"upload",description:mediaToUpload.name}},success:function(e,a){var t=e.data;n.callApi({resource:"media.upload",data:{accountId:n.accountId,mediaId:t.id,data:mediaToUpload.file},success:function(e,a){r(t)},error:function(e,a){n.callApi({resource:"media.delete",data:{accountId:n.accountId,mediaId:t.id,data:{}},success:function(e,a){}})}})}}):t.ui.alert(n.i18n.active().myOffice.musicOnHold.emptyUploadAlert)}),i.find(".save").on("click",function(){var e=i.find(".media-dropdown option:selected").val();"music_on_hold"in o||(o.music_on_hold={}),e&&e.length>0?o.music_on_hold={media_id:e}:o.music_on_hold={},n.myOfficeUpdateAccount(o,function(e){c.dialog("close").remove()})})},myOfficeRenderCallerIdPopup:function(e){var n=this,i=e.parent,c=e.myOfficeData,o={isE911Enabled:t.util.isNumberFeatureEnabled("e911"),mainNumbers:c.mainNumbers,selectedMainNumber:"caller_id"in c.account&&"external"in c.account.caller_id?c.account.caller_id.external.number||"none":"none"},r=a(t.template(n,"myOffice-callerIdPopup",o)),s=t.ui.dialog(r,{title:n.i18n.active().myOffice.callerId.title,position:["center",20]});if(t.util.isNumberFeatureEnabled("e911")){var u=r.find(".emergency-form > form");t.ui.validate(u,{messages:{postal_code:{required:"*"},street_address:{required:"*"},locality:{required:"*"},region:{required:"*"}}}),t.ui.valid(u)}n.myOfficeCallerIdPopupBindEvents({parent:i,popupTemplate:r,popup:s,account:c.account})},myOfficeCallerIdPopupBindEvents:function(e){var n=this,i=e.parent,c=e.popupTemplate,o=e.popup,r=e.account,s=c.find(".caller-id-select"),u=c.find(".caller-id-name"),l=c.find(".caller-id-emergency-zipcode"),d=c.find(".caller-id-emergency-address1"),f=c.find(".caller-id-emergency-address2"),m=c.find(".caller-id-emergency-city"),p=c.find(".caller-id-emergency-state"),h=function(e){e&&n.myOfficeGetNumber(e,function(e){"cnam"in e?u.val(e.cnam.display_name):u.val(""),t.util.isNumberFeatureEnabled("e911")&&("dash_e911"in e?(l.val(e.dash_e911.postal_code),d.val(e.dash_e911.street_address),f.val(e.dash_e911.extended_address),m.val(e.dash_e911.locality),p.val(e.dash_e911.region)):(l.val(""),d.val(""),f.val(""),m.val(""),p.val("")))})};c.find(".cancel-link").on("click",function(){o.dialog("close").remove()}),c.find(".upload-cancel").on("click",function(){closeUploadDiv()}),s.on("change",function(){var e=a(this).val();e?(c.find(".number-feature").slideDown(),h(e)):c.find(".number-feature").slideUp()}),l.on("blur",function(){a.getJSON("http://www.geonames.org/postalCodeLookupJSON?&country=US&callback=?",{postalcode:a(this).val()},function(e){e&&e.postalcodes.length&&e.postalcodes[0].placeName&&(m.val(e.postalcodes[0].placeName),p.val(e.postalcodes[0].adminName1))})}),c.find(".save").on("click",function(){var e,l=s.val(),d=function(){n.myOfficeUpdateAccount(r,function(e){o.dialog("close").remove(),n.myOfficeRender({parent:i})})},f=function(e){var t=u.val();r.caller_id=a.extend(!0,{},r.caller_id,{external:{number:l},emergency:{number:l}}),n.myOfficeGetNumber(l,function(i){l?a.extend(!0,i,{cnam:{display_name:t}}):delete i.cnam,e&&a.extend(!0,i,{dash_e911:e}),n.myOfficeUpdateNumber(i,function(e){d()})})};if(t.util.isNumberFeatureEnabled("e911")&&(e=c.find(".emergency-form > form")),l)if(t.util.isNumberFeatureEnabled("e911"))if(t.ui.valid(e)){var m=t.ui.getFormData(e[0]);f(m)}else t.ui.alert(n.i18n.active().myOffice.callerId.mandatoryE911Alert);else f();else delete r.caller_id.external,delete r.caller_id.emergency,d()}),h(s.val())},myOfficeWalkthroughRender:function(){var e=this;e.isActive()&&e.myOfficeHasWalkthrough(function(){e.myOfficeShowWalkthrough(function(){e.myOfficeUpdateWalkthroughFlagUser()})})},myOfficeHasWalkthrough:function(e){var a=this,n=a.uiFlags.user.get("showDashboardWalkthrough");n!==!1&&e&&e()},myOfficeShowWalkthrough:function(e){var n=this,i=a("#voip_container"),c=[{element:i.find(".category#myOffice")[0],intro:n.i18n.active().myOffice.walkthrough.steps[1],position:"right"},{element:i.find(".category#users")[0],intro:n.i18n.active().myOffice.walkthrough.steps[2],position:"right"},{element:i.find(".category#groups")[0],intro:n.i18n.active().myOffice.walkthrough.steps[3],position:"right"},{element:i.find(".category#strategy")[0],intro:n.i18n.active().myOffice.walkthrough.steps[4],position:"right"}];t.ui.stepByStep(c,function(){e&&e()})},myOfficeUpdateWalkthroughFlagUser:function(e){var a=this,n=a.uiFlags.user.set("showDashboardWalkthrough",!1);a.myOfficeUpdateOriginalUser(n,function(a){e&&e(a)})},myOfficeGetNumber:function(e,a,n){var t=this;t.callApi({resource:"numbers.get",data:{accountId:t.accountId,phoneNumber:encodeURIComponent(e)},success:function(e,n){a&&a(e.data)},error:function(e,a){n&&n(e)}})},myOfficeUpdateNumber:function(e,a,n){var t=this;t.callApi({resource:"numbers.update",data:{accountId:t.accountId,phoneNumber:encodeURIComponent(e.id),data:e},success:function(e,n){a&&a(e.data)},error:function(e,a){n&&n(e)}})},myOfficeListMedias:function(e){var a=this;a.callApi({resource:"media.list",data:{accountId:a.accountId,filters:{key_missing:"type"}},success:function(a){e&&e(a.data)}})},myOfficeUpdateAccount:function(e,a){var n=this;delete e.extra,n.callApi({resource:"account.update",data:{accountId:n.accountId,data:e},success:function(e){a&&a(e.data)}})},myOfficeUpdateOriginalUser:function(e,a){var n=this;n.callApi({resource:"user.update",data:{userId:e.id,accountId:t.apps.auth.originalAccount.id,data:e},success:function(e){a&&a(e.data)}})}});return i});