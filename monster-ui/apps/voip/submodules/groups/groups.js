define(["require","jquery","underscore","monster","monster-timezone","toastr"],function(e){var n=e("jquery"),t=e("underscore"),a=e("monster"),o=(e("monster-timezone"),e("toastr")),i={requests:{},subscribe:{"voip.groups.render":"groupsRender"},groupsRender:function(e){var o=this,e=e||{},i=e.parent||n(".right-content"),r=e.groupId,s=e.callback,u=!0;o.groupsRemoveOverlay(),o.groupsGetData(function(e){var l=t.find(e.callflows,function(e){return!e.hasOwnProperty("type")});if(l)a.ui.alert("error",o.i18n.active().groups.outdatedGroupsError);else{var c,d=o.groupsFormatListData(e),p=n(a.template(o,"groups-layout",{countGroups:Object.keys(d.groups).length}));if(t.each(d.groups,function(e){c=a.template(o,"groups-row",e),p.find(".groups-rows").append(c)}),o.groupsBindEvents(p,i),i.empty().append(p),o.groupsCheckWalkthrough(),r){var f=i.find(".grid-row[data-id="+r+"] .grid-cell");a.ui.highlight(f)}for(var g in d.groups)u="undefined"==typeof d.groups[g]?!0:!1;u?(i.find(".grid-row.title").css("display","none"),i.find(".no-groups-row").css("display","block")):(i.find(".grid-row.title").css("display","block"),i.find(".no-groups-row").css("display","none")),s&&s()}})},groupsFormatListData:function(e){var n=this,a={};return t.each(e.groups,function(e){a[e.id]=e,a[e.id].extra=n.groupsGetGroupFeatures(e)}),t.each(e.callflows,function(e){if(e.group_id in a)if("userGroup"===e.type){var n=[],o=[];t.each(e.numbers,function(e){e.length<7?n.push(e):o.push(e)}),a[e.group_id].extra.listCallerId=[],n.length>0&&(a[e.group_id].extra.extension=n[0],t.each(n,function(n){a[e.group_id].extra.listCallerId.push(n)})),a[e.group_id].extra.additionalExtensions=n.length>1,o.length>0&&(a[e.group_id].extra.mainNumber=o[0],t.each(o,function(n){a[e.group_id].extra.listCallerId.push(n)})),a[e.group_id].extra.additionalNumbers=o.length>1,a[e.group_id].extra.callflowId=e.id}else"baseGroup"===e.type&&(a[e.group_id].extra.baseCallflowId=e.id)}),e.groups=a,e},groupsGetGroupFeatures:function(e){var n=this,a={mapFeatures:{call_recording:{icon:"fa fa-microphone",iconColor:"monster-blue",title:n.i18n.active().groups.callRecording.title},ringback:{icon:"fa fa-music",iconColor:"monster-yellow",title:n.i18n.active().groups.ringback.title},next_action:{icon:"fa fa-arrow-right",iconColor:"monster-green",title:n.i18n.active().groups.nextAction.title},forward:{icon:"fa fa-mail-forward",iconColor:"monster-orange",title:n.i18n.active().groups.forward.title},prepend:{icon:"fa fa-file-text-o",iconColor:"monster-pink",title:n.i18n.active().groups.prepend.title}},hasFeatures:!1};return t.each(a.mapFeatures,function(n,t){("features"in e&&e.features.indexOf(t)>=0||"smartpbx"in e&&t in e.smartpbx&&e.smartpbx[t].enabled)&&(n.active=!0,a.hasFeatures=!0)}),a},groupsBindEvents:function(e,o){var i=this;setTimeout(function(){e.find(".search-query").focus()}),a.ui.tooltips(e,{options:{container:"body"}}),e.find(".grid-row:not(.title) .grid-cell").on("click",function(){var t=n(this),o=t.data("type"),r=t.parents(".grid-row"),s=r.data("id");e.find(".edit-groups").slideUp("400",function(){n(this).empty()}),t.hasClass("active")?(e.find(".grid-cell").removeClass("active"),e.find(".grid-row").removeClass("active"),i.groupsRemoveOverlay(),t.css({position:"inline-block","z-index":"0"}),t.parent().siblings(".edit-groups").css({position:"block","z-index":"0","border-top-color":"#a6a7a9"})):(e.find(".grid-cell").removeClass("active"),e.find(".grid-row").removeClass("active"),t.toggleClass("active"),r.toggleClass("active"),t.css({position:"relative","z-index":"2"}),t.parents(".groups-cells").siblings(".edit-groups").css({position:"relative","z-index":"2","border-top-color":"transparent"}),i.groupsGetTemplate(o,s,function(e,t){a.ui.tooltips(e),r.find(".edit-groups").append(e).slideDown(),n("body").append(n('<div id="groups_container_overlay"></div>'))}))}),e.find(".groups-header .search-query").on("keyup",function(){var a=n(this).val().toLowerCase(),o=e.find(".groups-rows .grid-row:not(.title)"),i=e.find(".groups-rows .empty-search-row");t.each(o,function(e){var t=n(e);t.data("search").toLowerCase().indexOf(a)<0?t.hide():t.show()}),o.size()>0&&(o.is(":visible")?i.hide():i.show())}),e.on("click",".cancel-link",function(){e.find(".edit-groups").slideUp("400",function(){n(this).empty(),e.find(".grid-cell.active").css({position:"inline-block","z-index":"0"}),e.find(".grid-row.active .edit-groups").css({position:"block","z-index":"0"}),e.find(".grid-row.active").removeClass("active"),i.groupsRemoveOverlay(),e.find(".grid-cell.active").removeClass("active")})}),e.find(".groups-header .add-group").on("click",function(){i.groupsGetCreationData(function(e){var o=n(a.template(i,"groups-creation",e)),r=o.find("#form_group_creation");a.ui.validate(r),a.ui.mask(r.find("#inputExtension"),"extension"),o.find("#create_group").on("click",function(){if(a.ui.valid(r)){var n=i.groupsCreationMergeData(e,o);t.isEmpty(n.group.endpoints)?a.ui.alert("warning",i.i18n.active().groups.emptyEndpointsWarning):i.groupsCreate(n,function(e){s.dialog("close").remove(),i.groupsRender({groupId:e.id})})}}),o.find("#group_user_selector .selected-users, #group_user_selector .available-users").sortable({connectWith:".connectedSortable"}).disableSelection();var s=a.ui.dialog(o,{title:i.i18n.active().groups.dialogCreationGroup.title})})}),n("body").on("click","#groups_container_overlay",function(){e.find(".edit-groups").slideUp("400",function(){n(this).empty()}),i.groupsRemoveOverlay(),e.find(".grid-cell.active").css({position:"inline-block","z-index":"0"}),e.find(".grid-row.active").parent().siblings(".edit-groups").css({position:"block","z-index":"0"}),e.find(".grid-cell.active").removeClass("active"),e.find(".grid-row.active").removeClass("active")})},groupsCreationMergeData:function(e,t){var o=a.ui.getFormData("form_group_creation"),i="20",r="0",s={timeout:i,delay:r,endpoint_type:"user"},u=[],l={};t.find(".selected-users li").each(function(){var e=n(this).data("user_id"),t=n.extend(!0,{},s,{id:e});l[e]={type:"user"},u.push(t)});var c={group:{name:o.name,endpoints:l},baseCallflow:{numbers:[a.util.randomString(25)],name:o.name+" Base Group",flow:{module:"ring_group",children:{},data:{strategy:"simultaneous",timeout:parseInt(i)+parseInt(r),endpoints:u}},type:"baseGroup"},callflow:{numbers:[o.extra.extension],name:o.name+" Ring Group",flow:{module:"callflow",children:{_:{module:"play",children:{},data:{id:"system_media/vm-not_available_no_voicemail"}}},data:{id:""}},type:"userGroup"}};return c},groupsGetTemplate:function(e,n,t){var a=this;"name"===e?a.groupsGetNameTemplate(n,t):"numbers"===e?a.groupsGetNumbersTemplate(n,t):"extensions"===e?a.groupsGetExtensionsTemplate(n,t):"features"===e?a.groupsGetFeaturesTemplate(n,t):"members"===e&&a.groupsGetMembersTemplate(n,t)},groupsGetFeaturesTemplate:function(e,t){var o=this;o.groupsGetFeaturesData(e,function(e){template=n(a.template(o,"groups-features",e.group)),o.groupsBindFeatures(template,e),t&&t(template,e)})},groupsGetNameTemplate:function(e,t){var o=this;o.groupsGetNameData(e,function(e){template=n(a.template(o,"groups-name",e)),o.groupsBindName(template,e),t&&t(template,e)})},groupsGetNumbersTemplate:function(e,t){var o=this;o.groupsGetNumbersData(e,function(e){o.groupsFormatNumbersData(e,function(e){template=n(a.template(o,"groups-numbers",n.extend(!0,{},e,{isCnamEnabled:a.util.isNumberFeatureEnabled("cnam"),isE911Enabled:a.util.isNumberFeatureEnabled("e911")}))),o.groupsBindNumbers(template,e),t&&t(template,e)})})},groupsGetExtensionsTemplate:function(e,t){var o=this;o.groupsGetNumbersData(e,function(e){o.groupsFormatNumbersData(e,function(e){template=n(a.template(o,"groups-extensions",e)),o.groupsBindExtensions(template,e),t&&t(template,e)})})},groupsGetMembersTemplate:function(e,t){var o=this;o.groupsGetMembersData(e,function(e){var e=o.groupsFormatMembersData(e);template=n(a.template(o,"groups-members",e)),a.pub("common.ringingDurationControl.render",{container:template.find(".members-container"),endpoints:e.extra.ringGroup,hasRemoveColumn:!0}),o.groupsBindMembers(template,e),t&&t(template,e)})},groupsBindFeatures:function(e,n){var t=this;e.find('.feature[data-feature="call_recording"]').on("click",function(){t.groupsRenderCallRecording(n)}),e.find('.feature[data-feature="ringback"]').on("click",function(){t.groupsRenderRingback(n)}),e.find('.feature[data-feature="next_action"]').on("click",function(){t.groupsRenderNextAction(n)}),e.find('.feature[data-feature="forward"]').on("click",function(){t.groupsRenderForward(n)}),e.find('.feature[data-feature="prepend"]').on("click",function(){t.groupsRenderPrepend(n)})},groupsRenderCallRecording:function(e){var t,o=this,i=a.util.findCallflowNode(e.callflow,"record_call"),r=n.extend(!0,{group:e.group},e.group.extra.mapFeatures.call_recording.active&&i?{url:i.data.url,format:i.data.format,timeLimit:i.data.time_limit}:{}),s=n(a.template(o,"groups-feature-call_recording",r)),u=s.find(".switch-state"),l=s.find("#call_recording_form");a.ui.validate(l,{rules:{time_limit:{digits:!0}}}),s.find(".cancel-link").on("click",function(){t.dialog("close").remove()}),u.on("change",function(){n(this).prop("checked")?s.find(".content").slideDown():s.find(".content").slideUp()}),s.find(".save").on("click",function(){if(a.ui.valid(l)){var i=a.ui.getFormData("call_recording_form"),r=u.prop("checked");if("smartpbx"in e.group||(e.group.smartpbx={}),"call_recording"in e.group.smartpbx||(e.group.smartpbx.call_recording={enabled:!1}),e.group.smartpbx.call_recording.enabled||r){e.group.smartpbx.call_recording.enabled=r;var s=n.extend(!0,{},e.callflow),c=a.util.findCallflowNode(s,"record_call")||a.util.findCallflowNode(s,"callflow");r?"record_call"===c.module?c.data=n.extend(!0,{action:"start"},i):(c.children={_:n.extend(!0,{},c)},c.module="record_call",c.data=n.extend(!0,{action:"start"},i)):"record_call"===c.module&&(c.module=c.children._.module,c.data=c.children._.data,c.children=c.children._.children),o.groupsUpdateCallflow(s,function(n){o.groupsUpdate(e.group,function(n){t.dialog("close").remove(),o.groupsRender({groupId:e.group.id})})})}else t.dialog("close").remove(),o.groupsRender({groupId:e.group.id})}}),t=a.ui.dialog(s,{title:e.group.extra.mapFeatures.call_recording.title,position:["center",20]})},groupsRenderRingback:function(e){for(var t=this,o="silence_stream://300000",i=e.baseCallflow.flow,r=void 0;"ring_group"!==i.module&&"_"in i.children;)i=i.children._;t.groupsListMedias(function(s){var u,l={group:e.group,silenceMedia:o,mediaList:s,media:i.data.ringback||""},c=n(a.template(t,"groups-feature-ringback",l)),d=c.find(".switch-state"),p=function(e){if(r=void 0,c.find(".upload-div input").val(""),c.find(".upload-div").slideUp(function(){c.find(".upload-toggle").removeClass("active")}),e){var n=c.find(".media-dropdown");n.append('<option value="'+e.id+'">'+e.name+"</option>"),n.val(e.id)}};c.find(".upload-input").fileUpload({inputOnly:!0,wrapperClass:"file-upload input-append",btnText:t.i18n.active().groups.ringback.audioUploadButton,btnClass:"monster-button",maxSize:5,success:function(e){r=e[0]},error:function(e){e.hasOwnProperty("size")&&e.size.length>0&&a.ui.alert(t.i18n.active().groups.ringback.fileTooBigAlert),c.find(".upload-div input").val(""),r=void 0}}),c.find(".cancel-link").on("click",function(){u.dialog("close").remove()}),d.on("change",function(){n(this).prop("checked")?c.find(".content").slideDown():c.find(".content").slideUp()}),c.find(".upload-toggle").on("click",function(){n(this).hasClass("active")?c.find(".upload-div").stop(!0,!0).slideUp():c.find(".upload-div").stop(!0,!0).slideDown()}),c.find(".upload-cancel").on("click",function(){p()}),c.find(".upload-submit").on("click",function(){r?t.callApi({resource:"media.create",data:{accountId:t.accountId,data:{streamable:!0,name:r.name,media_source:"upload",description:r.name}},success:function(e,n){var a=e.data;t.callApi({resource:"media.upload",data:{accountId:t.accountId,mediaId:a.id,data:r.file},success:function(e,n){p(a)},error:function(e,n){t.callApi({resource:"media.delete",data:{accountId:t.accountId,mediaId:a.id,data:{}},success:function(e,n){}})}})}}):a.ui.alert(t.i18n.active().groups.ringback.emptyUploadAlert)}),c.find(".save").on("click",function(){var n=c.find(".media-dropdown option:selected").val(),a=d.prop("checked");"smartpbx"in e.group||(e.group.smartpbx={}),a?(i.data.ringback=n,"ringback"in e.group.smartpbx?e.group.smartpbx.ringback.enabled=!0:e.group.smartpbx.ringback={enabled:!0},t.groupsUpdateCallflow(e.baseCallflow,function(){t.groupsUpdate(e.group,function(n){u.dialog("close").remove(),t.groupsRender({groupId:e.group.id})})})):(i.data.ringback||e.group.smartpbx.ringback&&e.group.smartpbx.ringback.enabled)&&(delete i.data.ringback,"ringback"in e.group.smartpbx&&(e.group.smartpbx.ringback.enabled=!1),t.groupsUpdateCallflow(e.baseCallflow,function(){t.groupsUpdate(e.group,function(n){u.dialog("close").remove(),t.groupsRender({groupId:e.group.id})})}))}),u=a.ui.dialog(c,{title:e.group.extra.mapFeatures.ringback.title,position:["center",20]})})},groupsRenderNextAction:function(e){for(var o=this,i=e.callflow.flow,r=null;"callflow"!=i.module;)i=i.children._;"_"in i.children&&(r=i.children._.data.id);var s,u=n.extend(!0,{selectedEntity:r},e),l=n(a.template(o,"groups-feature-next_action",u)),c=l.find(".switch-state");l.find(".cancel-link").on("click",function(){s.dialog("close").remove()}),c.on("change",function(){n(this).prop("checked")?l.find(".content").slideDown():l.find(".content").slideUp()}),l.find(".save").on("click",function(){var i=l.find(".next-action-select option:selected"),r=c.prop("checked");if("smartpbx"in e.group||(e.group.smartpbx={}),"next_action"in e.group.smartpbx||(e.group.smartpbx.next_action={enabled:!1}),e.group.smartpbx.next_action.enabled||r){e.group.smartpbx.next_action.enabled=r;var u=n.extend(!0,{},e.callflow),d=a.util.findCallflowNode(u,"callflow");t.isArray(d)&&(d=d[0]),d.children={},r?d.children._={children:{},module:i.data("module"),data:{id:i.val()}}:d.children._={module:"play",children:{},data:{id:"system_media/vm-not_available_no_voicemail"}},o.groupsUpdateCallflow(u,function(n){o.groupsUpdate(e.group,function(n){s.dialog("close").remove(),o.groupsRender({groupId:e.group.id})})})}else s.dialog("close").remove(),o.groupsRender({groupId:e.group.id})}),s=a.ui.dialog(l,{title:e.group.extra.mapFeatures.next_action.title,position:["center",20]})},groupsRenderForward:function(e){var t,o=this,i=n(a.template(o,"groups-feature-forward",e)),r=i.find(".switch-state");i.find(".cancel-link").on("click",function(){t.dialog("close").remove()}),i.find(".save").on("click",function(){var n=r.prop("checked"),i=!n;e.group.smartpbx=e.group.smartpbx||{},e.group.smartpbx.forward=e.group.smartpbx.forward||{},e.group.smartpbx.forward.enabled=n,e.group.ignore_forward=i,e.baseCallflow.flow.data.ignore_forward=i,a.parallel({groups:function(n){o.groupsUpdate(e.group,function(e){n(null,e)})},ringGroup:function(n){o.groupsUpdateCallflow(e.baseCallflow,function(e){n(null,e)})}},function(e,n){t.dialog("close").remove(),o.groupsRender({groupId:n.groups.id})})}),t=a.ui.dialog(i,{title:e.group.extra.mapFeatures.forward.title,position:["center",20]})},groupsRenderPrepend:function(e){var t,o=this,i=a.util.findCallflowNode(e.callflow,"prepend_cid"),r=n.extend(!0,{group:e.group},e.group.extra.mapFeatures.prepend.active&&i?{caller_id_name_prefix:i.data.caller_id_name_prefix,caller_id_number_prefix:i.data.caller_id_number_prefix}:{}),s=n(a.template(o,"groups-feature-prepend",r)),u=s.find(".switch-state");s.find(".cancel-link").on("click",function(){t.dialog("close").remove()}),u.on("change",function(){n(this).prop("checked")?s.find(".content").slideDown():s.find(".content").slideUp()}),s.find(".save").on("click",function(){var r=u.prop("checked"),s=n.extend(!0,{action:"prepend"},a.ui.getFormData("prepend_form"));if("smartpbx"in e.group||(e.group.smartpbx={}),"prepend"in e.group.smartpbx||(e.group.smartpbx.prepend={enabled:!1}),e.group.smartpbx.prepend.enabled||r){e.group.smartpbx.prepend.enabled=r;var l=n.extend(!0,{},e.callflow);r?"prepend_cid"!==l.flow.module?l.flow={children:{_:n.extend(!0,{},e.callflow.flow)},module:"prepend_cid",data:s}:l.flow.data=s:i&&(l.flow=n.extend(!0,{},i.children._)),o.groupsUpdateCallflow(l,function(n){o.groupsUpdate(e.group,function(n){t.dialog("close").remove(),o.groupsRender({groupId:e.group.id})})})}else t.dialog("close").remove(),o.groupsRender({groupId:e.group.id})}),t=a.ui.dialog(s,{title:e.group.extra.mapFeatures.prepend.title,position:["center",20]})},groupsBindName:function(e,t){var i=this,r=e.find("#form-name");a.ui.validate(r),e.find(".save-group").on("click",function(){if(a.ui.valid(r)){var e=a.ui.getFormData("form-name");t=n.extend(!0,{},t,e),i.groupsUpdate(t,function(e){i.groupsRender({groupId:e.id})})}}),e.find(".delete-group").on("click",function(){a.ui.confirm(i.i18n.active().groups.confirmDeleteGroup,function(){i.groupsDelete(t.id,function(e){o.success(a.template(i,"!"+i.i18n.active().groups.groupDeleted,{name:e.group.name})),i.groupsRender()})})})},groupsBindNumbers:function(e,i){var r=this,s=r.i18n.active().groups.toastrMessages,u="",l=[];e.on("click",".list-assigned-items .remove-number",function(){var t=n(this),a=t.parents(".item-row");l.push(a.data("id")),a.slideUp(function(){a.remove(),e.find(".list-assigned-items .item-row").is(":visible")||e.find(".list-assigned-items .empty-row").slideDown(),e.find(".spare-link").removeClass("disabled")})}),e.on("keyup",".list-wrapper .unassigned-list-header .search-query",function(){var a,o=e.find(".list-unassigned-items .item-row"),i=e.find(".list-unassigned-items .empty-search-row");u=n(this).val().toLowerCase(),t.each(o,function(e){a=n(e),a.data("search").toLowerCase().indexOf(u)<0?a.hide():a.show()}),o.size()>0&&(o.is(":visible")?i.hide():i.show())}),a.util.isNumberFeatureEnabled("e911")&&e.on("click",".e911-number",function(){var e=n(this).parents(".item-row").first(),t=e.data("id");if(t){var o={phoneNumber:t,callbacks:{success:function(t){n.isEmptyObject(t.data.dash_e911)?e.find(".features i.feature-dash_e911").removeClass("active"):e.find(".features i.feature-dash_e911").addClass("active")}}};a.pub("common.e911.renderPopup",o)}}),a.util.isNumberFeatureEnabled("cnam")&&e.on("click",".callerId-number",function(){var e=n(this).parents(".item-row").first(),t=e.data("id");if(t){var o={phoneNumber:t,callbacks:{success:function(n){"cnam"in n.data&&n.data.cnam.display_name?e.find(".features i.feature-outbound_cnam").addClass("active"):e.find(".features i.feature-outbound_cnam").removeClass("active"),"cnam"in n.data&&n.data.cnam.inbound_lookup?e.find(".features i.feature-inbound_cnam").addClass("active"):e.find(".features i.feature-inbound_cnam").removeClass("active")}}};a.pub("common.callerId.renderPopup",o)}}),e.on("click",".prepend-number",function(){var e=n(this).parents(".item-row").first(),t=e.data("id");if(t){var o={phoneNumber:t,callbacks:{success:function(n){"prepend"in n.data&&n.data.prepend.enabled?e.find(".features i.feature-prepend").addClass("active"):e.find(".features i.feature-prepend").removeClass("active")}}};a.pub("common.numberPrepend.renderPopup",o)}}),e.on("click",".actions .spare-link:not(.disabled)",function(o){o.preventDefault();var i=(n(this),{accountName:a.apps.auth.currentAccount.name,accountId:r.accountId,ignoreNumbers:n.map(e.find(".item-row"),function(e){return n(e).data("id")}),extraNumbers:l,callback:function(o,i){e.find(".empty-row").hide(),t.each(o,function(o,i){o.isLocal=o.features.indexOf("local")>-1,e.find(".list-assigned-items").append(n(a.template(r,"groups-numbersItemRow",{isCnamEnabled:a.util.isNumberFeatureEnabled("cnam"),isE911Enabled:a.util.isNumberFeatureEnabled("e911"),number:o}))),l=t.without(l,o.phoneNumber)}),a.ui.tooltips(e),0===i&&e.find(".spare-link").addClass("disabled")}});a.pub("common.numbers.dialogSpare",i)}),e.on("click",".actions .buy-link",function(o){o.preventDefault(),a.pub("common.buyNumbers",{searchType:n(this).data("type"),callbacks:{success:function(o){a.pub("common.numbers.getListFeatures",function(i){t.each(o,function(t,o){t.viewFeatures=n.extend(!0,{},i),t.phoneNumber=t.id;var s=n(a.template(r,"groups-numbersItemRow",{isCnamEnabled:a.util.isNumberFeatureEnabled("cnam"),isE911Enabled:a.util.isNumberFeatureEnabled("e911"),number:t}));a.ui.tooltips(s),e.find(".list-unassigned-items .empty-row").hide(),e.find(".list-unassigned-items").append(s)})})}}})}),e.on("click",".save-numbers",function(){var t=n(this),i=t.parents(".grid-row"),u=i.data("callflow_id"),l=i.data("name");dataNumbers=[],e.find(".item-row").each(function(e,t){dataNumbers.push(n(t).data("id"))}),r.groupsUpdateNumbers(u,dataNumbers,function(e){o.success(a.template(r,"!"+s.numbersUpdated,{name:l})),r.groupsRender({groupId:e.group_id})})})},groupsBindExtensions:function(e,i){var r=this,s=r.i18n.active().groups.toastrMessages,u=[];e.on("click",".save-extensions",function(){var t=[],i=n(this).parents(".grid-row"),u=i.data("callflow_id"),l=i.data("name");e.find(".list-assigned-items .item-row").each(function(e,a){var o,a=n(a);o=(a.data("id")?a.data("id"):a.find(".input-extension").val())+"",t.push(o)}),r.groupsUpdateExtensions(u,t,function(e){o.success(a.template(r,"!"+s.numbersUpdated,{name:l})),r.groupsRender({groupId:e.group_id})})}),e.on("click","#add_extensions",function(){var o=function(t){var t=u[u.length-1]+1,o={recommendedExtension:t},i=n(a.template(r,"groups-newExtension",o)),s=e.find(".list-assigned-items");a.ui.mask(i.find(".input-extension"),"extension"),u.push(t),s.find(".empty-row").hide(),s.append(i)};t.isEmpty(u)?r.groupsListExtensions(function(e){u=e,o()}):o()}),e.on("click",".remove-extension",function(){var e=n(this).parents(".item-row"),t=e.siblings(".empty-row");0===e.siblings(".item-row").size()&&t.show(),e.remove()}),e.on("click",".cancel-extension-link",function(){var e=parseInt(n(this).siblings("input").val()),t=u.indexOf(e);t>-1&&u.splice(t,1),n(this).parents(".item-row").remove()})},groupsBindMembers:function(e,o){var i=this;e.find(".save-groups").on("click",function(){var n=o.id;a.pub("common.ringingDurationControl.getEndpoints",{container:e,callback:function(e){t.each(e,function(e){delete e.name,e.endpoint_type="user"}),i.groupsUpdateBaseRingGroup(n,e,function(e){i.groupsRender({groupId:n})})}})}),e.on("click",".add-user-link",function(){var i=n.map(e.find(".grid-time-row[data-id]"),function(e){return n(e).data("id")}),r=t.filter(o.extra.remainingUsers,function(e){return-1===i.indexOf(e.id)});a.pub("common.monsterListing.render",{dataList:r,dataType:"users",okCallback:function(n){t.each(n,function(n){var t={id:n.id,timeout:20,delay:0,endpoint_type:"user",name:n.name};a.pub("common.ringingDurationControl.addEndpoint",{container:e.find(".members-container"),endpoint:t,hasRemoveColumn:!0})})}})})},groupsGetCreationData:function(e){var n=this;n.groupsListUsers(function(n){n.sort(function(e,n){return e.last_name>n.last_name});var t={extra:{listUsers:n}};e&&e(t)})},groupsListUsers:function(e){var n=this;n.callApi({resource:"user.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(n){e&&e(n.data)}})},groupsGetFeaturesData:function(e,n){var o=this;a.parallel({group:function(n){o.groupsGetGroup(e,function(e){n(null,e)})},users:function(e){o.groupsListUsers(function(n){e(null,n)})},callflow:function(n){o.groupsGetRingGroup(e,function(e){n(null,e)})},baseCallflow:function(n){o.groupsGetBaseRingGroup(e,function(e){n(null,e)})},voicemails:function(e){o.groupsListVMBoxes(function(n){e(null,n)})},mainMenu:function(e){o.callApi({resource:"callflow.list",data:{accountId:o.accountId,filters:{filter_type:"main"}},success:function(n){e(null,n.data&&n.data.length>0?t.find(n.data,function(e){return"MainOpenHoursMenu"===e.numbers[0]}):null)}})},userCallflows:function(e){o.callApi({resource:"callflow.list",data:{accountId:o.accountId,filters:{has_key:"owner_id",filter_type:"mainUserCallflow"}},success:function(n){e(null,n.data)}})}},function(e,a){a.group.extra=o.groupsGetGroupFeatures(a.group),a.userCallflows=t.filter(a.userCallflows,function(e){var n=t.find(a.users,function(n){return e.owner_id===n.id});return n?(e.userName=n.first_name+" "+n.last_name,!0):!1}),n&&n(a)})},groupsGetNameData:function(e,n){var t=this;t.groupsGetGroup(e,function(e){n&&n(e)})},groupsFormatNumbersData:function(e,o){var i={emptyExtensions:!0,extensions:[],emptyAssigned:!0,assignedNumbers:{},countSpare:0,unassignedNumbers:{}};a.pub("common.numbers.getListFeatures",function(a){t.each(e.numbers.numbers,function(e,o){e.viewFeatures=n.extend(!0,{},a),e.localityEnabled="locality"in e?!0:!1,t.each(e.features,function(n){n in e.viewFeatures&&(e.viewFeatures[n].active="active")}),e.hasOwnProperty("used_by")&&""!==e.used_by||(i.unassignedNumbers[o]=e,i.countSpare++)}),"groupCallflow"in e.callflow&&"numbers"in e.callflow.groupCallflow&&t.each(e.callflow.groupCallflow.numbers,function(n){n in e.numbers.numbers?(e.numbers.numbers[n].isLocal=e.numbers.numbers[n].features.indexOf("local")>-1,i.assignedNumbers[n]=e.numbers.numbers[n]):i.extensions.push(n)}),i.emptyExtensions=t.isEmpty(i.extensions),i.emptyAssigned=t.isEmpty(i.assignedNumbers),i.emptySpare=t.isEmpty(i.unassignedNumbers),o&&o(i)})},groupsGetNumbersData:function(e,n){var t=this;a.parallel({callflow:function(n){var a={};t.callApi({resource:"callflow.list",data:{accountId:t.accountId,filters:{filter_group_id:e,filter_type:"userGroup"}},success:function(e){e.data.length>0?t.groupsGetCallflow(e.data[0].id,function(e){a.groupCallflow=e,n&&n(null,a)}):n&&n(null,null)}})},numbers:function(e){t.callApi({resource:"numbers.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(n){e&&e(null,n.data)}})}},function(e,t){n&&n(t)})},groupsGetMembersData:function(e,n){var t=this;a.parallel({users:function(e){t.groupsListUsers(function(n){e(null,n)})},group:function(n){t.groupsGetGroup(e,function(e){n(null,e)})},baseCallflow:function(n){t.groupsGetBaseRingGroup(e,function(e){n(null,e)})}},function(e,t){n&&n(t)})},groupsFormatMembersData:function(e){var n=this,a={},o=e.baseCallflow.flow;t.each(e.users,function(e){a[e.id]=e});var i=o.data.endpoints;return t.each(i,function(e){e.delay=parseInt(e.delay),e.timeout=parseInt(e.timeout),e.id in a?e.name=a[e.id].first_name+" "+a[e.id].last_name:(e.name=n.i18n.active().groups.userDeleted,e.deleted=!0)}),e.group.extra={ringGroup:i,remainingUsers:a},e.group},groupsUpdateNumbers:function(e,n,a){var o=this;o.groupsGetCallflow(e,function(e){t.each(e.numbers,function(e){e.length<7&&n.push(e)}),e.numbers=n,o.groupsUpdateCallflow(e,function(e){a&&a(e)})})},groupsUpdateExtensions:function(e,n,a){var o=this;o.groupsGetCallflow(e,function(e){t.each(e.numbers,function(e){e.length>6&&n.push(e)}),e.numbers=n,o.groupsUpdateCallflow(e,function(e){a&&a(e)})})},groupsListExtensions:function(e){var n=this,a=[];n.groupsListCallflows(function(n){t.each(n,function(e){t.each(e.numbers,function(e){if(e.length<7){var n=parseInt(e);n>1&&a.push(n)}})}),a.sort(function(e,n){var t=parseInt(e),a=parseInt(n),o=-1;return t>0&&a>0&&(o=t>a),o}),e&&e(a)})},groupsCheckWalkthrough:function(){var e=this;e.groupsHasWalkthrough(function(){e.groupsShowWalkthrough(function(){e.groupsUpdateWalkthroughFlagUser()})})},groupsHasWalkthrough:function(e){var n=this,t=n.uiFlags.user.get("showGroupsWalkthrough");t!==!1&&e&&e()},groupsUpdateWalkthroughFlagUser:function(e){var n=this,t=n.uiFlags.user.set("showGroupsWalkthrough",!1);n.groupsUpdateOriginalUser(t,function(n){e&&e(n)})},groupsShowWalkthrough:function(e){var t=this,o=n("#voip_container"),i=o.find(".grid-row:not(.title):first"),r=[{element:o.find(".add-group")[0],intro:t.i18n.active().groups.walkthrough.steps[1],position:"right"},{element:i.find(".walkthrough-group")[0],intro:t.i18n.active().groups.walkthrough.steps[2],position:"right"},{element:i.find(".phone-number")[0],intro:t.i18n.active().groups.walkthrough.steps[3],position:"bottom"},{element:i.find(".features")[0],intro:t.i18n.active().groups.walkthrough.steps[4],position:"left"}];a.ui.stepByStep(r,function(){e&&e()})},groupsListCallflows:function(e){var n=this;n.callApi({resource:"callflow.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(n){e&&e(n.data)}})},groupsListMedias:function(e){var n=this;n.callApi({resource:"media.list",data:{accountId:n.accountId,filters:{paginate:"false",key_missing:"type"}},success:function(n){e&&e(n.data)}})},groupsListVMBoxes:function(e){var n=this;n.callApi({resource:"voicemail.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(n){e&&e(n.data)}})},groupsCreate:function(e,n){var t=this;t.callApi({resource:"group.create",data:{accountId:t.accountId,data:e.group},success:function(a){e.callflow.group_id=a.data.id,e.baseCallflow.group_id=a.data.id,t.callApi({resource:"callflow.create",data:{accountId:t.accountId,data:e.baseCallflow},success:function(o){e.callflow.flow.data.id=o.data.id,t.callApi({resource:"callflow.create",data:{accountId:t.accountId,data:e.callflow},success:function(e){n&&n(a.data)},error:function(){t.callApi({resource:"group.delete",data:{accountId:t.accountId,groupId:a.data.id}}),t.callApi({resource:"callflow.delete",data:{accountId:t.accountId,callflowId:o.data.id}})}})},error:function(){t.callApi({resource:"group.delete",data:{accountId:t.accountId,groupId:a.data.id}})}})}})},groupsGetRingGroup:function(e,n,t){var a=this;a.callApi({resource:"callflow.list",data:{accountId:a.accountId,filters:{filter_group_id:e,filter_type:"userGroup"}},success:function(e){e.data.length>0?a.groupsGetCallflow(e.data[0].id,function(e){n&&n(e)}):(t&&t(e),o.error(a.i18n.active().groups.ringGroupMissing))},error:function(e){t&&t(e)}})},groupsGetBaseRingGroup:function(e,n,t){var a=this;a.callApi({resource:"callflow.list",data:{accountId:a.accountId,filters:{filter_group_id:e,filter_type:"baseGroup"}},success:function(e){e.data.length>0?a.groupsGetCallflow(e.data[0].id,function(e){n&&n(e)}):(t&&t(e),o.error(a.i18n.active().groups.ringGroupMissing))},error:function(e){t&&t(e)}})},groupsComputeTimeout:function(e){var n=0;return t.each(e,function(e){var t=parseInt(e.delay),a=parseInt(e.timeout),o=t+a;o>n&&(n=o)}),n},groupsUpdateBaseRingGroup:function(e,n,o){var i=this;a.parallel({group:function(a){i.groupsGetGroup(e,function(e){var o=!1;t.each(n,function(n){return n.id in e.endpoints?void delete e.endpoints[n.id]:(o=!0,!1)}),t.isEmpty(e.endpoints)||(o=!0),o?(e.endpoints={},t.each(n,function(n){e.endpoints[n.id]={type:"user"}}),i.groupsUpdate(e,function(e){a&&a(null,e)})):a&&a(null,e)})},callflow:function(t){i.groupsGetBaseRingGroup(e,function(e){e.flow.data.endpoints=n,e.flow.data.timeout=i.groupsComputeTimeout(n),i.groupsUpdateCallflow(e,function(e){t&&t(null,e)})})}},function(e,n){o&&o(n)})},groupsUpdate:function(e,n){var t=this;delete e.extra,t.callApi({resource:"group.update",data:{accountId:t.accountId,groupId:e.id,data:e},success:function(e){n&&n(e.data)}})},groupsUpdateCallflow:function(e,n){var t=this;delete e.metadata,t.callApi({resource:"callflow.update",data:{accountId:t.accountId,callflowId:e.id,data:e},success:function(e){n&&n(e.data)}})},groupsGetGroup:function(e,n){var t=this;t.callApi({resource:"group.get",data:{groupId:e,accountId:t.accountId},success:function(e){n&&n(e.data)}})},groupsDelete:function(e,n){var t=this;a.parallel({group:function(n){t.callApi({resource:"group.delete",data:{accountId:t.accountId,groupId:e},success:function(e){n&&n(null,e.data)}})},callflow:function(n){t.groupsGetRingGroup(e,function(e){t.callApi({resource:"callflow.delete",data:{accountId:t.accountId,callflowId:e.id},success:function(e){n&&n(null,e)}})},function(e){n&&n(null,e)})},baseCallflow:function(n){t.groupsGetBaseRingGroup(e,function(e){t.callApi({resource:"callflow.delete",data:{accountId:t.accountId,callflowId:e.id},success:function(e){n&&n(null,e)}})},function(e){n&&n(null,e)})}},function(e,t){n&&n(t)})},groupsGetCallflow:function(e,n){var t=this;t.callApi({resource:"callflow.get",data:{accountId:t.accountId,
callflowId:e},success:function(e){n&&n(e.data)}})},groupsGetData:function(e){var n=this;a.parallel({groups:function(e){n.callApi({resource:"group.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(n){e(null,n.data)}})},callflows:function(e){n.callApi({resource:"callflow.list",data:{accountId:n.accountId,filters:{has_key:"group_id"}},success:function(n){e(null,n.data)}})}},function(n,t){e&&e(t)})},groupsRemoveOverlay:function(){n("body").find("#groups_container_overlay").remove()},groupsUpdateOriginalUser:function(e,n){var t=this;t.callApi({resource:"user.update",data:{userId:e.id,accountId:a.apps.auth.originalAccount.id,data:e},success:function(e){n&&n(e.data)}})}};return i});