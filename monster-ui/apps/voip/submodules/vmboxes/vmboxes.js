define(["require","jquery","underscore","monster","toastr","monster-timezone"],function(e){var t=e("jquery"),i=e("underscore"),n=e("monster"),a=e("toastr"),o=e("monster-timezone"),s={requests:{},subscribe:{"voip.vmboxes.render":"vmboxesRender"},vmboxesRender:function(e){var a=this,e=e||{},o=e.parent||t(".right-content"),s=e.voicemailId||"",d=e.callback;a.vmboxesGetData(function(e){var c,r=a.vmboxesFormatListData(e),l=t(n.template(a,"vmboxes-layout",r));if(i.each(r.vmboxes,function(e){c=n.template(a,"vmboxes-row",e),l.find(".vmboxes-rows").append(c)}),a.vmboxesBindEvents(l,o,r),o.empty().append(l),s){var u=o.find(".grid-row[data-id="+s+"]");n.ui.highlight(u,{endColor:"#FCFCFC"})}0==r.vmboxes.length?o.find(".no-vmboxes-row").css("display","block"):o.find(".no-vmboxes-row").css("display","none"),d&&d()})},vmboxesBindEvents:function(e,n,a){var o=this,s=function(e){o.vmboxesRender({voicemailId:e.id})};setTimeout(function(){e.find(".search-query").focus()}),e.find(".settings").on("click",function(){o.vmboxesRenderEdit(t(this).parents(".grid-row").data("id"),s)}),e.find(".add-vmbox").on("click",function(){o.vmboxesRenderEdit(void 0,s)}),e.find(".vmboxes-header .search-query").on("keyup",function(){var n=t(this).val().toLowerCase(),a=e.find(".vmboxes-rows .grid-row:not(.title)"),o=e.find(".vmboxes-rows .empty-search-row");i.each(a,function(e){var e=t(e);e.data("search").toLowerCase().indexOf(n)<0?e.hide():e.show()}),a.size()>0&&(a.is(":visible")?o.hide():o.show())})},vmboxesRenderEdit:function(e,t){var i=this;i.vmboxesGetEditData(e,function(e){e=i.vmboxesMigrateData(e),i.vmboxesRenderVmbox(e,t)})},vmboxesMigrateData:function(e){return e.hasOwnProperty("notify_email_address")&&(e.notify_email_addresses=e.notify_email_address),e},vmboxesRenderVmbox:function(e,a){var o=this,s=e.id?"edit":"add",d="edit"===s?n.template(o,"!"+o.i18n.active().vmboxes.editTitle,{name:e.name}):o.i18n.active().vmboxes.addTitle,c=t(n.template(o,"vmboxes-edit",e)),r={afterSave:function(e){l.dialog("close").remove(),a&&a(e)},afterDelete:function(e){l.dialog("close").remove(),o.vmboxesRender()},afterCancel:function(){l.dialog("close").remove()}};i.each(e.notify_email_addresses,function(e){c.find(".saved-entities").append(n.template(o,"vmboxes-emailRow",{name:e}))}),o.vmboxesEditBindEvents(c,e,r);var l=n.ui.dialog(c,{position:["center",20],title:d,width:"700"})},vmboxesEditBindEvents:function(e,i,s){var d=this,c=e.find("#form_vmbox");n.ui.validate(c,{rules:{name:{required:!0}}}),n.ui.tabs(e),o.populateDropdown(e.find("#timezone"),i.timezone||"inherit",{inherit:d.i18n.active().defaultTimezone}),e.find("#timezone").chosen({search_contains:!0,width:"220px"}),n.ui.tooltips(e),e.find(".actions .save").on("click",function(){if(n.ui.valid(c)){var t=d.vmboxesMergeData(i,e);d.vmboxesSaveVmbox(t,function(e){s.afterSave&&s.afterSave(e)})}else e.find('.tabs-selector[data-section="basic"]').click()}),e.find("#delete_vmbox").on("click",function(){var e=t(this).parents(".edit-vmbox").data("id");n.ui.confirm(d.i18n.active().vmboxes.confirmDeleteVmbox,function(){d.vmboxesDeleteVmbox(e,function(e){a.success(n.template(d,"!"+d.i18n.active().vmboxes.deletedVmbox,{vmboxName:e.name})),s.afterDelete&&s.afterDelete(e)})})}),e.find(".actions .cancel-link").on("click",function(){s.afterCancel&&s.afterCancel()});var r=function(t){t.preventDefault();var i=e.find("#entity_name"),a=i.val();templateFlag=n.template(d,"vmboxes-emailRow",{name:a}),e.find(".saved-entities").prepend(templateFlag),i.val("").focus()};e.find(".entity-wrapper.placeholder:not(.active)").on("click",function(){t(this).addClass("active"),e.find("#entity_name").focus()}),e.find("#cancel_entity").on("click",function(i){i.stopPropagation(),t(this).siblings("input").val(""),e.find(".entity-wrapper.placeholder").removeClass("active")}),e.find("#add_entity").on("click",function(e){r(e)}),e.find("#entity_name").on("keypress",function(e){var t=e.keyCode||e.which;13===t&&r(e)}),e.find(".saved-entities").on("click",".delete-entity",function(){t(this).parents(".entity-wrapper").remove()});var l,u=e.find(".greeting-container"),m=function(e){if(l=void 0,u.find(".upload-div input").val(""),u.find(".upload-div").slideUp(function(){u.find(".upload-toggle").removeClass("active")}),e){var t=u.find(".media-dropdown");t.append('<option value="'+e.id+'">'+e.name+"</option>"),t.val(e.id)}};u.find(".upload-input").fileUpload({inputOnly:!0,wrapperClass:"file-upload input-append",btnText:d.i18n.active().vmboxes.popupSettings.greeting.audioUploadButton,btnClass:"monster-button",maxSize:5,success:function(e){l=e[0]},error:function(e){e.hasOwnProperty("size")&&e.size.length>0&&n.ui.alert(d.i18n.active().vmboxes.popupSettings.greeting.fileTooBigAlert),u.find(".upload-div input").val(""),l=void 0}}),u.find(".upload-toggle").on("click",function(){t(this).hasClass("active")?u.find(".upload-div").stop(!0,!0).slideUp():u.find(".upload-div").stop(!0,!0).slideDown()}),u.find(".upload-cancel").on("click",function(){m()}),u.find(".upload-submit").on("click",function(){l?d.callApi({resource:"media.create",data:{accountId:d.accountId,data:{streamable:!0,name:l.name,media_source:"upload",description:l.name}},success:function(e,t){var i=e.data;d.callApi({resource:"media.upload",data:{accountId:d.accountId,mediaId:i.id,data:l.file},success:function(e,t){m(i)},error:function(e,t){d.callApi({resource:"media.delete",data:{accountId:d.accountId,mediaId:i.id,data:{}},success:function(e,t){}})}})}}):n.ui.alert(d.i18n.active().vmboxes.popupSettings.greeting.emptyUploadAlert)})},vmboxesMergeData:function(e,i){var a=n.ui.getFormData("form_vmbox"),o=t.extend(!0,{},e,a);return o.notify_email_addresses=[],i.find(".saved-entities .entity-wrapper").each(function(){o.notify_email_addresses.push(t(this).data("name"))}),o.not_configurable=!a.extra.configurable,""===o.pin&&delete o.pin,o.hasOwnProperty("notify_email_address")&&delete o.notify_email_address,o.timezone&&"inherit"===o.timezone&&delete o.timezone,o.media&&"none"===o.media.unavailable&&delete o.media.unavailable,delete o.extra,o},vmboxesFormatData:function(e){var i={require_pin:!0,check_if_owner:!0},n=t.extend(!0,{},i,e.vmbox);return n.extra={mediaList:e.mediaList},n},vmboxesFormatListData:function(e){var t={countVMBoxes:e.vmboxes.length,vmboxes:e.vmboxes},n={};return i.each(e.users,function(e){n[e.id]=e}),t.vmboxes.sort(function(e,t){return parseInt(e.mailbox)>parseInt(t.mailbox)?1:-1}),i.each(t.vmboxes,function(e){e.hasOwnProperty("owner_id")&&n.hasOwnProperty(e.owner_id)?e.friendlyOwnerName=n[e.owner_id].first_name+" "+n[e.owner_id].last_name:e.friendlyOwnerName="-"}),t},vmboxesDeleteVmbox:function(e,t){var i=this;i.callApi({resource:"voicemail.delete",data:{accountId:i.accountId,voicemailId:e,data:{}},success:function(e){t(e.data)}})},vmboxesGetEditData:function(e,t){var i=this;n.parallel({vmbox:function(t){e?i.vmboxesGetVmbox(e,function(e){t(null,e)}):t(null,{})},mediaList:function(e){i.callApi({resource:"media.list",data:{accountId:i.accountId},success:function(t){e(null,t.data)}})}},function(e,n){var a=i.vmboxesFormatData(n);t&&t(a)})},vmboxesGetVmbox:function(e,t,i){var n=this;n.callApi({resource:"voicemail.get",data:{accountId:n.accountId,voicemailId:e},success:function(e){t&&t(e.data)},error:function(e){i&&i(e)}})},vmboxesSaveVmbox:function(e,t){var i=this;e.id?i.vmboxesUpdateVmbox(e,t):i.vmboxesCreateVmbox(e,t)},vmboxesCreateVmbox:function(e,t){var i=this;i.callApi({resource:"voicemail.create",data:{accountId:i.accountId,data:e},success:function(e){t(e.data)}})},vmboxesUpdateVmbox:function(e,t,i){var n=this;n.callApi({resource:"voicemail.update",data:{accountId:n.accountId,data:e,voicemailId:e.id},success:function(e){t&&t(e.data)},error:function(e){i&&i(e)}})},vmboxesGetData:function(e){var t=this;n.parallel({users:function(e){t.callApi({resource:"user.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t){e&&e(null,t.data)}})},vmboxes:function(e){t.callApi({resource:"voicemail.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t){e(null,t.data)}})}},function(i,n){t.vmboxesFormatListData(n),e&&e(n)})}};return s});