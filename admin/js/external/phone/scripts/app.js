var ctxSip;$(document).ready(function(){typeof user=="undefined"&&(user=JSON.parse(localStorage.getItem("SIPCreds"))),ctxSip={config:{password:user.Pass,display_name:user.Display,uri:"sip:"+user.User+"@"+user.Realm,ws_servers:user.WSServer,register_expires:30,traceSip:!0,log:{level:0}},ringtone:document.getElementById("ringtone"),ringbacktone:document.getElementById("ringbacktone"),dtmfTone:document.getElementById("dtmfTone"),Sessions:[],callTimers:{},callActiveID:null,callVolume:1,Stream:null,formatPhone:function(e){var t;return e.indexOf("@")?t=e.split("@")[0]:t=e,t=t.toString().replace(/[^0-9]/g,""),t.length===10?"("+t.substr(0,3)+") "+t.substr(3,3)+"-"+t.substr(6,4):t.length===11?"("+t.substr(1,3)+") "+t.substr(4,3)+"-"+t.substr(7,4):t},startRingTone:function(){try{ctxSip.ringtone.play()}catch(e){}},stopRingTone:function(){try{ctxSip.ringtone.pause()}catch(e){}},startRingbackTone:function(){try{ctxSip.ringbacktone.play()}catch(e){}},stopRingbackTone:function(){try{ctxSip.ringbacktone.pause()}catch(e){}},getUniqueID:function(){return Math.random().toString(36).substr(2,9)},newSession:function(e){e.displayName=e.remoteIdentity.displayName||e.remoteIdentity.uri.user,e.ctxid=ctxSip.getUniqueID();var t;return e.direction==="incoming"?(t="Incoming: "+e.displayName,ctxSip.startRingTone()):(t="Trying: "+e.displayName,ctxSip.startRingbackTone()),ctxSip.logCall(e,"ringing"),ctxSip.setCallSessionStatus(t),e.on("progress",function(e){e.direction==="outgoing"&&ctxSip.setCallSessionStatus("Calling...")}),e.on("connecting",function(e){e.direction==="outgoing"&&ctxSip.setCallSessionStatus("Connecting...")}),e.on("accepted",function(t){ctxSip.callActiveID&&ctxSip.callActiveID!==e.ctxid&&ctxSip.phoneHoldButtonPressed(ctxSip.callActiveID),ctxSip.stopRingbackTone(),ctxSip.stopRingTone(),ctxSip.setCallSessionStatus("Answered"),ctxSip.logCall(e,"answered"),ctxSip.callActiveID=e.ctxid}),e.on("hold",function(t){ctxSip.callActiveID=null,ctxSip.logCall(e,"holding")}),e.on("unhold",function(t){ctxSip.logCall(e,"resumed"),ctxSip.callActiveID=e.ctxid}),e.on("muted",function(t){ctxSip.Sessions[e.ctxid].isMuted=!0,ctxSip.setCallSessionStatus("Muted")}),e.on("unmuted",function(t){ctxSip.Sessions[e.ctxid].isMuted=!1,ctxSip.setCallSessionStatus("Answered")}),e.on("cancel",function(t){ctxSip.stopRingTone(),ctxSip.stopRingbackTone(),ctxSip.setCallSessionStatus("Canceled"),this.direction==="outgoing"&&(ctxSip.callActiveID=null,e=null,ctxSip.logCall(this,"ended"))}),e.on("bye",function(t){ctxSip.stopRingTone(),ctxSip.stopRingbackTone(),ctxSip.setCallSessionStatus(""),ctxSip.logCall(e,"ended"),ctxSip.callActiveID=null,e=null}),e.on("failed",function(e){ctxSip.stopRingTone(),ctxSip.stopRingbackTone(),ctxSip.setCallSessionStatus("Terminated")}),e.on("rejected",function(t){ctxSip.stopRingTone(),ctxSip.stopRingbackTone(),ctxSip.setCallSessionStatus("Rejected"),ctxSip.callActiveID=null,ctxSip.logCall(this,"ended"),e=null}),ctxSip.Sessions[e.ctxid]=e,e},getUserMediaFailure:function(e){window.console.error("getUserMedia failed:",e),ctxSip.setError(!0,"Media Error.","You must allow access to your microphone.  Check the address bar.",!0)},getUserMediaSuccess:function(e){ctxSip.Stream=e},setCallSessionStatus:function(e){$("#txtCallStatus").html(e)},setStatus:function(e){$("#txtRegStatus").html('<i class="fa fa-signal"></i> '+e)},logCall:function(e,t){var n={clid:e.displayName,uri:e.remoteIdentity.uri.toString(),id:e.ctxid,time:(new Date).getTime()},r=JSON.parse(localStorage.getItem("sipCalls"));r||(r={}),r.hasOwnProperty(e.ctxid)||(r[n.id]={id:n.id,clid:n.clid,uri:n.uri,start:n.time,flow:e.direction}),t==="ended"&&(r[n.id].stop=n.time),t==="ended"&&r[n.id].status==="ringing"?r[n.id].status="missed":r[n.id].status=t,localStorage.setItem("sipCalls",JSON.stringify(r)),ctxSip.logShow()},logItem:function(t){var n=t.status!=="ended"&&t.status!=="missed",r=t.status!=="ended"?'<span id="'+t.id+'"></span>':moment.duration(t.stop-t.start).humanize(),i="",s,o;switch(t.status){case"ringing":i="list-group-item-success",s="fa-bell";break;case"missed":i="list-group-item-danger",t.flow==="incoming"&&(s="fa-chevron-left"),t.flow==="outgoing"&&(s="fa-chevron-right");break;case"holding":i="list-group-item-warning",s="fa-pause";break;case"answered":case"resumed":i="list-group-item-info",s="fa-phone-square";break;case"ended":t.flow==="incoming"&&(s="fa-chevron-left"),t.flow==="outgoing"&&(s="fa-chevron-right")}o='<div class="list-group-item sip-logitem clearfix '+i+'" data-uri="'+t.uri+'" data-sessionid="'+t.id+'" title="Double Click to Call">',o+='<div class="clearfix"><div class="pull-left">',o+='<i class="fa fa-fw '+s+' fa-fw"></i> <strong>'+ctxSip.formatPhone(t.uri)+"</strong><br><small>"+moment(t.start).format("MM/DD hh:mm:ss a")+"</small>",o+="</div>",o+='<div class="pull-right text-right"><em>'+t.clid+"</em><br>"+r+"</div></div>",n&&(o+='<div class="btn-group btn-group-xs pull-right">',t.status==="ringing"&&t.flow==="incoming"?o+='<button class="btn btn-xs btn-success btnCall" title="Call"><i class="fa fa-phone"></i></button>':(o+='<button class="btn btn-xs btn-primary btnHoldResume" title="Hold"><i class="fa fa-pause"></i></button>',o+='<button class="btn btn-xs btn-info btnTransfer" title="Transfer"><i class="fa fa-random"></i></button>',o+='<button class="btn btn-xs btn-warning btnMute" title="Mute"><i class="fa fa-fw fa-microphone"></i></button>'),o+='<button class="btn btn-xs btn-danger btnHangUp" title="Hangup"><i class="fa fa-stop"></i></button>',o+="</div>"),o+="</div>",$("#sip-logitems").append(o);if(t.status==="answered"){var u=document.getElementById(t.id);ctxSip.callTimers[t.id]=new e(u),ctxSip.callTimers[t.id].start()}n&&t.status!=="ringing"&&ctxSip.callTimers[t.id].start({startTime:t.start}),$("#sip-logitems").scrollTop(0)},logShow:function(){var e=JSON.parse(localStorage.getItem("sipCalls")),t=[];e!==null?($("#sip-splash").addClass("hide"),$("#sip-log").removeClass("hide"),$("#sip-logitems").empty(),$.each(e,function(e,n){t.push(n)}),t.sort(function(e,t){return t.start-e.start}),$.each(t,function(e,t){ctxSip.logItem(t)})):($("#sip-splash").removeClass("hide"),$("#sip-log").addClass("hide"))},logClear:function(){localStorage.removeItem("sipCalls"),ctxSip.logShow()},sipCall:function(e){try{var t=ctxSip.phone.invite(e,{media:{stream:ctxSip.Stream,constraints:{audio:!0,video:!1},render:{remote:{audio:$("#audioRemote").get()[0]}},RTCConstraints:{optional:[{DtlsSrtpKeyAgreement:"true"}]}}});return t.direction="outgoing",ctxSip.newSession(t)}catch(n){throw n}},sipTransfer:function(e){var t=ctxSip.Sessions[e],n=window.prompt("Enter destination number","");ctxSip.setCallSessionStatus("<i>Transfering the call...</i>"),t.refer(n)},sipHangUp:function(e){var t=ctxSip.Sessions[e];if(!t)return;t.startTime?t.bye():t.reject?t.reject():t.cancel&&t.cancel()},sipSendDTMF:function(e){try{ctxSip.dtmfTone.play()}catch(t){}var n=ctxSip.callActiveID;if(n){var r=ctxSip.Sessions[n];r.dtmf(e)}},phoneCallButtonPressed:function(e){var t=ctxSip.Sessions[e],n=$("#numDisplay").val();t?t.accept&&!t.startTime&&t.accept({media:{stream:ctxSip.Stream,constraints:{audio:!0,video:!1},render:{remote:{audio:$("#audioRemote").get()[0]}},RTCConstraints:{optional:[{DtlsSrtpKeyAgreement:"true"}]}}}):($("#numDisplay").val(""),ctxSip.sipCall(n))},phoneMuteButtonPressed:function(e){var t=ctxSip.Sessions[e];t.isMuted?t.unmute():t.mute()},phoneHoldButtonPressed:function(e){var t=ctxSip.Sessions[e];t.isOnHold().local===!0?t.unhold():t.hold()},setError:function(e,t,n,r){if(e===!0){$("#mdlError p").html(n),$("#mdlError").modal("show");if(r){var i='<button type="button" class="close" data-dismiss="modal">&times;</button>';$("#mdlError .modal-header").prepend(i),$("#mdlError .modal-title").html(t),$("#mdlError").modal({keyboard:!0})}else $("#mdlError .modal-header").find("button").remove(),$("#mdlError .modal-title").html(t),$("#mdlError").modal({keyboard:!1});$("#numDisplay").prop("disabled","disabled")}else $("#numDisplay").removeProp("disabled"),$("#mdlError").modal("hide")},hasWebRTC:function(){return navigator.webkitGetUserMedia?!0:navigator.mozGetUserMedia?!0:navigator.getUserMedia?!0:(ctxSip.setError(!0,"Unsupported Browser.","Your browser does not support the features required for this phone."),window.console.error("WebRTC support not found"),!1)}};if(!ctxSip.hasWebRTC())return!0;ctxSip.phone=new SIP.UA(ctxSip.config),ctxSip.phone.on("connected",function(e){ctxSip.setStatus("Connected")}),ctxSip.phone.on("disconnected",function(e){ctxSip.setStatus("Disconnected"),ctxSip.setError(!0,"Websocket Disconnected.","An Error occurred connecting to the websocket."),$("#sessions > .session").each(function(e,t){ctxSip.removeSession(t,500)})}),ctxSip.phone.on("registered",function(e){var t=function(){return"If you close this window, you will not be able to make or receive calls from your browser."},n=function(){localStorage.removeItem("ctxPhone"),ctxSip.phone.stop()};window.onbeforeunload=t,window.onunload=n,localStorage.setItem("ctxPhone","true"),$("#mldError").modal("hide"),ctxSip.setStatus("Ready"),SIP.WebRTC.isSupported()&&SIP.WebRTC.getUserMedia({audio:!0,video:!1},ctxSip.getUserMediaSuccess,ctxSip.getUserMediaFailure)}),ctxSip.phone.on("registrationFailed",function(e){ctxSip.setError(!0,"Registration Error.","An Error occurred registering your phone. Check your settings."),ctxSip.setStatus("Error: Registration Failed")}),ctxSip.phone.on("unregistered",function(e){ctxSip.setError(!0,"Registration Error.","An Error occurred registering your phone. Check your settings."),ctxSip.setStatus("Error: Registration Failed")}),ctxSip.phone.on("invite",function(e){var t=e;t.direction="incoming",ctxSip.newSession(t)}),$("#numDisplay").keypress(function(e){e.which===13&&ctxSip.phoneCallButtonPressed()}),$(".digit").click(function(e){e.preventDefault();var t=$("#numDisplay").val(),n=$(this).data("digit");return $("#numDisplay").val(t+n),ctxSip.sipSendDTMF(n),!1}),$("#phoneUI .dropdown-menu").click(function(e){e.preventDefault()}),$("#phoneUI").delegate(".btnCall","click",function(e){return ctxSip.phoneCallButtonPressed(),!0}),$(".sipLogClear").click(function(e){e.preventDefault(),ctxSip.logClear()}),$("#sip-logitems").delegate(".sip-logitem .btnCall","click",function(e){var t=$(this).closest(".sip-logitem").data("sessionid");return ctxSip.phoneCallButtonPressed(t),!1}),$("#sip-logitems").delegate(".sip-logitem .btnHoldResume","click",function(e){var t=$(this).closest(".sip-logitem").data("sessionid");return ctxSip.phoneHoldButtonPressed(t),!1}),$("#sip-logitems").delegate(".sip-logitem .btnHangUp","click",function(e){var t=$(this).closest(".sip-logitem").data("sessionid");return ctxSip.sipHangUp(t),!1}),$("#sip-logitems").delegate(".sip-logitem .btnTransfer","click",function(e){var t=$(this).closest(".sip-logitem").data("sessionid");return ctxSip.sipTransfer(t),!1}),$("#sip-logitems").delegate(".sip-logitem .btnMute","click",function(e){var t=$(this).closest(".sip-logitem").data("sessionid");return ctxSip.phoneMuteButtonPressed(t),!1}),$("#sip-logitems").delegate(".sip-logitem","dblclick",function(e){e.preventDefault();var t=$(this).data("uri");$("#numDisplay").val(t),ctxSip.phoneCallButtonPressed()}),$("#sldVolume").on("change",function(){var e=$(this).val()/100,t=$("#btnVol"),n=$("#btnVol").find("i"),r=ctxSip.callActiveID;return ctxSip.Sessions[r]&&(ctxSip.Sessions[r].player.volume=e,ctxSip.callVolume=e),$("audio").each(function(){$(this).get()[0].volume=e}),e<.1?(t.removeClass(function(e,t){return(t.match(/(^|\s)btn\S+/g)||[]).join(" ")}).addClass("btn btn-sm btn-danger"),n.removeClass().addClass("fa fa-fw fa-volume-off")):e<.8?(t.removeClass(function(e,t){return(t.match(/(^|\s)btn\S+/g)||[]).join(" ")}).addClass("btn btn-sm btn-info"),n.removeClass().addClass("fa fa-fw fa-volume-down")):(t.removeClass(function(e,t){return(t.match(/(^|\s)btn\S+/g)||[]).join(" ")}).addClass("btn btn-sm btn-primary"),n.removeClass().addClass("fa fa-fw fa-volume-up")),!1}),setTimeout(function(){ctxSip.logShow()},3e3);var e=function(e,t){function n(){return document.createElement("span")}function u(){o||(i=t.startTime,o=setInterval(l,t.delay))}function a(){o&&(clearInterval(o),o=null)}function f(){s=0,c()}function l(){s+=h(),c()}function c(){r.innerHTML=moment(s).format("mm:ss")}function h(){var e=Date.now(),t=e-i;return i=e,t}var r=n(),i,s,o;t=t||{},t.delay=t.delay||1e3,t.startTime=t.startTime||Date.now(),e.appendChild(r),f(),this.start=u,this.stop=a}});