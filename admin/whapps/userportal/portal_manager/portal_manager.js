winkstart.module("userportal","portal_manager",{css:["css/portal_manager.css"],templates:{portal_manager:"tmpl/portal_manager.html",device_line:"tmpl/device_line.html"},subscribe:{"portal_manager.activate":"activate"},validation:[{name:"#vm-to-email-txt",regex:_t("portal_manager","vm_to_email_txt_regex")},{name:"#ring-number-txt",regex:_t("portal_manager","ring_number_txt_regex")}],resources:{"portal_manager.quickcall":{url:"{api_url}/accounts/{account_id}/devices/{device_id}/quickcall/{number}",contentType:"application/json",verb:"GET"},"portal_manager.contact_list":{url:"{api_url}/accounts/{account_id}/contact_list",contentType:"application/json",verb:"GET"},"portal_account.get":{url:"{api_url}/accounts/{account_id}",contentType:"application/json",verb:"GET"},"portal_user.list":{url:"{api_url}/accounts/{account_id}/users",contentType:"application/json",verb:"GET"},"portal_media.list":{url:"{api_url}/accounts/{account_id}/media",contentType:"application/json",verb:"GET"},"user_device.get":{url:"{api_url}/accounts/{account_id}/devices/{device_id}",contentType:"application/json",verb:"GET"},"account_devices.status":{url:"{api_url}/accounts/{account_id}/devices/status",contentType:"application/json",verb:"GET"},"account_devices.list":{url:"{api_url}/accounts/{account_id}/devices",contentType:"application/json",verb:"GET"},"user_device.list":{url:"{api_url}/accounts/{account_id}/devices?filter_owner_id={user_id}",contentType:"application/json",verb:"GET"},"user_settings.get":{url:"{api_url}/accounts/{account_id}/users/{user_id}",contentType:"application/json",verb:"GET"},"user_settings.post":{url:"{api_url}/accounts/{account_id}/users/{user_id}",contentType:"application/json",verb:"POST"},"user_vmbox.list":{url:"{api_url}/accounts/{account_id}/vmboxes",contentType:"application/json",verb:"GET"},"user_vmbox.get":{url:"{api_url}/accounts/{account_id}/vmboxes/{vmbox_id}",contentType:"application/json",verb:"GET"},"user_vmbox.update":{url:"{api_url}/accounts/{account_id}/vmboxes/{vmbox_id}",contentType:"application/json",verb:"POST"},"user_cdr.list":{url:"{api_url}/accounts/{account_id}/users/{user_id}/cdrs?created_from={created_from}&created_to={created_to}",contentType:"application/json",verb:"GET"}}},function(e){var t=this;winkstart.registerResources(t.__whapp,t.config.resources)},{user_cdr_range:7,get_registered_devices:function(e,t){winkstart.request("account_devices.status",{api_url:winkstart.apps.userportal.api_url,account_id:winkstart.apps.userportal.account_id},function(t,n){typeof e=="function"&&e(t)},function(e,n){typeof t=="function"&&t(e)})},get_user_devices:function(e,t){winkstart.request("user_device.list",{api_url:winkstart.apps.userportal.api_url,account_id:winkstart.apps.userportal.account_id,user_id:winkstart.apps.userportal.user_id},function(t,n){typeof e=="function"&&e(t)},function(e,n){typeof t=="function"&&t(e)})},get_vmbox_by_owner:function(e,t,n){winkstart.request("user_vmbox.list",{api_url:winkstart.apps.userportal.api_url,account_id:winkstart.apps.userportal.account_id},function(n,r){var i=[];$.each(n.data,function(){this.owner_id===e&&i.push(this)}),typeof t=="function"&&t({data:i})},function(e,t){typeof n=="function"&&n(e)})},get_vmbox:function(e,t,n){winkstart.request("user_vmbox.get",{api_url:winkstart.apps.userportal.api_url,account_id:winkstart.apps.userportal.account_id,vmbox_id:e},function(e,n){typeof t=="function"&&t(e)},function(e,t){typeof n=="function"&&n(e)})},update_vmbox:function(e,t,n){winkstart.request("user_vmbox.update",{api_url:winkstart.apps.userportal.api_url,account_id:winkstart.apps.userportal.account_id,vmbox_id:e.data.id,data:e.data},function(e,n){typeof t=="function"&&t(e)},winkstart.error_message.process_error())},get_settings:function(e,t){var n=this;winkstart.request("user_settings.get",{api_url:winkstart.apps.userportal.api_url,account_id:winkstart.apps.userportal.account_id,user_id:winkstart.apps.userportal.user_id},function(t,r){t=n.format_settings(t),typeof e=="function"&&e(t)},function(e,n){typeof t=="function"&&t(e)})},update_settings:function(e,t,n){var r=this;r.get_settings(function(i){var s=r.normalize_data($.extend(!0,{},i.data,e));winkstart.request("user_settings.post",{api_url:winkstart.apps.userportal.api_url,account_id:winkstart.apps.userportal.account_id,user_id:winkstart.apps.userportal.user_id,data:s},function(e,n){typeof t=="function"&&t(e)},function(e,t){typeof n=="function"&&n(e)})})},format_settings:function(e){var t=this;return e.data.hasOwnProperty("call_forward")||(e.data.call_forward={}),e},normalize_data:function(e){return e.call_forward.number===""&&delete e.call_forward.number,e},activate:function(e){var t=this;t.render_portal_manager()},render_portal_manager:function(e){var t=this,e=e||$("#ws-content");t.get_settings(function(n){n._t=function(e){return window.translate.portal_manager[e]};var r=t.templates.portal_manager.tmpl(n);t.refresh_list_devices(r),t.setup_page(r),n.data.vm_to_email_enabled||$(".email-field",r).hide(),(!("call_forward"in n.data)||!n.data.call_forward.enabled)&&$("#call-forward-data",r).hide(),e.empty().append(r),$(".dataTables_scrollHeadInner, .dataTables_scrollHeadInner table",r).attr("style","width:100%")})},setup_contact_list_table:function(e,t){var n=this,e=$(".bottom_part",e),t=t||{},r=[{sTitle:_t("portal_manager","name"),sWidth:"300px"},{sTitle:_t("portal_manager","internal_number"),fnRender:function(e){var t="-",n=e.aData[e.iDataColumn];return n!=="-"&&(t='<a class="link-quickcall" data-number="'+n+'">'+n+"</a>"),t},sWidth:"200px"},{sTitle:_t("portal_manager","external_number"),fnRender:function(e){var t="-",n=e.aData[e.iDataColumn];return n!=="-"&&(t='<a class="link-quickcall" data-number="'+n+'">'+n+"</a>"),t},sWidth:"200px"}];winkstart.table.create("contact_list",$("#contact_list_grid",e),r,{},{sDom:'<"contact_title">frtlip',bAutoWidth:!1,aaSorting:[[0,"desc"]]}),$(e).delegate(".link-quickcall","click",function(){var t=$("#device_quickcall",e).val(),n=$(this).data("number");t&&t.length===32?winkstart.request("portal_manager.quickcall",{api_url:winkstart.apps.userportal.api_url,account_id:winkstart.apps.userportal.account_id,device_id:t,number:n},function(e){}):winkstart.alert(_t("portal_manager","you_need_to_select_a_registered_device"))}),$("div.contact_title",e).html('<div class="device-selector">'+_t("portal_manager","quickcall_device")+'<select class="medium" id="device_quickcall"></select><input type="text" id="manual_number" placeholder="2000"></input><button id="quickcall_btn" style="display: none;" class="btn primary">'+_t("portal_manager","call")+"</button></div>"),$("#manual_number",e).keyup(function(){$(this).val()!==""?$("#quickcall_btn",e).show():$("#quickcall_btn",e).hide()}),$("#quickcall_btn",e).click(function(){var t=$("#device_quickcall",e).val(),n=$("#manual_number",e).val();t&&t.length===32?winkstart.request("portal_manager.quickcall",{api_url:winkstart.apps.userportal.api_url,account_id:winkstart.apps.userportal.account_id,device_id:t,number:n},function(e){}):winkstart.alert(_t("portal_manager","you_need_to_select_a_registered_device"))}),$(".cancel-search",e).click(function(){$("#contact_list-grid_filter input[type=text]",e).val(""),winkstart.table.contact_list.fnFilter("")}),winkstart.request(!0,"portal_manager.contact_list",{account_id:winkstart.apps.userportal.account_id,api_url:winkstart.apps.userportal.api_url},function(e,t){if(e.data){$.fn.dataTableExt.afnFiltering.pop();var n=[];$.each(e.data,function(e,t){n.push([t.name,t.internal_number?t.internal_number:"-",t.external_number?t.external_number:"-"])}),winkstart.table.contact_list.fnAddData(n)}})},setup_page:function(e){var t=this,n=e;$("#ring-number-txt",n).keyup(function(){$(this).val()===""?($(".device-field",n).slideUp(),$("#ring-device-checkbox",n).removeAttr("checked")):($(".device-field",n).slideDown(),$("#ring-device-checkbox",n).attr("checked","checked"))}),$("#vm-to-email-checkbox",n).change(function(){$("#vm-to-email-checkbox",n).attr("checked")?$(".email-field",n).slideDown():$(".email-field",n).slideUp()}),$("#call-forward-enabled",n).change(function(){$("#call-forward-enabled",n).attr("checked")?$("#call-forward-data",n).slideDown():$("#call-forward-data",n).slideUp()}),$("#contact_list_btn",n).click(function(e){e.preventDefault(),t.popup_contact_list()}),$("#save-settings-link",n).click(function(e){e.preventDefault();var r=$("#ring-number-txt",n).val();r.match(/^[\+]?[0-9\s\-\.\(\)]{7,20}$/)&&(r=r.replace(/\s|\(|\)|\-|\./g,""));var i=$("#call-forward-enabled",n).attr("checked"),s={vm_to_email_enabled:!1,call_forward:{number:r,enabled:i&&r!==""?!0:!1,substitute:$("#ring-device-checkbox",n).attr("checked")?!1:!0,keep_caller_id:$("#call_forward_keep_caller_id",n).attr("checked")?!0:!1}};$("#vm-to-email-checkbox",n).attr("checked")&&(s.vm_to_email_enabled=!0,s.email=$("#vm-to-email-txt",n).val()),t.update_settings(s,function(){t.render_portal_manager()})}),t.setup_voicemail_table(e),t.setup_cdr_table(e),t.setup_contact_list_table(e)},refresh_list_devices:function(e){var t=this,n=e,r={cellphone:"Cell",smartphone:"Smartphone",fax:"Fax",sip_device:"VoIP",softphone:"Softphone",landline:"Landline"};t.get_registered_devices(function(e){t.get_user_devices(function(i){$(".list_devices",n).html('<div class="clear"/>'),$("#device_quickcall",n).empty();var s,o={};$.each(e.data,function(e,t){o[t.device_id]=!0}),$.each(i.data,function(e,i){i.registered=i.id in o||$.inArray(i.device_type,["cellphone","smartphone","landline"])>-1?"registered":"unregistered",s={status:i.registered,name:i.name,device_type:i.device_type,friendly_type:r[i.device_type],id:i.id},i.registered==="registered"&&$("#device_quickcall",n).append('<option value="'+i.id+'">'+i.name+"</option>"),$(".list_devices",n).prepend(t.templates.device_line.tmpl(s))})})})},setup_cdr_table:function(e){var t=e,n=this,r=n.user_cdr_range,i=[{sTitle:_t("portal_manager","date"),sWidth:"250px"},{sTitle:_t("portal_manager","from_caller_id"),sWidth:"350px"},{sTitle:_t("portal_manager","to_dialed_number"),sWidth:"350px"},{sTitle:_t("portal_manager","duration"),sWidth:"160px"},{sTitle:"billing_seconds",bVisible:!1}];winkstart.table.create("user_cdr",$("#user_cdr-grid",t),i,{},{sDom:'<"date">frtlip',sScrollY:"150px",aaSorting:[[0,"desc"]]}),$.fn.dataTableExt.afnFiltering.pop(),$("div.date",t).html(_t("portal_manager","start_date")+': <input id="startDate" readonly="readonly" type="text"/>&nbsp;&nbsp;'+_t("portal_manager","end_date")+': <input id="endDate" readonly="readonly" type="text"/>&nbsp;&nbsp;&nbsp;&nbsp;<button class="button-search btn primary" id="searchLink" href="javascript:void(0);">'+_t("portal_manager","filter")+'</button><label class="call_duration"/>');var s=$("#user_cdr-grid_wrapper .call_duration",t);$("#user_cdr-grid_wrapper #user_cdr-grid_filter input[type=text]",t).keyup(function(){$(this).val!==""?s.hide():s.show()}),$("#searchLink",t).click(function(){var e=$("#startDate",t).val(),i=$("#endDate",t).val(),s=/^(0[1-9]|1[012])[- \/.](0[1-9]|[12][0-9]|3[01])[- \/.](19|20)\d\d$/;winkstart.table.user_cdr.fnClearTable(),$("#user_cdr-grid_wrapper .call_duration",t).text("");if(e.match(s)&&i.match(s)){var o=(new Date(e)).getTime()/1e3+62167219200,u=(new Date(i)).getTime()/1e3+62167219200;u-o<=r*24*60*60?n.list_by_date(o,u):winkstart.alert(_t("portal_manager","the_range_is_bigger_than")+r+_t("portal_manager","days_please_correct_it"))}else winkstart.alert(_t("portal_manager","dates_in_the_filter"))}),n.init_datepicker(t);var o=new Date(n.to_string_date(new Date));o.setDate(o.getDate()+1);var u=Math.floor(o.getTime()/1e3)+62167219200,a=u-r*24*60*60;n.list_by_date(a,u)},init_datepicker:function(e){function f(e,n){var s,o;if(n.id=="startDate"){s=r.datepicker("getDate");if(i.datepicker("getDate")==null)o=s,o.setDate(s.getDate()+a),i.val(t.to_string_date(o));else{o=i.datepicker("getDate");if(o>(new Date(s)).setDate(s.getDate()+a)||o<=s)o=s,o.setDate(o.getDate()+a),o>u?o=u:!0,i.val(t.to_string_date(o))}}else n.id=="endDate"&&r.datepicker("getDate")==null&&(s=i.datepicker("getDate"),s.setDate(s.getDate()-1),r.val(t.to_string_date(s)))}function l(e){var n=new Date(2011,0,0),i,s=t.user_cdr_range;return e.id=="endDate"?(i=u,r.datepicker("getDate")!=null&&(n=r.datepicker("getDate"),n.setDate(n.getDate()+1),i=r.datepicker("getDate"),i.setDate(i.getDate()+s),i>u&&(i=u))):e.id=="startDate"&&(i=new Date),{minDate:n,maxDate:i}}var t=this,n=e,r=$("#startDate",n),i=$("#endDate",n),s=new Date,o,u=new Date,a=t.user_cdr_range;u.setDate(u.getDate()+1),$("#startDate, #endDate",n).datepicker({beforeShow:l,onSelect:f}),o=u,s.setDate((new Date).getDate()-a+1),r.datepicker("setDate",s),i.datepicker("setDate",o)},to_string_date:function(e){var t=e.getDate(),n=e.getMonth()+1,r=e.getFullYear();return t<10?t="0"+t:!0,n<10?n="0"+n:!0,n+"/"+t+"/"+r},friendly_date:function(e){var t="-";if(e){var n=new Date,r=n.getFullYear(),i=n.getMonth()+1<10?"0"+(n.getMonth()+1):n.getMonth()+1,s=n.getDate()<10?"0"+n.getDate():n.getDate(),o=new Date((e-62167219200)*1e3),u=o.getMonth()+1,a=o.getFullYear(),f=o.getDate(),l=o.getHours(),c=o.getMinutes();l>=12?(l!==12&&(l-=12),suffix="pm"):(l===0&&(l=12),suffix="am"),f=f<10?"0"+f:f,u=u<10?"0"+u:u,l=l<10?"0"+l:l,c=c<10?"0"+c:c;var h=a!=(new Date).getFullYear()?u+"/"+f+"/"+a:u+"/"+f,p=l+":"+c+suffix;r===a&&i===u&&s===f&&(h="Today"),t=h+" "+p}return t},list_by_date:function(e,t){var n=this,r=function(e,t){var e=parseFloat(e);return seconds=e%60,minutes=(e-seconds)/60%60,hours=Math.floor((e-seconds)/3600),t=t||"numbers",hours<10&&t=="numbers"&&(hours="0"+hours),minutes<10&&(minutes="0"+minutes),seconds<10&&(seconds="0"+seconds),t=="verbose"?e=hours+" hours "+minutes+" minutes and "+seconds+" seconds":e=hours!="00"?hours+":"+minutes+":"+seconds:minutes+":"+seconds,e};winkstart.request("user_cdr.list",{account_id:winkstart.apps.userportal.account_id,api_url:winkstart.apps.userportal.api_url,user_id:winkstart.apps.userportal.user_id,created_from:e,created_to:t},function(e,t){var i,s,o=0,u=[];$.each(e.data,function(){this.duration_seconds>0&&(i=this.duration_seconds>=0?r(this.duration_seconds):"--",s=n.friendly_date(this.timestamp),o+=this.duration_seconds>=0?parseFloat(this.duration_seconds):0,u.push([s,this.caller_id_number===this.caller_id_name?this.caller_id_number||"(empty)":this.caller_id_number+" ("+this.caller_id_name+")",this.callee_id_number===this.callee_id_name?this.callee_id_number||this.to.substring(0,this.to.indexOf("@")!=-1?this.to.indexOf("@"):this.to.length)||"(empty)":this.callee_id_number+" ("+this.callee_id_name+")",i||"-",this.duration_seconds,this.timestamp]))}),o="Total duration : "+r(o,"verbose"),winkstart.table.user_cdr.fnAddData(u),$(".dataTables_scrollHeadInner, .dataTables_scrollHeadInner table").attr("style","width:100%")})},setup_voicemail_table:function(e){var t=this,n=[{sTitle:'<input type="checkbox" id="select_all_voicemails"/>',sWidth:"40px",bSortable:!1,fnRender:function(e){var t=e.aData[e.iDataColumn];return'<input type="checkbox" class="select-checkbox" msg_uri="'+t+'"/>'}},{sTitle:_t("portal_manager","message_index"),bSearchable:!1,bVisible:!1},{sTitle:_t("portal_manager","voicemail_box_id"),bSearchable:!1,bVisible:!1},{sTitle:_t("portal_manager","date"),sWidth:"220px",iDataSort:7},{sTitle:_t("portal_manager","caller_id"),sWidth:"150px"},{sTitle:_t("portal_manager","status"),sWidth:"130px"},{sTitle:_t("portal_manager","listen"),bSortable:!1,sWidth:"200px",fnRender:function(e){var n=e.aData[e.iDataColumn];return'<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="105" height="19"><param name="quality" value="high" /><param name="wmode" value="transparent"><param name="menu" value="false" /><embed src="whapps/userportal/portal_manager/assets/flash/xspf_player.swf?player_mode=mini&skin_mode=on&song_url='+t.voicemail_uri(n)+'&song_title=VM&autoload=1&bg_color=595959&txt_color=BCB5AB&button_color=BCB5AB"type="application/x-shockwave-flash" width="105" height="17"></embed>'+'</object><a style="position:relative; top: -10px;" href="'+t.voicemail_uri(n)+'"><span class="icon medium download" alt="Download"/></a>'}},{sTitle:"timestamp",bSearchable:!1,bVisible:!1}];winkstart.table.create("voicemail",$("#voicemail-grid",e),n,{},{sDom:'<"actions_voicemail">frtlip',sScrollY:"150px",aaSorting:[[3,"desc"]]}),$.fn.dataTableExt.afnFiltering.pop(),$("div.actions_voicemail",e).html('<button id="new-voicemail-link" class="btn primary" data-action="new">'+_t("portal_manager","mark_as_new")+'</button><button id="save-voicemail-link" class="btn success" data-action="saved">'+_t("portal_manager","mark_as_saved")+'</button><button id="delete-voicemail-link" class="btn danger" data-action="deleted">'+_t("portal_manager","delete")+"</button>"),$("#save-voicemail-link, #delete-voicemail-link, #new-voicemail-link",e).click(function(n){n.preventDefault();var r,i=$(this).dataset("action");if($(".select-checkbox:checked",e).size()){var s=function(){r={},$(".select-checkbox:checked",e).each(function(){var e=$(this).parents("tr")[0],t=winkstart.table.voicemail.fnGetData(e,2);r[t]?r[t].push(e):r[t]=[e]}),$.each(r,function(n,r){t.get_vmbox(n,function(n){var s;if(n.data.messages==undefined)return!1;$.each(r,function(e,t){s=winkstart.table.voicemail.fnGetData(t,1),$.inArray(i,["saved","deleted","new"])>-1&&(n.data.messages[s].folder=i)}),t.update_vmbox(n,function(){$.each(r,function(e,t){$.inArray(i,["saved","new"])>-1?winkstart.table.voicemail.fnUpdate(i,t,5):i=="deleted"&&winkstart.table.voicemail.fnDeleteRow(t)}),$(".select-checkbox, #select_all_voicemails",e).prop("checked",!1)})})})};i==="delete"?winkstart.confirm(_t("portal_manager","are_you_sure_that_you_want_to_delete"),function(){s()}):s()}}),$("#select_all_voicemails",e).change(function(){$(".select-checkbox",e).prop("checked",$(this).is(":checked"))}),t.get_vmbox_by_owner(winkstart.apps.userportal.user_id,function(n){if(n.data.length>0){var r=n.data[0].id;t.get_vmbox(r,function(n){if(n.data.messages){var i=[];$.each(n.data.messages,function(e,n){if(this.folder!="deleted"){var s=n.media_id,o=r+"/messages/"+s,u=new Date((n.timestamp-62167219200)*1e3),a=u.getMonth()+1,f=u.getFullYear()%100,l=u.getDate(),c=a+"/"+l+"/"+f,h=u.toLocaleTimeString(),p=c+" "+h;p=t.friendly_date(n.timestamp),i.push(["0",e,r,p,n.caller_id_number,n.folder,o,n.timestamp])}}),winkstart.table.voicemail.fnAddData(i),$(".dataTables_scrollHeadInner, .dataTables_scrollHeadInner table",e).attr("style","width:100%")}})}})},voicemail_uri:function(e){return winkstart.apps.userportal.api_url+"/accounts/"+winkstart.apps.userportal.account_id+"/vmboxes/"+e+"/raw?auth_token="+winkstart.apps.userportal.auth_token+"&folder=saved"}});