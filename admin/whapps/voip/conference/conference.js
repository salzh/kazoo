winkstart.module("voip","conference",{css:["css/style.css"],templates:{conference:"tmpl/conference.html",edit:"tmpl/edit.html",conference_callflow:"tmpl/conference_callflow.html"},subscribe:{"conference.activate":"activate","conference.edit":"edit_conference","callflow.define_callflow_nodes":"define_callflow_nodes","conference.popup_edit":"popup_edit_conference"},resources:{"conference.list":{url:"{api_url}/accounts/{account_id}/conferences",contentType:"application/json",verb:"GET"},"conference.get":{url:"{api_url}/accounts/{account_id}/conferences/{conference_id}",contentType:"application/json",verb:"GET"},"conference.create":{url:"{api_url}/accounts/{account_id}/conferences",contentType:"application/json",verb:"PUT"},"conference.update":{url:"{api_url}/accounts/{account_id}/conferences/{conference_id}",contentType:"application/json",verb:"POST"},"conference.delete":{url:"{api_url}/accounts/{account_id}/conferences/{conference_id}",contentType:"application/json",verb:"DELETE"},"user.list":{url:"{api_url}/accounts/{account_id}/users",contentType:"application/json",verb:"GET"}},validation:[{name:"#name",regex:/^.+$/},{name:"#member_pins_string",regex:_t("conference","member_pins_string_regex")},{name:"#member_numbers_string",regex:/^[0-9,\s]*$/}]},function(e){var t=this;winkstart.registerResources(this.__whapp,this.config.resources),winkstart.publish("whappnav.subnav.add",{whapp:"voip",module:this.__module,label:_t("conference","conferences_label"),icon:"conference",weight:"05",category:_t("config","advanced_menu_cat")})},{letters_to_numbers:function(e){var t="";return $.each(e.split(""),function(e,n){n.match(/^[aAbBcC]$/)?t+="2":n.match(/^[dDeEfF]$/)?t+="3":n.match(/^[gGhHiI]$/)?t+="4":n.match(/^[jJkKlL]$/)?t+="5":n.match(/^[mMnNoO]$/)?t+="6":n.match(/^[pPqQrRsS]$/)?t+="7":n.match(/^[tTuUvV]$/)?t+="8":n.match(/^[wWxXyYzZ]$/)?t+="9":t+=n}),t},fix_arrays:function(e,t){var n=this;return"member"in t&&"numbers"in t.member&&(e.member.numbers=t.member.numbers),e},save_conference:function(e,t,n,r){var i=this,s=i.fix_arrays(i.normalize_data($.extend(!0,{},t.data,e)),e);typeof t.data=="object"&&t.data.id?winkstart.request(!0,"conference.update",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,conference_id:t.data.id,data:s},function(e,t){typeof n=="function"&&n(e,t,"update")},function(e,t){typeof r=="function"&&r(e,t,"update")}):winkstart.request(!0,"conference.create",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,data:s},function(e,t){typeof n=="function"&&n(e,t,"create")},function(e,t){typeof r=="function"&&r(e,t,"create")})},edit_conference:function(e,t,n,r,i){var s=this,o=t||$("#conference-content"),u=n||$("#conference-view",o),r=r||{},a={save_success:r.save_success||function(e){s.render_list(o),s.edit_conference({id:e.data.id},o,u,a)},save_error:r.save_error,delete_success:r.delete_success||function(){u.empty(),s.render_list(o)},delete_error:r.delete_error,after_render:r.after_render},f={data:$.extend(!0,{member:{},play_entry_tone:!0,play_exit_tone:!0},i||{}),field_data:{users:[]}};winkstart.parallel({user_list:function(e){winkstart.request(!0,"user.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){t.data.unshift({id:"",first_name:"- No",last_name:"owner -"}),f.field_data.users=t.data,e(null,t)})},get_conference:function(t){typeof e=="object"&&e.id?winkstart.request(!0,"conference.get",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,conference_id:e.id},function(e,n){s.migrate_data(e),s.format_data(e),t(null,e)}):t(null,{})}},function(t,n){var r=f;typeof e=="object"&&e.id&&(r=$.extend(!0,f,n.get_conference)),s.render_conference(r,u,a),typeof a.after_render=="function"&&a.after_render()})},delete_conference:function(e,t,n){var r=this;e.data.id&&winkstart.request(!0,"conference.delete",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,conference_id:e.data.id},function(e,n){typeof t=="function"&&t(e,n)},function(e,t){typeof n=="function"&&n(e,t)})},render_conference:function(e,t,n){e._t=function(e){return window.translate.conference[e]};var r=this,i=r.templates.edit.tmpl(e);winkstart.validate.set(r.config.validation,i),$('*[rel=popover]:not([type="text"])',i).popover({trigger:"hover"}),$('*[rel=popover][type="text"]',i).popover({trigger:"focus"}),winkstart.tabs($(".view-buttons",i),$(".tabs",i)),$("#owner_id",i).val()||$("#edit_link",i).hide(),$("#owner_id",i).change(function(){$("#owner_id option:selected",i).val()?$("#edit_link",i).show():$("#edit_link",i).hide()}),$(".inline_action",i).click(function(e){var t=$(this).dataset("action")=="edit"?{id:$("#owner_id",i).val()}:{},n=t.id;e.preventDefault(),winkstart.publish("user.popup_edit",t,function(e){n?"id"in e.data?$("#owner_id #"+e.data.id,i).text(e.data.first_name+" "+e.data.last_name):($("#owner_id #"+n,i).remove(),$("#edit_link",i).hide()):($("#owner_id",i).append('<option id="'+e.data.id+'" value="'+e.data.id+'">'+e.data.first_name+" "+e.data.last_name+"</option>"),$("#owner_id",i).val(e.data.id),$("#edit_link",i).show())})}),$(".conference-save",i).click(function(t){t.preventDefault(),winkstart.validate.is_valid(r.config.validation,i,function(){var t=form2object("conference-form");r.clean_form_data(t),e.data.member.pins=t.member.pins,"field_data"in e&&delete e.field_data,r.save_conference(t,e,n.save_success,winkstart.error_message.process_error(n.save_error))},function(){winkstart.alert(_t("conference","there_were_errors_on_the_form"))})}),$(".conference-delete",i).click(function(t){t.preventDefault(),winkstart.confirm(_t("conference","are_you_sure_you_want_to_delete"),function(){r.delete_conference(e,n.delete_success,n.delete_error)})}),t.empty().append(i)},migrate_data:function(e){return $.isArray(e.data.conference_numbers)&&(e.data.member.numbers==undefined&&(e.data.member.numbers=e.data.conference_numbers),delete e.data.conference_numbers),e.data.member_play_name&&(e.data.play_name_on_join==undefined&&(e.data.play_name_on_join=e.data.member_play_name),delete e.data.member_play_name),e.data.member_join_muted&&(e.data.member.join_muted==undefined&&(e.data.member.join_muted=e.data.member_join_muted),delete e.data.member_join_muted),e.data.member_join_deaf&&(e.data.member.join_deaf==undefined&&(e.data.member.join_deaf=e.data.member_join_deaf),delete e.data.member_join_deaf),e},format_data:function(e){return typeof e.data.member=="object"&&($.isArray(e.data.member.pins)&&(e.data.member.pins_string=e.data.member.pins.join(", ")),$.isArray(e.data.member.numbers)&&(e.data.member.numbers_string=e.data.member.numbers.join(", "))),e},normalize_data:function(e){return e.member.pins.length||delete e.member.pins,e.member.numbers.length||delete e.member.numbers,e.owner_id||delete e.owner_id,delete e.member.pins_string,delete e.member.numbers_string,e},clean_form_data:function(e){var t=this;return e.member.pins_string=t.letters_to_numbers(e.member.pins_string),e.member.pins=$.map(e.member.pins_string.split(","),function(e){var t=$.trim(e);return t!=""?t:null}),e.member.numbers=$.map(e.member.numbers_string.split(","),function(e){var t=$.trim(e);return t!=""?t:null}),e},render_list:function(e){var t=this;winkstart.request(!0,"conference.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){var r=function(e){var t=[];return e.length>0&&$.each(e,function(e,n){t.push({id:n.id,title:n.name||_t("conference","name")})}),t.sort(function(e,t){return e.title.toLowerCase()<t.title.toLowerCase()?-1:1}),t};$("#conference-listpanel",e).empty().listpanel({label:_t("conference","conferences_label"),identifier:"conference-listview",new_entity_label:_t("conference","add_conference_label"),data:r(t.data),publisher:winkstart.publish,notifyMethod:"conference.edit",notifyCreateMethod:"conference.edit",notifyParent:e})})},activate:function(e){var t=this,n=t.templates.conference.tmpl();(e||$("#ws-content")).empty().append(n),t.render_list(n)},popup_edit_conference:function(e,t,n){var r,i;i=$('<div class="inline_popup"><div class="inline_content main_content"/></div>'),winkstart.publish("conference.edit",e,i,$(".inline_content",i),{save_success:function(e){r.dialog("close"),typeof t=="function"&&t(e)},delete_success:function(){r.dialog("close"),typeof t=="function"&&t({data:{}})},after_render:function(){r=winkstart.dialog(i,{title:e.id?_t("conference","edit_conference"):_t("conference","create_conference")})}},n)},define_callflow_nodes:function(e){var t=this;$.extend(e,{"conference[id=*]":{name:_t("conference","conference"),icon:"conference",category:_t("config","basic_cat"),module:"conference",tip:_t("conference","conference_tip"),data:{id:"null"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",caption:function(e,t){var n=e.getMetadata("id"),r="";return n in t&&(r=t[n].name),r},edit:function(e,n){var r=this;winkstart.request(!0,"conference.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(r,i){var s,o;o=t.templates.conference_callflow.tmpl({_t:function(e){return window.translate.conference[e]},items:winkstart.sort(r.data),selected:e.getMetadata("id")||"!"}),$("#conference_selector option:selected",o).val()==undefined&&$("#edit_link",o).hide(),$(".inline_action",o).click(function(t){var n=$(this).dataset("action")=="edit"?{id:$("#conference_selector",o).val()}:{};t.preventDefault(),winkstart.publish("conference.popup_edit",n,function(t){e.setMetadata("id",t.data.id||"null"),e.caption=t.data.name||"",s.dialog("close")})}),$("#add",o).click(function(){e.setMetadata("id",$("#conference_selector",o).val()),e.caption=$("#conference_selector option:selected",o).text(),s.dialog("close")}),s=winkstart.dialog(o,{title:_t("conference","conference"),minHeight:"0",beforeClose:function(){typeof n=="function"&&n()}})})}},"conference[]":{name:_t("conference","conference_service"),icon:"conference",category:_t("config","advanced_cat"),module:"conference",tip:_t("conference","conference_service_tip"),data:{},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",caption:function(e){return""},edit:function(e,t){typeof t=="function"&&t()}}})}});