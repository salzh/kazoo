winkstart.module("voip","faxbox",{css:["css/faxbox.css"],templates:{faxbox_callflow:"tmpl/faxbox_callflow.html",faxbox:"tmpl/faxbox.html",edit:"tmpl/edit.html"},subscribe:{"callflow.define_callflow_nodes":"define_callflow_nodes","faxbox.popup_edit":"popup_edit_faxbox","faxbox.activate":"activate","faxbox.edit":"edit_faxbox"},validation:[],resources:{"faxbox.list":{url:"{api_url}/accounts/{account_id}/faxboxes",contentType:"application/json",verb:"GET"},"faxbox.get":{url:"{api_url}/accounts/{account_id}/faxboxes/{faxbox_id}",contentType:"application/json",verb:"GET"},"faxbox.create":{url:"{api_url}/accounts/{account_id}/faxboxes",contentType:"application/json",verb:"PUT"},"faxbox.update":{url:"{api_url}/accounts/{account_id}/faxboxes/{faxbox_id}",contentType:"application/json",verb:"POST"},"faxbox.delete":{url:"{api_url}/accounts/{account_id}/faxboxes/{faxbox_id}",contentType:"application/json",verb:"DELETE"},"user.get":{url:"{api_url}/accounts/{account_id}/users/{user_id}",contentType:"application/json",verb:"GET"},"user.list":{url:"{api_url}/accounts/{account_id}/users",contentType:"application/json",verb:"GET"}}},function(e){var t=this;winkstart.registerResources(t.__whapp,t.config.resources),winkstart.publish("whappnav.subnav.add",{whapp:"voip",module:t.__module,label:_t("faxbox","faxboxes_label"),icon:"printer2",weight:"35",category:_t("config","advanced_menu_cat")})},{render_list:function(e){var t=this;winkstart.request(!0,"faxbox.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){var r=function(e){var t=[];return e.length>0&&$.each(e,function(e,n){t.push({id:n.id,title:n.name||_t("faxbox","no_name")})}),t.sort(function(e,t){return e.title.toLowerCase()<t.title.toLowerCase()?-1:1}),t};$("#faxbox-listpanel",e).empty().listpanel({label:_t("faxbox","faxbox_label"),identifier:"faxbox-listview",new_entity_label:_t("faxbox","add_faxbox_label"),data:r(t.data),publisher:winkstart.publish,notifyMethod:"faxbox.edit",notifyCreateMethod:"faxbox.edit",notifyParent:e})})},render_faxbox:function(e,t,n){var r=this,i=r.templates.edit.tmpl({faxbox:r.normalized_data(e.faxbox),users:e.user_list,_t:function(e){return window.translate.faxbox[e]}});winkstart.timezone.populate_dropdown($("#fax_timezone",i),e.faxbox.fax_timezone),$('*[rel=popover]:not([type="text"])',i).popover({trigger:"hover"}),$('*[rel=popover][type="text"]',i).popover({trigger:"focus"}),winkstart.tabs($(".view-buttons",i),$(".tabs",i)),e.faxbox.hasOwnProperty("id")?$("#owner_id",i).change(function(s){var o=form2object("faxbox-form");$(this).val()?($('[id$="bound_notification_email"]',i).each(function(e,t){$(t).attr("disabled",!0)}),winkstart.request(!0,"user.get",{account_id:winkstart.apps.voip.account_id,user_id:$(this).val(),api_url:winkstart.apps.voip.api_url},function(s,u){e.faxbox=$.extend(!0,{},r.get_default_faxbox(),e.faxbox,o,{cloud_connector_claim_url:i.find("#cloud_connector_claim_url").attr("href"),notifications:{inbound:{email:{send_to:s.data.email||s.data.username}},outbound:{email:{send_to:s.data.email||s.data.username}}}}),$("#edit_link",i).hide(),r.render_faxbox(e,t,n)})):$('[id$="bound_notification_email"]',i).each(function(e,t){$(t).attr("disabled",!1)})}):$("#owner_id",i).change(function(s){$(this).val()?winkstart.request(!0,"user.get",{account_id:winkstart.apps.voip.account_id,user_id:$(this).val(),api_url:winkstart.apps.voip.api_url},function(s,o){e.faxbox=r.get_default_faxbox(s.data),$("#edit_link",i).show(),r.render_faxbox(e,t,n)}):(e.faxbox=r.get_default_faxbox(),$("#edit_link",i).hide(),r.render_faxbox(e,t,n))}),$("#owner_id",i).val()||$("#edit_link",i).hide(),$(".inline-action",i).click(function(e){var t=$(this).dataset("action")=="edit"?{id:$("#owner_id",i).val()}:{},n=t.id;winkstart.publish("user.popup_edit",t,function(e){n?"id"in e.data?$("#owner_id #"+e.data.id,i).text(e.data.first_name+" "+e.data.last_name):$("#owner_id #"+n,i).remove():($("#owner_id",i).append('<option id="'+e.data.id+'" value="'+e.data.id+'">'+e.data.first_name+" "+e.data.last_name+"</option>"),$("#owner_id",i).val(e.data.id))})}),$("#caller_id",i).change(function(e){var t=$(this).val(),n=$("#fax_identity",i);/^(\+1|1)([0-9]{10})$|^([0-9]{10})$/.test(t)?/^(\+1)/.test(t)?n.val(t.replace(/^\+1([0-9]{3})([0-9]{3})([0-9]{4})$/,"+1 ($1) $2-$3")):/^1([0-9]{10})$/.test(t)?n.val(t.replace(/^1([0-9]{3})([0-9]{3})([0-9]{4})$/,"+1 ($1) $2-$3")):n.val(t.replace(/^([0-9]{3})([0-9]{3})([0-9]{4})$/,"+1 ($1) $2-$3")):n.val("")}),$(".faxbox-save",i).click(function(t){t.preventDefault();var i=form2object("faxbox-form");r.save_faxbox(i,e.faxbox,n.save_success,winkstart.error_message.process_error(n.save_error))}),$(".faxbox-delete",i).click(function(t){t.preventDefault(),winkstart.confirm(_t("faxbox","are_you_sure_you_want_to_delete"),function(){r.delete_faxbox(e.faxbox,n.delete_success,n.delete_error)})}),t.empty().append(i)},activate:function(e){var t=this,n=t.templates.faxbox.tmpl();(e||$("#ws-content")).empty().append(n),t.render_list(n)},save_faxbox:function(e,t,n,r){var i=this,s=i.normalized_data($.extend(!0,{},t,e));typeof t=="object"&&t.id?winkstart.request(!0,"faxbox.update",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,faxbox_id:t.id,data:s},function(e,t){typeof n=="function"&&n(e,t,"update")},function(e,t){typeof r=="function"&&r(e,t,"update")}):winkstart.request(!0,"faxbox.create",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,data:s},function(e,t){typeof n=="function"&&n(e,t,"create")},function(e,t){typeof r=="function"&&r(e,t,"create")})},edit_faxbox:function(e,t,n,r){var i=this,s=t||$("#faxbox-content"),o=n||$("#faxbox-view",s),r=r||{},u={save_success:r.save_success||function(e){i.render_list(s),i.edit_faxbox({id:e.data.id},s,o,u)},save_error:r.save_error,delete_success:r.delete_success||function(){o.empty(),i.render_list(s)},delete_error:r.delete_error,after_render:r.after_render};winkstart.parallel({faxbox:function(t){typeof e=="object"&&e.id?winkstart.request(!0,"faxbox.get",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,faxbox_id:e.id},function(n,r){n.data.id=e.id,t(null,n.data)}):t(null,{})},user_list:function(e){winkstart.request(!0,"user.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){t.data.sort(function(e,t){return e.first_name.concat(" ",e.last_name).toLowerCase()>t.first_name.concat(" ",t.last_name).toLowerCase()?1:-1}),t.data.unshift({id:"",first_name:_t("faxbox","no"),last_name:_t("faxbox","owner")}),e(null,t.data)})},current_user:function(e){winkstart.apps.auth.account_id===winkstart.apps.voip.account_id?winkstart.request(!0,"user.get",{account_id:winkstart.apps.voip.account_id,user_id:winkstart.apps.voip.user_id,api_url:winkstart.apps.voip.api_url},function(t,n){e(null,t.data)}):e(null,{})}},function(t,n){e.hasOwnProperty("id")||(Object.keys(n.current_user).length===0?n.faxbox=$.extend(!0,i.get_default_faxbox(),n.faxbox):n.faxbox=$.extend(!0,i.get_default_faxbox(n.current_user),n.faxbox)),delete n.current_user,i.render_faxbox(n,o,u),typeof u.after_render=="function"&&u.after_render()})},delete_faxbox:function(e,t,n){var r=this;typeof e=="object"&&e.id&&winkstart.request(!0,"faxbox.delete",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,faxbox_id:e.id},function(e,n){typeof t=="function"&&t(e,n)},function(e,t){typeof n=="function"&&n(e,t)})},normalized_data:function(e){if(e.hasOwnProperty("notifications")){var t=e.notifications.inbound.email.send_to,n=e.notifications.outbound.email.send_to;e.notifications.inbound.email.send_to=t instanceof Array?t.join(" "):t.split(" "),e.notifications.outbound.email.send_to=n instanceof Array?n.join(" "):n.split(" ")}if(e.hasOwnProperty("smtp_permission_list"))if(e.smtp_permission_list==="")delete e.smtp_permission_list;else{var r=e.smtp_permission_list;e.smtp_permission_list=r instanceof Array?r.join(" "):r.split(" ")}return e.hasOwnProperty("custom_smtp_address")&&e.custom_smtp_address===""&&delete e.custom_smtp_address,e.hasOwnProperty("owner_id")&&e.owner_id===""&&delete e.owner_id,e},get_default_faxbox:function(e){var t={name:"",caller_name:"",fax_header:"",fax_timezone:"",retries:1,notifications:{inbound:{email:{send_to:""}},outbound:{email:{send_to:""}}}};return typeof e=="undefined"?t:$.extend(!0,{},t,{name:e.first_name.concat(" ",e.last_name,_t("faxbox","default_settings_name_extension")),caller_name:e.first_name.concat(" ",e.last_name),fax_header:winkstart.config.company_name.concat(_t("faxbox","default_settings_header_extension")),fax_timezone:e.timezone,owner_id:e.id,notifications:{inbound:{email:{send_to:e.email||e.username}},outbound:{email:{send_to:e.email||e.username}}}})},popup_edit_faxbox:function(e,t,n){var r,i;i=$('<div class="inline_popup"><div class="inline_content main_content"/></div>'),winkstart.publish("faxbox.edit",e,i,$(".inline_content",i),{save_success:function(e){r.dialog("close"),typeof t=="function"&&t(e)},delete_success:function(){r.dialog("close"),typeof t=="function"&&t({data:{}})},after_render:function(){r=winkstart.dialog(i,{title:_t("faxbox",(e.id?"edit":"create").concat("_faxbox"))})}},n)},define_callflow_nodes:function(e){var t=this;$.extend(e,{"faxbox[id=*]":{name:_t("faxbox","faxboxes_label"),icon:"printer2",category:_t("config","advanced_cat"),module:"faxbox",tip:_t("faxbox","faxbox_tip"),data:{},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",caption:function(e,t){var n=e.getMetadata("id"),r="";return n in t&&(r=t[n].name),r},edit:function(e,n){var r=this;winkstart.request(!0,"faxbox.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(r,i){var s,o;o=t.templates.faxbox_callflow.tmpl({_t:function(e){return window.translate.faxbox[e]},items:winkstart.sort(r.data),selected:e.getMetadata("id")||""}),$("#faxbox_selector option:selected",o).val()==undefined&&$("#edit_link",o).hide(),$(".inline_action",o).click(function(t){var n=$(this).dataset("action")=="edit"?{id:$("#faxbox_selector",o).val()}:{};t.preventDefault(),winkstart.publish("faxbox.popup_edit",n,function(t){e.setMetadata("id",t.data.id||"null"),e.caption=t.data.name||"",s.dialog("close")})}),$("#add",o).click(function(){e.setMetadata("id",$("#faxbox_selector",o).val()),e.caption=$("#faxbox_selector option:selected",o).text(),s.dialog("close")}),s=winkstart.dialog(o,{title:_t("faxbox","voicemail_title"),minHeight:"0",beforeClose:function(){typeof n=="function"&&n()}})})}}})}});