winkstart.module("voip","queue",{css:["css/queue.css"],templates:{queue:"tmpl/queue.html",edit:"tmpl/edit.html",queue_callflow:"tmpl/queue_callflow.html",user_row:"tmpl/user_row.html"},subscribe:{"queue.activate":"activate","queue.edit":"edit_queue","callflow.define_callflow_nodes":"define_callflow_nodes","queue.popup_edit":"popup_edit_queue"},validation:[{name:"#name",regex:/^.*/},{name:"#connection_timeout",regex:/^[0-9]+$/},{name:"#member_timeout",regex:/^[0-9]+$/}],resources:{"queue.list":{url:"{api_url}/accounts/{account_id}/queues",contentType:"application/json",verb:"GET"},"queue.get":{url:"{api_url}/accounts/{account_id}/queues/{queue_id}",contentType:"application/json",verb:"GET"},"queue.create":{url:"{api_url}/accounts/{account_id}/queues",contentType:"application/json",verb:"PUT"},"queue.update":{url:"{api_url}/accounts/{account_id}/queues/{queue_id}",contentType:"application/json",verb:"POST"},"queue.delete":{url:"{api_url}/accounts/{account_id}/queues/{queue_id}",contentType:"application/json",verb:"DELETE"},"queue.user_list":{url:"{api_url}/accounts/{account_id}/users",contentType:"application/json",verb:"GET"}}},function(e){var t=this;winkstart.registerResources(t.__whapp,t.config.resources),winkstart.publish("whappnav.subnav.add",{whapp:"voip",module:t.__module,label:_t("voip_queue","queue_label"),icon:"queue",weight:"65",category:_t("config","advanced_menu_cat")})},{save_queue:function(e,t,n,r){var i=this,s=i.normalize_data($.extend(!0,{},t.data,e));typeof t.data=="object"&&t.data.id?winkstart.request(!0,"queue.update",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,queue_id:t.data.id,data:s},function(e,r){typeof n=="function"&&i.update_users(t.field_data.user_list,e.data.id,function(){n(e,r,"update")})},function(e,t){typeof r=="function"&&r(e,t,"update")}):winkstart.request(!0,"queue.create",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,data:s},function(e,r){typeof n=="function"&&i.update_users(t.field_data.user_list,e.data.id,function(){n(e,r,"create")})},function(e,t){typeof r=="function"&&r(e,t,"update")})},update_single_user:function(e,t,n,r){var i=this;winkstart.request(!1,"user.get",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,user_id:e},function(i,s){if(n=="add"){if(!i.data.queues||typeof i.data.queues!="object")i.data.queues=[];i.data.queues.push(t),"queue_pin"in i.data||(i.data.queue_pin="")}else i.data.queues.splice(i.data.queues.indexOf(t),1);winkstart.request(!1,"user.update",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,user_id:e,data:i.data},function(e,t){typeof r=="function"&&r(t)},function(e,t){typeof r=="function"&&r(t)})})},update_users:function(e,t,n){var r=e.old_list,i=e.new_list,s=this,o=0,u=0,a=function(){o++,o>=u&&n()};r?($.each(r,function(e,n){i.indexOf(n)===-1&&(u++,s.update_single_user(n,t,"remove",a))}),$.each(i,function(e,n){r.indexOf(n)===-1&&(u++,s.update_single_user(n,t,"add",a))})):i&&$.each(i,function(e,n){u++,s.update_single_user(n,t,"add",a)}),u==0&&n()},edit_queue:function(e,t,n,r,i){var s=this,o=t||$("#queue-content"),u=n||$("#queue-view",o),r=r||{},a={save_success:r.save_success||function(e){s.render_list(o),s.edit_queue({id:e.data.id},o,u,a)},save_error:r.save_error,delete_success:r.delete_success||function(){u.empty(),s.render_list(o)},delete_error:r.delete_error,after_render:r.after_render},f={data:$.extend(!0,{connection_timeout:"300",member_timeout:"5"},i||{}),field_data:{sort_by:{first_name:_t("voip_queue","first_name"),last_name:_t("voip_queue","last_name")}}};winkstart.request(!0,"user.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){f.field_data.users=t.data,typeof e=="object"&&e.id?winkstart.request(!0,"queue.get",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,queue_id:e.id},function(e,t){var n=$.extend(!0,f,e);n.field_data.old_list=[],"agents"in e.data&&(n.field_data.old_list=e.data.agents),s.render_queue(n,u,a),typeof a.after_render=="function"&&a.after_render()}):(s.render_queue(f,u,a),typeof a.after_render=="function"&&a.after_render())})},delete_queue:function(e,t,n){var r=this;typeof e.data=="object"&&e.data.id&&winkstart.request(!0,"queue.delete",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,queue_id:e.data.id},function(e,n){typeof t=="function"&&t(e,n)},function(e,t){typeof n=="function"&&n(e,t)})},render_queue:function(e,t,n){e._t=function(e){return window.translate.voip_queue[e]};var r=this,i=r.templates.edit.tmpl(e);r.render_user_list(e,i),winkstart.validate.set(r.config.validation,i),$("*[rel=popover]",i).popover({trigger:"focus"}),winkstart.tabs($(".view-buttons",i),$(".tabs",i)),$(".queue-save",i).click(function(t){t.preventDefault(),winkstart.validate.is_valid(r.config.validation,i,function(){var t=form2object("queue-form");r.clean_form_data(t);var s=[];$(".rows .row:not(#row_no_data)",i).each(function(){s.push($(this).dataset("id"))}),e.field_data.user_list={old_list:e.data.agents||[],new_list:s},r.save_queue(t,e,n.save_success,winkstart.error_message.process_error(n.save_error))},function(){winkstart.alert(_t("voip_queue","there_were_errors_on_the_form"))})}),$(".queue-delete",i).click(function(t){t.preventDefault(),winkstart.confirm(_t("voip_queue","are_you_sure_you_want_to_delete"),function(){r.delete_queue(e,n.delete_success,n.delete_error)})}),$(".add_user_div",i).click(function(){var e=$("#user_id",i);if(e.val()!="empty_option_user"){var t=e.val(),n={user_id:t,user_name:$("#option_user_"+t,i).text(),_t:function(e){return window.translate.voip_queue[e]}};$("#row_no_data",i).size()>0&&$("#row_no_data",i).remove(),$(".rows",i).prepend(r.templates.user_row.tmpl(n)),$("#option_user_"+t,i).hide(),e.val("empty_option_user")}}),$(i).delegate(".action_user.edit","click",function(){var e={id:$(this).dataset("id")};winkstart.publish("user.popup_edit",e,function(e){$("#row_user_"+e.data.id+" .column.first",i).html(e.data.first_name+" "+e.data.last_name),$("#option_user_"+e.data.id,i).html(e.data.first_name+" "+e.data.last_name)})}),$(i).delegate(".action_user.delete","click",function(){var e=$(this).dataset("id");$("#row_user_"+e,i).remove(),$("#option_user_"+e,i).show(),$(".rows .row",i).size()==0&&$(".rows",i).append(r.templates.user_row.tmpl({_t:function(e){return window.translate.voip_queue[e]}}))}),t.empty().append(i)},normalize_data:function(e){return delete e.users,e},clean_form_data:function(e){delete e.user_id},render_list:function(e){var t=this,n=e||$("#queue-content");winkstart.request(!0,"queue.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(e,t){var r=function(e){var t=[];return e.length>0&&$.each(e,function(e,n){t.push({id:n.id,title:n.name||_t("voip_queue","no_name")})}),t.sort(function(e,t){return e.title.toLowerCase()<t.title.toLowerCase()?-1:1}),t};$("#queue-listpanel",n).empty().listpanel({label:_t("voip_queue","queues_label"),identifier:"queue-listview",new_entity_label:_t("voip_queue","add_queue_label"),data:r(e.data),publisher:winkstart.publish,notifyMethod:"queue.edit",notifyCreateMethod:"queue.edit",notifyParent:n})})},activate:function(e){var t=this,n=t.templates.queue.tmpl();(e||$("#ws-content")).empty().append(n),t.render_list(n)},render_user_list:function(e,t){var n=this;if(e.data.id)if("agents"in e.data&&e.data.agents.length>0){var r;$.each(e.field_data.users,function(i,s){e.data.agents.indexOf(s.id)>=0&&(r={user_id:s.id,user_name:s.first_name+" "+s.last_name,_t:function(e){return window.translate.voip_queue[e]}},$(".rows",t).append(n.templates.user_row.tmpl(r)),$("#option_user_"+s.id,t).hide())})}else $(".rows",t).empty().append(n.templates.user_row.tmpl({_t:function(e){return window.translate.voip_queue[e]}}));else $(".rows",t).empty().append(n.templates.user_row.tmpl({_t:function(e){return window.translate.voip_queue[e]}}))},popup_edit_queue:function(e,t,n){var r,i;i=$('<div class="inline_popup"><div class="inline_content"/></div>'),winkstart.publish("queue.edit",e,i,$(".inline_content",i),{save_success:function(e){r.dialog("close"),typeof t=="function"&&t(e)},delete_success:function(){r.dialog("close"),typeof t=="function"&&t({data:{}})},after_render:function(){r=winkstart.dialog(i,{title:e.id?_t("voip_queue","edit_queue"):_t("voip_queue","create_queue")})}},n)},define_callflow_nodes:function(e){var t=this;$.extend(e,{"queue[id=*]":{name:_t("voip_queue","queue"),icon:"queue",category:_t("config","call_center_cat"),module:"queue",tip:_t("voip_queue","ask_the_caller_to_input"),data:{id:"null"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",caption:function(e,t){var n=e.getMetadata("id"),r="";return n in t&&(r=t[n].name),r},edit:function(e,n){var r=this;winkstart.request(!0,"queue.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(r,i){var s,o;o=t.templates.queue_callflow.tmpl({_t:function(e){return window.translate.voip_queue[e]},items:r.data,selected:e.getMetadata("id")||"",route_var:e.getMetadata("var")||""}),$("#queue_selector option:selected",o).val()==undefined&&$("#edit_link",o).hide(),$(".inline_action",o).click(function(t){var n=$(this).dataset("action")=="edit"?{id:$("#queue_selector",o).val()}:{};t.preventDefault(),winkstart.publish("queue.popup_edit",n,function(t){e.setMetadata("id",t.data.id||"null"),$("#route_var",o).val().length>0?e.setMetadata("var",$("#route_var",o).val()):e.deleteMetadata("var"),e.caption=t.data.name||"",s.dialog("close")})}),$("#toggle_advanced",o).click(function(){$("#route_var_div",o).toggle()}),$("#add",o).click(function(){e.setMetadata("id",$("#queue_selector",s).val()),$("#route_var",o).val().length>0?e.setMetadata("var",$("#route_var",o).val()):e.deleteMetadata("var"),e.caption=$("#queue_selector option:selected",s).text(),s.dialog("close")}),s=winkstart.dialog(o,{title:_t("voip_queue","queue_title"),minHeight:"0",beforeClose:function(){typeof n=="function"&&n()}})})}},"agent[action=resume]":{name:_t("voip_queue","agent_resume"),icon:"rightarrow",category:_t("config","call_center_cat"),module:"agent",tip:"",data:{action:"resume",retries:"3"},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",caption:function(e,t){return""},edit:function(e,t){typeof t=="function"&&t()}},"agent[action=break]":{name:_t("voip_queue","agent_break"),icon:"rightarrow",category:_t("config","call_center_cat"),module:"agent",tip:"",data:{action:"break",retries:"3"},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",caption:function(e,t){return""},edit:function(e,t){typeof t=="function"&&t()}},"agent[action=logout]":{name:_t("voip_queue","logout_agent"),icon:"rightarrow",category:_t("config","call_center_cat"),module:"agent",tip:"",data:{action:"logout",retries:"3"},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",caption:function(e,t){return""},edit:function(e,t){typeof t=="function"&&t()}},"agent[action=login]":{name:_t("voip_queue","login_agent"),icon:"rightarrow",category:_t("config","call_center_cat"),module:"agent",tip:"",data:{action:"login",retries:"3"},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",caption:function(e,t){return""},edit:function(e,t){typeof t=="function"&&t()}},"agent[action=toggle]":{name:_t("voip_queue","toggle_agent"),icon:"rightarrow",category:_t("config","call_center_cat"),module:"agent",tip:"",data:{action:"toggle",retries:"3"},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",caption:function(e,t){return""},edit:function(e,t){typeof t=="function"&&t()}}})}});