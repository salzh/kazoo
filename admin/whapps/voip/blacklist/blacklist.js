winkstart.module("voip","blacklist",{css:["css/blacklist.css"],templates:{blacklist:"tmpl/blacklist.html",edit:"tmpl/edit.html",addNumber:"tmpl/addNumber.html"},subscribe:{"blacklist.activate":"activate","blacklist.edit":"render_edit_blacklist"},validation:[{name:"#name",regex:/^.+$/}],resources:{"blacklist.list":{url:"{api_url}/accounts/{account_id}/blacklists",contentType:"application/json",verb:"GET"},"blacklist.get":{url:"{api_url}/accounts/{account_id}/blacklists/{blacklist_id}",contentType:"application/json",verb:"GET"},"blacklist.create":{url:"{api_url}/accounts/{account_id}/blacklists",contentType:"application/json",verb:"PUT"},"blacklist.update":{url:"{api_url}/accounts/{account_id}/blacklists/{blacklist_id}",contentType:"application/json",verb:"POST"},"blacklist.delete":{url:"{api_url}/accounts/{account_id}/blacklists/{blacklist_id}",contentType:"application/json",verb:"DELETE"}}},function(e){var t=this;winkstart.registerResources(t.__whapp,t.config.resources),winkstart.publish("whappnav.subnav.add",{whapp:"voip",module:t.__module,label:_t("blacklist","blacklist_label"),icon:"line_circle",weight:"100",category:_t("config","advanced_menu_cat")})},{render_edit_blacklist:function(e){var t=this,n=$("#blacklist-content"),r=$("#blacklist-view",n),i={};typeof e=="object"&&e.id?t.getBlacklist(e.id,function(e){t.format_data(e),t.renderBlacklist(e,r)}):t.renderBlacklist(i,r)},clean_form_data:function(e){return delete e.extra,e},format_data:function(e){return e},normalize_data:function(e){return e},renderBlacklist:function(e,t){var n=this;e._t=function(e){return window.translate.blacklist[e]};var r=$(n.templates.edit.tmpl(e));e.hasOwnProperty("numbers")&&$.each(e.numbers,function(e,t){var i={number:e,_t:function(e){return window.translate.blacklist[e]}};$(".list-numbers .saved-numbers",r).append(n.templates.addNumber.tmpl(i))}),winkstart.validate.set(n.config.validation,r),n.bindEvents(e,r),$('*[rel=popover]:not([type="text"])',r).popover({trigger:"hover"}),$('*[rel=popover][type="text"]',r).popover({trigger:"focus"}),t.empty().append(r)},bindEvents:function(e,t){var n=this,r=function(e){var r=t.find("#number_value").val();if(r){var i={number:r,_t:function(e){return window.translate.blacklist[e]}};$(".list-numbers .saved-numbers",t).prepend(n.templates.addNumber.tmpl(i)),$("#number_value",t).val("")}};$(".number-wrapper.placeholder:not(.active)",t).click(function(){var e=$(this);e.addClass("active"),$("#number_value",t).focus()}),$("#add_number",t).click(function(){r()}),$(".add-number",t).bind("keypress",function(e){var t=e.keyCode||e.which;t===13&&r(e)}),$(t).delegate(".delete-number","click",function(e){$(this).parents(".number-wrapper").remove()}),$("#cancel_number",t).click(function(e){e.stopPropagation(),$(".number-wrapper.placeholder.active",t).removeClass("active"),$("#number_value",t).val("")}),$(".blacklist-save",t).click(function(){var r=form2object("blacklist-form"),i=n.clean_form_data(r),s={};$(".saved-numbers .number-wrapper",t).each(function(t,n){delete e.numbers;var r=$(n).attr("data-number");s[r]={}}),i.numbers=s;var o=n.normalize_data($.extend(!0,{},e,i));n.saveBlacklist(o,function(e){n.renderList(),n.render_edit_blacklist(e)})}),$(".blacklist-delete",t).click(function(){n.deleteBlacklist(e.id,function(){$("#blacklist-view").empty(),n.renderList()})})},renderList:function(e){var t=this,e=e||$("#blacklist-content");t.listBlacklists(function(t,n){var r=function(e){var t=[];return e.length>0&&$.each(e,function(e,n){t.push({id:n.id,title:n.name||_t("blacklist","no_name")})}),t.sort(function(e,t){return e.title.toLowerCase()<t.title.toLowerCase()?-1:1}),t};$("#blacklist-listpanel",e).empty().listpanel({label:_t("blacklist","blacklist_label"),identifier:"blacklist-listview",new_entity_label:_t("blacklist","add_blacklist_label"),data:r(t),publisher:winkstart.publish,notifyMethod:"blacklist.edit",notifyCreateMethod:"blacklist.edit",notifyParent:e})})},activate:function(e){var t=this,n={_t:function(e){return window.translate.blacklist[e]}},r=t.templates.blacklist.tmpl(n);(e||$("#ws-content")).empty().append(r),t.renderList(r)},saveBlacklist:function(e,t){var n=this;e.id?n.updateBlacklist(e,t):n.createBlacklist(e,t)},listBlacklists:function(e){var t=this;winkstart.request(!0,"blacklist.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){e&&e(t.data)})},getBlacklist:function(e,t){var n=this;winkstart.request(!0,"blacklist.get",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,blacklist_id:e},function(e,n){t&&t(e.data)})},createBlacklist:function(e,t){var n=this;winkstart.request(!0,"blacklist.create",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,data:e},function(e,n){t&&t(e.data)})},updateBlacklist:function(e,t){var n=this;winkstart.request(!0,"blacklist.update",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,blacklist_id:e.id,data:e},function(e,n){t&&t(e.data)})},deleteBlacklist:function(e,t){var n=this;winkstart.request(!0,"blacklist.delete",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,blacklist_id:e},function(e,n){t&&t(e.data)})}});