winkstart.module("voip","bulk",{css:["css/bulk.css"],templates:{bulk:"tmpl/bulk.html"},subscribe:{"bulk.activate":"activate"},resources:{"bulk.list_classifiers":{url:"{api_url}/accounts/{account_id}/phone_numbers/classifiers",contentType:"application/json",verb:"GET"},"bulk.list":{url:"{api_url}/accounts/{account_id}/bulk",contentType:"application/json",verb:"GET"},"bulk.update":{url:"{api_url}/accounts/{account_id}/bulk",contentType:"application/json",verb:"POST"}}},function(e){winkstart.registerResources(this.__whapp,this.config.resources),winkstart.publish("whappnav.subnav.add",{whapp:"voip",module:this.__module,label:_t("bulk","bulk_edit_label"),icon:"device",weight:"80",category:_t("config","advanced_menu_cat")})},{init_table:function(e){var t=e,n=[{sTitle:'<input type="checkbox" id="select_all_endpoints"/>',fnRender:function(e){return'<input type="checkbox" class="select_endpoint" data-id="'+e.aData[e.iDataColumn]+'"/>'},bSortable:!1,sWidth:"100px"},{sTitle:_t("bulk","name_stitle")},{sTitle:_t("bulk","endpoint_type_stitle"),sWidth:"200px"},{sTitle:_t("bulk","bulk_id_stitle"),bVisible:!1}];winkstart.table.create("bulk",$("#bulk-grid",t),n,{},{sDom:'<"date">frtlip',aaSorting:[[7,"desc"]]}),$(".cancel-search",t).click(function(){$("#registration-grid_filter input[type=text]",t).val(""),winkstart.table.bulk.fnFilter("")}),$("#select_all_endpoints",e).click(function(){$(".select_endpoint",e).prop("checked",$(this).is(":checked"))})},activate:function(e){var t=this,n={},r={data:{call_restriction:{}},field_data:{call_restriction:{}}};winkstart.parallel({list_classifiers:function(e){winkstart.request("bulk.list_classifiers",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){"data"in t&&$.each(t.data,function(e,t){r.field_data.call_restriction[e]={friendly_name:t.friendly_name},r.data.call_restriction[e]={action:"inherit"}}),e(null,t)})},media_list:function(e){winkstart.request(!0,"media.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){t.data&&(t.data.unshift({id:"",name:_t("bulk","default_music")},{id:"silence_stream://300000",name:_t("bulk","silence")}),r.field_data.media=t.data),e(null,t)})},device_list:function(e){winkstart.request(!0,"device.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,r){$.each(t.data,function(){n[this.id]=$.extend(!0,{endpoint_type:"device"},this)}),e(null,t)})},user_list:function(e){winkstart.request(!0,"user.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,r){$.each(t.data,function(){n[this.id]=$.extend(!0,{name:this.first_name+" "+this.last_name,endpoint_type:"user"},this)}),e(null,t)})},group_list:function(e){winkstart.request(!0,"groups.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,r){$.each(t.data,function(){n[this.id]=$.extend(!0,{endpoint_type:"group"},this)}),e(null,t)})}},function(e,i){r._t=function(e){return window.translate.bulk[e]};var s=t.templates.bulk.tmpl(r);t.bind_events(s),$("#ws-content").empty().append(s),t.init_table(s),$.fn.dataTableExt.afnFiltering.pop();var o=[];$.each(n,function(e,t){o.push([e,t.name,t.endpoint_type,e])}),winkstart.table.bulk.fnAddData(o)})},bind_events:function(e){winkstart.timezone.populate_dropdown($("#timezone",e)),$(".input",$(".bulk-edit-checkbox",e).parents(".clearfix")).hide(),$(".bulk-edit-checkbox",e).click(function(){$(this).prop("checked")?$(".input",$(this).parents(".clearfix").first()).show():$(".input",$(this).parents(".clearfix").first()).show().hide()}),$(".bulk-save",e).click(function(){var t=[];$(".select_endpoint:checked",e).each(function(e,n){t.push($(n).data("id"))});var n={};$(".clearfix",e).each(function(e,t){$(".bulk-edit-checkbox",$(t)).prop("checked")&&(n=$.extend(!0,n,form2object($(t).attr("id"))))}),delete n.extra;var r={ids:t,updates:n};winkstart.request("bulk.update",{api_url:winkstart.apps.voip.api_url,account_id:winkstart.apps.voip.account_id,data:r},function(e){var t=!1;$.each(e.data,function(e,n){n.status!=="success"&&(t=!0)}),t===!0?winkstart.alert(_t("bulk","an_error_occured_during")):winkstart.alert("info",_t("bulk","the_endpoints_selected"))})})}});