winkstart.module("voip","menu",{css:["css/menu.css"],templates:{menu:"tmpl/menu.html",edit:"tmpl/edit.html",menu_callflow:"tmpl/menu_callflow.html",menu_key_callflow:"tmpl/menu_key_callflow.html"},subscribe:{"menu.activate":"activate","menu.edit":"edit_menu","callflow.define_callflow_nodes":"define_callflow_nodes","menu.popup_edit":"popup_edit_menu"},validation:[{name:"#name",regex:/^.*/},{name:"#retries",regex:/^[0-9]+$/},{name:"#record_pin",regex:/^[0-9]*$/},{name:"#timeout",regex:/^[0-9]+$/},{name:"#max_extension_length",regex:/^[0-9]*$/},{name:"#hunt_allow",regex:/^.*$/},{name:"#hunt_deny",regex:/^.*$/}],resources:{"menu.list":{url:"{api_url}/accounts/{account_id}/menus",contentType:"application/json",verb:"GET"},"menu.list_no_loading":{url:"{api_url}/accounts/{account_id}/menus",contentType:"application/json",verb:"GET",trigger_events:!1},"menu.get":{url:"{api_url}/accounts/{account_id}/menus/{menu_id}",contentType:"application/json",verb:"GET"},"menu.create":{url:"{api_url}/accounts/{account_id}/menus",contentType:"application/json",verb:"PUT"},"menu.update":{url:"{api_url}/accounts/{account_id}/menus/{menu_id}",contentType:"application/json",verb:"POST"},"menu.delete":{url:"{api_url}/accounts/{account_id}/menus/{menu_id}",contentType:"application/json",verb:"DELETE"}}},function(e){var t=this;winkstart.registerResources(t.__whapp,t.config.resources),winkstart.publish("whappnav.subnav.add",{whapp:"voip",module:t.__module,label:_t("menu","menus_label"),icon:"menu1",weight:"40",category:_t("config","advanced_menu_cat")})},{save_menu:function(e,t,n,r){var i=this,s=i.normalize_data($.extend(!0,{},t.data,e));typeof t.data=="object"&&t.data.id?winkstart.request(!0,"menu.update",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,menu_id:t.data.id,data:s},function(e,t){typeof n=="function"&&n(e,t,"update")},function(e,t){typeof r=="function"&&r(e,t,"update")}):winkstart.request(!0,"menu.create",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,data:s},function(e,t){typeof n=="function"&&n(e,t,"create")},function(e,t){typeof r=="function"&&r(e,t,"update")})},edit_menu:function(e,t,n,r,i){var s=this,o=t||$("#menu-content"),u=n||$("#menu-view",o),r=r||{},a={save_success:r.save_success||function(e){s.render_list(o),s.edit_menu({id:e.data.id},o,u,a)},save_error:r.save_error,delete_success:r.delete_success||function(){u.empty(),s.render_list(o)},delete_error:r.delete_error,after_render:r.after_render},f={data:$.extend(!0,{retries:"3",timeout:"10000",max_extension_length:"4",media:{}},i||{}),field_data:{media:[]}};winkstart.parallel({media_list:function(e){winkstart.request(!0,"media.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){t.data.unshift({id:"",name:_t("menu","not_set")}),f.field_data.media=t.data,e(null,t)})},menu_get:function(t){typeof e=="object"&&e.id?winkstart.request(!0,"menu.get",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,menu_id:e.id},function(e,n){s.format_data(e.data),t(null,e)}):t(null,{})}},function(t,n){var r=f;typeof e=="object"&&e.id&&(r=$.extend(!0,f,n.menu_get)),s.render_menu(r,u,a),typeof a.after_render=="function"&&a.after_render()})},delete_menu:function(e,t,n){var r=this;typeof e.data=="object"&&e.data.id&&winkstart.request(!0,"menu.delete",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url,menu_id:e.data.id},function(e,n){typeof t=="function"&&t(e,n)},function(e,t){typeof n=="function"&&n(e,t)})},render_menu:function(e,t,n){e._t=function(e){return window.translate.menu[e]};var r=this,i=r.templates.edit.tmpl(e);winkstart.validate.set(r.config.validation,i),$('*[rel=popover]:not([type="text"])',i).popover({trigger:"hover"}),$('*[rel=popover][type="text"]',i).popover({trigger:"focus"}),winkstart.tabs($(".view-buttons",i),$(".tabs",i)),$("#media_greeting",i).val()||$("#edit_link_media",i).hide(),$("#media_greeting",i).change(function(){$("#media_greeting option:selected",i).val()?$("#edit_link_media",i).show():$("#edit_link_media",i).hide()}),$(".inline_action_media",i).click(function(e){var t=$(this).dataset("action")=="edit"?{id:$("#media_greeting",i).val()}:{},n=t.id;e.preventDefault(),winkstart.publish("media.popup_edit",t,function(e){n?"id"in e.data?$("#media_greeting #"+e.data.id,i).text(e.data.name):($("#media_greeting #"+n,i).remove(),$("#edit_link_media",i).hide()):($("#media_greeting",i).append('<option id="'+e.data.id+'" value="'+e.data.id+'">'+e.data.name+"</option>"),$("#media_greeting",i).val(e.data.id),$("#edit_link_media",i).show())})}),$(".menu-save",i).click(function(t){t.preventDefault(),winkstart.validate.is_valid(r.config.validation,i,function(){var t=form2object("menu-form");r.clean_form_data(t),"field_data"in e&&delete e.field_data,r.save_menu(t,e,n.save_success,winkstart.error_message.process_error(n.save_error))},function(){winkstart.alert(_t("menu","there_were_errors_on_the_form"))})}),$(".menu-delete",i).click(function(t){t.preventDefault(),winkstart.confirm(_t("menu","are_you_sure_you_want_to_delete"),function(){r.delete_menu(e,n.delete_success,n.delete_error)})}),t.empty().append(i)},normalize_data:function(e){return e.media.greeting||delete e.media.greeting,e.hunt_allow==""&&delete e.hunt_allow,e.hunt_deny==""&&delete e.hunt_deny,e.record_pin==""&&delete e.record_pin,e},format_data:function(e){e.media&&(e.media.invalid_media===!1&&e.media.transfer_media===!1&&e.media.exit_media===!1?e.suppress_media=!0:e.suppress_media=!1)},clean_form_data:function(e){e.record_pin.length==0?e.max_extension_length=4:e.max_extension_length<e.record_pin.length&&(e.max_extension_length=e.record_pin.length),e.timeout=e.timeout*1e3,"suppress_media"in e&&(e.media=e.media||{},e.suppress_media===!0?(e.media.invalid_media=!1,e.media.transfer_media=!1,e.media.exit_media=!1):(e.media.invalid_media=!0,e.media.transfer_media=!0,e.media.exit_media=!0))},render_list:function(e){var t=this,n=e||$("#menu-content");winkstart.request(!0,"menu.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(e,t){var r=function(e){var t=[];return e.length>0&&$.each(e,function(e,n){t.push({id:n.id,title:n.name||_t("menu","no_name")})}),t.sort(function(e,t){return e.title.toLowerCase()<t.title.toLowerCase()?-1:1}),t};$("#menu-listpanel",n).empty().listpanel({label:_t("menu","menus_label"),identifier:"menu-listview",new_entity_label:_t("menu","add_menu_label"),data:r(e.data),publisher:winkstart.publish,notifyMethod:"menu.edit",notifyCreateMethod:"menu.edit",notifyParent:n})})},activate:function(e){var t=this,n=t.templates.menu.tmpl();(e||$("#ws-content")).empty().append(n),t.render_list(n)},popup_edit_menu:function(e,t,n){var r,i;i=$('<div class="inline_popup"><div class="inline_content main_content"/></div>'),winkstart.publish("menu.edit",e,i,$(".inline_content",i),{save_success:function(e){r.dialog("close"),typeof t=="function"&&t(e)},delete_success:function(){r.dialog("close"),typeof t=="function"&&t({data:{}})},after_render:function(){r=winkstart.dialog(i,{title:e.id?_t("menu","edit_menu"):_t("menu","create_menu")})}},n)},define_stats:function(){var e={menus:{icon:"menu1",get_stat:function(e){winkstart.request("menu.list_no_loading",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(t,n){var r={name:"menus",number:t.data.length,active:t.data.length>0?!0:!1,color:t.data.length<1?"red":t.data.length>1?"green":"orange"};typeof e=="function"&&e(r)},function(t,n){e({error:!0})})},click_handler:function(){winkstart.publish("menu.activate")}}};return e},define_callflow_nodes:function(e){var t=this;$.extend(e,{"menu[id=*]":{name:_t("menu","menu"),icon:"menu1",category:_t("config","basic_cat"),module:"menu",tip:_t("menu","menu_tip"),data:{id:"null"},rules:[{type:"quantity",maxSize:"12"}],isUsable:"true",key_caption:function(e,t){var n=e.key;return n!="_"?n:_t("menu","default_action")},key_edit:function(e,n){var r,i;i=t.templates.menu_key_callflow.tmpl({_t:function(e){return window.translate.menu[e]},items:{_:_t("menu","default_action"),0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9","*":"*","#":"#"},selected:e.key}),$("#add",i).click(function(){e.key=$("#menu_key_selector",r).val(),e.key_caption=$("#menu_key_selector option:selected",r).text(),r.dialog("close")}),r=winkstart.dialog(i,{title:_t("menu","menu_option_title"),minHeight:"0",beforeClose:function(){typeof n=="function"&&n()}})},caption:function(e,t){var n=e.getMetadata("id"),r="";return n in t&&(r=t[n].name),r},edit:function(e,n){var r=this;winkstart.request(!0,"menu.list",{account_id:winkstart.apps.voip.account_id,api_url:winkstart.apps.voip.api_url},function(r,i){var s,o;o=t.templates.menu_callflow.tmpl({_t:function(e){return window.translate.menu[e]},items:winkstart.sort(r.data),selected:e.getMetadata("id")||"",route_var:e.getMetadata("var")||""}),$("#menu_selector option:selected",o).val()==undefined&&$("#edit_link",o).hide(),$(".inline_action",o).click(function(t){var n=$(this).dataset("action")=="edit"?{id:$("#menu_selector",o).val()}:{};t.preventDefault(),winkstart.publish("menu.popup_edit",n,function(t){e.setMetadata("id",t.data.id||"null"),$("#route_var",o).val().length>0?e.setMetadata("var",$("#route_var",o).val()):e.deleteMetadata("var"),e.caption=t.data.name||"",s.dialog("close")})}),$("#toggle_advanced",o).click(function(){$("#route_var_div",o).toggle()}),$("#add",o).click(function(){e.setMetadata("id",$("#menu_selector",s).val()),$("#route_var",o).val().length>0?e.setMetadata("var",$("#route_var",o).val()):e.deleteMetadata("var"),e.caption=$("#menu_selector option:selected",s).text(),s.dialog("close")}),s=winkstart.dialog(o,{title:_t("menu","menu_title"),minHeight:"0",beforeClose:function(){typeof n=="function"&&n()}})})}}})}});