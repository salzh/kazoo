winkstart.module("myaccount","app_store",{css:["css/app_store.css"],templates:{app_store:"tmpl/app_store.html"},subscribe:{"myaccount.nav.post_loaded":"myaccount_loaded","app_store.popup":"popup"},resources:{"app_store.user_get":{url:"{api_url}/accounts/{account_id}/users/{user_id}",contentType:"application/json",verb:"GET"},"app_store.user_update":{url:"{api_url}/accounts/{account_id}/users/{user_id}",contentType:"application/json",verb:"POST"},"app_store.account_get":{url:"{api_url}/accounts/{account_id}",contentType:"application/json",verb:"GET"},"app_store.account_update":{url:"{api_url}/accounts/{account_id}",contentType:"application/json",verb:"POST"}}},function(e){var t=this;winkstart.registerResources(t.__whapp,t.config.resources)},{update_acct:function(e,t,n,r){winkstart.request("app_store.user_update",{account_id:winkstart.apps.myaccount.account_id,api_url:winkstart.apps.myaccount.api_url,user_id:winkstart.apps.myaccount.user_id,data:$.extend(!0,{},e,t)},function(e,t){typeof n=="function"&&n(e,t)},function(e,t){typeof r=="function"&&r(e,t)})},myaccount_loaded:function(e){var t=this;winkstart.config.available_apps&&winkstart.request("app_store.account_get",{api_url:winkstart.apps.myaccount.api_url,account_id:winkstart.apps.myaccount.account_id},function(n,r){n.data.available_apps?t.add_sublink(n,e):(n.data.available_apps=[],$.each(winkstart.config.available_apps,function(e,t){n.data.available_apps.push(t.id)}),winkstart.request("app_store.account_update",{api_url:winkstart.apps.myaccount.api_url,account_id:winkstart.apps.myaccount.account_id,data:n.data},function(n,r){t.add_sublink(n,e)}))})},add_sublink:function(e,t){e.data.available_apps&&e.data.available_apps.length>0&&(!t.priv_level||t.priv_level==="admin")&&winkstart.publish("nav.add_sublink",{link:"nav",sublink:"app_store",label:_t("app-store","app_store_label"),weight:"20",publish:"app_store.popup"})},render_app_store:function(e,t,n){var r=this;winkstart.request("app_store.user_get",{account_id:winkstart.apps.myaccount.account_id,api_url:winkstart.apps.myaccount.api_url,user_id:winkstart.apps.myaccount.user_id},function(e,i){winkstart.request("app_store.account_get",{api_url:winkstart.apps.myaccount.api_url,account_id:winkstart.apps.myaccount.account_id},function(i,s){var o=$.extend({},o,{available_apps:{},apps:e.data.apps||{},_t:function(e){return window.translate["app-store"][e]}});i.data.available_apps=i.data.available_apps||((winkstart.config.onboard_roles||{})["default"]||{}).available_apps||[],$.each(i.data.available_apps,function(e,t){t in winkstart.config.available_apps&&(o.available_apps[e]=winkstart.config.available_apps[t])});var u=r.templates.app_store.tmpl(o),a=0,f=$(".app-store-ul li",u).length;$('*[rel=popover]:not([type="text"])',u).popover({trigger:"hover"}),$('*[rel=popover][type="text"]',u).popover({trigger:"focus"}),$(".switch",u)["switch"](),$("#left_scroll",u).click(function(){if(a>0){var e=$(".app-store-ul li",u).outerWidth();$(".app-store-ul").animate({left:"+="+e},500),a--}}),$("#right_scroll",u).click(function(){if(a+5<f){var e=$(".app-store-ul li",u).outerWidth();$(".app-store-ul").animate({left:"-="+e},500),a++}}),$("#app_store_save",u).click(function(e){e.preventDefault(),winkstart.confirm(_t("app-store","warning_this_is_going"),function(){winkstart.request("app_store.user_get",{account_id:winkstart.apps.myaccount.account_id,api_url:winkstart.apps.myaccount.api_url,user_id:winkstart.apps.myaccount.user_id},function(e,t){var n={},i=e.data;e.data.apps=e.data.apps||{},$(".app",u).find("[checked]").each(function(){var t=$(this).attr("name");e.data.apps[t]?n[t]=e.data.apps[t]:(n[t]=winkstart.config.available_apps[t],n[t].api_url=winkstart.config.default_api_url)}),i.apps=n,r.update_acct(i,{},function(){window.location.reload()})})})}),t.empty().append(u),typeof n=="function"&&n()})})},popup:function(){var e=this,t=$('<div class="inline_popup"><div class="inline_content main_content app-store"/></div>');e.render_app_store({},$(".inline_content",t),function(){winkstart.dialog(t,{height:"auto",modal:!0,title:_t("app-store","app_store_title"),autoOpen:!0})})}});