winkstart.module("myaccount","report",{css:["css/report.css"],templates:{report:"tmpl/report.html"},subscribe:{"myaccount.nav.post_loaded":"myaccount_loaded","report.render":"render_report"},resources:{"report.list_accounts_children":{url:"{api_url}/accounts/{account_id}/children",contentType:"application/json",verb:"GET"},"report.list_accounts_descendants":{url:"{api_url}/accounts/{account_id}/descendants",contentType:"application/json",verb:"GET"},"report.account_devices":{url:"{api_url}/accounts/{account_id}/devices",contentType:"application/json",verb:"GET"},"report.account_dids":{url:"{api_url}/accounts/{account_id}/phone_numbers",contentType:"application/json",verb:"GET"},"report.account_data":{url:"{api_url}/accounts/{account_id}",contentType:"application/json",verb:"GET"},"report.account_credits":{url:"{api_url}/accounts/{account_id}/braintree/credits",contentType:"application/json",verb:"GET"},"report.account_limits":{url:"{api_url}/accounts/{account_id}/limits",contentType:"application/json",verb:"GET"}}},function(e){var t=this;winkstart.registerResources(t.__whapp,t.config.resources)},{get_account_data:function(e,t,n){winkstart.request("report.account_"+e.type,{api_url:winkstart.apps.myaccount.api_url,account_id:e.account_id||("accounts"in winkstart.apps?winkstart.apps.accounts.account_id:winkstart.apps.myaccount.account_id)},function(e,n){typeof t=="function"&&t(e,n)},function(e,t){typeof n=="function"&&n(e,t)})},list_accounts:function(e,t,n){var r=this,i="accounts"in winkstart.apps?winkstart.apps.accounts.account_id:winkstart.apps.myaccount.account_id,s=function(e,r){winkstart.request("report.list_accounts_"+e,{api_url:winkstart.apps.myaccount.api_url,account_id:i},function(e,n){typeof t=="function"&&(r&&e.data.push(r),t(e,n))},function(e,t){typeof n=="function"&&n(e,t)})};e==="with_account"?r.get_account_data({type:"data"},function(e){var t={id:e.data.id,name:e.data.name};s("children",t)}):s(e)},myaccount_loaded:function(e){(winkstart.config.display_report||!e.priv_level||e.priv_level==="admin")&&winkstart.publish("nav.add_sublink",{link:"nav",sublink:"report",masqueradable:!0,label:_t("report","report_label"),weight:"17",publish:"report.render"})},render_report:function(e){var t=this,n=$('<div id="report_popup" class="inline_popup"><div class="inline_content main_content"/></div>'),r=$(".inline_content",n).append(t.templates.report.tmpl({_t:function(e){return window.translate.report[e]}}));report_dialog=winkstart.dialog(n,{modal:!0,title:_t("report","report_title")}),t.setup_report(r),$("#trigger_report",r).click(function(){$("#report_filters",r).hide(),$(".table-report",r).show(),$("#subtotals",r).hide();var e=$("input[type=radio][name=filter_account]:checked",r).val();e&&t.list_data_report(e,r)})},list_data_account:function(e,t,n,r){var i=this;r===undefined&&(r={dids:0,softphones:0,sip_devices:0,inbound_trunks:0,twoway_trunks:0,credits:0});if($(".table-report",e).is(":visible"))if(t.length){var s=t.splice(0,1)[0];winkstart.parallel({dids:function(e){i.get_account_data({type:"dids",account_id:s.id},function(t){e(null,t.data)})},devices:function(e){i.get_account_data({type:"devices",account_id:s.id},function(t){e(null,t.data)})},credits:function(e){i.get_account_data({type:"credits",account_id:s.id},function(t){e(null,t.data)})},limits:function(e){i.get_account_data({type:"limits",account_id:s.id},function(t){e(null,t.data)})}},function(o,u){var a=0,f=0,l=0,c=u.limits.inbound_trunks||0,h=u.limits.twoway_trunks||0;"numbers"in u.dids&&$.each(u.dids.numbers,function(e,t){l++}),$.each(u.devices,function(e,t){t.device_type==="softphone"?a++:$.inArray(t.device_type,["sip_device","fax","smartphone","sip_uri"])>-1&&f++}),r.dids+=l,r.sip_devices+=f,r.softphones+=a,r.credits+=u.credits.amount,r.inbound_trunks+=c,r.twoway_trunks+=h;var p=[s.name,f,a,l,c,h,"$"+parseFloat(u.credits.amount).toFixed(2)];winkstart.table.report.fnAddData(p),i.list_data_account(e,t,n,r)})}else typeof n=="function"&&n(r)},list_data_report:function(e,t){var n=this;winkstart.table.report.fnClearTable(),n.list_accounts(e,function(e){n.list_data_account(t,e.data,function(e){$("#amount_softphones",t).html(e.softphones),$("#amount_dids",t).html(e.dids),$("#amount_sip_devices",t).html(e.sip_devices),$("#amount_inbound_trunks",t).html(e.inbound_trunks),$("#amount_outbound_trunks",t).html(e.twoway_trunks),$("#amount_credits",t).html("$"+parseFloat(e.credits).toFixed(2)),$("#report_filters",t).show(),$("#subtotals",t).show()})})},setup_report:function(e){var t=this,n=[{sTitle:_t("report","account_stitle")},{sTitle:_t("report","sip_devices_stitle")},{sTitle:_t("report","softphones_stitle")},{sTitle:_t("report","dids_stitle")},{sTitle:_t("report","inbound_trunks_stitle")},{sTitle:_t("report","outbound_trunks_stitle")},{sTitle:_t("report","available_credits_stitle"),sType:"currency"}];winkstart.table.create("report",$("#report-grid",e),n,{},{sDom:"frtlip",aaSorting:[[0,"desc"]]}),$("#report-grid_filter input[type=text]",e).first().focus(),$(".cancel-search",e).click(function(){$("#report-grid_filter input[type=text]",e).val(""),winkstart.table.report.fnFilter("")})}});